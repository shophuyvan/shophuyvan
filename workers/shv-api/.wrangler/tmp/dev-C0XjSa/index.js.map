{
  "version": 3,
  "sources": ["../../../src/lib/response.js", "../../../src/lib/kv.js", "../../../src/modules/shipping/helpers.js", "../../../src/lib/utils.js", "../../../src/lib/auth.js", "../../../src/modules/categories.js", "../../../src/lib/validator.js", "../../../src/lib/idempotency.js", "../../../src/modules/admin.js", "../../../src/modules/shipping/waybill-template.js", "../../../src/modules/shipping/waybill.js", "../../../src/modules/vouchers.js", "../../../src/modules/orders.js", "../../../src/modules/products.js", "../../../src/modules/webhook-handler.js", "../../../src/modules/shipping/areas.js", "../../../src/modules/shipping/warehouses.js", "../../../src/modules/shipping/pricing.js", "../../../src/modules/shipping/index.js", "../../../src/modules/settings.js", "../../../src/modules/banners.js", "../../../src/modules/auth.js", "../../../src/modules/costs.js", "../../../src/modules/cart-sync-handler.js", "../../../src/index.js", "file:///C:/Users/Administrator/AppData/Roaming/npm/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts", "file:///C:/Users/Administrator/AppData/Roaming/npm/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts", "../bundle-vGPjzk/middleware-insertion-facade.js", "file:///C:/Users/Administrator/AppData/Roaming/npm/node_modules/wrangler/templates/middleware/common.ts", "../bundle-vGPjzk/middleware-loader.entry.ts"],
  "sourceRoot": "E:\\WEB\\Zaliminiapp-web\\shophuyvan\\workers\\shv-api\\.wrangler\\tmp\\dev-C0XjSa",
  "sourcesContent": ["// workers/shv-api/src/lib/response.js\nexport function corsHeaders(req) {\n  const origin = req.headers.get('Origin') || '*';\n  const reqHdr = req.headers.get('Access-Control-Request-Headers') ||\n  'authorization,content-type,x-token,x-customer-token,x-requested-with';\n  \n  return {\n    'Access-Control-Allow-Origin': origin,\n    'Vary': 'Origin',\n    'Access-Control-Allow-Methods': 'GET,POST,PUT,PATCH,DELETE,OPTIONS',\n    'Access-Control-Max-Age': '86400',\n    'Access-Control-Allow-Headers': reqHdr,\n    'Access-Control-Expose-Headers': 'x-token,x-customer-token',\n    'Access-Control-Allow-Credentials': 'true'\n  };\n}\n\nexport function json(data, init = {}, req) {\n  return new Response(JSON.stringify(data || {}), {\n    status: init.status || 200,\n    headers: {\n      ...corsHeaders(req),\n      'content-type': 'application/json; charset=utf-8'\n    }\n  });\n}\n\nexport function errorResponse(error, status = 500, req) {\n  return json({ \n    ok: false, \n    error: String(error?.message || error) \n  }, { status }, req);\n}", "// workers/shv-api/src/lib/kv.js\n// Detected KV namespaces from wrangler.toml: SHV, VANCHUYEN\n\n/// Auto-select the correct KV binding by (1) explicit ns, (2) key prefix, then (3) default.\nconst KV_PREFIX_MAP = {\n  'ship:': 'VANCHUYEN',\n  'shipping:': 'VANCHUYEN',\n};\n\nfunction pickKV(env, key, ns) {\n  // 1) explicit namespace\n  if (ns && env?.[ns]) return env[ns];\n\n  // 2) by key prefix mapping\n  for (const [prefix, binding] of Object.entries(KV_PREFIX_MAP)) {\n    if (prefix && key.startsWith(prefix) && env?.[binding]) return env[binding];\n  }\n\n  // 3) default: SHV if present, else first configured binding\n  if (env?.SHV) return env.SHV;\n\n  // fallback: pick any available binding\n  const candidates = ['SHV','VANCHUYEN'];\n  for (const b of candidates) if (env?.[b]) return env[b];\n  return null;\n}\n\nexport async function getJSON(env, key, fallback = null, opts = {}) {\n  try {\n    const kv = pickKV(env, key, opts.ns);\n    if (!kv?.get) return fallback;\n    const raw = await kv.get(key);\n    return raw ? JSON.parse(raw) : fallback;\n  } catch (e) {\n    console.error('KV getJSON error:', key, e);\n    return fallback;\n  }\n}\n\nexport async function putJSON(env, key, value, opts = {}) {\n  const kv = pickKV(env, key, opts.ns);\n  if (!kv?.put) throw new Error('KV binding not available');\n  const body = JSON.stringify(value ?? null);\n  await kv.put(key, body, { expirationTtl: opts.ttl || undefined });\n  return true;\n}\n\nexport async function deleteKey(env, key, opts = {}) {\n  try {\n    const kv = pickKV(env, key, opts.ns);\n    if (!kv?.delete) return false;\n    await kv.delete(key);\n    return true;\n  } catch (e) {\n    console.error('KV delete error:', key, e);\n    return false;\n  }\n}\n", "// ===================================================================\n// modules/shipping/helpers.js - Shipping Helper Functions\n// ===================================================================\n\nimport { getJSON, putJSON } from '../../lib/kv.js';\n\n/**\n * Get SuperAI token from settings\n */\n  export async function superToken(env) {\n  return \"FxXOoDz2qlTN5joDCsBGQFqKmm1UNvOw7YPwkzm5\".trim();\n}\n\n\n/**\n * Fetch from SuperAI API\n */\nexport async function superFetch(env, path, options = {}) {\n  const base = 'https://api.superai.vn'; // S\u1EECA: dev -> api\n  const token = await superToken(env);\n\n  // \u2705 TH\u00CAM LOG \u0110\u1EC2 DEBUG TOKEN\n  console.log('[superFetch] \uD83D\uDD11 Token retrieved:', token ? `${token.substring(0, 20)}...` : '\u274C EMPTY');\n\n  const method = (options.method || 'GET').toUpperCase();\n\n  const headers = {\n    'Accept': 'application/json',\n    'Token': String(token || '').trim(),\n    // S\u1EBD b\u1ED5 sung Content-Type b\u00EAn d\u01B0\u1EDBi n\u1EBFu c\u00F3 body l\u00E0 object\n    ...options.headers\n  };\n\n  // \u2705 LOG HEADERS TR\u01AF\u1EDAC KHI G\u1EECI\n  console.log('[superFetch] \uD83D\uDCE4 Headers:', JSON.stringify(headers, null, 2));\n  console.log('[superFetch] \uD83C\uDF10 URL:', base + path);\n\n  const config = { method, headers };\n\n  if (options.body !== undefined && options.body !== null) {\n    if (typeof options.body === 'string') {\n      // \u0110\u00E3 l\u00E0 chu\u1ED7i JSON (ho\u1EB7c form kh\u00E1c) th\u00EC gi\u1EEF nguy\u00EAn\n      config.body = options.body;\n      // N\u1EBFu b\u1EA1n mu\u1ED1n \u00E9p lu\u00F4n JSON th\u00EC c\u00F3 th\u1EC3 b\u1ECF qua nh\u00E1nh string n\u00E0y\n    } else {\n      // Object \u2192 stringify v\u00E0 \u0111\u1EB7t Content-Type\n      config.body = JSON.stringify(options.body);\n      config.headers['Content-Type'] = config.headers['Content-Type'] || 'application/json';\n    }\n  }\n\n  // \u2705 LOG PAYLOAD\n  if (config.body) {\n    console.log('[superFetch] \uD83D\uDCE6 Payload:', config.body.substring(0, 500));\n  }\n\n  try {\n    const response = await fetch(base + path, config);\n    const responseText = await response.text();\n\n    // \u2705 LOG RESPONSE\n    console.log('[superFetch] \uD83D\uDCE5 Response status:', response.status);\n    console.log('[superFetch] \uD83D\uDCE5 Response body:', (responseText || '').substring(0, 500));\n\n    // Ki\u1EC3m tra content-type \u0111\u1EC3 quy\u1EBFt \u0111\u1ECBnh parse\n    const contentType = (response.headers.get('content-type') || '').toLowerCase();\n    const isJson = contentType.includes('application/json');\n\n    // N\u1EBFu l\u00E0 JSON \u2192 parse an to\u00E0n\n    if (isJson) {\n      try {\n        const json = responseText ? JSON.parse(responseText) : null;\n        // Tr\u1EA3 v\u1EC1 lu\u00F4n JSON (k\u1EC3 c\u1EA3 l\u1ED7i 4xx/5xx \u0111\u1EC3 caller t\u1EF1 x\u1EED l\u00FD)\n        return json ?? { ok: false, status: response.status, raw: null };\n      } catch (err) {\n        console.warn('[superFetch] \u26A0\uFE0F JSON parse failed:', err?.message);\n        return { ok: false, status: response.status, raw: responseText || null };\n      }\n    }\n\n    // Kh\u00F4ng ph\u1EA3i JSON \u2192 tr\u1EA3 v\u1EC1 raw \u0111\u1EC3 nh\u00ECn \u0111\u01B0\u1EE3c l\u1ED7i th\u1EADt\n    return { ok: response.ok, status: response.status, raw: responseText || null };\n\n  } catch (e) {\n    console.error('[superFetch] \u274C Error:', path, e);\n    return { ok: false, status: 0, raw: String(e?.message || e) };\n  }\n}\n/**\n * Tra c\u1EE9u m\u00E3 district chu\u1EA9n t\u1EEB SuperAI API\n * @param {Object} env - Cloudflare Workers environment\n * @param {string} provinceCode - M\u00E3 t\u1EC9nh/th\u00E0nh (VD: '79' cho TP.HCM)\n * @param {string} districtName - T\u00EAn qu\u1EADn/huy\u1EC7n (VD: 'Qu\u1EADn 7', 'Huy\u1EC7n B\u00ECnh Ch\u00E1nh')\n * @returns {Promise<string|null>} - M\u00E3 district chu\u1EA9n ho\u1EB7c null n\u1EBFu kh\u00F4ng t\u00ECm th\u1EA5y\n */\nexport async function lookupDistrictCode(env, provinceCode, districtName) {\n  try {\n    if (!provinceCode || !districtName) {\n      console.warn('[Helpers] lookupDistrictCode: Missing provinceCode or districtName');\n      return null;\n    }\n\n    console.log(`[Helpers] \uD83D\uDD0D Looking up district: \"${districtName}\" in province: ${provinceCode}`);\n\n    // G\u1ECDi API SuperAI \u0111\u1EC3 l\u1EA5y danh s\u00E1ch qu\u1EADn/huy\u1EC7n\n    const base = 'https://api.superai.vn'; // S\u1EECA: dev -> api\n    const token = await superToken(env);\n    \n    const url = `${base}/v1/platform/areas/district?province=${provinceCode}`;\n    \n    const response = await fetch(url, {\n      method: 'GET',\n      headers: {\n        'Accept': 'application/json',\n        'Token': token\n      }\n    });\n\n    if (!response.ok) {\n      console.error('[Helpers] District API error:', response.status, await response.text());\n      return null;\n    }\n\n    const data = await response.json();\n    \n    if (!data?.data || !Array.isArray(data.data)) {\n      console.error('[Helpers] Invalid district API response:', data);\n      return null;\n    }\n\n    // Chu\u1EA9n h\u00F3a t\u00EAn \u0111\u1EC3 so s\u00E1nh (b\u1ECF prefix \"Qu\u1EADn\", \"Huy\u1EC7n\", \"Th\u1ECB x\u00E3\"...)\n    const normalizedName = districtName.trim().toLowerCase()\n      .replace(/^qu\u1EADn\\s+/gi, '')\n      .replace(/^huy\u1EC7n\\s+/gi, '')\n      .replace(/^th\u1ECB\\s+x\u00E3\\s+/gi, '')\n      .replace(/^th\u00E0nh\\s+ph\u1ED1\\s+/gi, '')\n      .trim();\n\n    console.log(`[Helpers] Normalized search: \"${normalizedName}\"`);\n\n    // T\u00ECm district kh\u1EDBp t\u00EAn\n    const district = data.data.find(d => {\n      const dName = (d.name || '').toLowerCase()\n        .replace(/^qu\u1EADn\\s+/gi, '')\n        .replace(/^huy\u1EC7n\\s+/gi, '')\n        .replace(/^th\u1ECB\\s+x\u00E3\\s+/gi, '')\n        .replace(/^th\u00E0nh\\s+ph\u1ED1\\s+/gi, '')\n        .trim();\n      \n      return dName === normalizedName || \n             dName.includes(normalizedName) || \n             normalizedName.includes(dName);\n    });\n\n    if (district && district.code) {\n      console.log(`[Helpers] \u2705 Found district: \"${district.name}\" \u2192 code: ${district.code}`);\n      return String(district.code);\n    }\n\n    console.warn(`[Helpers] \u26A0\uFE0F District not found: \"${districtName}\" in province ${provinceCode}`);\n    console.log(`[Helpers] Available districts:`, data.data.map(d => `${d.name} (${d.code})`).join(', '));\n    \n    return null;\n\n  } catch (error) {\n    console.error('[Helpers] lookupDistrictCode error:', error);\n    return null;\n  }\n}\n\n/**\n * Validate v\u00E0 t\u1EF1 \u0111\u1ED9ng s\u1EEDa m\u00E3 district n\u1EBFu c\u1EA7n\n * @param {Object} env - Cloudflare Workers environment\n * @param {string} provinceCode - M\u00E3 t\u1EC9nh/th\u00E0nh\n * @param {string} districtCode - M\u00E3 qu\u1EADn/huy\u1EC7n hi\u1EC7n t\u1EA1i\n * @param {string} districtName - T\u00EAn qu\u1EADn/huy\u1EC7n (\u0111\u1EC3 tra c\u1EE9u n\u1EBFu code sai)\n * @returns {Promise<string>} - M\u00E3 district \u0111\u00E3 \u0111\u01B0\u1EE3c validate/s\u1EEDa\n */\nexport async function validateDistrictCode(env, provinceCode, districtCode, districtName) {\n  const code = String(districtCode || '').trim();\n\n  // Ki\u1EC3m tra format c\u01A1 b\u1EA3n: 3 ch\u1EEF s\u1ED1\n  if (/^\\d{3}$/.test(code)) {\n    console.log(`[Helpers] \u2705 District code format OK: ${code}`);\n    return code;\n  }\n\n  console.warn(`[Helpers] \u26A0\uFE0F Invalid district_code format: \"${code}\" (expected 3 digits)`);\n\n  // N\u1EBFu c\u00F3 t\u00EAn district, th\u1EED tra c\u1EE9u\n  if (districtName && districtName.trim()) {\n    console.log(`[Helpers] \uD83D\uDD04 Attempting lookup by name: \"${districtName}\"`);\n    const lookedUpCode = await lookupDistrictCode(env, provinceCode, districtName);\n    \n    if (lookedUpCode) {\n      console.log(`[Helpers] \u2705 Auto-corrected: \"${code}\" \u2192 \"${lookedUpCode}\" (via name lookup)`);\n      return lookedUpCode;\n    }\n  }\n\n  // Kh\u00F4ng t\u00ECm \u0111\u01B0\u1EE3c, tr\u1EA3 v\u1EC1 code g\u1ED1c v\u00E0 log c\u1EA3nh b\u00E1o\n  console.error(`[Helpers] \u274C Cannot validate district_code: \"${code}\", keeping original value`);\n  return code;\n}\n\n/**\n * Tra c\u1EE9u m\u00E3 commune/ward chu\u1EA9n t\u1EEB SuperAI API\n * @param {Object} env - Cloudflare Workers environment\n * @param {string} districtCode - M\u00E3 qu\u1EADn/huy\u1EC7n\n * @param {string} communeName - T\u00EAn ph\u01B0\u1EDDng/x\u00E3\n * @returns {Promise<string|null>} - M\u00E3 commune chu\u1EA9n ho\u1EB7c null\n */\nexport async function lookupCommuneCode(env, districtCode, communeName) {\n  try {\n    if (!districtCode || !communeName) {\n      return null;\n    }\n\n    console.log(`[Helpers] \uD83D\uDD0D Looking up commune: \"${communeName}\" in district: ${districtCode}`);\n\n    const base = 'https://api.superai.vn'; // S\u1EECA: dev -> api\n    const token = await superToken(env);\n    \n    const url = `${base}/v1/platform/areas/commune?district=${districtCode}`;\n    \n    const response = await fetch(url, {\n      method: 'GET',\n      headers: {\n        'Accept': 'application/json',\n        'Token': token\n      }\n    });\n\n    if (!response.ok) {\n      console.error('[Helpers] Commune API error:', response.status);\n      return null;\n    }\n\n    const data = await response.json();\n    \n    if (!data?.data || !Array.isArray(data.data)) {\n      return null;\n    }\n\n    const normalizedName = communeName.trim().toLowerCase()\n      .replace(/^ph\u01B0\u1EDDng\\s+/gi, '')\n      .replace(/^x\u00E3\\s+/gi, '')\n      .replace(/^th\u1ECB\\s+tr\u1EA5n\\s+/gi, '')\n      .trim();\n\n    const commune = data.data.find(c => {\n      const cName = (c.name || '').toLowerCase()\n        .replace(/^ph\u01B0\u1EDDng\\s+/gi, '')\n        .replace(/^x\u00E3\\s+/gi, '')\n        .replace(/^th\u1ECB\\s+tr\u1EA5n\\s+/gi, '')\n        .trim();\n      \n      return cName === normalizedName || \n             cName.includes(normalizedName) || \n             normalizedName.includes(cName);\n    });\n\n    if (commune && commune.code) {\n      console.log(`[Helpers] \u2705 Found commune: \"${commune.name}\" \u2192 code: ${commune.code}`);\n      return String(commune.code);\n    }\n\n    return null;\n\n  } catch (error) {\n    console.error('[Helpers] lookupCommuneCode error:', error);\n    return null;\n  }\n}\n/**\n * Calculate chargeable weight (volumetric)\n */\nexport function chargeableWeightGrams(body = {}, order = {}) {\n  let weight = Number(order.weight_gram || body.weight_gram || body.package?.weight_grams || 0) || 0;\n\n  // Sum from items if not provided\n  const items = Array.isArray(body.items) ? body.items : \n               (Array.isArray(order.items) ? order.items : []);\n\n  if (!weight && items.length) {\n    try {\n      weight = items.reduce((sum, item) => {\n        const w = Number(item.weight_gram || item.weight_grams || item.weight || 0);\n        const qty = Number(item.qty || item.quantity || 1);\n        return sum + w * qty;\n      }, 0);\n    } catch (e) {\n      console.error('Weight calculation error:', e);\n    }\n  }\n\n  // Volumetric weight: (L*W*H)/5000 kg -> grams\n  try {\n    const dim = body.package?.dim_cm || body.dim_cm || body.package?.dimensions || {};\n    const L = Number(dim.l || dim.length || 0);\n    const W = Number(dim.w || dim.width || 0);\n    const H = Number(dim.h || dim.height || 0);\n\n    if (L > 0 && W > 0 && H > 0) {\n      const volumetric = Math.round((L * W * H) / 5000 * 1000);\n      if (volumetric > weight) weight = volumetric;\n    }\n  } catch (e) {\n    console.error('Volumetric calculation error:', e);\n  }\n\n  return Math.max(0, Math.round(weight));\n}\n", "export async function readBody(req) {\n  try {\n    const contentType = req.headers.get('content-type') || '';\n    \n    if (contentType.includes('application/json')) {\n      return await req.json();\n    }\n    \n    const text = await req.text();\n    \n    // Try parse as JSON\n    try {\n      return JSON.parse(text);\n    } catch {\n      return { raw: text };\n    }\n  } catch (e) {\n    console.error('readBody error:', e);\n    return {};\n  }\n}\n\nexport function slugify(text) {\n  return String(text || '')\n    .toLowerCase()\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')  // Remove Vietnamese diacritics\n    .replace(/\u0111/g, 'd')                // Handle \u0111 separately\n    .replace(/[^a-z0-9]+/g, '-')       // Replace non-alphanumeric with dash\n    .replace(/(^-|-$)/g, '');          // Remove leading/trailing dashes\n}\n\nexport function sanitizePhone(phone) {\n  // Remove all non-digit characters\n  return String(phone || '').replace(/\\D+/g, '');\n}\n\n// --- cookie utils ---\nexport function parseCookie(str = '') {\n  const out = {};\n  if (!str) return out;\n  str.split(/; */).forEach((pair) => {\n    if (!pair) return;\n    const idx = pair.indexOf('=');\n    const key = idx >= 0 ? pair.slice(0, idx) : pair;\n    const val = idx >= 0 ? pair.slice(idx + 1) : '';\n    out[decodeURIComponent(key.trim())] = decodeURIComponent((val || '').trim());\n  });\n  return out;\n}", "// ===================================================================\n// lib/auth.js - Authentication Helper (FIXED - Compatible with both systems)\n// ===================================================================\nimport { superToken } from '../modules/shipping/helpers.js';\nimport { parseCookie } from './utils'; // th\u00EAm d\u00F2ng n\u00E0y n\u1EBFu CH\u01AFA c\u00F3\n\n\nexport async function sha256Hex(text) {\n  const data = await crypto.subtle.digest(\n    'SHA-256',\n    new TextEncoder().encode(String(text || ''))\n  );\n  return [...new Uint8Array(data)]\n    .map(b => b.toString(16).padStart(2, '0'))\n    .join('');\n}\n\n/**\n * Check admin authentication\n * Compatible with BOTH old system and new admin system\n */\nexport async function adminOK(req, env) {\n  try {\n\t   // === DEBUG AUTH START ===\n  try {\n    const u = new URL(req.url);\n    const qToken = u.searchParams.get('token') || '';\n    const hAuth  = req.headers.get('authorization') || '';\n    const hXTok  = req.headers.get('x-token') || '';\n    const cookie = req.headers.get('cookie') || '';\n\n    console.log('[Auth][in]', {\n      path: u.pathname,\n      qToken_len: qToken.length,\n      hasAuthHdr: !!hAuth,\n      hasXToken: !!hXTok,\n      hasCookie: !!cookie\n    });\n  } catch (e) {\n    console.log('[Auth][in] parse error', e?.message || e);\n  }\n  // === DEBUG AUTH END ===\n    const url = new URL(req.url);\n    \n    // \u01AFu ti\u00EAn x-token (t\u1EEB FE), sau \u0111\u00F3 Token, Bearer, query ?token, cookie\n    let token =\n      req.headers.get('x-token') ||\n      req.headers.get('Token') ||\n      ((req.headers.get('authorization') || '').match(/^Bearer\\s+(.+)$/i)?.[1]) ||\n      url.searchParams.get('token') ||\n      parseCookie(req.headers.get('cookie') || '')['x-token'] ||\n      parseCookie(req.headers.get('cookie') || '')['token'] ||\n      '';\n    \n    token = String(token || '').trim().replace(/^\"+|\"+$/g, '');\n    \n    console.log('[Auth] Incoming token length:', token ? token.length : 0);\n    \n    if (!token) {\n      console.log('[Auth] No token provided');\n      return false;\n    }\n\n    // ===== NEW ADMIN SYSTEM CHECK =====\n    // Try to decode as new admin token format (base64 encoded)\n    try {\n      const decoded = atob(token);\n      if (decoded.includes(':')) {\n        // New format: adminId:timestamp\n        const adminId = decoded.split(':')[0];\n        \n        // Check if admin exists in new system\n        const adminData = await env.SHV.get(`admin:${adminId}`);\n        if (adminData) {\n          const admin = JSON.parse(adminData);\n          \n          // Check if admin is active\n          if (admin.status === 'active') {\n            console.log('[Auth] Valid new admin token:', admin.email);\n            return true;\n          } else {\n            console.log('[Auth] Admin account inactive');\n            return false;\n          }\n        }\n      }\n    } catch (e) {\n      // Not new format, continue to old checks\n    }\n\n    // ===== OLD SYSTEM CHECKS =====\n    \n    // Check 1: KV-stored session token (old auth module)\n    if (env?.SHV?.get) {\n      const saved = await env.SHV.get('admin_token');\n      if (saved && token === saved) {\n        console.log('[Auth] Valid old session token');\n        return true;\n      }\n    }\n    \n    // Check 2: Static ADMIN_TOKEN from env\n    if (env?.ADMIN_TOKEN) {\n      const expected = await sha256Hex(env.ADMIN_TOKEN);\n      if (token === expected) {\n        console.log('[Auth] Valid static admin token');\n        return true;\n      }\n    }\n    \n    // ===== STATIC SUPER KEY (t\u00EDch h\u1EE3p v\u1EADn chuy\u1EC3n) qua helpers.superToken =====\ntry {\n  const superKey = (await superToken(env)).trim();\n  if (token && token === superKey) {\n    console.log('[Auth] Valid SUPER_KEY via superToken');\n    return true;\n  }\n} catch (e) {\n  // fallback im l\u1EB7ng n\u1EBFu c\u00F3 l\u1ED7i khi \u0111\u1ECDc superToken\n}\n    console.log('[Auth] Token validation failed');\n    return false;\n    \n  } catch (e) {\n    console.error('[Auth] adminOK error:', e);\n    return false;\n  }\n}", "// ===================================================================\n// modules/categories.js - Example module \u0111\u1EA7u ti\u00EAn \u0111\u1EC3 h\u1ECDc c\u00E1ch refactor\n// ===================================================================\n\nimport { json } from '../lib/response.js';\nimport { adminOK } from '../lib/auth.js';\nimport { getJSON, putJSON } from '../lib/kv.js';\nimport { readBody } from '../lib/utils.js';\n\n/**\n * Main handler cho t\u1EA5t c\u1EA3 /categories routes\n */\nexport async function handle(req, env, ctx) {\n  const url = new URL(req.url);\n  const path = url.pathname;\n  const method = req.method;\n\n  // Admin: List categories\n  if (path === '/admin/categories' && method === 'GET') {\n    return listCategories(req, env);\n  }\n\n  // Admin: Upsert category\n  if (path === '/admin/categories/upsert' && method === 'POST') {\n    return upsertCategory(req, env);\n  }\n\n  // Admin: Delete category\n  if (path === '/admin/categories/delete' && method === 'POST') {\n    return deleteCategory(req, env);\n  }\n\n  // Public: List categories (sorted by order)\n  if (path === '/public/categories' && method === 'GET') {\n    return publicCategories(req, env);\n  }\n\n  // Route not found\n  return json({ \n    ok: false, \n    error: 'Route not found' \n  }, { status: 404 }, req);\n}\n\n/**\n * Admin: Get all categories (unsorted)\n */\nasync function listCategories(req, env) {\n  if (!(await adminOK(req, env))) { return json({ ok: false, error: 'Unauthorized' }, { status: 401 }, req); }\n    try {\n    const list = await getJSON(env, 'cats:list', []);\n    return json({ ok: true, items: list }, {}, req);\n  } catch (e) {\n    return json({ \n      ok: false, \n      error: String(e.message) \n    }, { status: 500 }, req);\n  }\n}\n\n/**\n * Admin: Create or update category\n */\nasync function upsertCategory(req, env) {\n  // Auth check\n  if (!(await adminOK(req, env))) {\n    return json({ \n      ok: false, \n      error: 'Unauthorized' \n    }, { status: 401 }, req);\n  }\n\n  try {\n    const body = await readBody(req) || {};\n    \n    // Build category object\n    const category = {\n      id: body.id || crypto.randomUUID(),\n      name: body.name || '',\n      slug: body.slug || slugify(body.name || ''),\n      parent: body.parent || '',\n      order: Number(body.order || 0)\n    };\n\n    // Validation\n    if (!category.name) {\n      return json({ \n        ok: false, \n        error: 'Name is required' \n      }, { status: 400 }, req);\n    }\n\n    // Get existing list\n    const list = await getJSON(env, 'cats:list', []);\n    \n    // Find existing category\n    const index = list.findIndex(x => x.id === category.id);\n    \n    if (index >= 0) {\n      // Update existing\n      list[index] = category;\n    } else {\n      // Add new\n      list.push(category);\n    }\n\n    // Save to KV\n    await putJSON(env, 'cats:list', list);\n\n    return json({ \n      ok: true, \n      item: category \n    }, {}, req);\n\n  } catch (e) {\n    return json({ \n      ok: false, \n      error: String(e.message) \n    }, { status: 500 }, req);\n  }\n}\n\n/**\n * Admin: Delete category by ID\n */\nasync function deleteCategory(req, env) {\n  // Auth check\n  if (!(await adminOK(req, env))) {\n    return json({ \n      ok: false, \n      error: 'Unauthorized' \n    }, { status: 401 }, req);\n  }\n\n  try {\n    const body = await readBody(req) || {};\n    const id = body.id;\n\n    if (!id) {\n      return json({ \n        ok: false, \n        error: 'ID is required' \n      }, { status: 400 }, req);\n    }\n\n    // Get existing list\n    const list = await getJSON(env, 'cats:list', []);\n    \n    // Filter out deleted category\n    const newList = list.filter(x => x.id !== id);\n\n    // Save to KV\n    await putJSON(env, 'cats:list', newList);\n\n    return json({ \n      ok: true, \n      deleted: id \n    }, {}, req);\n\n  } catch (e) {\n    return json({ \n      ok: false, \n      error: String(e.message) \n    }, { status: 500 }, req);\n  }\n}\n\n/**\n * Public: Get categories sorted by order\n */\nasync function publicCategories(req, env) {\n  try {\n    const list = await getJSON(env, 'cats:list', []);\n    \n    // Sort by order field\n    const sorted = list.sort((a, b) => \n      Number(a.order || 0) - Number(b.order || 0)\n    );\n\n    return json({ \n      ok: true, \n      items: sorted \n    }, {}, req);\n\n  } catch (e) {\n    return json({ \n      ok: false, \n      error: String(e.message) \n    }, { status: 500 }, req);\n  }\n}\n\n/**\n * Helper: Convert string to slug\n */\nfunction slugify(text) {\n  return String(text || '')\n    .toLowerCase()\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '') // Remove diacritics\n    .replace(/[^a-z0-9]+/g, '-')     // Replace non-alphanumeric with dash\n    .replace(/(^-|-$)/g, '');        // Remove leading/trailing dashes\n}", "function typeOf(value) {\n  if (value === null) return 'null';\n  if (Array.isArray(value)) return 'array';\n  return typeof value;\n}\n\nexport function validate(schema, data) {\n  const errors = [];\n  \n  function check(s, d, path = '') {\n    if (!s) return;\n    \n    // Type check\n    if (s.type) {\n      const types = Array.isArray(s.type) ? s.type : [s.type];\n      const actualType = typeOf(d);\n      const isValid = types.includes(actualType) || \n                     (types.includes('number') && !isNaN(Number(d)));\n      \n      if (!isValid) {\n        errors.push(`${path || 'data'}: expected ${types.join('|')} but got ${actualType}`);\n        return;\n      }\n    }\n    \n    // Required fields check\n    if (s.required && typeOf(d) === 'object') {\n      for (const key of s.required) {\n        if (!(key in d)) {\n          errors.push(`${path || 'data'}.${key} is required`);\n        }\n      }\n    }\n    \n    // Properties check (nested objects)\n    if (s.properties && typeOf(d) === 'object') {\n      for (const [key, subSchema] of Object.entries(s.properties)) {\n        if (d[key] !== undefined) {\n          check(subSchema, d[key], (path ? path + '.' : '') + key);\n        }\n      }\n    }\n    \n    // Items check (arrays)\n    if (s.items && typeOf(d) === 'array') {\n      d.forEach((item, index) => {\n        check(s.items, item, (path ? path : 'data') + `[${index}]`);\n      });\n    }\n  }\n  \n  check(schema, data, '');\n  \n  return {\n    ok: errors.length === 0,\n    errors\n  };\n}\n\n// Common schemas\nexport const SCH = {\n  address: {\n    type: 'object',\n    required: ['name', 'phone', 'address', 'province_code', 'district_code', 'commune_code']\n  },\n  \n  orderItem: {\n    type: 'object',\n    required: ['name', 'price', 'qty']\n  },\n  \n  orderCreate: {\n    type: 'object',\n    required: ['customer', 'items'],\n    properties: {\n      customer: {\n        type: 'object',\n        required: ['name', 'phone', 'address', 'province_code', 'district_code', 'commune_code']\n      },\n      items: {\n        type: 'array',\n        items: {\n          type: 'object',\n          required: ['name', 'price', 'qty']\n        }\n      },\n      totals: {\n        type: 'object',\n        properties: {\n          shipping_fee: { type: 'number' },\n          discount: { type: 'number' },\n          shipping_discount: { type: 'number' }\n        }\n      }\n    }\n  }\n};\n", "export async function idemGet(req, env) {\n  try {\n    const key = req.headers.get('Idempotency-Key');\n    if (!key) return { key: null, hit: false, body: null };\n    \n    const body = await env.SHV.get('idem:' + key);\n    return { key, hit: !!body, body };\n  } catch (e) {\n    return { key: null, hit: false, body: null };\n  }\n}\n\nexport async function idemSet(key, env, response) {\n  if (!key || !response || !(response instanceof Response)) return;\n  \n  try {\n    const text = await response.clone().text();\n    await env.SHV.put('idem:' + key, text, { \n      expirationTtl: 24 * 3600 // 24 hours\n    });\n  } catch (e) {\n    console.error('idemSet error:', e);\n  }\n}", "// File: workers/shv-api/src/modules/admin.js\n// Admin management module - FIXED\n\nimport { json, corsHeaders } from '../lib/response.js';\n\n/**\n * Main admin handler\n */\nexport async function handle(req, env, ctx) {\n  const url = new URL(req.url);\n  const path = url.pathname;\n  const method = req.method;\n\n  try {\n    // Setup route (only once)\n    if (path === '/admin/setup/init' && method === 'POST') {\n      return await setupSuperAdmin(req, env);\n    }\n\n    // Login routes - H\u1ED7 tr\u1EE3 nhi\u1EC1u endpoint\n    if ((path === '/admin/auth/login' || \n         path === '/admin/login' || \n         path === '/login' || \n         path === '/admin_auth/login') && \n        method === 'POST') {\n      return await handleLogin(req, env);\n    }\n\n    // Get current admin\n    if ((path === '/admin/auth/me' || path === '/admin/me') && method === 'GET') {\n      return await handleMe(req, env);\n    }\n\n    // List admins\n    if (path === '/admin/users/list' && method === 'GET') {\n      return await listAdmins(req, env);\n    }\n\n    // Create admin\n    if (path === '/admin/users/create' && method === 'POST') {\n      return await createAdmin(req, env);\n    }\n\n    // Get/Update/Delete admin by ID\n    const userMatch = path.match(/^\\/admin\\/users\\/([^\\/]+)$/);\n    if (userMatch) {\n      const adminId = userMatch[1];\n      \n      if (method === 'GET') {\n        return await getAdmin(req, env, adminId);\n      }\n      if (method === 'PUT') {\n        return await updateAdmin(req, env, adminId);\n      }\n      if (method === 'DELETE') {\n        return await deleteAdmin(req, env, adminId);\n      }\n    }\n\n    // List roles\n    if (path === '/admin/roles/list' && method === 'GET') {\n      return await listRoles(req, env);\n    }\n\n    // Create role\n    if (path === '/admin/roles/create' && method === 'POST') {\n      return await createRole(req, env);\n    }\n\n    // Get/Update/Delete role by ID\n    const roleMatch = path.match(/^\\/admin\\/roles\\/([^\\/]+)$/);\n    if (roleMatch) {\n      const roleId = roleMatch[1];\n      \n      if (method === 'GET') {\n        return await getRole(req, env, roleId);\n      }\n      if (method === 'PUT') {\n        return await updateRole(req, env, roleId);\n      }\n      if (method === 'DELETE') {\n        return await deleteRole(req, env, roleId);\n      }\n    }\n\t// List customers\nif (path === '/admin/customers/list' && method === 'GET') {\n  return await listCustomers(req, env);\n}\n\n// Create customer (admin t\u1EA1o)\nif (path === '/admin/customers/create' && method === 'POST') {\n  return await createCustomer(req, env);\n}\n\n// Get/Update/Delete customer by ID\nconst customerMatch = path.match(/^\\/admin\\/customers\\/([^\\/]+)$/);\nif (customerMatch) {\n  const customerId = customerMatch[1];\n  \n  if (method === 'GET') {\n    return await getCustomer(req, env, customerId);\n  }\n  if (method === 'PUT') {\n    return await updateCustomer(req, env, customerId);\n  }\n  if (method === 'DELETE') {\n    return await deleteCustomer(req, env, customerId);\n  }\n}\n\n// PUBLIC API - Customer register (t\u1EEB FE)\nif (path === '/api/customers/register' && method === 'POST') {\n  return await customerRegister(req, env);\n}\n\n// PUBLIC API - Customer login\nif (path === '/api/customers/login' && method === 'POST') {\n  return await customerLogin(req, env);\n}\n\n// PUBLIC API - Get customer info (c\u1EA7n token)\nif (path === '/api/customers/me' && method === 'GET') {\n  return await customerMe(req, env);\n}\n    return json({ ok: false, error: 'Route not found' }, { status: 404 }, req);\n\n  } catch (e) {\n    console.error('[Admin] Error:', e);\n    return json({ \n      ok: false, \n      error: 'Internal error', \n      details: e.message \n    }, { status: 500 }, req);\n  }\n}\n\n/**\n * Setup Super Admin (run once)\n */\nasync function setupSuperAdmin(req, env) {\n  try {\n    const setupToken = req.headers.get('X-Setup-Token');\n    \n    if (setupToken !== 'SETUP_SECRET_123') {\n      return json({ ok: false, error: 'Invalid setup token' }, { status: 403 }, req);\n    }\n\n    // Check if already exists\n    const existing = await env.SHV.get('admin:super_001');\n    if (existing) {\n      return json({\n        ok: false,\n        error: 'Super Admin already exists',\n        message: 'Use: admin@shophuyvan.com / Admin@123'\n      }, { status: 409 }, req);\n    }\n\n    // Create roles\n    const roles = [\n      {\n        id: 'role_super_admin',\n        name: 'Super Admin',\n        description: 'To\u00E0n quy\u1EC1n h\u1EC7 th\u1ED1ng',\n        permissions: ['*'],\n        is_system: true\n      },\n      {\n        id: 'role_manager',\n        name: 'Qu\u1EA3n l\u00FD',\n        description: 'Qu\u1EA3n l\u00FD s\u1EA3n ph\u1EA9m v\u00E0 \u0111\u01A1n h\u00E0ng',\n        permissions: ['dashboard.view', 'products.*', 'orders.*', 'banners.*', 'vouchers.*', 'stats.view'],\n        is_system: true\n      },\n      {\n        id: 'role_staff',\n        name: 'Nh\u00E2n vi\u00EAn',\n        description: 'X\u1EED l\u00FD \u0111\u01A1n h\u00E0ng',\n        permissions: ['dashboard.view', 'products.view', 'products.edit', 'orders.view', 'orders.edit'],\n        is_system: true\n      },\n      {\n        id: 'role_warehouse',\n        name: 'Kho h\u00E0ng',\n        description: 'Qu\u1EA3n l\u00FD kho',\n        permissions: ['dashboard.view', 'products.*', 'orders.view', 'shipping.*'],\n        is_system: true\n      }\n    ];\n\n    const now = new Date().toISOString();\n    for (const role of roles) {\n      role.created_at = now;\n      role.updated_at = now;\n      await env.SHV.put(`admin:role:${role.id}`, JSON.stringify(role));\n    }\n\n    await env.SHV.put('admin:roles:list', JSON.stringify(roles.map(r => r.id)));\n\n    // Create Super Admin\n    // Password: Admin@123\n    // Hash: $2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy\n    const superAdmin = {\n      id: 'admin_super_001',\n      email: 'admin@shophuyvan.com',\n      password_hash: '$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy',\n      full_name: 'Super Admin',\n      phone: '0901234567',\n      avatar: '',\n      role_id: 'role_super_admin',\n      status: 'active',\n      created_at: now,\n      updated_at: now,\n      last_login: null,\n      created_by: 'system'\n    };\n\n    await env.SHV.put(`admin:${superAdmin.id}`, JSON.stringify(superAdmin));\n    await env.SHV.put(`admin:email:${superAdmin.email}`, JSON.stringify(superAdmin));\n    await env.SHV.put('admin:list', JSON.stringify([superAdmin.id]));\n\n    return json({\n      ok: true,\n      message: 'Super Admin created successfully!',\n      credentials: {\n        email: 'admin@shophuyvan.com',\n        password: 'Admin@123'\n      },\n      roles_created: roles.length,\n      login_url: 'https://adminshophuyvan.pages.dev/login.html'\n    }, {}, req);\n\n  } catch (e) {\n    console.error('[Admin] Setup error:', e);\n    return json({ ok: false, error: 'Setup failed', details: e.message }, { status: 500 }, req);\n  }\n}\n\n/**\n * Login handler - T\u01AF\u01A0NG TH\u00CDCH V\u1EDAI H\u1EC6 TH\u1ED0NG C\u0168\n * Accept c\u1EA3 {user, pass} (c\u0169) v\u00E0 {email, password} (m\u1EDBi)\n */\nasync function handleLogin(req, env) {\n  try {\n    const body = await req.json();\n    \n    // Support c\u1EA3 2 format: {user, pass} v\u00E0 {email, password}\n    const username = body.user || body.email;\n    const password = body.pass || body.password;\n\n    if (!username || !password) {\n      return json({ ok: false, error: 'T\u00E0i kho\u1EA3n v\u00E0 m\u1EADt kh\u1EA9u l\u00E0 b\u1EAFt bu\u1ED9c' }, { status: 400 }, req);\n    }\n\n    // T\u00ECm admin - h\u1ED7 tr\u1EE3 c\u1EA3 username v\u00E0 email\n    let adminData = null;\n    let admin = null;\n    \n    // Try t\u00ECm theo email tr\u01B0\u1EDBc\n    const emailKey = `admin:email:${username.toLowerCase()}`;\n    adminData = await env.SHV.get(emailKey);\n    \n    // N\u1EBFu kh\u00F4ng t\u00ECm th\u1EA5y theo email, th\u1EED t\u00ECm theo username/id\n    if (!adminData) {\n      // Th\u1EED t\u00ECm trong list admins\n      const listData = await env.SHV.get('admin:list');\n      const list = listData ? JSON.parse(listData) : [];\n      \n      for (const adminId of list) {\n        const data = await env.SHV.get(`admin:${adminId}`);\n        if (data) {\n          const a = JSON.parse(data);\n          // Check n\u1EBFu username kh\u1EDBp v\u1EDBi email ho\u1EB7c full_name ho\u1EB7c id\n          if (a.email === username.toLowerCase() || \n              a.full_name.toLowerCase() === username.toLowerCase() ||\n              a.id === username ||\n              username === 'admin') { // Support login v\u1EDBi username \"admin\"\n            adminData = data;\n            admin = a;\n            break;\n          }\n        }\n      }\n    } else {\n      admin = JSON.parse(adminData);\n    }\n\n    if (!admin) {\n      return json({ ok: false, error: 'T\u00E0i kho\u1EA3n ho\u1EB7c m\u1EADt kh\u1EA9u kh\u00F4ng \u0111\u00FAng' }, { status: 401 }, req);\n    }\n\n    // Check status\n    if (admin.status !== 'active') {\n      return json({ ok: false, error: 'T\u00E0i kho\u1EA3n \u0111\u00E3 b\u1ECB kh\u00F3a' }, { status: 403 }, req);\n    }\n\n    // ===== FIX: Simple password check (demo only - use bcrypt in production) =====\n    // Accept password \"Admin@123\" ho\u1EB7c password \u0111\u01B0\u1EE3c set\n    const validPassword = password === 'Admin@123' || \n                         password === admin.password_hash ||\n                         btoa(password) === admin.password_hash.replace('$2a$10$', '').slice(0, 53);\n    \n    if (!validPassword) {\n      return json({ ok: false, error: 'T\u00E0i kho\u1EA3n ho\u1EB7c m\u1EADt kh\u1EA9u kh\u00F4ng \u0111\u00FAng' }, { status: 401 }, req);\n    }\n\n    // Get role\n    const roleData = await env.SHV.get(`admin:role:${admin.role_id}`);\n    const role = roleData ? JSON.parse(roleData) : null;\n\n    // Update last login\n    admin.last_login = new Date().toISOString();\n    await env.SHV.put(`admin:${admin.id}`, JSON.stringify(admin));\n    await env.SHV.put(`admin:email:${admin.email}`, JSON.stringify(admin));\n\n    // Generate simple token\n    const token = btoa(`${admin.id}:${Date.now()}`);\n\n    const { password_hash, ...safeAdmin } = admin;\n\n    // QUAN TR\u1ECCNG: Return format t\u01B0\u01A1ng th\u00EDch v\u1EDBi admin_real.js\n    return json({\n      ok: true,\n      token: token,           // Format m\u1EDBi\n      'x-token': token,       // Format c\u0169 (admin_real.js expect)\n      admin: {\n        ...safeAdmin,\n        role: role,\n        permissions: role?.permissions || []\n      }\n    }, {}, req);\n\n  } catch (e) {\n    console.error('[Admin] Login error:', e);\n    return json({ ok: false, error: 'L\u1ED7i \u0111\u0103ng nh\u1EADp: ' + e.message }, { status: 500 }, req);\n  }\n}\n\n/**\n * Get current admin info - T\u01AF\u01A0NG TH\u00CDCH V\u1EDAI x-token HEADER\n */\nasync function handleMe(req, env) {\n  try {\n    // Support c\u1EA3 Authorization Bearer v\u00E0 x-token header\n    let token = null;\n    \n    const authHeader = req.headers.get('Authorization');\n    if (authHeader && authHeader.startsWith('Bearer ')) {\n      token = authHeader.substring(7);\n    }\n    \n    // Fallback: check x-token header (admin_real.js d\u00F9ng)\n    if (!token) {\n      token = req.headers.get('x-token');\n    }\n    \n    if (!token) {\n      return json({ ok: false, error: 'Unauthorized' }, { status: 401 }, req);\n    }\n\n    const decoded = atob(token);\n    const adminId = decoded.split(':')[0];\n\n    const adminData = await env.SHV.get(`admin:${adminId}`);\n    if (!adminData) {\n      return json({ ok: false, error: 'Admin not found' }, { status: 404 }, req);\n    }\n\n    const admin = JSON.parse(adminData);\n    const { password_hash, ...safeAdmin } = admin;\n\n    const roleData = await env.SHV.get(`admin:role:${admin.role_id}`);\n    const role = roleData ? JSON.parse(roleData) : null;\n\n    return json({\n      ok: true,\n      admin: {\n        ...safeAdmin,\n        role: role,\n        permissions: role?.permissions || []\n      }\n    }, {}, req);\n\n  } catch (e) {\n    console.error('[Admin] Me error:', e);\n    return json({ ok: false, error: 'Invalid token' }, { status: 401 }, req);\n  }\n}\n\n/**\n * List all admins\n */\nasync function listAdmins(req, env) {\n  try {\n    const listData = await env.SHV.get('admin:list');\n    const list = listData ? JSON.parse(listData) : [];\n\n    const admins = [];\n    for (const adminId of list) {\n      const adminData = await env.SHV.get(`admin:${adminId}`);\n      if (adminData) {\n        const admin = JSON.parse(adminData);\n        const { password_hash, ...safeAdmin } = admin;\n\n        const roleData = await env.SHV.get(`admin:role:${admin.role_id}`);\n        const role = roleData ? JSON.parse(roleData) : null;\n\n        admins.push({\n          ...safeAdmin,\n          role_name: role?.name || 'Unknown'\n        });\n      }\n    }\n\n    return json({ ok: true, admins, total: admins.length }, {}, req);\n\n  } catch (e) {\n    console.error('[Admin] List error:', e);\n    return json({ ok: false, error: 'Failed to list admins' }, { status: 500 }, req);\n  }\n}\n\n/**\n * Create new admin\n */\nasync function createAdmin(req, env) {\n  try {\n    const body = await req.json();\n    const { email, password, full_name, phone, role_id } = body;\n\n    if (!email || !password || !full_name || !role_id) {\n      return json({ ok: false, error: 'Missing required fields' }, { status: 400 }, req);\n    }\n\n    // Check if email exists\n    const emailKey = `admin:email:${email.toLowerCase()}`;\n    const existing = await env.SHV.get(emailKey);\n    if (existing) {\n      return json({ ok: false, error: 'Email already exists' }, { status: 409 }, req);\n    }\n\n    const adminId = 'admin_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9);\n    const now = new Date().toISOString();\n\n    // Simple hash (use bcrypt in production)\n    const password_hash = '$2a$10$' + btoa(password).slice(0, 53);\n\n    const newAdmin = {\n      id: adminId,\n      email: email.toLowerCase(),\n      password_hash,\n      full_name,\n      phone: phone || '',\n      avatar: '',\n      role_id,\n      status: 'active',\n      created_at: now,\n      updated_at: now,\n      last_login: null,\n      created_by: 'admin'\n    };\n\n    await env.SHV.put(`admin:${adminId}`, JSON.stringify(newAdmin));\n    await env.SHV.put(emailKey, JSON.stringify(newAdmin));\n\n    const listData = await env.SHV.get('admin:list');\n    const list = listData ? JSON.parse(listData) : [];\n    list.push(adminId);\n    await env.SHV.put('admin:list', JSON.stringify(list));\n\n    const { password_hash: _, ...safeAdmin } = newAdmin;\n\n    return json({ ok: true, admin: safeAdmin }, {}, req);\n\n  } catch (e) {\n    console.error('[Admin] Create error:', e);\n    return json({ ok: false, error: 'Failed to create admin' }, { status: 500 }, req);\n  }\n}\n\n/**\n * Get admin by ID\n */\nasync function getAdmin(req, env, adminId) {\n  try {\n    const adminData = await env.SHV.get(`admin:${adminId}`);\n    if (!adminData) {\n      return json({ ok: false, error: 'Admin not found' }, { status: 404 }, req);\n    }\n\n    const admin = JSON.parse(adminData);\n    const { password_hash, ...safeAdmin } = admin;\n\n    return json({ ok: true, admin: safeAdmin }, {}, req);\n\n  } catch (e) {\n    console.error('[Admin] Get error:', e);\n    return json({ ok: false, error: 'Failed to get admin' }, { status: 500 }, req);\n  }\n}\n\n/**\n * Update admin\n */\nasync function updateAdmin(req, env, adminId) {\n  try {\n    const adminData = await env.SHV.get(`admin:${adminId}`);\n    if (!adminData) {\n      return json({ ok: false, error: 'Admin not found' }, { status: 404 }, req);\n    }\n\n    const admin = JSON.parse(adminData);\n    const body = await req.json();\n\n    if (body.full_name) admin.full_name = body.full_name;\n    if (body.phone) admin.phone = body.phone;\n    if (body.avatar) admin.avatar = body.avatar;\n    if (body.status) admin.status = body.status;\n    if (body.role_id) admin.role_id = body.role_id;\n\n    if (body.password) {\n      admin.password_hash = '$2a$10$' + btoa(body.password).slice(0, 53);\n    }\n\n    admin.updated_at = new Date().toISOString();\n\n    await env.SHV.put(`admin:${adminId}`, JSON.stringify(admin));\n    await env.SHV.put(`admin:email:${admin.email}`, JSON.stringify(admin));\n\n    const { password_hash, ...safeAdmin } = admin;\n\n    return json({ ok: true, admin: safeAdmin }, {}, req);\n\n  } catch (e) {\n    console.error('[Admin] Update error:', e);\n    return json({ ok: false, error: 'Failed to update admin' }, { status: 500 }, req);\n  }\n}\n\n/**\n * Delete admin\n */\nasync function deleteAdmin(req, env, adminId) {\n  try {\n    const adminData = await env.SHV.get(`admin:${adminId}`);\n    if (!adminData) {\n      return json({ ok: false, error: 'Admin not found' }, { status: 404 }, req);\n    }\n\n    const admin = JSON.parse(adminData);\n\n    await env.SHV.delete(`admin:${adminId}`);\n    await env.SHV.delete(`admin:email:${admin.email}`);\n\n    const listData = await env.SHV.get('admin:list');\n    const list = listData ? JSON.parse(listData) : [];\n    const newList = list.filter(id => id !== adminId);\n    await env.SHV.put('admin:list', JSON.stringify(newList));\n\n    return json({ ok: true, message: 'Admin deleted' }, {}, req);\n\n  } catch (e) {\n    console.error('[Admin] Delete error:', e);\n    return json({ ok: false, error: 'Failed to delete admin' }, { status: 500 }, req);\n  }\n}\n\n/**\n * List roles\n */\nasync function listRoles(req, env) {\n  try {\n    const listData = await env.SHV.get('admin:roles:list');\n    const roleIds = listData ? JSON.parse(listData) : [];\n\n    const roles = [];\n    for (const id of roleIds) {\n      const roleData = await env.SHV.get(`admin:role:${id}`);\n      if (roleData) {\n        roles.push(JSON.parse(roleData));\n      }\n    }\n\n    return json({ ok: true, roles }, {}, req);\n\n  } catch (e) {\n    console.error('[Admin] List roles error:', e);\n    return json({ ok: false, error: 'Failed to list roles' }, { status: 500 }, req);\n  }\n}\n\n/**\n * Create role\n */\nasync function createRole(req, env) {\n  try {\n    const body = await req.json();\n    const { name, description, permissions, is_system } = body;\n\n    if (!name || !permissions || !Array.isArray(permissions)) {\n      return json({ ok: false, error: 'Invalid data' }, { status: 400 }, req);\n    }\n\n    const roleId = 'role_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9);\n    const now = new Date().toISOString();\n\n    const role = {\n      id: roleId,\n      name,\n      description: description || '',\n      permissions,\n      is_system: is_system || false,\n      created_at: now,\n      updated_at: now\n    };\n\n    await env.SHV.put(`admin:role:${roleId}`, JSON.stringify(role));\n\n    const listData = await env.SHV.get('admin:roles:list');\n    const list = listData ? JSON.parse(listData) : [];\n    list.push(roleId);\n    await env.SHV.put('admin:roles:list', JSON.stringify(list));\n\n    return json({ ok: true, role }, {}, req);\n\n  } catch (e) {\n    console.error('[Admin] Create role error:', e);\n    return json({ ok: false, error: 'Failed to create role' }, { status: 500 }, req);\n  }\n}\n\n/**\n * Get role by ID\n */\nasync function getRole(req, env, roleId) {\n  try {\n    const roleData = await env.SHV.get(`admin:role:${roleId}`);\n    if (!roleData) {\n      return json({ ok: false, error: 'Role not found' }, { status: 404 }, req);\n    }\n\n    return json({ ok: true, role: JSON.parse(roleData) }, {}, req);\n\n  } catch (e) {\n    console.error('[Admin] Get role error:', e);\n    return json({ ok: false, error: 'Failed to get role' }, { status: 500 }, req);\n  }\n}\n\n/**\n * Update role\n */\nasync function updateRole(req, env, roleId) {\n  try {\n    const roleData = await env.SHV.get(`admin:role:${roleId}`);\n    if (!roleData) {\n      return json({ ok: false, error: 'Role not found' }, { status: 404 }, req);\n    }\n\n    const role = JSON.parse(roleData);\n    const body = await req.json();\n\n    if (body.name) role.name = body.name;\n    if (body.description !== undefined) role.description = body.description;\n    if (body.permissions) role.permissions = body.permissions;\n    if (body.is_system !== undefined) role.is_system = body.is_system;\n\n    role.updated_at = new Date().toISOString();\n\n    await env.SHV.put(`admin:role:${roleId}`, JSON.stringify(role));\n\n    return json({ ok: true, role }, {}, req);\n\n  } catch (e) {\n    console.error('[Admin] Update role error:', e);\n    return json({ ok: false, error: 'Failed to update role' }, { status: 500 }, req);\n  }\n}\n\n/**\n * Delete role\n */\nasync function deleteRole(req, env, roleId) {\n  try {\n    const roleData = await env.SHV.get(`admin:role:${roleId}`);\n    if (!roleData) {\n      return json({ ok: false, error: 'Role not found' }, { status: 404 }, req);\n    }\n\n    const role = JSON.parse(roleData);\n    if (role.is_system) {\n      return json({ ok: false, error: 'Cannot delete system role' }, { status: 400 }, req);\n    }\n\n    await env.SHV.delete(`admin:role:${roleId}`);\n\n    const listData = await env.SHV.get('admin:roles:list');\n    const list = listData ? JSON.parse(listData) : [];\n    const newList = list.filter(id => id !== roleId);\n    await env.SHV.put('admin:roles:list', JSON.stringify(newList));\n\n    return json({ ok: true, message: 'Role deleted' }, {}, req);\n\n  } catch (e) {\n    console.error('[Admin] Delete role error:', e);\n    return json({ ok: false, error: 'Failed to delete role' }, { status: 500 }, req);\n  }\n}\n// ===================================================================\n// CUSTOMERS MANAGEMENT FUNCTIONS\n// Ch\u00E8n v\u00E0o CU\u1ED0I FILE admin.js (sau h\u00E0m deleteRole)\n// ===================================================================\n\n/**\n * List all customers\n */\nasync function listCustomers(req, env) {\n  try {\n    const listData = await env.SHV.get('customer:list');\n    const list = listData ? JSON.parse(listData) : [];\n\n    const customers = [];\n    for (const customerId of list) {\n      const customerData = await env.SHV.get(`customer:${customerId}`);\n      if (customerData) {\n        const customer = JSON.parse(customerData);\n        const { password_hash, ...safeCustomer } = customer;\n        customers.push(safeCustomer);\n      }\n    }\n\n    return json({ ok: true, customers, total: customers.length }, {}, req);\n\n  } catch (e) {\n    console.error('[Customers] List error:', e);\n    return json({ ok: false, error: 'Failed to list customers' }, { status: 500 }, req);\n  }\n}\n\n/**\n * Create customer (Admin t\u1EA1o)\n */\nasync function createCustomer(req, env) {\n  try {\n    const body = await req.json();\n    const { email, password, full_name, phone, customer_type, tier, points } = body; // \u2705 TH\u00CAM tier\n\n    if (!email || !password || !full_name) {\n      return json({ ok: false, error: 'Email, password v\u00E0 h\u1ECD t\u00EAn l\u00E0 b\u1EAFt bu\u1ED9c' }, { status: 400 }, req);\n    }\n\n    // Check email exists\n    const emailKey = `customer:email:${email.toLowerCase()}`;\n    const existing = await env.SHV.get(emailKey);\n    if (existing) {\n      return json({ ok: false, error: 'Email \u0111\u00E3 t\u1ED3n t\u1EA1i' }, { status: 409 }, req);\n    }\n\n    const customerId = 'cust_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9);\n    const now = new Date().toISOString();\n\n    const password_hash = '$2a$10$' + btoa(password).slice(0, 53);\n\n    const newCustomer = {\n      id: customerId,\n      email: email.toLowerCase(),\n      password_hash,\n      full_name,\n      phone: phone || '',\n      customer_type: customer_type || 'retail',\n      points: points || 0,\n      tier: tier || calculateTier(points || 0), // \u2705 \u01AFu ti\u00EAn tier t\u1EEB body, fallback t\u00EDnh theo points\n      status: 'active',\n      created_at: now,\n      updated_at: now,\n      last_login: null,\n      created_by: 'admin'\n    };\n\n    await env.SHV.put(`customer:${customerId}`, JSON.stringify(newCustomer));\n    await env.SHV.put(emailKey, JSON.stringify(newCustomer));\n\n    const listData = await env.SHV.get('customer:list');\n    const list = listData ? JSON.parse(listData) : [];\n    list.push(customerId);\n    await env.SHV.put('customer:list', JSON.stringify(list));\n\n    const { password_hash: _, ...safeCustomer } = newCustomer;\n\n    return json({ ok: true, customer: safeCustomer }, {}, req);\n\n  } catch (e) {\n    console.error('[Customers] Create error:', e);\n    return json({ ok: false, error: 'Failed to create customer' }, { status: 500 }, req);\n  }\n}\n\n/**\n * Get customer by ID\n */\nasync function getCustomer(req, env, customerId) {\n  try {\n    const customerData = await env.SHV.get(`customer:${customerId}`);\n    if (!customerData) {\n      return json({ ok: false, error: 'Customer not found' }, { status: 404 }, req);\n    }\n\n    const customer = JSON.parse(customerData);\n    const { password_hash, ...safeCustomer } = customer;\n\n    return json({ ok: true, customer: safeCustomer }, {}, req);\n\n  } catch (e) {\n    console.error('[Customers] Get error:', e);\n    return json({ ok: false, error: 'Failed to get customer' }, { status: 500 }, req);\n  }\n}\n\n/**\n * Update customer\n */\nasync function updateCustomer(req, env, customerId) {\n  try {\n    const customerData = await env.SHV.get(`customer:${customerId}`);\n    if (!customerData) {\n      return json({ ok: false, error: 'Customer not found' }, { status: 404 }, req);\n    }\n\n    const customer = JSON.parse(customerData);\n    const body = await req.json();\n\n    if (body.full_name) customer.full_name = body.full_name;\n    if (body.phone) customer.phone = body.phone;\n    if (body.customer_type) customer.customer_type = body.customer_type;\n    if (body.tier) customer.tier = body.tier; // \u2705 TH\u00CAM\n    if (body.points !== undefined) {\n      customer.points = body.points;\n      // T\u1EF1 \u0111\u1ED9ng t\u00EDnh l\u1EA1i tier n\u1EBFu kh\u00F4ng g\u1EEDi tier th\u1EE7 c\u00F4ng\n      if (!body.tier) customer.tier = calculateTier(body.points);\n    }\n    if (body.status) customer.status = body.status;\n\n    if (body.password) {\n      customer.password_hash = '$2a$10$' + btoa(body.password).slice(0, 53);\n    }\n\n    customer.updated_at = new Date().toISOString();\n\n    await env.SHV.put(`customer:${customerId}`, JSON.stringify(customer));\n    await env.SHV.put(`customer:email:${customer.email}`, JSON.stringify(customer));\n\n    const { password_hash, ...safeCustomer } = customer;\n\n    return json({ ok: true, customer: safeCustomer }, {}, req);\n\n  } catch (e) {\n    console.error('[Customers] Update error:', e);\n    return json({ ok: false, error: 'Failed to update customer' }, { status: 500 }, req);\n  }\n}\n\n/**\n * Delete customer\n */\nasync function deleteCustomer(req, env, customerId) {\n  try {\n    const customerData = await env.SHV.get(`customer:${customerId}`);\n    if (!customerData) {\n      return json({ ok: false, error: 'Customer not found' }, { status: 404 }, req);\n    }\n\n    const customer = JSON.parse(customerData);\n\n    await env.SHV.delete(`customer:${customerId}`);\n    await env.SHV.delete(`customer:email:${customer.email}`);\n\n    const listData = await env.SHV.get('customer:list');\n    const list = listData ? JSON.parse(listData) : [];\n    const newList = list.filter(id => id !== customerId);\n    await env.SHV.put('customer:list', JSON.stringify(newList));\n\n    return json({ ok: true, message: 'Customer deleted' }, {}, req);\n\n  } catch (e) {\n    console.error('[Customers] Delete error:', e);\n    return json({ ok: false, error: 'Failed to delete customer' }, { status: 500 }, req);\n  }\n}\n\n/**\n * Customer Register (PUBLIC API)\n */\nasync function customerRegister(req, env) {\n  try {\n    const body = await req.json();\n    const { email, password, full_name, phone } = body;\n\n    if (!email || !password || !full_name) {\n      return json({ ok: false, error: 'Vui l\u00F2ng \u0111i\u1EC1n \u0111\u1EA7y \u0111\u1EE7 th\u00F4ng tin' }, { status: 400 }, req);\n    }\n\n    // Check email exists\n    const emailKey = `customer:email:${email.toLowerCase()}`;\n    const existing = await env.SHV.get(emailKey);\n    if (existing) {\n      return json({ ok: false, error: 'Email \u0111\u00E3 \u0111\u01B0\u1EE3c \u0111\u0103ng k\u00FD' }, { status: 409 }, req);\n    }\n\n    const customerId = 'cust_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9);\n    const now = new Date().toISOString();\n\n    const password_hash = '$2a$10$' + btoa(password).slice(0, 53);\n\n    const newCustomer = {\n      id: customerId,\n      email: email.toLowerCase(),\n      password_hash,\n      full_name,\n      phone: phone || '',\n      customer_type: 'retail', // M\u1EB7c \u0111\u1ECBnh l\u00E0 kh\u00E1ch l\u1EBB\n      points: 0,\n      tier: 'retail', // \u2705 TH\u00CAM: G\u00E1n tier m\u1EB7c \u0111\u1ECBnh\n      status: 'active',\n      created_at: now,\n      updated_at: now,\n      last_login: null,\n      created_by: 'self'\n    };\n\n    await env.SHV.put(`customer:${customerId}`, JSON.stringify(newCustomer));\n    await env.SHV.put(emailKey, JSON.stringify(newCustomer));\n\n    const listData = await env.SHV.get('customer:list');\n    const list = listData ? JSON.parse(listData) : [];\n    list.push(customerId);\n    await env.SHV.put('customer:list', JSON.stringify(list));\n\n    // Auto login\n    const token = btoa(`${customerId}:${Date.now()}`);\n\n    const { password_hash: _, ...safeCustomer } = newCustomer;\n\n    return json({\n      ok: true,\n      message: '\u0110\u0103ng k\u00FD th\u00E0nh c\u00F4ng!',\n      token,\n      customer: safeCustomer\n    }, {}, req);\n\n  } catch (e) {\n    console.error('[Customers] Register error:', e);\n    return json({ ok: false, error: 'L\u1ED7i \u0111\u0103ng k\u00FD: ' + e.message }, { status: 500 }, req);\n  }\n}\n\n/**\n * Customer Login (PUBLIC API)\n */\nasync function customerLogin(req, env) {\n  try {\n    const body = await req.json();\n    const { email, password } = body;\n\n    if (!email || !password) {\n      return json({ ok: false, error: 'Vui l\u00F2ng nh\u1EADp email v\u00E0 m\u1EADt kh\u1EA9u' }, { status: 400 }, req);\n    }\n\n    const emailKey = `customer:email:${email.toLowerCase()}`;\n    const customerData = await env.SHV.get(emailKey);\n\n    if (!customerData) {\n      return json({ ok: false, error: 'Email ho\u1EB7c m\u1EADt kh\u1EA9u kh\u00F4ng \u0111\u00FAng' }, { status: 401 }, req);\n    }\n\n    const customer = JSON.parse(customerData);\n\n    if (customer.status !== 'active') {\n      return json({ ok: false, error: 'T\u00E0i kho\u1EA3n \u0111\u00E3 b\u1ECB kh\u00F3a' }, { status: 403 }, req);\n    }\n\n    // Simple password check\n    const validPassword = password === customer.password_hash ||\n                         btoa(password) === customer.password_hash.replace('$2a$10$', '').slice(0, 53);\n\n    if (!validPassword) {\n      return json({ ok: false, error: 'Email ho\u1EB7c m\u1EADt kh\u1EA9u kh\u00F4ng \u0111\u00FAng' }, { status: 401 }, req);\n    }\n\n    // Update last login\n    customer.last_login = new Date().toISOString();\n    await env.SHV.put(`customer:${customer.id}`, JSON.stringify(customer));\n    await env.SHV.put(emailKey, JSON.stringify(customer));\n\n    const token = btoa(`${customer.id}:${Date.now()}`);\n\n    const { password_hash, ...safeCustomer } = customer;\n\n    return json({\n      ok: true,\n      message: '\u0110\u0103ng nh\u1EADp th\u00E0nh c\u00F4ng!',\n      token,\n      customer: safeCustomer\n    }, {}, req);\n\n  } catch (e) {\n    console.error('[Customers] Login error:', e);\n    return json({ ok: false, error: 'L\u1ED7i \u0111\u0103ng nh\u1EADp: ' + e.message }, { status: 500 }, req);\n  }\n}\n\n/**\n * Get current customer info (PUBLIC API)\n */\nasync function customerMe(req, env) {\n  try {\n    let token = req.headers.get('Authorization')?.replace('Bearer ', '') ||\n                req.headers.get('x-customer-token') || '';\n\n    if (!token) {\n      return json({ ok: false, error: 'Unauthorized' }, { status: 401 }, req);\n    }\n\n    const decoded = atob(token);\n    const customerId = decoded.split(':')[0];\n\n    const customerData = await env.SHV.get(`customer:${customerId}`);\n    if (!customerData) {\n      return json({ ok: false, error: 'Customer not found' }, { status: 404 }, req);\n    }\n\n    const customer = JSON.parse(customerData);\n    const { password_hash, ...safeCustomer } = customer;\n\n    return json({\n      ok: true,\n      customer: safeCustomer\n    }, {}, req);\n\n  } catch (e) {\n    console.error('[Customers] Me error:', e);\n    return json({ ok: false, error: 'Invalid token' }, { status: 401 }, req);\n  }\n}\n\n// ===================================================================\n// TIER SYSTEM HELPER FUNCTIONS\n// ===================================================================\n\nconst TIER_CONFIG = {\n  retail: {\n    name: 'Th\uFFFDnh vi\uFFFDn thu?ng',\n    icon: '??',\n    min_points: 0,\n    discount: 0,\n    color: '#6b7280'\n  },\n  silver: {\n    name: 'Th\uFFFDnh vi\uFFFDn b?c',\n    icon: '??',\n    min_points: 1000000,\n    discount: 3,\n    color: '#94a3b8'\n  },\n  gold: {\n    name: 'Th\uFFFDnh vi\uFFFDn v\uFFFDng',\n    icon: '??',\n    min_points: 3000000,\n    discount: 5,\n    color: '#fbbf24'\n  },\n  diamond: {\n    name: 'Th\uFFFDnh vi\uFFFDn kim cuong',\n    icon: '??',\n    min_points: 5000000,\n    discount: 8,\n    color: '#06b6d4'\n  }\n};\n\nfunction calculateTier(points) {\n  const p = Number(points || 0);\n  if (p >= TIER_CONFIG.diamond.min_points) return 'diamond';\n  if (p >= TIER_CONFIG.gold.min_points) return 'gold';\n  if (p >= TIER_CONFIG.silver.min_points) return 'silver';\n  return 'retail';\n}\n\nfunction getTierInfo(tier) {\n  return TIER_CONFIG[tier] || TIER_CONFIG.retail;\n}\n\nfunction updateCustomerTier(customer) {\n  const newTier = calculateTier(customer.points);\n  const oldTier = customer.tier || 'retail';\n  \n  if (newTier !== oldTier) {\n    customer.tier = newTier;\n    customer.tier_updated_at = new Date().toISOString();\n    console.log(`[TIER] Customer ${customer.id} upgraded: ${oldTier} \u2192 ${newTier} (points: ${customer.points})`);\n    return true;\n  }\n  return false;\n}\n\nfunction addPoints(customer, points) {\n  const oldTier = customer.tier || 'retail';\n  customer.points = (Number(customer.points || 0) + Number(points || 0));\n  const upgraded = updateCustomerTier(customer);\n  const newTier = customer.tier || 'retail';\n  \n  return { upgraded, oldTier, newTier };\n}\n\nexport {\n  TIER_CONFIG,\n  calculateTier,\n  getTierInfo,\n  updateCustomerTier,\n  addPoints\n};", "// workers/shv-api/src/modules/shipping/waybill-template.js\n// ===================================================================\n// Waybill HTML Template (SPX Format) - UPDATED: Larger Font + Single Row Layout\n// ===================================================================\n\nexport function getWaybillHTML(data) {\n  const {\n    superaiCode,\n    logo,\n    sender,\n    receiver,\n    customer,\n    items,\n    order,\n    createdDate,\n    barcodeSrc,\n    store\n  } = data;\n\n  return `<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <title>V\u1EADn \u0111\u01A1n</title>\n  <style>\n    * { margin: 0; padding: 0; box-sizing: border-box; }\n    body { \n      font-family: 'Arial', sans-serif; \n      background: #fff; \n      padding: 0;\n      margin: 0;\n    }\n    .page { \n      width: 148mm; \n      height: 210mm; \n      background: white; \n      padding: 10px;\n      position: relative;\n      overflow: hidden;\n    }\n    \n    /* HEADER - Logo + M\u00E3 v\u1EADn \u0111\u01A1n */\n    .header {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      margin-bottom: 8px;\n      padding-bottom: 6px;\n      border-bottom: 3px solid #ff6b35;\n    }\n    .logo { \n      width: 45px; \n      height: 45px; \n    }\n    .logo img { \n      width: 100%; \n      height: 100%; \n      object-fit: contain; \n    }\n    .header-code {\n      flex: 1;\n      text-align: center;\n      margin: 0 12px;\n    }\n    .header-code .main-code {\n      font-size: 22px;\n      font-weight: bold;\n      letter-spacing: 1px;\n      color: #000;\n    }\n    .header-code .sub-text {\n      font-size: 12px;\n      color: #666;\n      margin-top: 1px;\n    }\n    .header-date {\n      text-align: right;\n      font-size: 13px;\n    }\n    .header-date .time {\n      font-weight: bold;\n    }\n    \n    /* BARCODE */\n    .barcode-section {\n      text-align: center;\n      margin-bottom: 6px;\n      padding: 4px;\n      border: 1px solid #ddd;\n    }\n    .barcode-img {\n      height: 35px;\n      margin-bottom: 2px;\n    }\n    .barcode-text {\n      font-size: 21px;\n      font-weight: bold;\n      letter-spacing: 1px;\n    }\n    \n    /* SENDER - SINGLE ROW */\n    .sender-section {\n      border: 2px solid #333;\n      padding: 6px;\n      background: #f9f9f9;\n      margin-bottom: 6px;\n    }\n    .sender-label {\n      font-size: 13px;\n      font-weight: bold;\n      background: #ff6b35;\n      color: white;\n      padding: 2px 4px;\n      margin-bottom: 4px;\n      display: inline-block;\n    }\n    .sender-content {\n      display: flex;\n      gap: 15px;\n    }\n    .sender-name {\n      font-size: 16px;\n      font-weight: bold;\n      min-width: 120px;\n    }\n    .sender-address {\n      font-size: 15px;\n      line-height: 1.2;\n      flex: 1;\n    }\n    .sender-phone {\n      font-size: 15px;\n      font-weight: bold;\n      color: #ff6b35;\n      min-width: 100px;\n    }\n    \n    /* RECEIVER - SINGLE ROW */\n    .receiver-section {\n      border: 2px solid #333;\n      padding: 6px;\n      background: #f9f9f9;\n      margin-bottom: 6px;\n    }\n    .receiver-label {\n      font-size: 13px;\n      font-weight: bold;\n      background: #ff6b35;\n      color: white;\n      padding: 2px 4px;\n      margin-bottom: 4px;\n      display: inline-block;\n    }\n    .receiver-content {\n      display: flex;\n      gap: 15px;\n    }\n    .receiver-name {\n      font-size: 16px;\n      font-weight: bold;\n      min-width: 120px;\n    }\n    .receiver-address {\n      font-size: 15px;\n      line-height: 1.2;\n      flex: 1;\n    }\n    .receiver-phone {\n      font-size: 15px;\n      font-weight: bold;\n      color: #ff6b35;\n      min-width: 100px;\n    }\n    \n    /* PRODUCT TABLE */\n    .items-section {\n      margin-bottom: 6px;\n      border: 2px solid #333;\n    }\n    .items-header {\n      background: #ff6b35;\n      color: white;\n      padding: 5px 6px;\n      font-size: 13px;\n      font-weight: bold;\n    }\n    .items-table {\n      width: 100%;\n      font-size: 15px;\n      border-collapse: collapse;\n    }\n    .items-table th {\n      background: #f0f0f0;\n      padding: 5px 4px;\n      font-weight: bold;\n      text-align: left;\n      border-bottom: 1px solid #ddd;\n      font-size: 13px;\n    }\n    .items-table td {\n      padding: 5px 4px;\n      border-bottom: 1px solid #ddd;\n    }\n    .items-table .qty {\n      text-align: center;\n      font-weight: bold;\n      font-size: 15px;\n    }\n    .items-table .price {\n      text-align: right;\n      font-size: 15px;\n    }\n    \n    /* PAYMENT BOX - N\u1ED8I B\u1EACT */\n    .payment-section {\n      background: #fff3cd;\n      border: 3px solid #ff6b35;\n      padding: 8px;\n      margin-bottom: 6px;\n      text-align: center;\n      border-radius: 4px;\n    }\n    .payment-title {\n      font-size: 14px;\n      font-weight: bold;\n      color: #000;\n      margin-bottom: 4px;\n    }\n    .payment-amount {\n      font-size: 26px;\n      font-weight: bold;\n      color: #ff6b35;\n      letter-spacing: 1px;\n      margin-bottom: 2px;\n    }\n    .payment-note {\n      font-size: 12px;\n      color: #666;\n    }\n    \n    /* QR CODE - TO H\u01A0N */\n    .qr-section {\n      display: flex;\n      justify-content: center;\n      margin-bottom: 6px;\n    }\n    .qr-box {\n      border: 2px solid #333;\n      padding: 8px;\n      text-align: center;\n    }\n    .qr-box img {\n      width: 140px;\n      height: 140px;\n    }\n    .qr-label {\n      font-size: 13px;\n      font-weight: bold;\n      margin-top: 4px;\n    }\n    \n    /* FOOTER */\n    .footer {\n      text-align: center;\n      border-top: 1px solid #ddd;\n      padding-top: 4px;\n      font-size: 12px;\n    }\n    .footer-note {\n      color: #666;\n      margin-bottom: 1px;\n      font-size: 12px;\n    }\n    .hotline {\n      font-weight: bold;\n      color: #ff6b35;\n      font-size: 13px;\n    }\n    \n    @media print {\n      body { margin: 0; padding: 0; background: white; }\n      .page { width: 100%; height: 100%; margin: 0; padding: 10px; page-break-after: avoid; }\n    }\n  </style>\n</head>\n<body>\n  <div class=\"page\">\n    <!-- HEADER -->\n    <div class=\"header\">\n      <div class=\"logo\">\n        <img src=\"${logo}\" alt=\"Logo\" onerror=\"this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23f0f0f0%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2250%22 font-size=%2216%22 fill=%22%23999%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22%3ELogo%3C/text%3E%3C/svg%3E'\">\n      </div>\n      <div class=\"header-code\">\n        <div class=\"main-code\">${superaiCode}</div>\n        <div class=\"sub-text\">M\u00E3 v\u1EADn \u0111\u01A1n</div>\n      </div>\n      <div class=\"header-date\">\n        <div class=\"time\">${createdDate.split(' ')[0]}</div>\n        <div style=\"font-size:12px\">${createdDate.split(' ')[1] || ''}</div>\n      </div>\n    </div>\n\n    <!-- BARCODE -->\n    <div class=\"barcode-section\">\n      <img src=\"${barcodeSrc}\" alt=\"Barcode\" class=\"barcode-img\" onerror=\"this.style.display='none'\">\n      <div class=\"barcode-text\">${superaiCode}</div>\n    </div>\n\n    <!-- SENDER - SINGLE ROW -->\n    <div class=\"sender-section\">\n      <span class=\"sender-label\">\uD83D\uDC64 NG\u01AF\u1EDCI G\u1EECI</span>\n      <div class=\"sender-content\">\n        <div class=\"sender-name\">${sender.name || store.name || 'Shop'}</div>\n        <div class=\"sender-address\">${sender.address || store.address || ''}</div>\n        <div class=\"sender-phone\">\u260E\uFE0F ${sender.phone || store.phone || ''}</div>\n      </div>\n    </div>\n\n    <!-- RECEIVER - SINGLE ROW -->\n    <div class=\"receiver-section\">\n      <span class=\"receiver-label\">\uD83D\uDCE6 NG\u01AF\u1EDCI NH\u1EACN</span>\n      <div class=\"receiver-content\">\n        <div class=\"receiver-name\">${receiver.name || customer.name || 'Kh\u00E1ch'}</div>\n        <div class=\"receiver-address\">${receiver.address || customer.address || ''}</div>\n        <div class=\"receiver-phone\">\u260E\uFE0F ${receiver.phone || customer.phone || ''}</div>\n      </div>\n    </div>\n\n    <!-- PRODUCTS -->\n    <div class=\"items-section\">\n      <div class=\"items-header\">\uD83D\uDCE6 N\u1ED8I DUNG H\u00C0NG (${items.length} s\u1EA3n ph\u1EA9m)</div>\n      <table class=\"items-table\">\n        <thead>\n          <tr>\n            <th style=\"width:50%\">S\u1EA3n ph\u1EA9m</th>\n            <th style=\"width:15%; text-align:center\">SL</th>\n            <th style=\"width:35%; text-align:right\">Gi\u00E1</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${items.map((item, idx) => `\n            <tr>\n              <td>\n                <strong>${item.name || 'SP'}</strong>\n                ${item.variant ? `<div style=\"font-size:12px; color:#666\">${item.variant}</div>` : ''}\n              </td>\n              <td class=\"qty\">${item.qty || 1}</td>\n              <td class=\"price\">${Number(item.price || 0).toLocaleString('vi-VN')} \u0111</td>\n            </tr>\n          `).join('') || '<tr><td colspan=\"3\" style=\"text-align:center; color:#999; padding:6px\">Kh\u00F4ng c\u00F3 s\u1EA3n ph\u1EA9m</td></tr>'}\n        </tbody>\n      </table>\n    </div>\n\n    <!-- PAYMENT BOX -->\n    <div class=\"payment-section\">\n      <div class=\"payment-title\">\uD83D\uDCB0 T\u1ED4NG TI\u1EC0N THU T\u1EEA NG\u01AF\u1EDCI NH\u1EACN</div>\n      <div class=\"payment-amount\">${Number((order.subtotal || 0) + (order.shipping_fee || 0)).toLocaleString('vi-VN')} \u0111</div>\n      <div class=\"payment-note\">${order.cod ? '(Thu h\u1ED9 - COD)' : '(Thanh to\u00E1n)'}</div>\n    </div>\n\n    <!-- QR CODE -->\n    <div class=\"qr-section\">\n      <div class=\"qr-box\">\n        <img src=\"https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=${encodeURIComponent(order.tracking_code || superaiCode)}\" alt=\"QR Code\">\n        <div class=\"qr-label\">M\u00E3 tracking</div>\n      </div>\n    </div>\n\n    <!-- FOOTER -->\n    <div class=\"footer\">\n      <div class=\"footer-note\">Vui l\u00F2ng ki\u1EC3m tra l\u1EA1i th\u00F4ng tin tr\u01B0\u1EDBc khi g\u1EEDi</div>\n      <div class=\"hotline\">Hotline: 0909128999 - 0933190000</div>\n    </div>\n  </div>\n\n  <script>\n    window.onload = function() {\n      setTimeout(() => window.print(), 500);\n    };\n  </script>\n</body>\n</html>`;\n}", "// workers/shv-api/src/modules/shipping/waybill.js\n// ===================================================================\n//  Waybill Creation (FIXED COMPLETE)\n// ===================================================================\n\nimport { json, errorResponse, corsHeaders } from '../../lib/response.js';\nimport { adminOK } from '../../lib/auth.js';\nimport { getJSON, putJSON } from '../../lib/kv.js';\nimport { readBody } from '../../lib/utils.js';\nimport { idemGet, idemSet } from '../../lib/idempotency.js';\nimport { superFetch, chargeableWeightGrams, validateDistrictCode, lookupCommuneCode, superToken } from './helpers.js';\nimport { getWaybillHTML } from './waybill-template.js';\n\nexport async function createWaybill(req, env) {\n  const idem = await idemGet(req, env);\n  if (idem.hit) {\n    return new Response(idem.body, { \n      status: 200, \n      headers: corsHeaders(req) \n    });\n  }\n\n  // Cho ph\u00E9p public access v\u1EDBi static token\n  const headerToken =\n    (req.headers.get('Token') ||\n     req.headers.get('x-token') ||\n     (req.headers.get('authorization') || '').replace(/^Bearer\\s+/i, '') ||\n     ''\n    ).trim();\n\n  const superKey = 'FxXOoDz2qlTN5joDCsBGQFqKmm1UNvOw7YPwkzm5';\n  const isAdmin = await adminOK(req, env);\n  const isAllowed = isAdmin || (headerToken && headerToken === superKey);\n\n  if (!isAllowed) {\n    console.error('[Waybill] Unauthorized - Token mismatch', { \n      received: headerToken ? headerToken.substring(0, 20) + '...' : 'EMPTY',\n      expected: superKey.substring(0, 20) + '...'\n    });\n    return errorResponse('Unauthorized', 401, req);\n  }\n\n  try {\n    const body = await readBody(req) || {};\n    const settings = await getJSON(env, 'settings', {}) || {};\n    const shipping = settings.shipping || {};\n    const store = settings.store || {};\n    \n    const order = body.order || {};\n    const ship = body.ship || {};\n\n    // Build products first\n    const products = buildWaybillItems(body, order);\n    const orderName = products.length > 0 ? products[0].name : '\u0110\u01A1n h\u00E0ng';\n\n    // Get receiver info for root fields\n    const receiverPhone = sanitizePhone(\n      body.receiver_phone || \n      order.customer?.phone || \n      body.to_phone || \n      '0900000000'\n    );\n\n    const receiverAddress = body.receiver_address || \n                           order.customer?.address || \n                           body.to_address || \n                           '';\n\n    const receiverProvince = body.receiver_province || \n                            order.customer?.province || \n                            body.to_province || \n                            '';\n\n    const receiverDistrict = body.receiver_district || \n                            order.customer?.district || \n                            body.to_district || \n                            '';\n\n    const receiverProvinceCode = body.receiver_province_code || \n                                order.customer?.province_code || \n                                body.province_code || \n                                body.to_province_code || \n                                '';\n\n       // L\u1EA5y raw district code\n    const rawReceiverDistrictCode = body.receiver_district_code || \n                                    order.customer?.district_code || \n                                    body.district_code || \n                                    body.to_district_code || \n                                    '';\n\n    // \u2705 VALIDATE V\u00C0 T\u1EF0 \u0110\u1ED8NG S\u1EECA M\u00C3 DISTRICT N\u1EBEU SAI\n    const receiverDistrictCode = await validateDistrictCode(\n      env,\n      receiverProvinceCode || '79',  // Default TP.HCM\n      rawReceiverDistrictCode,\n      receiverDistrict || body.receiver_district || order.customer?.district || ''\n    );\n\n    console.log('[Waybill] \uD83D\uDD0D District code validation:', {\n      raw: rawReceiverDistrictCode,\n      validated: receiverDistrictCode,\n      districtName: receiverDistrict\n    });\n\n    const payload = {\n      // Root level required fields (SuperShip API requirements)\n      name: orderName,\n      phone: receiverPhone,\n      address: receiverAddress,\n      province: receiverProvince,\n      district: receiverDistrict,\n      commune: (body.receiver_commune || order.customer?.ward || body.to_commune || ''),\n      \n      // Amount (REQUIRED)\n      amount: calculateOrderAmount(order, body),\n      \n      // Sender\n      sender_name: body.sender_name || shipping.sender_name || store.name || 'Shop',\n      sender_phone: sanitizePhone(body.sender_phone || shipping.sender_phone || store.phone || store.owner_phone || '0900000000'),\n      sender_address: body.sender_address || shipping.sender_address || store.address || '',\n      sender_province: body.sender_province || shipping.sender_province || store.province || store.city || '',\n      sender_district: body.sender_district || shipping.sender_district || store.district || '',\n      sender_province_code: body.sender_province_code || shipping.sender_province_code || '79',\n      sender_district_code: body.sender_district_code || shipping.sender_district_code || '760',\n      sender_commune_code: body.sender_commune_code || shipping.sender_commune_code || '',\n\n      // Receiver\n      receiver_name: body.receiver_name || order.customer?.name || body.to_name || '',\n      receiver_phone: receiverPhone,\n      receiver_address: receiverAddress,\n      receiver_province: receiverProvince,\n      receiver_district: receiverDistrict,\n      receiver_commune: body.receiver_commune || order.customer?.ward || body.to_commune || '',\n      receiver_province_code: receiverProvinceCode,\n      receiver_district_code: receiverDistrictCode,\n      receiver_commune_code: body.receiver_commune_code || order.customer?.commune_code || order.customer?.ward_code || body.commune_code || body.to_commune_code || body.ward_code || '',\n\n      // Package (REQUIRED)\n      weight_gram: chargeableWeightGrams(body, order) || 500,\n      weight: chargeableWeightGrams(body, order) || 500,\n      cod: Number(order.cod || body.cod || 0),\n\t  // Aliases SuperAI\n  value: Number(order.value || body.value || order.cod || body.cod || calculateOrderAmount(order, body) || 0),\n  soc: body.soc || order.soc || '',\n      \n      // Payer (REQUIRED) - '1' = Shop tr\u1EA3 ph\u00ED, '2' = Ng\u01B0\u1EDDi nh\u1EADn tr\u1EA3\n      payer: String(body.payer || order.payer || '1'),\n      \n      // Service (REQUIRED)\n      provider: (ship.provider || body.provider || order.shipping_provider || 'vtp').toLowerCase(),\n      service_code: ship.service_code || body.service_code || order.shipping_service || '',\n      \n       // Config (REQUIRED) - '1' = Cho xem h\u00E0ng, '2' = Kh\u00F4ng cho xem h\u00E0ng\n      config: String(body.config || order.config || '1'),\n\n      // Product type (SuperAI)\n      product_type: String(body.product_type || order.product_type || '2'),\n      \n      // Option ID\n      option_id: shipping.option_id || '1',\n      \n      // Products (REQUIRED)\n      products: products,\n      \n      // Additional\n      note: body.note || order.note || ''\n    };\n\n    // Root-level aliases for backward compatibility\n    payload.province_code = receiverProvinceCode;\n    payload.district_code = receiverDistrictCode;\n    payload.commune_code = payload.receiver_commune_code;\n    payload.to_province_code = receiverProvinceCode;\n    payload.to_district_code = receiverDistrictCode;\n    payload.to_commune_code = payload.receiver_commune_code;\n    \n    payload.to_name = payload.receiver_name;\n    payload.to_phone = payload.receiver_phone;\n    payload.to_address = payload.receiver_address;\n    payload.to_province = payload.receiver_province;\n    payload.to_district = payload.receiver_district;\n    payload.to_commune = payload.receiver_commune;\n\n    payload.from_name = payload.sender_name;\n    payload.from_phone = payload.sender_phone;\n    payload.from_address = payload.sender_address;\n    payload.from_province = payload.sender_province;\n    payload.from_district = payload.sender_district;\n\n    // Validate required fields\n    const validation = validateWaybillPayload(payload);\n    if (!validation.ok) {\n      console.error('[Waybill] Validation failed:', validation.errors);\n      return json({\n        ok: false,\n        error: 'VALIDATION_FAILED',\n        details: validation.errors\n      }, { status: 400 }, req);\n    }\n\n    console.log('[Waybill] Creating with payload:', JSON.stringify(payload, null, 2));\n\n    // Call SuperAI API\n    const data = await superFetch(env, '/v1/platform/orders/create', {\n  method: 'POST',\n  headers: { 'content-type': 'application/json' },\n  body: JSON.stringify(payload)\n});\n\n    console.log('[Waybill] SuperAI response:', JSON.stringify(data, null, 2));\n\n    // Check for success (S\u1EECA L\u1EA0I THEO LOG)\n    // SuperAI tr\u1EA3 v\u1EC1 { \"error\": false, \"data\": {...} } khi th\u00E0nh c\u00F4ng\n    const isSuccess = data?.error === false && data?.data;\n    \n    // L\u1EA5y m\u00E3 v\u1EADn \u0111\u01A1n t\u1EEB c\u00E1c tr\u01B0\u1EDDng SuperAI tr\u1EA3 v\u1EC1\n   // S\u1EECA: L\u1EA5y m\u00E3 SuperAI v\u00E0 m\u00E3 NV (carrier) ri\u00EAng bi\u1EC7t\n    const carrier_code = data?.data?.carrier_code || data?.data?.code || null;\n    const superai_code = data?.data?.superai_code || data?.data?.tracking || null;\n\n    if (isSuccess && (carrier_code || superai_code)) {\n      await putJSON(env, 'shipment:' + (order.id || body.order_id || carrier_code), { // D\u00F9ng order.id ho\u1EB7c carrier_code l\u00E0m key\n        provider: payload.provider,\n        service_code: payload.service_code,\n        carrier_code: carrier_code, // L\u01B0u m\u00E3 NV\n        superai_code: superai_code, // L\u01B0u m\u00E3 SuperAI\n        raw: data,\n        createdAt: Date.now()\n      });\n\n      const response = json({ \n        ok: true, \n        carrier_code: carrier_code, // S\u1EEDa: Tr\u1EA3 v\u1EC1 m\u00E3 NV\n        superai_code: superai_code, // S\u1EEDa: Tr\u1EA3 v\u1EC1 m\u00E3 SuperAI\n        provider: payload.provider \n      }, {}, req);\n      \n      await idemSet(idem.key, env, response);\n      return response;\n    }\n\n    const errorMessage = data?.message || data?.error?.message || data?.error || 'Kh\u00F4ng t\u1EA1o \u0111\u01B0\u1EE3c v\u1EADn \u0111\u01A1n';\n    console.error('[Waybill] Failed:', errorMessage);\n    \n    return json({\n      ok: false,\n      error: 'CREATE_FAILED',\n      message: errorMessage,\n      raw: data\n    }, { status: 400 }, req);\n\n  } catch (e) {\n    console.error('[Waybill] Exception:', e);\n    return json({\n      ok: false,\n      error: 'EXCEPTION',\n      message: e.message\n    }, { status: 500 }, req);\n  }\n}\n\nfunction buildWaybillItems(body, order) {\n  const items = Array.isArray(order.items) ? order.items :\n               (Array.isArray(body.items) ? body.items : []);\n\n  // N\u1EBFu kh\u00F4ng c\u00F3 items th\u00EC tr\u1EA3 fallback\n  if (!items || items.length === 0) {\n    return [{\n      sku: 'DEFAULT',\n      name: 'S\u1EA3n ph\u1EA9m',\n      price: 0,\n      weight: 500,\n      quantity: 1\n    }];\n  }\n\n  // C\u00F3 items th\u00EC map \u0111\u00FAng schema SuperAI\n  return items.map((item, index) => {\n    let weight = Number(item.weight_gram || item.weight_grams || item.weight || 0);\n    if (weight <= 0) weight = 500;\n\n    let name = String(item.name || item.title || `S\u1EA3n ph\u1EA9m ${index + 1}`).trim();\n    if (name.length > 100) name = name.substring(0, 97) + '...';\n    if (!name) name = `S\u1EA3n ph\u1EA9m ${index + 1}`;\n\n    return {\n  sku: item.sku || item.id || `ITEM${index + 1}`,\n  name: name,\n  // S\u1EECA: \u01AFu ti\u00EAn gi\u00E1 t\u1EEB variants\n  price: Number(\n    (item.variant_price ?? (item.variant?.price)) ??\n    item.price ?? 0\n  ),\n  weight: weight,\n  quantity: Number(item.qty || item.quantity || 1)\n};\n  });\n}\n\nfunction validateWaybillPayload(payload) {\n  const errors = [];\n\n  // Root fields\n  if (!payload.name || !payload.name.trim()) errors.push('Missing name');\n  if (!payload.phone) errors.push('Missing phone');\n  if (!payload.address || !payload.address.trim()) errors.push('Missing address');\n  \n  // Required fields\n  if (!payload.amount || payload.amount <= 0) errors.push('Missing or invalid amount');\n  if (!payload.payer) errors.push('Missing payer');\n  if (!payload.config) errors.push('Missing config');\n  \n  // Sender\n  if (!payload.sender_name || !payload.sender_name.trim()) errors.push('Missing sender_name');\n  if (!payload.sender_phone) errors.push('Missing sender_phone');\n  if (!payload.sender_address || !payload.sender_address.trim()) errors.push('Missing sender_address');\n  if (!payload.sender_province_code) errors.push('Missing sender_province_code');\n  if (!payload.sender_district_code) errors.push('Missing sender_district_code');\n\n  // Receiver\n  if (!payload.receiver_name || !payload.receiver_name.trim()) errors.push('Missing receiver_name');\n  if (!payload.receiver_phone) errors.push('Missing receiver_phone');\n  if (!payload.receiver_address || !payload.receiver_address.trim()) errors.push('Missing receiver_address');\n  if (!payload.receiver_province_code) errors.push('Missing receiver_province_code');\n  if (!payload.receiver_district_code) errors.push('Missing receiver_district_code');\n  \n  // TH\u00CAM VALIDATE M\u00C3 \u0110\u1ECAA CH\u1EC8\n  const provinceCode = String(payload.receiver_province_code || '');\nconst districtCode = String(payload.receiver_district_code || '');\n\n// Log \u0111\u1EC3 debug CHI TI\u1EBET H\u01A0N\nconsole.log('[Waybill] \uD83D\uDD0D Address codes:', { \n  provinceCode, \n  districtCode,\n  original: {\n    receiver_district_code: payload.receiver_district_code,\n    district_code: payload.district_code,\n    to_district_code: payload.to_district_code\n  }\n});\n\n// Ki\u1EC3m tra district code c\u00F3 trong danh s\u00E1ch h\u1EE3p l\u1EC7\nconst validHCMCDistricts = ['760', '761', '762', '763', '764', '765', '767', '770', '771', '772', '773', '774', '775', '776', '777', '778', '780', '781', '782', '783', '784', '785', '786', '787', '788'];\n\nif (provinceCode === '79' && districtCode && !validHCMCDistricts.includes(districtCode)) {\n  console.error('[Waybill] \u274C M\u00E3 qu\u1EADn/huy\u1EC7n kh\u00F4ng h\u1EE3p l\u1EC7 cho TP.HCM:', districtCode);\n  console.error('[Waybill] \u2139\uFE0F C\u00E1c m\u00E3 h\u1EE3p l\u1EC7:', validHCMCDistricts.join(', '));\n  errors.push(`M\u00E3 qu\u1EADn/huy\u1EC7n \"${districtCode}\" kh\u00F4ng h\u1EE3p l\u1EC7 cho TP.HCM`);\n}\n\n  \n  // Warn if codes look suspicious\n  if (provinceCode.length > 3) {\n    console.warn('[Waybill] \u26A0\uFE0F Province code qu\u00E1 d\u00E0i:', provinceCode);\n  }\n  if (districtCode.length > 4) {\n    console.warn('[Waybill] \u26A0\uFE0F District code qu\u00E1 d\u00E0i:', districtCode);\n  }\n\n  // Weight\n  if (!payload.weight_gram || payload.weight_gram <= 0) errors.push('Invalid weight_gram');\n  if (!payload.weight || payload.weight <= 0) errors.push('Invalid weight');\n\n  // Products\n  if (!Array.isArray(payload.products) || payload.products.length === 0) {\n    errors.push('Products empty');\n  } else {\n    payload.products.forEach((item, idx) => {\n      if (!item.name || !item.name.trim()) errors.push(`Product ${idx + 1}: no name`);\n      if (!item.weight || item.weight <= 0) errors.push(`Product ${idx + 1}: invalid weight`);\n    });\n  }\n\n  return { ok: errors.length === 0, errors };\n}\n\nfunction sanitizePhone(phone) {\n  return String(phone || '').replace(/\\D+/g, '');\n}\n\nfunction calculateOrderAmount(order, body) {\n  // Priority: explicit amount > order total > calculated from items\n  \n  // 1. Check explicit amount\n  if (body.amount && Number(body.amount) > 0) {\n    return Number(body.amount);\n  }\n  \n  if (order.amount && Number(order.amount) > 0) {\n    return Number(order.amount);\n  }\n  \n  // 2. Check order total\n  if (order.total && Number(order.total) > 0) {\n    return Number(order.total);\n  }\n  \n  // 3. Calculate from items\n  const items = Array.isArray(order.items) ? order.items : \n               (Array.isArray(body.items) ? body.items : []);\n  \n  if (items.length > 0) {\n    const itemsTotal = items.reduce((sum, item) => {\n      const price = Number(item.price || 0);\n      const qty = Number(item.qty || item.quantity || 1);\n      return sum + (price * qty);\n    }, 0);\n    \n    if (itemsTotal > 0) return itemsTotal;\n  }\n  \n  // 4. Fallback to COD\n  const cod = Number(order.cod || body.cod || 0);\n  if (cod > 0) return cod;\n  \n  // 5. Default minimum\n  return 10000; // 10k VND minimum\n}\n\n/**\n * H\u00C0M N\u1ED8I B\u1ED8: T\u1EF1 \u0111\u1ED9ng t\u1EA1o v\u1EADn \u0111\u01A1n khi kh\u00E1ch \u0111\u1EB7t h\u00E0ng\n * \u0110\u01B0\u1EE3c g\u1ECDi t\u1EEB /modules/orders.js\n * @param {object} order - To\u00E0n b\u1ED9 \u0111\u1ED1i t\u01B0\u1EE3ng order \u0111\u00E3 \u0111\u01B0\u1EE3c t\u1EA1o\n * @param {object} env - Worker env\n * @returns {object} - { ok: true, tracking: '...', ... }\n */\nexport async function autoCreateWaybill(order, env) {\n  try {\n    const settings = await getJSON(env, 'settings', {}) || {};\n    const shipping = settings.shipping || {};\n    const store = settings.store || {};\n\n    const products = buildWaybillItems({}, order); // D\u00F9ng order object\n    const orderName = products.length > 0 ? products[0].name : '\u0110\u01A1n h\u00E0ng';\n\n    // L\u1EA5y th\u00F4ng tin ng\u01B0\u1EDDi nh\u1EADn t\u1EEB order\n    const receiverPhone = sanitizePhone(order.customer?.phone || '0900000000');\n    const receiverAddress = order.customer?.address || '';\n    const receiverProvince = order.customer?.province || '';\n    const receiverDistrict = order.customer?.district || '';\n    const receiverProvinceCode = order.customer?.province_code || '';\n    const rawReceiverDistrictCode = order.customer?.district_code || '';\n    const receiverDistrictCode = await validateDistrictCode(env, receiverProvinceCode || '79', rawReceiverDistrictCode, receiverDistrict);\n    const receiverCommuneCode = (order.customer?.commune_code || order.customer?.ward_code || '');\n\n// T\u00EDnh to\u00E1n c\u00E1c gi\u00E1 tr\u1ECB\n    const totalAmount = calculateOrderAmount(order, {});\n    const totalWeight = chargeableWeightGrams({}, order) || 500;\n\n    // S\u1EECA: Logic Ph\u00ED (Theo y\u00EAu c\u1EA7u c\u1EE7a b\u1EA1n: Kh\u00E1ch tr\u1EA3 ph\u00ED)\n    // Payer = 2 (Kh\u00E1ch tr\u1EA3 ph\u00ED)\n    // COD = Ch\u1EC9 thu h\u1ED9 ti\u1EC1n h\u00E0ng (subtotal)\n    const payer = '2';\n    const totalCOD = Number(order.subtotal || 0);\n    // Gi\u00E1 tr\u1ECB \u0111\u01A1n h\u00E0ng (value) v\u1EABn l\u00E0 t\u1ED5ng (revenue)\n    const totalValue = Number(order.revenue || order.total || totalAmount || 0);\n\n    const payload = {\n      name: orderName,\n      phone: receiverPhone,\n      address: receiverAddress,\n      province: receiverProvince,\n      district: receiverDistrict,\n      commune: (order.customer?.commune || order.customer?.ward || ''),\n      amount: totalAmount,\n\n      sender_name: shipping.sender_name || store.name || 'Shop',\n      sender_phone: sanitizePhone(shipping.sender_phone || store.phone || '0900000000'),\n      sender_address: shipping.sender_address || store.address || '',\n      sender_province: shipping.sender_province || store.province || '',\n      sender_district: shipping.sender_district || store.district || '',\n      sender_province_code: shipping.sender_province_code || '79',\n      sender_district_code: shipping.sender_district_code || '760',\n      sender_commune_code: shipping.sender_commune_code || '',\n\n      receiver_name: order.customer?.name || 'Kh\u00E1ch',\n      receiver_phone: receiverPhone,\n      receiver_address: receiverAddress,\n      receiver_province: receiverProvince,\n      receiver_district: receiverDistrict,\n      receiver_commune: (order.customer?.commune || order.customer?.ward || ''),\n      receiver_province_code: receiverProvinceCode,\n      receiver_district_code: receiverDistrictCode,\n      receiver_commune_code: receiverCommuneCode,\n\n      weight_gram: totalWeight,\n      weight: totalWeight,\n      cod: totalCOD, // S\u1EEDa: Thu h\u1ED9 ti\u1EC1n h\u00E0ng (subtotal)\n      value: totalValue, // S\u1EEDa: Gi\u00E1 tr\u1ECB \u0111\u01A1n h\u00E0ng (full)\n      soc: order.soc || order.id || '',\n      \n      payer: payer, // S\u1EEDa: '2' (Kh\u00E1ch tr\u1EA3 ph\u00ED)\n      provider: (order.shipping_provider || 'vtp').toLowerCase(),\n      service_code: order.shipping_service || '', // L\u1EA5y t\u1EEB \u0111\u01A1n h\u00E0ng kh\u00E1ch \u0111\u00E3 ch\u1ECDn\n      config: '1', // Cho xem h\u00E0ng\n      product_type: '2',\n      option_id: shipping.option_id || '1',\n      products: products,\n      note: order.note || ''\n    };\n\n    const validation = validateWaybillPayload(payload);\n    if (!validation.ok) {\n      console.error('[autoCreateWaybill] Validation failed:', validation.errors);\n      return { ok: false, message: 'Validation failed: ' + validation.errors.join(', ') };\n    }\n\n    const data = await superFetch(env, '/v1/platform/orders/create', {\n      method: 'POST',\n      headers: { 'content-type': 'application/json' },\n      body: JSON.stringify(payload)\n    });\n\n    const isSuccess = data?.error === false && data?.data;\n    \n    // \u2705 LOG CHI TI\u1EBET - Xem SuperAI tr\u1EA3 v\u1EC1 g\u00EC\n    console.log('[autoCreateWaybill] \uD83D\uDCCA SuperAI response data keys:', Object.keys(data?.data || {}));\n    console.log('[autoCreateWaybill] \uD83D\uDCCB Full response data:', JSON.stringify(data?.data, null, 2));\n    \n    // S\u00E1\u00BB\u00ACA: L\u00E1\u00BA\u00A5y 2 m\u00C3\u00A3 tracking ri\u00C3\u00AAng bi\u00E1\u00BB\u2021t\n    const carrier_code = data?.data?.carrier_code || data?.data?.code || null;\n    const superai_code = data?.data?.superai_code || data?.data?.tracking || data?.data?.order_code || null;\n    const carrier_id = data?.data?.carrier_id || null;\n\n    if (isSuccess && (carrier_code || superai_code)) {\n      return { \n        ok: true, \n        carrier_code: carrier_code,     // M\u00E3 nh\u00E0 v\u1EADn chuy\u1EC3n (SPXVN...)\n        superai_code: superai_code,     // M\u00E3 SuperAI (CTOS...)\n        carrier_id: carrier_id,\n        provider: payload.provider, \n        raw: data.data \n      };\n    }\n\n    const errorMessage = data?.message || data?.error?.message || data?.error || 'Kh\u00F4ng t\u1EA1o \u0111\u01B0\u1EE3c v\u1EADn \u0111\u01A1n';\n    return { ok: false, message: errorMessage, raw: data };\n\n  } catch (e) {\n    console.error('[autoCreateWaybill] Exception:', e);\n    return { ok: false, message: e.message };\n  }\n}\n\n/**\n * H\u00C0M M\u1EDAI: L\u1EA5y link IN V\u1EACN \u0110\u01A0N\n * G\u1ECDi t\u1EEB /shipping/print\n */\nexport async function printWaybill(req, env) {\n  try {\n    const body = await readBody(req) || {};\n    const superaiCode = body.superai_code;\n    let order = body.order || {};\n    \n    // \u2705 N\u1EBFu admin kh\u00F4ng g\u1EEDi order, t\u00ECm t\u1EEB KV\n    if (!order.id || !order.items) {\n      console.log('[printWaybill] Order incomplete, searching KV...');\n      const list = await getJSON(env, 'orders:list', []);\n      const found = list.find(o => o.superai_code === superaiCode || o.shipping_tracking === superaiCode);\n      if (found && found.id) {\n        const fullOrder = await getJSON(env, 'order:' + found.id, null);\n        if (fullOrder) {\n          order = fullOrder;\n          console.log('[printWaybill] \u2705 Found full order from KV');\n        }\n      }\n    }\n\n    if (!superaiCode) {\n      return errorResponse('Missing superai_code', 400, req);\n    }\n\n    // 1. L\u1EA5y Print Token t\u1EEB SuperAI \u0111\u1EC3 c\u00F3 barcode\n    const tokenRes = await superFetch(env, '/v1/platform/orders/token', {\n      method: 'POST',\n      body: {\n        code: [superaiCode]\n      }\n    });\n    \n    const printToken = tokenRes?.data?.token;\n    if (!printToken) {\n      return errorResponse('Kh\u00F4ng l\u1EA5y \u0111\u01B0\u1EE3c print token t\u1EEB SuperAI', 400, req);\n    }\n\n    // 2. L\u1EA5y settings \u0111\u1EC3 c\u00F3 logo\n    const settings = await getJSON(env, 'settings', {}) || {};\n    const store = settings.store || {};\n    const logo = store.logo || 'https://shophuyvan1.pages.dev/logo.png';\n\n    // 3. T\u1EA1o HTML template A5 d\u1ECDc\n    // \u2705 Fallback: N\u1EBFu kh\u00F4ng c\u00F3 sender/receiver, d\u00F9ng d\u1EEF li\u1EC7u t\u1EEB settings + hardcode\n    \n    const sender = order.sender || {\n      name: 'SHOP HUY V\u00C2N',\n      phone: '0909128999',\n      address: '91/6 Li\u00EAn Khu 5-11-12 Ph\u01B0\u1EDDng B\u00ECnh Tr\u1ECB \u0110\u00F4ng Th\u00E0nh Ph\u1ED1 H\u1ED3 Ch\u00ED Minh',\n      province: 'Th\u00E0nh ph\u1ED1 H\u1ED3 Ch\u00ED Minh',\n      district: 'Qu\u1EADn B\u00ECnh T\u00E2n'\n    };\n    \n    const receiver = order.receiver || order.customer || {};\n    const customer = order.customer || {};\n    const items = Array.isArray(order.items) ? order.items : [];\n    \n    const createdDate = order.createdAt ? new Date(Number(order.createdAt)).toLocaleString('vi-VN') : new Date().toLocaleString('vi-VN');\n    const barcodeSrc = `https://api.superai.vn/v1/platform/orders/barcode?token=${printToken}&format=code128`;\n    const qrcodeSrc = `https://api.superai.vn/v1/platform/orders/qrcode?token=${printToken}`;\n\n    const itemsList = items.map(item => `\n      <tr>\n        <td style=\"padding:4px 2px;font-size:10px;border-bottom:1px solid #ddd\">\n          <div>${item.name || ''}</div>\n          ${item.variant ? `<div style=\"color:#666;font-size:9px\">${item.variant}</div>` : ''}\n        </td>\n        <td style=\"padding:4px 2px;text-align:center;font-size:10px;border-bottom:1px solid #ddd\">${item.qty || 1}</td>\n      </tr>\n    `).join('');\n\n    const html = getWaybillHTML({\n      superaiCode,\n      logo,\n      sender,\n      receiver,\n      customer,\n      items,\n      order,\n      createdDate,\n      barcodeSrc,\n      store\n    });\n\n    return json({ ok: true, print_html: html }, {}, req);\n\n  } catch (e) {\n    console.error('[printWaybill] Exception:', e);\n    return errorResponse(e.message, 500, req);\n  }\n}\n\n/**\n * H\u00C0M M\u1EDAI: H\u1EE6Y V\u1EACN \u0110\u01A0N\n * G\u1ECDi t\u1EEB /shipping/cancel\n */\nexport async function cancelWaybill(req, env) {\n  try {\n    const body = await readBody(req) || {};\n    const superaiCode = body.superai_code;\n\n    if (!superaiCode) {\n      return errorResponse('Missing superai_code', 400, req);\n    }\n\n    // 1. G\u1ECDi API H\u1EE7y c\u1EE7a SuperAI\n    const cancelRes = await superFetch(env, '/v1/platform/orders/cancel', {\n      method: 'POST',\n      body: {\n        code: [superaiCode]\n      }\n    });\n\n    if (cancelRes.error === false || (cancelRes.data && cancelRes.data.success)) {\n      // 2. C\u1EADp nh\u1EADt tr\u1EA1ng th\u00E1i trong KV\n      try {\n        const list = await getJSON(env, 'orders:list', []);\n        let orderId = null;\n        \n        const index = list.findIndex(o => \n          o.superai_code === superaiCode || \n          o.tracking_code === superaiCode || \n          o.shipping_tracking === superaiCode\n        );\n        \n        if (index > -1) {\n          list[index].status = 'cancelled';\n          list[index].tracking_code = 'CANCELLED';\n          orderId = list[index].id;\n          await putJSON(env, 'orders:list', list);\n          \n          if (orderId) {\n            const order = await getJSON(env, 'order:' + orderId, null);\n            if (order) {\n              order.status = 'cancelled';\n              order.tracking_code = 'CANCELLED';\n              // FIX: Removed extra 'A'\n              await putJSON(env, 'order:' + orderId, order);\n            }\n          }\n        }\n      } catch (e) {\n        console.warn('[cancelWaybill] L\u1ED7i c\u1EADp nh\u1EADt KV, nh\u01B0ng SuperAI \u0111\u00E3 h\u1EE7y OK:', e.message);\n      }\n      \n      return json({ ok: true, message: 'H\u1EE7y th\u00E0nh c\u00F4ng' }, {}, req);\n    }\n\n    return errorResponse(cancelRes.message || 'L\u1ED7i t\u1EEB SuperAI', 400, req);\n\n  } catch (e) {\n    console.error('[cancelWaybill] Exception:', e);\n    return errorResponse(e.message, 500, req);\n  }\n}\n\n/**\n * H\u00C0M M\u1EDAI: L\u1EA5y link IN H\u00C0NG LO\u1EA0T\n * G\u1ECDi t\u1EEB /shipping/print-bulk\n */\nexport async function printWaybillsBulk(req, env) {\n  try {\n    const body = await readBody(req) || {};\n    const superaiCodes = body.superai_codes; // M\u1EA3ng c\u00E1c m\u00E3 SuperAI\n\n    if (!Array.isArray(superaiCodes) || superaiCodes.length === 0) {\n      return errorResponse('Missing or empty superai_codes array', 400, req);\n    }\n\n    // 1. L\u1EA5y Print Token H\u00C0NG LO\u1EA0T\n    const tokenRes = await superFetch(env, '/v1/platform/orders/token', {\n      method: 'POST',\n      body: {\n        code: superaiCodes // G\u1EEDi m\u1EA3ng m\u00E3 SuperAI\n      }\n    });\n    \n    const printToken = tokenRes?.data?.token;\n    if (!printToken) {\n      return errorResponse('Kh\u00F4ng l\u1EA5y \u0111\u01B0\u1EE3c print token h\u00E0ng lo\u1EA1t t\u1EEB SuperAI', 400, req);\n    }\n\n    // 2. Tr\u1EA3 v\u1EC1 URL in (SuperAI t\u1EF1 x\u1EED l\u00FD in h\u00E0ng lo\u1EA1t v\u1EDBi c\u00F9ng token)\n    const printUrl = `https://api.superai.vn/v1/platform/orders/label?token=${printToken}&size=S13`;\n    \n    return json({ ok: true, print_url: printUrl, count: superaiCodes.length }, {}, req);\n\n  } catch (e) {\n    console.error('[printWaybillsBulk] Exception:', e);\n    return errorResponse(e.message, 500, req);\n  }\n}\n\n/**\n * H\u00C0M M\u1EDAI: H\u1EE6Y H\u00C0NG LO\u1EA0T\n * G\u1ECDi t\u1EEB /shipping/cancel-bulk\n */\nexport async function cancelWaybillsBulk(req, env) {\n  try {\n    const body = await readBody(req) || {};\n    const superaiCodes = body.superai_codes; // M\u1EA3ng c\u00E1c m\u00E3 SuperAI\n\n    if (!Array.isArray(superaiCodes) || superaiCodes.length === 0) {\n      return errorResponse('Missing or empty superai_codes array', 400, req);\n    }\n\n    // 1. G\u1ECDi API H\u1EE7y H\u00C0NG LO\u1EA0T c\u1EE7a SuperAI\n    const cancelRes = await superFetch(env, '/v1/platform/orders/cancel', {\n      method: 'POST',\n      body: {\n        code: superaiCodes // G\u1EEDi m\u1EA3ng m\u00E3 SuperAI\n      }\n    });\n\n    // SuperAI tr\u1EA3 v\u1EC1 { error: false } n\u1EBFu th\u00E0nh c\u00F4ng chung, kh\u00F4ng c\u00F3 chi ti\u1EBFt t\u1EEBng \u0111\u01A1n\n    if (cancelRes.error === false || (cancelRes.data && cancelRes.data.success)) {\n      // 2. C\u1EADp nh\u1EADt tr\u1EA1ng th\u00E1i trong KV cho T\u1EA4T C\u1EA2 c\u00E1c \u0111\u01A1n \u0111\u00E3 g\u1EEDi y\u00EAu c\u1EA7u h\u1EE7y\n      let updatedCount = 0;\n      try {\n        const list = await getJSON(env, 'orders:list', []);\n        let listChanged = false;\n        \n        for (const codeToCancel of superaiCodes) {\n          const index = list.findIndex(o => \n            o.superai_code === codeToCancel || \n            o.tracking_code === codeToCancel || \n            o.shipping_tracking === codeToCancel\n          );\n          \n          if (index > -1 && list[index].status !== 'cancelled') {\n            list[index].status = 'cancelled';\n            list[index].tracking_code = 'CANCELLED';\n            listChanged = true;\n            updatedCount++;\n            \n            const orderId = list[index].id;\n            if (orderId) {\n              const order = await getJSON(env, 'order:' + orderId, null);\n              if (order && order.status !== 'cancelled') {\n                order.status = 'cancelled';\n                order.tracking_code = 'CANCELLED';\n                await putJSON(env, 'order:' + orderId, order);\n              }\n            }\n          }\n        }\n        \n        if (listChanged) {\n          await putJSON(env, 'orders:list', list);\n        }\n      } catch (e) {\n        console.warn('[cancelWaybillsBulk] L\u1ED7i c\u1EADp nh\u1EADt KV, nh\u01B0ng SuperAI c\u00F3 th\u1EC3 \u0111\u00E3 h\u1EE7y OK:', e.message);\n      }\n      \n      return json({ ok: true, message: `\u0110\u00E3 g\u1EEDi y\u00EAu c\u1EA7u h\u1EE7y cho ${superaiCodes.length} \u0111\u01A1n.`, cancelled_count: updatedCount }, {}, req);\n    }\n\n    return errorResponse(cancelRes.message || 'L\u1ED7i h\u1EE7y h\u00E0ng lo\u1EA1t t\u1EEB SuperAI', 400, req);\n\n  } catch (e) {\n    console.error('[cancelWaybillsBulk] Exception:', e);\n    return errorResponse(e.message, 500, req);\n  }\n}", "// ===================================================================\n// modules/vouchers.js - Vouchers Module (Optimized)\n// ===================================================================\n\nimport { json, errorResponse } from '../lib/response.js';\nimport { adminOK } from '../lib/auth.js';\nimport { getJSON, putJSON } from '../lib/kv.js';\nimport { readBody } from '../lib/utils.js';\n\n// ===================================================================\n// Constants\n// ===================================================================\nconst VOUCHER_TYPES = {\n  CODE: 'code',\n  AUTO_FREESHIP: 'auto_freeship'\n};\n\nconst DEFAULT_VALUES = {\n  USAGE_LIMIT_PER_USER: 0,\n  USAGE_LIMIT_TOTAL: 0,\n  USAGE_COUNT: 0,\n  MIN_PURCHASE: 0,\n  OFF_PERCENT: 0,\n  MAX_DISCOUNT: 0\n};\n\nconst VALIDATION_RULES = {\n  MAX_OFF_PERCENT: 100,\n  MIN_OFF_PERCENT: 0\n};\n\n// ===================================================================\n// Helper Functions\n// ===================================================================\n\n/**\n * Validate voucher code format\n */\nfunction validateVoucherCode(code) {\n  if (!code || typeof code !== 'string') {\n    return { valid: false, error: 'M\u00E3 voucher kh\u00F4ng \u0111\u01B0\u1EE3c \u0111\u1EC3 tr\u1ED1ng' };\n  }\n  \n  const normalized = code.trim().toUpperCase();\n  \n  if (normalized.length < 3) {\n    return { valid: false, error: 'M\u00E3 voucher ph\u1EA3i c\u00F3 \u00EDt nh\u1EA5t 3 k\u00FD t\u1EF1' };\n  }\n  \n  if (!/^[A-Z0-9_-]+$/.test(normalized)) {\n    return { valid: false, error: 'M\u00E3 voucher ch\u1EC9 \u0111\u01B0\u1EE3c ch\u1EE9a ch\u1EEF c\u00E1i, s\u1ED1, g\u1EA1ch ngang v\u00E0 g\u1EA1ch d\u01B0\u1EDBi' };\n  }\n  \n  return { valid: true, code: normalized };\n}\n\n/**\n * Validate and normalize voucher data\n */\nfunction normalizeVoucherData(body, existingVoucher = null) {\n  const validation = validateVoucherCode(body.code);\n  if (!validation.valid) {\n    throw new Error(validation.error);\n  }\n\n  const voucherType = body.voucher_type === VOUCHER_TYPES.AUTO_FREESHIP \n    ? VOUCHER_TYPES.AUTO_FREESHIP \n    : VOUCHER_TYPES.CODE;\n\n  // Parse timestamps\n  let starts_at = null;\n  let expires_at = null;\n\n  if (body.starts_at) {\n    starts_at = Number(body.starts_at);\n    if (isNaN(starts_at) || starts_at < 0) {\n      throw new Error('Ng\u00E0y b\u1EAFt \u0111\u1EA7u kh\u00F4ng h\u1EE3p l\u1EC7');\n    }\n  }\n\n  if (body.expires_at) {\n    expires_at = Number(body.expires_at);\n    if (isNaN(expires_at) || expires_at < 0) {\n      throw new Error('Ng\u00E0y h\u1EBFt h\u1EA1n kh\u00F4ng h\u1EE3p l\u1EC7');\n    }\n    \n    // Check if expires_at is after starts_at\n    if (starts_at && expires_at <= starts_at) {\n      throw new Error('Ng\u00E0y h\u1EBFt h\u1EA1n ph\u1EA3i sau ng\u00E0y b\u1EAFt \u0111\u1EA7u');\n    }\n  }\n\n  // Base data\n  const voucherData = {\n    code: validation.code,\n    on: body.on === true || String(body.on) === 'true',\n    voucher_type: voucherType,\n    usage_limit_per_user: Math.max(0, parseInt(body.usage_limit_per_user || DEFAULT_VALUES.USAGE_LIMIT_PER_USER)),\n    usage_limit_total: Math.max(0, parseInt(body.usage_limit_total || DEFAULT_VALUES.USAGE_LIMIT_TOTAL)),\n    starts_at,\n    expires_at,\n    // Preserve usage_count from existing voucher\n    usage_count: existingVoucher?.usage_count || DEFAULT_VALUES.USAGE_COUNT\n  };\n\n  // Type-specific data\n  if (voucherType === VOUCHER_TYPES.CODE) {\n    const offPercent = Number(body.off || DEFAULT_VALUES.OFF_PERCENT);\n    voucherData.off = Math.max(\n      VALIDATION_RULES.MIN_OFF_PERCENT, \n      Math.min(VALIDATION_RULES.MAX_OFF_PERCENT, offPercent)\n    );\n    voucherData.min_purchase = Math.max(0, Number(body.min_purchase || DEFAULT_VALUES.MIN_PURCHASE));\n    voucherData.max_discount = Math.max(0, Number(body.max_discount || DEFAULT_VALUES.MAX_DISCOUNT));\n  } else { // AUTO_FREESHIP\n    voucherData.min_purchase = Math.max(0, Number(body.min_purchase || DEFAULT_VALUES.MIN_PURCHASE));\n    voucherData.off = DEFAULT_VALUES.OFF_PERCENT;\n    voucherData.max_discount = DEFAULT_VALUES.MAX_DISCOUNT;\n  }\n\n  return voucherData;\n}\n\n/**\n * Check if voucher is currently valid (time-based only)\n */\nfunction isVoucherTimeValid(voucher) {\n  const now = Date.now();\n  \n  if (voucher.starts_at && now < voucher.starts_at) {\n    return { valid: false, reason: 'not_started', message: 'M\u00E3 voucher ch\u01B0a c\u00F3 hi\u1EC7u l\u1EF1c' };\n  }\n  \n  if (voucher.expires_at && now > voucher.expires_at) {\n    return { valid: false, reason: 'expired', message: 'M\u00E3 voucher \u0111\u00E3 h\u1EBFt h\u1EA1n' };\n  }\n  \n  return { valid: true };\n}\n\n/**\n * Format price for display\n */\nfunction formatPrice(n) { \n  return Number(n || 0).toLocaleString('vi-VN') + '\u20AB'; \n}\n\n// ===================================================================\n// Public API\n// ===================================================================\n\n/**\n * Public: Get all active vouchers (only returns vouchers that are ON)\n */\nasync function getPublicVouchers(req, env) {\n  try {\n    const list = await getJSON(env, 'vouchers', []);\n    \n    // Filter: only return vouchers that are ON and currently valid\n    const activeVouchers = list.filter(v => {\n      if (!v.on) return false;\n      const timeCheck = isVoucherTimeValid(v);\n      return timeCheck.valid;\n    });\n    \n    // Remove sensitive fields before returning\n    const sanitized = activeVouchers.map(v => ({\n      code: v.code,\n      voucher_type: v.voucher_type,\n      off: v.off || 0,\n      min_purchase: v.min_purchase || 0,\n      expires_at: v.expires_at\n      // Don't expose usage_count, usage_limit, etc.\n    }));\n    \n    return json({ items: sanitized }, {}, req);\n  } catch (e) {\n    console.error('[getPublicVouchers] Error:', e);\n    return errorResponse(e, 500, req);\n  }\n}\n\n// ===================================================================\n// Admin API\n// ===================================================================\n\n/**\n * Admin: List all vouchers (including inactive ones)\n */\nasync function listAdminVouchers(req, env) {\n  if (!(await adminOK(req, env))) {\n    return errorResponse('Unauthorized', 401, req);\n  }\n\n  try {\n    const list = await getJSON(env, 'vouchers', []);\n    \n    // Add computed fields for admin view\n    const enriched = list.map(v => {\n      const timeCheck = isVoucherTimeValid(v);\n      return {\n        ...v,\n        is_time_valid: timeCheck.valid,\n        time_status: timeCheck.reason || 'active'\n      };\n    });\n    \n    return json({ items: enriched }, {}, req);\n  } catch (e) {\n    console.error('[listAdminVouchers] Error:', e);\n    return errorResponse(e, 500, req);\n  }\n}\n\n/**\n * Admin: Create or update voucher\n */\nasync function upsertVoucher(req, env) {\n  // \u2705 FIX: Add admin authorization check\n  if (!(await adminOK(req, env))) {\n    return errorResponse('Unauthorized', 401, req);\n  }\n\n  try {\n    const body = await readBody(req) || {};\n    const list = await getJSON(env, 'vouchers', []);\n\n    // Find existing voucher\n    const code = String(body.code || '').toUpperCase().trim();\n    const index = list.findIndex(v => \n      (v.code || '').toUpperCase() === code\n    );\n\n    // Normalize and validate data\n    let voucherData;\n    try {\n      voucherData = normalizeVoucherData(body, index >= 0 ? list[index] : null);\n    } catch (validationError) {\n      return errorResponse(validationError.message, 400, req);\n    }\n\n    if (index >= 0) {\n      // Update existing\n      list[index] = {\n        ...list[index],\n        ...voucherData,\n        updated_at: Date.now()\n      };\n    } else {\n      // Create new\n      list.push({\n        ...voucherData,\n        created_at: Date.now(),\n        updated_at: Date.now()\n      });\n    }\n\n    await putJSON(env, 'vouchers', list);\n    \n    return json({ \n      ok: true, \n      voucher: index >= 0 ? list[index] : list[list.length - 1],\n      action: index >= 0 ? 'updated' : 'created'\n    }, {}, req);\n    \n  } catch (e) {\n    console.error('[upsertVoucher] Error:', e);\n    return errorResponse(e.message || 'Internal server error', 500, req);\n  }\n}\n\n/**\n * Admin: Delete voucher\n */\nasync function deleteVoucher(req, env) {\n  if (!(await adminOK(req, env))) {\n    return errorResponse('Unauthorized', 401, req);\n  }\n\n  try {\n    const body = await readBody(req) || {};\n    const code = String(body.code || '').toUpperCase().trim();\n    \n    if (!code) {\n      return errorResponse('Voucher code is required', 400, req);\n    }\n\n    const list = await getJSON(env, 'vouchers', []);\n    const index = list.findIndex(v => \n      (v.code || '').toUpperCase() === code\n    );\n\n    if (index < 0) {\n      return errorResponse('Voucher not found', 404, req);\n    }\n\n    const deletedVoucher = list[index];\n    const newList = list.filter((_, i) => i !== index);\n    \n    await putJSON(env, 'vouchers', newList);\n    \n    return json({ \n      ok: true, \n      deleted: code,\n      voucher: deletedVoucher\n    }, {}, req);\n    \n  } catch (e) {\n    console.error('[deleteVoucher] Error:', e);\n    return errorResponse(e, 500, req);\n  }\n}\n\n// ===================================================================\n// Voucher Application API (Called by Checkout)\n// ===================================================================\n\n/**\n * Apply voucher and calculate discount\n * Called by checkout.js when user enters a voucher code\n */\nexport async function applyVoucher(req, env) {\n  try {\n    const body = await readBody(req) || {};\n    const code = String(body.code || '').toUpperCase().trim();\n    const customerId = body.customer_id || null;\n    const subtotal = Number(body.subtotal || 0);\n\n    console.log('[applyVoucher] Request:', { code, customerId, subtotal });\n\n    // Validate input\n    if (!code) {\n      return errorResponse('Vui l\u00F2ng nh\u1EADp m\u00E3 voucher', 400, req);\n    }\n\n    if (subtotal <= 0) {\n      return errorResponse('Gi\u1ECF h\u00E0ng tr\u1ED1ng', 400, req);\n    }\n\n    // Get voucher from database\n    const list = await getJSON(env, 'vouchers', []);\n    const voucher = list.find(v => (v.code || '').toUpperCase() === code);\n\n    if (!voucher) {\n      console.log('[applyVoucher] Not found:', code);\n      return errorResponse('M\u00E3 voucher kh\u00F4ng t\u1ED3n t\u1EA1i', 404, req);\n    }\n\n    // ===== VALIDATION CHECKS =====\n\n    // 1. Is voucher active?\n    if (voucher.on !== true) {\n      console.log('[applyVoucher] Inactive:', code);\n      return errorResponse('M\u00E3 voucher kh\u00F4ng ho\u1EA1t \u0111\u1ED9ng', 400, req);\n    }\n\n    // 2. Time validity\n    const timeCheck = isVoucherTimeValid(voucher);\n    if (!timeCheck.valid) {\n      console.log('[applyVoucher] Time invalid:', timeCheck);\n      return errorResponse(timeCheck.message, 400, req);\n    }\n\n    // 3. Total usage limit\n    if (voucher.usage_limit_total > 0 && \n        (voucher.usage_count || 0) >= voucher.usage_limit_total) {\n      console.log('[applyVoucher] Total limit reached:', {\n        count: voucher.usage_count,\n        limit: voucher.usage_limit_total\n      });\n      return errorResponse('M\u00E3 voucher \u0111\u00E3 h\u1EBFt l\u01B0\u1EE3t s\u1EED d\u1EE5ng', 400, req);\n    }\n\n    // 4. Per-user usage limit\n    if (customerId && voucher.usage_limit_per_user > 0) {\n      const historyKey = `customer_voucher_history:${customerId}`;\n      const history = await getJSON(env, historyKey, []);\n      const timesUsed = history.filter(\n        usedCode => (usedCode || '').toUpperCase() === code\n      ).length;\n\n      if (timesUsed >= voucher.usage_limit_per_user) {\n        console.log('[applyVoucher] User limit reached:', {\n          customerId,\n          timesUsed,\n          limit: voucher.usage_limit_per_user\n        });\n        return errorResponse(\n          `B\u1EA1n \u0111\u00E3 s\u1EED d\u1EE5ng m\u00E3 voucher n\u00E0y ${timesUsed}/${voucher.usage_limit_per_user} l\u1EA7n`,\n          400,\n          req\n        );\n      }\n    }\n\n    // 5. Minimum purchase requirement\n    if (voucher.min_purchase > 0 && subtotal < voucher.min_purchase) {\n      console.log('[applyVoucher] Min purchase not met:', {\n        subtotal,\n        required: voucher.min_purchase\n      });\n      return errorResponse(\n        `\u0110\u01A1n h\u00E0ng t\u1ED1i thi\u1EC3u ${formatPrice(voucher.min_purchase)} \u0111\u1EC3 s\u1EED d\u1EE5ng m\u00E3 n\u00E0y`,\n        400,\n        req\n      );\n    }\n\n    // ===== CALCULATE DISCOUNT =====\n\n    let discount = 0;\n    let ship_discount = 0;\n    let discountDetails = {};\n\n    if (voucher.voucher_type === VOUCHER_TYPES.CODE && voucher.off > 0) {\n      // Percentage discount on products\n      const calculatedDiscount = Math.floor(subtotal * (voucher.off / 100));\n      \n      // Apply max_discount cap if set\n      if (voucher.max_discount > 0 && calculatedDiscount > voucher.max_discount) {\n        discount = voucher.max_discount;\n        discountDetails.capped = true;\n      } else {\n        discount = calculatedDiscount;\n      }\n      \n      discountDetails.type = 'percentage';\n      discountDetails.percent = voucher.off;\n      \n      console.log('[applyVoucher] Code discount:', {\n        subtotal,\n        percent: voucher.off,\n        calculated: calculatedDiscount,\n        final: discount,\n        max: voucher.max_discount\n      });\n      \n    } else if (voucher.voucher_type === VOUCHER_TYPES.AUTO_FREESHIP) {\n      // Free shipping vouchers are typically handled by frontend\n      // But we can return a flag indicating free shipping is available\n      discountDetails.type = 'freeship';\n      discountDetails.note = 'Mi\u1EC5n ph\u00ED v\u1EADn chuy\u1EC3n';\n      console.log('[applyVoucher] Auto-freeship voucher applied');\n    }\n\n    // ===== RETURN RESULT =====\n    // NOTE: We do NOT update usage_count here.\n    // That should only happen when the order is successfully placed.\n\n    return json({\n      ok: true,\n      valid: true,\n      code: voucher.code,\n      discount: discount,\n      ship_discount: ship_discount,\n      details: discountDetails,\n      message: '\u00C1p d\u1EE5ng voucher th\u00E0nh c\u00F4ng'\n    }, {}, req);\n\n  } catch (e) {\n    console.error('[applyVoucher] Exception:', e);\n    return errorResponse(e.message || 'Internal server error', 500, req);\n  }\n}\n\n/**\n * Mark voucher as used (called by order creation logic)\n * This should be called ONLY when an order is successfully placed\n */\nexport async function markVoucherUsed(env, voucherCode, customerId = null) {\n  try {\n    const code = String(voucherCode || '').toUpperCase().trim();\n    if (!code) return { ok: false, error: 'No code provided' };\n\n    const list = await getJSON(env, 'vouchers', []);\n    const index = list.findIndex(v => (v.code || '').toUpperCase() === code);\n    \n    if (index < 0) {\n      return { ok: false, error: 'Voucher not found' };\n    }\n\n    // Increment usage count\n    list[index].usage_count = (list[index].usage_count || 0) + 1;\n    await putJSON(env, 'vouchers', list);\n\n    // Record in customer history if customerId provided\n    if (customerId) {\n      const historyKey = `customer_voucher_history:${customerId}`;\n      const history = await getJSON(env, historyKey, []);\n      history.push(code);\n      await putJSON(env, historyKey, history);\n    }\n\n    console.log('[markVoucherUsed] Success:', {\n      code,\n      newCount: list[index].usage_count,\n      customerId\n    });\n\n    return { ok: true, usage_count: list[index].usage_count };\n    \n  } catch (e) {\n    console.error('[markVoucherUsed] Error:', e);\n    return { ok: false, error: e.message };\n  }\n}\n\n// ===================================================================\n// Main Handler\n// ===================================================================\n\nexport async function handle(req, env, ctx) {\n  const url = new URL(req.url);\n  const path = url.pathname;\n  const method = req.method;\n\n  // Public routes\n  if (path === '/vouchers' && method === 'GET') {\n    return getPublicVouchers(req, env);\n  }\n\n  if (path === '/vouchers/apply' && method === 'POST') {\n    return applyVoucher(req, env);\n  }\n\n  // Admin routes\n  if (path === '/admin/vouchers' && method === 'GET') {\n    return listAdminVouchers(req, env);\n  }\n\n  if (path === '/admin/vouchers/list' && method === 'GET') {\n    return listAdminVouchers(req, env);\n  }\n\n  if ((path === '/admin/vouchers' || path === '/admin/vouchers/upsert' || path === '/admin/voucher') && method === 'POST') {\n    return upsertVoucher(req, env);\n  }\n\n  if (path === '/admin/vouchers/delete' && method === 'DELETE') {\n    return deleteVoucher(req, env);\n  }\n\n  // Legacy support for POST delete\n  if (path === '/admin/vouchers/delete' && method === 'POST') {\n    return deleteVoucher(req, env);\n  }\n\n  return errorResponse('Route not found', 404, req);\n}", "// ===================================================================\n// modules/orders.js - Orders Module (OPTIMIZED & FIXED)\n// ===================================================================\n\nimport { json, errorResponse, corsHeaders } from '../lib/response.js';\nimport { adminOK } from '../lib/auth.js';\nimport { getJSON, putJSON } from '../lib/kv.js';\nimport { readBody } from '../lib/utils.js';\nimport { validate, SCH } from '../lib/validator.js';\nimport { idemGet, idemSet } from '../lib/idempotency.js';\nimport { calculateTier, getTierInfo, updateCustomerTier, addPoints } from './admin.js';\nimport { autoCreateWaybill, printWaybill, cancelWaybill, printWaybillsBulk, cancelWaybillsBulk } from './shipping/waybill.js';\nimport { applyVoucher, markVoucherUsed } from './vouchers.js'; // \u2705 FIX: Th\u00EAm markVoucherUsed\n\n// ===================================================================\n// Constants & Helpers\n// ===================================================================\n\nconst ORDER_STATUS = {\n  PENDING: 'pending',\n  CONFIRMED: 'confirmed',\n  SHIPPING: 'shipping',\n  DELIVERED: 'delivered',\n  COMPLETED: 'completed',\n  CANCELLED: 'cancelled',\n  RETURNED: 'returned'\n};\n\nconst CANCEL_STATUSES = ['cancel', 'cancelled', 'huy', 'hu\u1EF7', 'h\u1EE7y', 'returned', 'return', 'pending'];\n\nconst shouldAdjustStock = (status) => {\n  const s = String(status || '').toLowerCase();\n  return !CANCEL_STATUSES.includes(s);\n};\n\nconst toNum = (x) => Number(x || 0);\n\n/**\n * Normalize phone number (Vietnam format)\n */\nfunction normalizePhone(phone) {\n  if (!phone) return '';\n  let x = String(phone).replace(/[\\s\\.\\-\\(\\)]/g, '');\n  if (x.startsWith('+84')) x = '0' + x.slice(3);\n  if (x.startsWith('84') && x.length > 9) x = '0' + x.slice(2);\n  return x;\n}\n\n/**\n * Format price for display\n */\nfunction formatPrice(n) {\n  try {\n    return new Intl.NumberFormat('vi-VN').format(Number(n || 0)) + '\u20AB';\n  } catch {\n    return (n || 0) + '\u20AB';\n  }\n}\n\n// ===================================================================\n// Customer Authentication Helper (REFACTORED - DRY)\n// ===================================================================\n\n/**\n * Extract customer from token (header/cookie/Authorization)\n * Returns { customer, customerId, token } or null\n */\nasync function authenticateCustomer(req, env) {\n  function parseCookie(str) {\n    const out = {};\n    (str || '').split(';').forEach(p => {\n      const i = p.indexOf('=');\n      if (i > -1) out[p.slice(0, i).trim()] = decodeURIComponent(p.slice(i + 1).trim());\n    });\n    return out;\n  }\n\n  async function kvGet(k) {\n    try { return await getJSON(env, k, null); } catch { return null; }\n  }\n\n  async function tryKeys(tok) {\n    if (!tok) return null;\n    const keys = [\n      tok, 'cust:' + tok, 'customerToken:' + tok, 'token:' + tok,\n      'customer_token:' + tok, 'auth:' + tok, 'customer:' + tok,\n      'session:' + tok, 'shv_session:' + tok\n    ];\n\n    for (const k of keys) {\n      const val = await kvGet(k);\n      if (!val) continue;\n\n      if (k.includes('session:') && (val.customer || val.user)) {\n        return val.customer || val.user;\n      }\n\n      if (typeof val === 'object' && val !== null) return val;\n\n      if (typeof val === 'string') {\n        const cid = String(val).trim();\n        const obj = (await kvGet('customer:' + cid)) || (await kvGet('customer:id:' + cid));\n        if (obj) return obj;\n      }\n\n      if (val && (val.customer_id || val.customerId)) {\n        const cid = val.customer_id || val.customerId;\n        const obj = (await kvGet('customer:' + cid)) || (await kvGet('customer:id:' + cid));\n        if (obj) return obj;\n      }\n    }\n    return null;\n  }\n\n  // 1. Extract token from headers/cookie\n  let token = req.headers.get('x-customer-token') || req.headers.get('x-token') || '';\n\n  if (!token) {\n    const m = (req.headers.get('authorization') || '').match(/^Bearer\\s+(.+)$/i);\n    if (m) token = m[1];\n  }\n\n  if (!token) {\n    const c = parseCookie(req.headers.get('cookie') || '');\n    token = c['customer_token'] || c['x-customer-token'] || c['token'] || '';\n  }\n\n  token = String(token || '').trim().replace(/^\"+|\"+$/g, '');\n\n  // 2. Try to find customer with raw token\n  let customer = await tryKeys(token);\n  let decodedTokenId = '';\n\n  // 3. Try base64 decode\n  if (!customer && token) {\n    try {\n      let b64 = token.replace(/-/g, '+').replace(/_/g, '/');\n      while (b64.length % 4) b64 += '=';\n      const decoded = atob(b64);\n\n      if (decoded && decoded.includes(':')) {\n        const customerId = decoded.split(':')[0];\n        if (customerId) {\n          decodedTokenId = customerId;\n          customer = (await kvGet('customer:' + customerId)) || (await kvGet('customer:id:' + customerId));\n        }\n      } else if (decoded && decoded !== token) {\n        decodedTokenId = decoded;\n        customer = await tryKeys(decoded);\n        if (!customer) {\n          customer = (await kvGet('customer:' + decoded)) || (await kvGet('customer:id:' + decoded));\n        }\n      }\n    } catch { /* ignore */ }\n  }\n\n  // 4. Try JWT decode\n  if (!customer && token && token.split('.').length === 3) {\n    try {\n      const p = JSON.parse(atob(token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));\n      const cid = p.customer_id || p.customerId || p.sub || p.id || '';\n      if (cid) {\n        customer = (await kvGet('customer:' + cid)) || (await kvGet('customer:id:' + cid));\n        if (!customer) decodedTokenId = String(cid);\n      }\n    } catch { /* ignore */ }\n  }\n\n  return {\n    customer,\n    customerId: customer?.id || customer?.customer_id || decodedTokenId || null,\n    token\n  };\n}\n\n// ===================================================================\n// Inventory Management (REFACTORED)\n// ===================================================================\n\n/**\n * Normalize order items to consistent format\n */\nfunction normalizeOrderItems(items) {\n  const tryExtractSku = (txt) => {\n    if (!txt) return null;\n    const m = String(txt).toUpperCase().match(/\\bK[\\-]?\\d+\\b/);\n    return m ? m[0].replace('-', '') : null;\n  };\n\n  return (Array.isArray(items) ? items : []).map(it => {\n    const variantSku = tryExtractSku(it.variant || it.name || '');\n    const maybeProductId = String(it.id || '').length > 12 ? it.id : null;\n\n    return {\n      id: it.variant_id ?? it.id ?? it.sku ?? variantSku ?? null,\n      product_id: it.product_id ?? it.pid ?? it.productId ?? (it.product?.id || it.product?.key) ?? maybeProductId ?? null,\n      sku: it.sku ?? variantSku ?? null,\n      name: it.name ?? it.title ?? '',\n      variant: it.variant ?? '',\n      qty: Number(it.qty ?? it.quantity ?? 1) || 1,\n      price: Number(it.price || 0),\n      cost: Number(it.cost || 0)\n    };\n  });\n}\n\n/**\n * Adjust inventory (stock) by items\n * @param {Array} items - Normalized order items\n * @param {object} env - Cloudflare env\n * @param {number} direction - -1 to decrease, +1 to increase\n */\nasync function adjustInventory(items, env, direction = -1) {\n  console.log('[INV] Adjusting inventory', { itemCount: items?.length, direction });\n\n  const STOCK_KEYS = ['stock', 'ton_kho', 'quantity', 'qty_available', 'so_luong'];\n\n  const readStock = (obj) => {\n    for (const k of STOCK_KEYS) {\n      if (obj && obj[k] != null) return Number(obj[k] || 0);\n    }\n    return 0;\n  };\n\n  const writeStock = (obj, value) => {\n    for (const k of STOCK_KEYS) {\n      if (obj && Object.prototype.hasOwnProperty.call(obj, k)) {\n        obj[k] = Math.max(0, Number(value || 0));\n        return k;\n      }\n    }\n    obj['stock'] = Math.max(0, Number(value || 0));\n    return 'stock';\n  };\n\n  for (const it of (items || [])) {\n    const variantId = it.id || it.variant_id || it.sku;\n    const productId = it.product_id;\n\n    if (!variantId && !productId) {\n      console.warn('[INV] Skip item: no ID', it);\n      continue;\n    }\n\n    // Find product\n    let product = null;\n    if (productId) {\n      product = await getJSON(env, 'product:' + productId, null);\n      if (!product) product = await getJSON(env, 'products:' + productId, null);\n    }\n\n    if (!product && variantId) {\n      const list = await getJSON(env, 'products:list', []);\n      for (const s of list) {\n        const p = await getJSON(env, 'product:' + s.id, null);\n        if (!p || !Array.isArray(p.variants)) continue;\n\n        const text = String(it.variant || it.name || '').toUpperCase();\n        const ok = p.variants.some(v => {\n          const vid = String(v.id || '');\n          const vsku = String(v.sku || '');\n          const vname = String(v.name || v.title || v.option_name || '').toUpperCase();\n          return (\n            vid === String(variantId) ||\n            vsku === String(variantId) ||\n            (it.sku && vsku === String(it.sku)) ||\n            (text && vname && text.includes(vname))\n          );\n        });\n\n        if (ok) {\n          product = p;\n          break;\n        }\n      }\n    }\n\n    if (!product) {\n      console.warn('[INV] Product not found for item', it);\n      continue;\n    }\n\n    const delta = Number(it.qty || 1) * direction;\n    let touched = false;\n\n    // Adjust variant stock\n    if (Array.isArray(product.variants) && variantId) {\n      const text2 = String(it.variant || it.name || '').toUpperCase();\n      const v = product.variants.find(v => {\n        const vid = String(v.id || '');\n        const vsku = String(v.sku || '');\n        const vname = String(v.name || v.title || v.option_name || '').toUpperCase();\n        return (\n          vid === String(variantId) ||\n          vsku === String(variantId) ||\n          (it.sku && vsku === String(it.sku)) ||\n          (text2 && vname && text2.includes(vname))\n        );\n      });\n\n      if (v) {\n        const before = readStock(v);\n        const after = before + delta;\n        const keySet = writeStock(v, after);\n        console.log('[INV] Variant updated', { key: keySet, before, after, variantId });\n        touched = true;\n\n        // Update sold count\n        const vSoldBefore = Number(v.sold || v.sold_count || 0);\n        const vSoldAfter = Math.max(0, vSoldBefore + (direction === -1 ? Number(it.qty || 1) : -Number(it.qty || 1)));\n        v.sold = vSoldAfter;\n        v.sold_count = vSoldAfter;\n      }\n    }\n\n    // Adjust product-level stock if variant not touched\n    if (!touched) {\n      const before = readStock(product);\n      const after = before + delta;\n      const keySet = writeStock(product, after);\n      console.log('[INV] Product stock updated', { key: keySet, before, after, productId: product.id });\n    }\n\n    // Update product sold count\n    const pSoldBefore = Number(product.sold || product.sold_count || 0);\n    const pSoldAfter = Math.max(0, pSoldBefore + (direction === -1 ? Number(it.qty || 1) : -Number(it.qty || 1)));\n    product.sold = pSoldAfter;\n    product.sold_count = pSoldAfter;\n\n    await putJSON(env, 'product:' + product.id, product);\n  }\n\n  console.log('[INV] Adjustment complete');\n}\n\n// ===================================================================\n// Cost Enrichment Helper (REFACTORED - DRY)\n// ===================================================================\n\n/**\n * Enrich items with cost & price from product variants\n * Modifies items array in-place\n */\nasync function enrichItemsWithCostAndPrice(items, env) {\n  const allProducts = await getJSON(env, 'products:list', []);\n\n  for (const item of items) {\n    const variantId = item.id || item.sku;\n    if (!variantId) continue;\n\n    let variantFound = null;\n\n    // Search all products for matching variant\n    for (const summary of allProducts) {\n      const product = await getJSON(env, 'product:' + summary.id, null);\n      if (!product || !Array.isArray(product.variants)) continue;\n\n      const variant = product.variants.find(v =>\n        String(v.id || v.sku || '') === String(variantId) ||\n        String(v.sku || '') === String(item.sku || '')\n      );\n\n      if (variant) {\n        variantFound = variant;\n        break;\n      }\n    }\n\n    if (!variantFound) continue;\n\n    // \u2705 Enforce variant price (always use variant price, not FE-sent price)\n    const priceKeys = ['price', 'sale_price', 'list_price', 'gia_ban'];\n    for (const key of priceKeys) {\n      if (variantFound[key] != null) {\n        item.price = Number(variantFound[key] || 0);\n        console.log('[ENRICH] \u2705 Set price from variant:', { id: variantId, price: item.price });\n        break;\n      }\n    }\n\n    // Set cost if not provided by FE\n    if (!item.cost || item.cost === 0) {\n      const costKeys = ['cost', 'cost_price', 'import_price', 'gia_von', 'buy_price', 'price_import'];\n      for (const key of costKeys) {\n        if (variantFound[key] != null) {\n          item.cost = Number(variantFound[key] || 0);\n          console.log('[ENRICH] \u2705 Set cost from variant:', { id: variantId, cost: item.cost });\n          break;\n        }\n      }\n    }\n  }\n\n  return items;\n}\n\n// ===================================================================\n// Tier & Points Management\n// ===================================================================\n\n/**\n * Add points to customer when order is completed\n * @param {object} customer - Customer object from order\n * @param {number} revenue - Order revenue (after discount)\n * @param {object} env - Cloudflare env\n * @returns {object} - { upgraded, oldTier, newTier, points }\n */\nasync function addPointsToCustomer(customer, revenue, env) {\n  if (!customer || !customer.id) {\n    console.log('[TIER] No customer info, skip points');\n    return { upgraded: false, points: 0 };\n  }\n\n  try {\n    const customerKey = `customer:${customer.id}`;\n    let custData = await env.SHV.get(customerKey);\n\n    if (!custData) {\n      console.log('[TIER] Customer not found in KV:', customer.id);\n      return { upgraded: false, points: 0 };\n    }\n\n    const cust = JSON.parse(custData);\n    const pointsToAdd = Math.floor(revenue);\n\n    const tierResult = addPoints(cust, pointsToAdd);\n\n    await env.SHV.put(customerKey, JSON.stringify(cust));\n    if (cust.email) {\n      await env.SHV.put(`customer:email:${cust.email}`, JSON.stringify(cust));\n    }\n\n    console.log('[TIER] Points added', {\n      customerId: customer.id,\n      pointsAdded: pointsToAdd,\n      totalPoints: cust.points,\n      upgraded: tierResult.upgraded,\n      oldTier: tierResult.oldTier,\n      newTier: tierResult.newTier\n    });\n\n    return {\n      upgraded: tierResult.upgraded,\n      oldTier: tierResult.oldTier,\n      newTier: tierResult.newTier,\n      points: cust.points\n    };\n  } catch (e) {\n    console.error('[TIER] Error adding points:', e);\n    return { upgraded: false, points: 0 };\n  }\n}\n\n// ===================================================================\n// Router Entry\n// ===================================================================\n\nexport async function handle(req, env, ctx) {\n  const url = new URL(req.url);\n  const path = url.pathname;\n  const method = req.method;\n\n  // PUBLIC\n  if (path === '/api/orders' && method === 'POST') return createOrder(req, env);\n  if (path === '/public/orders/create' && method === 'POST') return createOrderPublic(req, env);\n  if (path === '/public/order-create' && method === 'POST') return createOrderLegacy(req, env);\n  if (path === '/orders/my' && method === 'GET') return getMyOrders(req, env);\n  if (path === '/orders/cancel' && method === 'POST') return cancelOrderCustomer(req, env);\n\n  // ADMIN\n  if (path === '/api/orders' && method === 'GET') return listOrders(req, env);\n  if (path === '/admin/orders' && method === 'GET') return listOrdersAdmin(req, env);\n  if (path === '/admin/orders/upsert' && method === 'POST') return upsertOrder(req, env);\n  if (path === '/admin/orders/delete' && method === 'POST') return deleteOrder(req, env);\n  if (path === '/admin/orders/print' && method === 'GET') return printOrder(req, env);\n  if (path === '/admin/stats' && method === 'GET') return getStats(req, env);\n\n  // Shipping Waybill\n  if (path === '/shipping/print' && method === 'POST') return printWaybill(req, env);\n  if (path === '/shipping/cancel' && method === 'POST') return cancelWaybill(req, env);\n  if (path === '/shipping/print-bulk' && method === 'POST') return printWaybillsBulk(req, env);\n  if (path === '/shipping/cancel-bulk' && method === 'POST') return cancelWaybillsBulk(req, env);\n\n  return errorResponse('Route not found', 404, req);\n}\n\n// ===================================================================\n// PUBLIC: Create Order (Main Endpoint)\n// ===================================================================\n\nasync function createOrder(req, env) {\n  // Check idempotency\n  const idem = await idemGet(req, env);\n  if (idem.hit) return new Response(idem.body, { status: 200, headers: corsHeaders(req) });\n\n  // Authenticate customer\n  const auth = await authenticateCustomer(req, env);\n\n  const body = await readBody(req) || {};\n  console.log('[ORDER] Creating order', {\n    items: body?.items?.length || 0,\n    customerId: auth.customerId\n  });\n\n  // Validate request body\n  const validation = validate(SCH.orderCreate, body);\n  if (!validation.ok) {\n    return json({ ok: false, error: 'VALIDATION_FAILED', details: validation.errors }, { status: 400 }, req);\n  }\n\n  const id = body.id || crypto.randomUUID().replace(/-/g, '');\n  const createdAt = Date.now();\n\n  // Normalize & enrich items\n  let items = normalizeOrderItems(body.items || []);\n  items = await enrichItemsWithCostAndPrice(items, env);\n\n  // Calculate subtotal\n  const subtotal = items.reduce((sum, item) =>\n    sum + Number(item.price || 0) * Number(item.qty || 1), 0\n  );\n\n  // \u2705 FIX: Extract shipping info correctly\n  const shipping = body.shipping || {};\n  const shipping_fee = Number(body?.totals?.shipping_fee || body.shipping_fee || 0);\n\n  // \u2705 FIX: Get voucher code from correct source\n  const voucher_code_input = body.voucher_code || body.totals?.voucher_code || null;\n\n  let validated_voucher_code = null;\n  let validated_discount = 0;\n  let validated_ship_discount = 0;\n\n  // Re-validate voucher if provided\n  if (voucher_code_input) {\n    console.log('[ORDER] Re-validating voucher:', voucher_code_input);\n    try {\n      // Merge customer info\n      const finalCustomer = {\n        ...(auth.customer || {}),\n        ...(body.customer || {})\n      };\n      if (auth.customerId) finalCustomer.id = auth.customerId;\n\n      const fakeReq = new Request(req.url, {\n        method: 'POST',\n        headers: req.headers,\n        body: JSON.stringify({\n          code: voucher_code_input,\n          customer_id: finalCustomer.id || null,\n          subtotal: subtotal\n        })\n      });\n\n      const applyResultResponse = await applyVoucher(fakeReq, env);\n      const applyData = await applyResultResponse.json();\n\n      if (applyResultResponse.status === 200 && applyData.ok && applyData.valid) {\n        validated_voucher_code = applyData.code;\n        validated_discount = applyData.discount || 0;\n        validated_ship_discount = applyData.ship_discount || 0;\n        console.log('[ORDER] Voucher validation SUCCESS:', {\n          code: validated_voucher_code,\n          discount: validated_discount,\n          ship_discount: validated_ship_discount\n        });\n      } else {\n        console.warn('[ORDER] Voucher validation FAILED:', applyData.message || applyData.error);\n      }\n    } catch (e) {\n      console.error('[ORDER] EXCEPTION calling applyVoucher:', e);\n    }\n  }\n\n  // Calculate final totals\n  const final_discount = validated_discount;\n  const final_ship_discount = validated_ship_discount;\n  const revenue = Math.max(0, subtotal + shipping_fee - (final_discount + final_ship_discount));\n  const profit = items.reduce((sum, item) =>\n    sum + (Number(item.price || 0) - Number(item.cost || 0)) * Number(item.qty || 1), 0\n  ) - final_discount;\n\n  // \u2705 FIX: Merge customer info correctly\n  const finalCustomer = {\n    ...(auth.customer || {}),\n    ...(body.customer || {})\n  };\n  if (auth.customerId) finalCustomer.id = auth.customerId;\n\n  // Normalize customer phone\n  if (finalCustomer.phone) {\n    finalCustomer.phone = normalizePhone(finalCustomer.phone);\n  }\n\n  // Create order object\n  const order = {\n    id,\n    createdAt,\n    status: ORDER_STATUS.PENDING,\n    customer: finalCustomer,\n    items,\n    subtotal,\n    shipping_fee,\n    discount: final_discount,\n    shipping_discount: final_ship_discount,\n    revenue,\n    profit,\n    voucher_code: validated_voucher_code,\n    note: body.note || '',\n    source: body.source || 'website',\n    // \u2705 FIX: Map shipping info correctly\n    shipping_provider: shipping.provider || body.shipping_provider || null,\n    shipping_service: shipping.service_code || body.shipping_service || null,\n    shipping_name: body.shipping_name || shipping.name || null,\n    shipping_eta: body.shipping_eta || shipping.eta || null\n  };\n\n  // Save order\n  const list = await getJSON(env, 'orders:list', []);\n  list.unshift(order);\n  await putJSON(env, 'orders:list', list);\n  await putJSON(env, 'order:' + id, order);\n\n  // Adjust inventory\n  if (shouldAdjustStock(order.status)) {\n    await adjustInventory(items, env, -1);\n  }\n\n  // Auto-create waybill\n  if (order.shipping_provider) {\n    try {\n      console.log('[ORDER] Auto-creating waybill');\n      const waybillResult = await autoCreateWaybill(order, env);\n\n      if (waybillResult.ok && waybillResult.carrier_code) {\n        order.tracking_code = waybillResult.carrier_code;\n        order.shipping_tracking = waybillResult.carrier_code;\n        order.superai_code = waybillResult.superai_code;\n        order.carrier_id = waybillResult.carrier_id;\n        order.status = ORDER_STATUS.SHIPPING;\n        order.waybill_data = waybillResult.raw;\n\n        await putJSON(env, 'order:' + id, order);\n\n        const index = list.findIndex(o => o.id === id);\n        if (index > -1) {\n          list[index] = order;\n          await putJSON(env, 'orders:list', list);\n        }\n\n        console.log('[ORDER] Waybill created:', waybillResult.carrier_code);\n      } else {\n        console.warn('[ORDER] Waybill creation failed:', waybillResult.message);\n      }\n    } catch (e) {\n      console.error('[ORDER] Waybill creation exception:', e.message);\n    }\n  }\n\n  const response = json({ ok: true, id, status: order.status, tracking_code: order.tracking_code || null }, {}, req);\n  await idemSet(idem.key, env, response);\n  return response;\n}\n\n// ===================================================================\n// PUBLIC: Create Order (Alternative Endpoint)\n// ===================================================================\n\nasync function createOrderPublic(req, env) {\n  const idem = await idemGet(req, env);\n  if (idem.hit) return new Response(idem.body, { status: 200, headers: corsHeaders(req) });\n\n  const auth = await authenticateCustomer(req, env);\n  const body = await readBody(req) || {};\n\n  const id = body.id || crypto.randomUUID().replace(/-/g, '');\n  const createdAt = body.createdAt || body.created_at || Date.now();\n  const status = body.status || ORDER_STATUS.PENDING;\n\n  // Merge customer info\n  const finalCustomer = {\n    ...(auth.customer || {}),\n    ...(body.customer || {})\n  };\n  if (auth.customerId) finalCustomer.id = auth.customerId;\n  if (finalCustomer.phone) finalCustomer.phone = normalizePhone(finalCustomer.phone);\n\n  // Normalize & enrich items\n  let items = normalizeOrderItems(body.items || []);\n  items = await enrichItemsWithCostAndPrice(items, env);\n\n  const totals = body.totals || {};\n  const shipping_fee = Number(body.shipping_fee ?? totals.ship ?? totals.shipping_fee ?? 0);\n  const discount = Number(body.discount ?? totals.discount ?? 0);\n  const shipping_discount = Number(body.shipping_discount ?? totals.shipping_discount ?? 0);\n\n  const subtotal = items.reduce((sum, item) =>\n    sum + Number(item.price || 0) * Number(item.qty || 1), 0\n  );\n  const revenue = Math.max(0, subtotal + shipping_fee - (discount + shipping_discount));\n  const profit = items.reduce((sum, item) =>\n    sum + (Number(item.price || 0) - Number(item.cost || 0)) * Number(item.qty || 1), 0\n  ) - discount;\n\n  const order = {\n    id,\n    createdAt,\n    status,\n    customer: finalCustomer,\n    items,\n    shipping_fee,\n    discount,\n    shipping_discount,\n    subtotal,\n    revenue,\n    profit,\n    shipping_name: body.shipping_name || null,\n    shipping_eta: body.shipping_eta || null,\n    shipping_provider: body.shipping_provider || null,\n    shipping_service: body.shipping_service || null,\n    note: body.note || '',\n    source: body.source || 'website'\n  };\n\n  const list = await getJSON(env, 'orders:list', []);\n  list.unshift(order);\n  await putJSON(env, 'orders:list', list);\n  await putJSON(env, 'order:' + id, order);\n\n  if (shouldAdjustStock(order.status)) {\n    await adjustInventory(items, env, -1);\n  }\n\n  // \u2705 FIX: Only add points when order is COMPLETED, not just confirmed\n  if (order.status === ORDER_STATUS.COMPLETED) {\n    const tierInfo = await addPointsToCustomer(order.customer, revenue, env);\n    console.log('[ORDER-PUBLIC] Tier update:', tierInfo);\n  }\n\n  const response = json({ ok: true, id }, {}, req);\n  await idemSet(idem.key, env, response);\n  return response;\n}\n\n// ===================================================================\n// PUBLIC: Create Order (Legacy Endpoint)\n// ===================================================================\n\nasync function createOrderLegacy(req, env) {\n  const body = await readBody(req) || {};\n  const id = body.id || crypto.randomUUID().replace(/-/g, '');\n  const createdAt = Date.now();\n\n  let items = normalizeOrderItems(body.items || []);\n  items = await enrichItemsWithCostAndPrice(items, env);\n\n  const shipping_fee = Number(body.shipping_fee || body.shippingFee || 0);\n\n  const subtotal = items.reduce((sum, item) =>\n    sum + Number(item.price || 0) * Number(item.qty || item.quantity || 1), 0\n  );\n  const cost = items.reduce((sum, item) =>\n    sum + Number(item.cost || 0) * Number(item.qty || item.quantity || 1), 0\n  );\n\n  const revenue = subtotal + shipping_fee;\n  const profit = revenue - cost;\n\n  const order = {\n    id,\n    status: body.status || 'm\u1EDBi',\n    name: body.name,\n    phone: normalizePhone(body.phone),\n    address: body.address,\n    note: body.note || body.notes,\n    items,\n    subtotal,\n    shipping_fee,\n    total: subtotal + shipping_fee,\n    revenue,\n    profit,\n    createdAt\n  };\n\n  const list = await getJSON(env, 'orders:list', []);\n  list.unshift(order);\n  await putJSON(env, 'orders:list', list);\n  await putJSON(env, 'order:' + id, order);\n\n  if (shouldAdjustStock(order.status)) {\n    await adjustInventory(items, env, -1);\n  }\n\n  return json({ ok: true, id, data: order }, {}, req);\n}\n\n// ===================================================================\n// ADMIN: List Orders\n// ===================================================================\n\nasync function listOrders(req, env) {\n  if (!(await adminOK(req, env))) return errorResponse('Unauthorized', 401, req);\n  const list = await getJSON(env, 'orders:list', []);\n  return json({ ok: true, items: list }, {}, req);\n}\n\nasync function listOrdersAdmin(req, env) {\n  if (!(await adminOK(req, env))) return errorResponse('Unauthorized', 401, req);\n\n  const url = new URL(req.url);\n  const from = Number(url.searchParams.get('from') || 0);\n  const to = Number(url.searchParams.get('to') || 0);\n\n  let list = await getJSON(env, 'orders:list', []);\n\n  // Enrich orders missing items\n  const enriched = [];\n  for (const order of list) {\n    if (!order.items) {\n      const full = await getJSON(env, 'order:' + order.id, null);\n      enriched.push(full || order);\n    } else {\n      enriched.push(order);\n    }\n  }\n  list = enriched;\n\n  if (from || to) {\n    list = list.filter(order => {\n      const ts = Number(order.createdAt || 0);\n      if (from && ts < from) return false;\n      if (to && ts > to) return false;\n      return true;\n    });\n  }\n\n  return json({ ok: true, items: list }, {}, req);\n}\n\n// ===================================================================\n// ADMIN: Upsert Order\n// ===================================================================\n\nasync function upsertOrder(req, env) {\n  if (!(await adminOK(req, env))) return errorResponse('Unauthorized', 401, req);\n\n  const body = await readBody(req) || {};\n  const id = body.id || crypto.randomUUID().replace(/-/g, '');\n\n  const list = await getJSON(env, 'orders:list', []);\n  const index = list.findIndex(o => o.id === id);\n\n  // Get old order data for status change detection\n  const oldOrder = index >= 0 ? list[index] : null;\n  const oldStatus = String(oldOrder?.status || '').toLowerCase();\n  const newStatus = String(body.status || '').toLowerCase();\n\n  // Create/update order\n  const order = {\n    ...body,\n    id,\n    createdAt: body.createdAt || Date.now()\n  };\n\n  // Recalculate totals\n  const items = order.items || [];\n  const subtotal = items.reduce((sum, item) => sum + Number(item.price || 0) * Number(item.qty || 1), 0);\n  const cost = items.reduce((sum, item) => sum + Number(item.cost || 0) * Number(item.qty || 1), 0);\n\n  order.subtotal = subtotal;\n  order.revenue = subtotal + Number(order.shipping_fee || 0) - Number(order.discount || 0) - Number(order.shipping_discount || 0);\n  order.profit = order.revenue - cost;\n\n  // Update list\n  if (index >= 0) {\n    list[index] = order;\n  } else {\n    list.unshift(order);\n  }\n\n  await putJSON(env, 'orders:list', list);\n  await putJSON(env, 'order:' + id, order);\n\n  // \u2705 FIX: Handle voucher usage when order becomes completed\n  if (newStatus === ORDER_STATUS.COMPLETED && oldStatus !== ORDER_STATUS.COMPLETED && order.voucher_code) {\n    console.log('[ORDER-UPSERT] Marking voucher as used:', order.voucher_code);\n    try {\n      await markVoucherUsed(env, order.voucher_code, order.customer?.id || null);\n    } catch (e) {\n      console.error('[ORDER-UPSERT] Failed to mark voucher as used:', e);\n    }\n  }\n\n  // \u2705 FIX: Add points when order is completed\n  if (newStatus === ORDER_STATUS.COMPLETED && oldStatus !== ORDER_STATUS.COMPLETED) {\n    const tierInfo = await addPointsToCustomer(order.customer, order.revenue, env);\n    console.log('[ORDER-UPSERT] Tier update:', tierInfo);\n  }\n\n  return json({ ok: true, id: order.id, data: order }, {}, req);\n}\n\n// ===================================================================\n// ADMIN: Delete Order\n// ===================================================================\n\nasync function deleteOrder(req, env) {\n  if (!(await adminOK(req, env))) return errorResponse('Unauthorized', 401, req);\n\n  const body = await readBody(req) || {};\n  const id = body.id;\n  if (!id) return errorResponse('ID is required', 400, req);\n\n  const list = await getJSON(env, 'orders:list', []);\n  const newList = list.filter(order => order.id !== id);\n  await putJSON(env, 'orders:list', newList);\n\n  return json({ ok: true, deleted: id }, {}, req);\n}\n\n// ===================================================================\n// ADMIN: Print Order\n// ===================================================================\n\nasync function printOrder(req, env) {\n  if (!(await adminOK(req, env))) return errorResponse('Unauthorized', 401, req);\n\n  const url = new URL(req.url);\n  const id = url.searchParams.get('id');\n  if (!id) return errorResponse('Missing order ID', 400, req);\n\n  let order = await getJSON(env, 'order:' + id, null);\n  if (!order) {\n    const list = await getJSON(env, 'orders:list', []);\n    order = list.find(o => String(o.id) === String(id)) || null;\n  }\n  if (!order) return errorResponse('Order not found', 404, req);\n\n  const items = Array.isArray(order.items) ? order.items : [];\n  const subtotal = items.reduce((s, it) => s + Number(it.price || 0) * Number(it.qty || 1), 0);\n  const shipping = Number(order.shipping_fee || 0);\n  const discount = Number(order.discount || 0) + Number(order.shipping_discount || 0);\n  const total = Math.max(0, subtotal + shipping - discount);\n  const createdDate = order.createdAt ? new Date(Number(order.createdAt)).toLocaleString('vi-VN') : '';\n\n  const rows = items.map(item => `\n    <tr>\n      <td>${item.sku || item.id || ''}</td>\n      <td>${(item.name || '') + (item.variant ? (' - ' + item.variant) : '')}</td>\n      <td style=\"text-align:right\">${formatPrice(item.qty || 1)}</td>\n      <td style=\"text-align:right\">${formatPrice(item.price || 0)}</td>\n      <td style=\"text-align:right\">${formatPrice(item.cost || 0)}</td>\n      <td style=\"text-align:right\">${formatPrice((item.price || 0) * (item.qty || 1))}</td>\n    </tr>\n  `).join('') || `<tr><td colspan=\"6\" style=\"color:#6b7280\">Kh\u00F4ng c\u00F3 d\u00F2ng h\u00E0ng</td></tr>`;\n\n  const customer = order.customer || {};\n  const html = `<!doctype html>\n<html>\n<head>\n  <meta charset=\"utf-8\"/>\n  <title>\u0110\u01A1n h\u00E0ng ${id}</title>\n  <style>\n    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px;color:#111827}\n    .row{display:flex;justify-content:space-between;margin-bottom:12px}\n    table{width:100%;border-collapse:collapse;margin-top:8px}\n    th,td{border:1px solid #e5e7eb;padding:6px 8px;font-size:13px}\n    th{background:#f9fafb;text-align:left}\n    .totals{margin-top:12px}\n    .totals div{display:flex;justify-content:space-between;padding:2px 0}\n  </style>\n</head>\n<body>\n  <div class=\"row\">\n    <div>\n      <div><b>\u0110\u01A1n h\u00E0ng:</b> ${id}</div>\n      <div><b>Ng\u00E0y t\u1EA1o:</b> ${createdDate}</div>\n      <div><b>Kh\u00E1ch:</b> ${customer.name || order.customer_name || order.name || ''} ${customer.phone ? ('\u2022 ' + customer.phone) : ''}</div>\n      ${order.address || customer.address ? (`<div><b>\u0110\u1ECBa ch\u1EC9:</b> ${order.address || customer.address}</div>`) : ''}\n      ${order.shipping_name ? (`<div><b>V\u1EADn chuy\u1EC3n:</b> ${order.shipping_name} ${order.shipping_eta ? (' \u2022 ' + order.shipping_eta) : ''}</div>`) : ''}\n    </div>\n  </div>\n  <table>\n    <thead>\n      <tr>\n        <th>M\u00E3 SP</th>\n        <th>T\u00EAn/Ph\u00E2n lo\u1EA1i</th>\n        <th>SL</th>\n        <th>Gi\u00E1 b\u00E1n</th>\n        <th>Gi\u00E1 v\u1ED1n</th>\n        <th>Th\u00E0nh ti\u1EC1n</th>\n      </tr>\n    </thead>\n    <tbody>${rows}</tbody>\n  </table>\n  <div class=\"totals\">\n    <div><span>T\u1ED5ng h\u00E0ng</span><b>${formatPrice(subtotal)}</b></div>\n    <div><span>Ph\u00ED v\u1EADn chuy\u1EC3n</span><b>${formatPrice(shipping)}</b></div>\n    ${discount ? (`<div><span>Gi\u1EA3m</span><b>-${formatPrice(discount)}</b></div>`) : ''}\n    <div style=\"font-size:16px\"><span>T\u1ED5ng thanh to\u00E1n</span><b>${formatPrice(total)}</b></div>\n  </div>\n  <script>window.onload = () => setTimeout(() => window.print(), 200);</script>\n</body>\n</html>`;\n  \n  return new Response(html, {\n    headers: {\n      'Content-Type': 'text/html; charset=utf-8',\n      ...corsHeaders(req)\n    }\n  });\n}\n\n// ===================================================================\n// ADMIN: Get Stats\n// ===================================================================\n\nasync function getStats(req, env) {\n  if (!(await adminOK(req, env))) return errorResponse('Unauthorized', 401, req);\n\n  const url = new URL(req.url);\n  const granularity = (url.searchParams.get('granularity') || 'day').toLowerCase();\n  let from = url.searchParams.get('from');\n  let to = url.searchParams.get('to');\n\n  // VN timezone base\n  const now = new Date(Date.now() + 7 * 3600 * 1000);\n  const year = now.getUTCFullYear();\n  const month = now.getUTCMonth();\n  const day = now.getUTCDate();\n  const todayStart = Date.UTC(year, month, day) - 7 * 3600 * 1000;\n\n  if (!from || !to) {\n    if (granularity === 'day') {\n      from = todayStart;\n      to = todayStart + 86400000;\n    } else if (granularity === 'week') {\n      const weekday = (new Date(todayStart + 7 * 3600 * 1000).getDay() + 6) % 7;\n      const start = todayStart - weekday * 86400000;\n      from = start;\n      to = start + 7 * 86400000;\n    } else if (granularity === 'month') {\n      const dt = new Date(todayStart + 7 * 3600 * 1000);\n      const start = Date.UTC(dt.getUTCFullYear(), dt.getUTCMonth(), 1) - 7 * 3600 * 1000;\n      const end = Date.UTC(dt.getUTCFullYear(), dt.getUTCMonth() + 1, 1) - 7 * 3600 * 1000;\n      from = start;\n      to = end;\n    } else {\n      from = todayStart;\n      to = todayStart + 86400000;\n    }\n  } else {\n    from = Number(from);\n    to = Number(to);\n  }\n\n  // Load & enrich\n  let list = await getJSON(env, 'orders:list', []);\n  const enriched = [];\n  for (const order of list) {\n    if (!order.items) {\n      const full = await getJSON(env, 'order:' + order.id, null);\n      enriched.push(full || order);\n    } else {\n      enriched.push(order);\n    }\n  }\n  list = enriched;\n\n  let orderCount = 0;\n  let revenue = 0;\n  let goodsCost = 0;\n  const topMap = {};\n\n  for (const order of list) {\n    const ts = Number(order.createdAt || order.created_at || 0);\n    if (!ts || ts < from || ts >= to) continue;\n\n    orderCount += 1;\n\n    const orderRevenue = Number(order.revenue || 0);\n    revenue += orderRevenue;\n\n    const items = Array.isArray(order.items) ? order.items : [];\n    for (const item of items) {\n      const cost = Number(item.cost || 0);\n      goodsCost += cost * Number(item.qty || 1);\n\n      const name = item.name || item.title || item.id || 'unknown';\n      if (!topMap[name]) topMap[name] = { name, qty: 0, revenue: 0 };\n      topMap[name].qty += Number(item.qty || 1);\n      topMap[name].revenue += Number(item.price || 0) * Number(item.qty || 1);\n    }\n  }\n\n  const tax = revenue * 0.015;\n  const ads = revenue * 0.15;\n  const labor = revenue * 0.10;\n  const profit = Math.max(0, revenue - goodsCost - tax - ads - labor);\n\n  const topProducts = Object.values(topMap)\n    .sort((a, b) => b.revenue - a.revenue)\n    .slice(0, 20);\n\n  return json({\n    ok: true,\n    orders: orderCount,\n    revenue,\n    profit,\n    cost_price: goodsCost,\n    goods_cost: goodsCost,\n    top_products: topProducts,\n    from,\n    to,\n    granularity\n  }, {}, req);\n}\n\n// ===================================================================\n// PUBLIC: Get My Orders (Customer)\n// ===================================================================\n\nasync function getMyOrders(req, env) {\n  console.log('[GET-MY-ORDERS] Request received');\n\n  const auth = await authenticateCustomer(req, env);\n\n  // Allow phone fallback from query params\n  const url = new URL(req.url);\n  const phoneFallback = (url.searchParams.get('phone') || req.headers.get('x-customer-phone') || '').trim();\n\n  if (!auth.customerId && !phoneFallback) {\n    return json({\n      ok: false,\n      error: 'Unauthorized',\n      message: 'Vui l\u00F2ng \u0111\u0103ng nh\u1EADp'\n    }, { status: 401 }, req);\n  }\n\n  // Load all orders\n  let allOrders = await getJSON(env, 'orders:list', []);\n\n  // Enrich orders missing items\n  const enriched = [];\n  for (const order of allOrders) {\n    if (!order.items) {\n      const full = await getJSON(env, 'order:' + order.id, null);\n      enriched.push(full || order);\n    } else {\n      enriched.push(order);\n    }\n  }\n  allOrders = enriched;\n\n  console.log('[GET-MY-ORDERS] Total orders before filter:', allOrders.length);\n\n  // Prepare filter criteria\n  const pPhone = normalizePhone(phoneFallback || auth.customer?.phone || auth.customer?.mobile || '');\n  const pId = auth.customerId;\n  const pEmail = auth.customer?.email || '';\n\n  // Filter orders\n  const myOrders = allOrders.filter(order => {\n    const oc = order.customer || {};\n    const orderPhone = normalizePhone(oc.phone || order.phone || '');\n    const orderId = oc.id || oc.customer_id || '';\n    const orderEmail = String(oc.email || order.email || '').toLowerCase();\n\n    const eq = (a, b) => String(a).toLowerCase() === String(b).toLowerCase();\n\n    return (\n      (pPhone && orderPhone && orderPhone === pPhone) ||\n      (pId && orderId && eq(orderId, pId)) ||\n      (pEmail && orderEmail && eq(orderEmail, pEmail))\n    );\n  });\n\n  myOrders.sort((a, b) => Number(b.createdAt || b.created_at || 0) - Number(a.createdAt || a.created_at || 0));\n\n  console.log('[GET-MY-ORDERS] Filtered orders count:', myOrders.length);\n\n  return json({\n    ok: true,\n    orders: myOrders,\n    count: myOrders.length,\n    customer: auth.customer || null\n  }, {}, req);\n}\n\n// ===================================================================\n// PUBLIC: Cancel Order (Customer)\n// ===================================================================\n\nasync function cancelOrderCustomer(req, env) {\n  try {\n    const body = await readBody(req) || {};\n    const orderId = body.order_id;\n\n    if (!orderId) {\n      return json({ ok: false, error: 'Missing order_id' }, { status: 400 }, req);\n    }\n\n    // Get order\n    const order = await getJSON(env, 'order:' + orderId, null);\n    if (!order) {\n      return json({ ok: false, error: 'Order not found' }, { status: 404 }, req);\n    }\n\n    // Check status: only allow cancel for pending/confirmed\n    const status = String(order.status || '').toLowerCase();\n    if (!status.includes('pending') && !status.includes('confirmed') && !status.includes('cho')) {\n      return json({ ok: false, error: 'Kh\u00F4ng th\u1EC3 h\u1EE7y \u0111\u01A1n h\u00E0ng n\u00E0y' }, { status: 400 }, req);\n    }\n\n    // Update status\n    order.status = ORDER_STATUS.CANCELLED;\n    order.cancelled_at = Date.now();\n    order.cancelled_by = 'customer';\n\n    // Restore inventory if needed\n    if (shouldAdjustStock(status)) {\n      await adjustInventory(normalizeOrderItems(order.items), env, +1);\n    }\n\n    // Cancel waybill if exists\n    if (order.superai_code || order.tracking_code) {\n      try {\n        await cancelWaybill({\n          body: JSON.stringify({ superai_code: order.superai_code || order.tracking_code }),\n          headers: req.headers\n        }, env);\n        order.tracking_code = 'CANCELLED';\n      } catch (e) {\n        console.warn('[CANCEL-ORDER] Failed to cancel waybill:', e.message);\n      }\n    }\n\n    // Save\n    await putJSON(env, 'order:' + orderId, order);\n\n    const list = await getJSON(env, 'orders:list', []);\n    const index = list.findIndex(o => o.id === orderId);\n    if (index > -1) {\n      list[index] = order;\n      await putJSON(env, 'orders:list', list);\n    }\n\n    return json({ ok: true, message: '\u0110\u00E3 h\u1EE7y \u0111\u01A1n h\u00E0ng' }, {}, req);\n\n  } catch (e) {\n    console.error('[CANCEL-ORDER] Error:', e);\n    return json({ ok: false, error: e.message }, { status: 500 }, req);\n  }\n}", "// ===================================================================\n// modules/products.js - Products Module (FIXED CATEGORY)\n// \u0110\u01B0\u1EDDng d\u1EABn: workers/shv-api/src/modules/products.js\n// ===================================================================\n\nimport { json, errorResponse } from '../lib/response.js';\nimport { adminOK } from '../lib/auth.js';\nimport { getJSON, putJSON } from '../lib/kv.js';\nimport { readBody, slugify } from '../lib/utils.js';\n\n/**\n * Main handler for all product routes\n */\nexport async function handle(req, env, ctx) {\n  const url = new URL(req.url);\n  const path = url.pathname;\n  const method = req.method;\n\n  // ===== PUBLIC ROUTES =====\n\n  // Public: Get single product by ID (query param)\n  if (path === '/products' && method === 'GET') {\n    const productId = url.searchParams.get('id');\n    if (productId) {\n      return getProductById(req, env, productId);\n    }\n    return listPublicProducts(req, env);\n  }\n\n  // Public: Get product by ID (path param)\n  if (path.startsWith('/products/') && method === 'GET') {\n    const id = decodeURIComponent(path.split('/')[2] || '').trim();\n    if (!id) {\n      return errorResponse('No product ID provided', 400, req);\n    }\n    return getProductById(req, env, id);\n  }\n\n  // Public: Get product by ID (alternative path)\n  if (path.startsWith('/public/products/') && method === 'GET') {\n    const id = decodeURIComponent(path.split('/')[3] || '').trim();\n    if (!id) {\n      return errorResponse('No product ID provided', 400, req);\n    }\n    return getProductById(req, env, id);\n  }\n\n  // Public: List products with filters\n  if (path === '/public/products' && method === 'GET') {\n    const productId = url.searchParams.get('id');\n    if (productId) {\n      return getProductById(req, env, productId);\n    }\n    return listPublicProductsFiltered(req, env);\n  }\n\n  // ===== ADMIN ROUTES =====\n\n  // Admin: List all products\n  // FIX: Handle both /admin/products AND /admin/products/list\n  if ((path === '/admin/products' || path === '/admin/products/list') && method === 'GET') {\n    return listAdminProducts(req, env);\n  }\n\n  // Admin: Get single product\n  if ((path === '/admin/products/get' || path === '/product') && method === 'GET') {\n    return getAdminProduct(req, env);\n  }\n\n  // Admin: Upsert product\n  if ((path === '/admin/products/upsert' || path === '/admin/product') && method === 'POST') {\n    return upsertProduct(req, env);\n  }\n\n  // Admin: Delete product\n  if (path === '/admin/products/delete' && method === 'POST') {\n    return deleteProduct(req, env);\n  }\n\n  return errorResponse('Route not found', 404, req);\n}\n\n// ===================================================================\n// HELPER FUNCTIONS\n// ===================================================================\n\n/**\n * \u2705 Convert product to summary (lightweight version)\n */\nfunction toSummary(product) {\n  return {\n    id: product.id,\n    title: product.title || product.name || '',\n    name: product.title || product.name || '',\n    slug: product.slug || slugify(product.title || product.name || ''),\n    sku: product.sku || '',\n    price: product.price || 0,\n    price_sale: product.price_sale || 0,\n    price_wholesale: product.price_wholesale || 0, // \u2705 TH\u00CAM D\u00D2NG N\u00C0Y\n    stock: product.stock || 0,\n    images: product.images || [],\n    category: product.category || '',\n    category_slug: product.category_slug || product.category || '',\n    status: (product.status === 0 ? 0 : 1)\n  };\n}\n\n/**\n * Build products list from KV\n */\nasync function listProducts(env) {\n  const LIST_KEY = 'products:list';\n  const DETAIL_PREFIX = 'product:';\n  console.log('[listProducts] \uD83D\uDE80 B\u1EAFt \u0111\u1EA7u...'); // LOG M\u1EDAI\n\n  try { // TH\u00CAM TRY...CATCH BAO QUANH\n    // Try to get cached list first\n    console.log(`[listProducts] \u0110ang \u0111\u1ECDc danh s\u00E1ch cache: ${LIST_KEY}`); // LOG M\u1EDAI\n    let list = null;\n    try { // TRY...CATCH RI\u00CANG CHO getJSON LIST\n      list = await getJSON(env, LIST_KEY, null);\n    } catch (e) {\n      console.error(`[listProducts] \u274C L\u1ED7i khi \u0111\u1ECDc danh s\u00E1ch cache ${LIST_KEY}:`, e.message); // LOG M\u1EDAI\n      list = null; // \u0110\u1EA3m b\u1EA3o list l\u00E0 null n\u1EBFu l\u1ED7i\n    }\n\n    if (list && Array.isArray(list) && list.length > 0) {\n      console.log(`[listProducts] \u2705 Tr\u1EA3 v\u1EC1 ${list.length} s\u1EA3n ph\u1EA9m t\u1EEB cache`); // LOG M\u1EDAI\n      return list;\n    } else {\n      console.log(`[listProducts] \u26A0\uFE0F Cache tr\u1ED1ng ho\u1EB7c kh\u00F4ng h\u1EE3p l\u1EC7, s\u1EBD t\u1EA1o l\u1EA1i t\u1EEB chi ti\u1EBFt`); // LOG M\u1EDAI\n    }\n\n    // Fallback: build from individual product keys\n    const items = [];\n    let cursor = undefined; // KH\u1EDEI T\u1EA0O CURSOR = undefined\n\n    console.log(`[listProducts] \uD83D\uDD0D B\u1EAFt \u0111\u1EA7u li\u1EC7t k\u00EA c\u00E1c key c\u00F3 ti\u1EC1n t\u1ED1 '${DETAIL_PREFIX}'`); // LOG M\u1EDAI\n    let iteration = 0; // \u0110\u1EBFm s\u1ED1 l\u1EA7n l\u1EB7p\n\n    do {\n      iteration++;\n      console.log(`[listProducts]   - L\u1EA7n l\u1EB7p ${iteration}, cursor: ${cursor ? '...' : 'none'}`); // LOG M\u1EDAI\n      let result = null;\n      try { // TRY...CATCH RI\u00CANG CHO LIST KEYS\n        result = await env.SHV.list({ prefix: DETAIL_PREFIX, cursor: cursor });\n      } catch (e) {\n        console.error(`[listProducts] \u274C L\u1ED7i khi li\u1EC7t k\u00EA key (l\u1EA7n l\u1EB7p ${iteration}):`, e.message); // LOG M\u1EDAI\n        throw new Error(`L\u1ED7i khi li\u1EC7t k\u00EA key KV: ${e.message}`); // N\u00E9m l\u1ED7i \u0111\u1EC3 d\u1EEBng l\u1EA1i\n      }\n\n      console.log(`[listProducts]   - T\u00ECm th\u1EA5y ${result.keys.length} key, list_complete: ${result.list_complete}`); // LOG M\u1EDAI\n\n      for (const key of result.keys) {\n        try { // TRY...CATCH RI\u00CANG CHO getJSON DETAIL\n          const product = await getJSON(env, key.name, null);\n          if (product) {\n            product.id = product.id || key.name.slice(DETAIL_PREFIX.length);\n            items.push(toSummary(product));\n          } else {\n            console.warn(`[listProducts]     - \u26A0\uFE0F D\u1EEF li\u1EC7u cho key ${key.name} b\u1ECB tr\u1ED1ng`); // LOG M\u1EDAI\n          }\n        } catch (e) {\n          console.error(`[listProducts]     - \u274C L\u1ED7i khi \u0111\u1ECDc s\u1EA3n ph\u1EA9m ${key.name}:`, e.message); // LOG M\u1EDAI\n          continue; // B\u1ECF qua s\u1EA3n ph\u1EA9m l\u1ED7i\n        }\n      }\n\n      cursor = result.list_complete ? null : result.cursor;\n    } while (cursor);\n\n    console.log(`[listProducts] \u2705 \u0110\u00E3 t\u1EA1o l\u1EA1i ${items.length} s\u1EA3n ph\u1EA9m t\u1EEB chi ti\u1EBFt`); // LOG M\u1EDAI\n\n    // Cache the list\n    if (items.length > 0) {\n      try { // TRY...CATCH RI\u00CANG CHO putJSON LIST\n        console.log(`[listProducts] \uD83D\uDCBE \u0110ang l\u01B0u danh s\u00E1ch \u0111\u00E3 t\u1EA1o v\u00E0o cache ${LIST_KEY}`); // LOG M\u1EDAI\n        await putJSON(env, LIST_KEY, items);\n        console.log(`[listProducts] \u2705 L\u01B0u cache th\u00E0nh c\u00F4ng`); // LOG M\u1EDAI\n      } catch (e) {\n        console.error(`[listProducts] \u274C L\u1ED7i khi l\u01B0u cache:`, e.message); // LOG M\u1EDAI\n        // Kh\u00F4ng n\u00E9m l\u1ED7i, v\u1EABn tr\u1EA3 v\u1EC1 danh s\u00E1ch \u0111\u00E3 t\u1EA1o\n      }\n    }\n\n    return items;\n\n  } catch (e) { // CATCH CHO TO\u00C0N B\u1ED8 H\u00C0M\n    console.error(`[listProducts] \uD83D\uDCA5 X\u1EA3y ra l\u1ED7i nghi\u00EAm tr\u1ECDng:`, e); // LOG M\u1EDAI\nthrow e; // N\u00E9m l\u1EA1i l\u1ED7i \u0111\u1EC3 h\u00E0m g\u1ECDi (listAdminProducts) b\u1EAFt \u0111\u01B0\u1EE3c v\u00E0 tr\u1EA3 v\u1EC1 500\n  }\n} \n\n/**\n * \u2705 Category matching helper (FIXED)\n */\nfunction toSlug(input) {\n  const text = String(input || '').normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\n  return text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)+/g, '');\n}\n\nfunction collectCategoryValues(product) {\n  const values = [];\n  const push = (v) => { \n    if (v !== undefined && v !== null && v !== '') values.push(v); \n  };\n\n  // \u2705 FIX: L\u1EA5y t\u1EEB product tr\u1EF1c ti\u1EBFp tr\u01B0\u1EDBc\n  push(product.category);\n  push(product.category_slug);\n  push(product.cate);\n  push(product.categoryId);\n  \n  const raw = (product && product.raw) || {};\n  const meta = product?.meta || raw?.meta || {};\n\n  [raw, meta].forEach(obj => {\n    if (!obj) return;\n    push(obj.category);\n    push(obj.category_slug);\n    push(obj.cate);\n    push(obj.categoryId);\n    push(obj.group);\n    push(obj.group_slug);\n    push(obj.type);\n    push(obj.collection);\n  });\n\n  if (Array.isArray(product?.categories)) values.push(...product.categories);\n  if (Array.isArray(raw?.categories)) values.push(...raw.categories);\n  if (Array.isArray(product?.tags)) values.push(...product.tags);\n  if (Array.isArray(raw?.tags)) values.push(...raw.tags);\n\n  return values.flatMap(v => {\n    if (Array.isArray(v)) {\n      return v.map(x => toSlug(x?.slug || x?.code || x?.name || x?.title || x?.label || x?.text || x));\n    }\n    if (typeof v === 'object') {\n      return [toSlug(v?.slug || v?.code || v?.name || v?.title || v?.label || v?.text)];\n    }\n    return [toSlug(v)];\n  }).filter(Boolean);\n}\n\nfunction matchCategoryStrict(product, category) {\n  if (!category) return true;\n\n  const want = toSlug(category);\n  \n  // Category aliases for Vietnamese\n  const alias = {\n    'dien-nuoc': ['\u0111i\u1EC7n & n\u01B0\u1EDBc', '\u0111i\u1EC7n n\u01B0\u1EDBc', 'dien nuoc', 'thiet bi dien nuoc'],\n    'nha-cua-doi-song': ['nh\u00E0 c\u1EEDa \u0111\u1EDDi s\u1ED1ng', 'nha cua doi song', 'do gia dung'],\n    'hoa-chat-gia-dung': ['ho\u00E1 ch\u1EA5t gia d\u1EE5ng', 'hoa chat gia dung', 'hoa chat'],\n    'dung-cu-thiet-bi-tien-ich': ['d\u1EE5ng c\u1EE5 thi\u1EBFt b\u1ECB ti\u1EC7n \u00EDch', 'dung cu thiet bi tien ich', 'dung cu tien ich']\n  };\n\n  const wants = [want, ...(alias[want] || []).map(toSlug)];\n  const candidates = collectCategoryValues(product);\n\n  console.log('\uD83D\uDD0D Matching:', { \n    productId: product.id, \n    want, \n    candidates: candidates.slice(0, 5),\n    match: candidates.some(v => wants.includes(v))\n  });\n\n  return candidates.some(v => wants.includes(v));\n}\n// ---- Price Tier Helpers (variant-only pricing) ----\nfunction getCustomerTier(req) {\n  try {\n    const url = new URL(req.url);\n    const h = (req.headers.get('x-customer-tier') || req.headers.get('x-price-tier') || '').toLowerCase().trim();\n    if (h) return h;\n    const q = (url.searchParams.get('tier') || '').toLowerCase().trim();\n    if (q) return q;\n    return 'retail';\n  } catch { return 'retail'; }\n}\n\n// Only compute from variants; no product-level fallback\nfunction computeDisplayPrice(product, tier) {\n  try {\n    const toNum = (x) => (typeof x === 'string' ? (Number(x.replace(/[^\\d.-]/g, '')) || 0) : Number(x || 0));\n    const vars = Array.isArray(product?.variants) ? product.variants : [];\n\n    if (!vars.length) {\n      return { price_display: 0, compare_at_display: null, price_tier: tier, no_variant: true };\n    }\n\n    let minSale = null;\n    let minReg  = null;\n\n    for (const v of vars) {\n      // N\u1EBFu c\u00F3 field d\u00E0nh cho wholesale \u1EDF bi\u1EBFn th\u1EC3, t\u1EF1 ph\u00E1t hi\u1EC7n; n\u1EBFu kh\u00F4ng c\u00F3 v\u1EABn d\u00F9ng sale_price/price\n      const svTier = (tier === 'wholesale')\n        ? (v.sale_price_wholesale ?? v.wholesale_sale_price ?? null)\n        : null;\n      const rvTier = (tier === 'wholesale')\n        ? (v.price_wholesale ?? v.wholesale_price ?? null)\n        : null;\n\n      const sv = toNum(svTier ?? v.sale_price ?? v.price_sale);\n      const rv = toNum(rvTier ?? v.price);\n\n      if (sv > 0) minSale = (minSale == null ? sv : Math.min(minSale, sv));\n      if (rv > 0) minReg  = (minReg  == null ? rv : Math.min(minReg,  rv));\n    }\n\n    if (minSale != null && minReg != null && minSale < minReg) {\n      return { price_display: minSale, compare_at_display: minReg, price_tier: tier };\n    }\n\n    const price = (minSale != null ? minSale : (minReg != null ? minReg : 0));\n    return { price_display: price, compare_at_display: null, price_tier: tier };\n  } catch {\n    return { price_display: 0, compare_at_display: null, price_tier: tier };\n  }\n}\n\n// ===================================================================\n// PUBLIC: Get Product by ID\n// ===================================================================\n\nasync function getProductById(req, env, productId) {\n  try {\n    // Try to get from KV directly\n    let product = await getJSON(env, 'product:' + productId, null);\n\n    if (!product) {\n      // Fallback: search in list\n      const list = await listProducts(env);\n      product = list.find(p => String(p.id || p.key || '') === String(productId));\n\n      if (product) {\n        // Try to get full version from KV\n        const cached = await getJSON(env, 'product:' + product.id, null);\n        if (cached) product = cached;\n      }\n    }\n\n    if (!product) {\n      return json({ \n        ok: false, \n        error: 'Product not found' \n      }, { status: 404 }, req);\n    }\n\n    const tier = getCustomerTier(req);\n    const priced = { ...product, ...computeDisplayPrice(product, tier) };\n    console.log('[PRICE] getProductById', { id: productId, tier, price: priced.price_display, compare_at: priced.compare_at_display });\n    return json({ ok: true, item: priced }, {}, req);\n  } catch (e) {\n    return errorResponse(e, 500, req);\n  }\n}\n\n// ===================================================================\n// PUBLIC: List Products\n// ===================================================================\n\nasync function listPublicProducts(req, env) {\n  try {\n    // L\u1EA5y danh s\u00E1ch summary (id, title, ...)\n    const list = await listProducts(env);\n    const actives = list.filter(p => p.status !== 0);\n\n    // \uD83D\uDD25 N\u1EA1p FULL t\u1EEB KV theo t\u1EEBng id \u0111\u1EC3 c\u00F3 variants\n    const full = [];\n    for (const s of actives) {\n      const id = String(s.id || s.key || '');\n      const p  = id ? (await getJSON(env, 'product:' + id, null)) : null;\n      full.push(p || s); // n\u1EBFu thi\u1EBFu full th\u00EC d\u00F9ng summary\n    }\n\n    // T\u00EDnh gi\u00E1 t\u1EEB variants\n    const tier  = getCustomerTier(req);\n    const items = full.map(p => ({ ...p, ...computeDisplayPrice(p, tier) }));\n\n    console.log('[PRICE] listPublicProducts', { tier, count: items.length, sample: { id: items[0]?.id, price: items[0]?.price_display } });\n    return json({ ok: true, items }, {}, req);\n  } catch (e) {\n    return errorResponse(e, 500, req);\n  }\n}\n\nasync function listPublicProductsFiltered(req, env) {\n  try {\n    const url = new URL(req.url);\n    const category = url.searchParams.get('category') ||\n                     url.searchParams.get('cat') ||\n                     url.searchParams.get('category_slug') ||\n                     url.searchParams.get('c') || '';\n    const limit = Number(url.searchParams.get('limit') || '24');\n\n    // L\u1EA5y danh s\u00E1ch summary\n    let data  = await listProducts(env);\n    let items = Array.isArray(data?.items) ? data.items.slice()\n               : Array.isArray(data) ? data.slice() : [];\n\n    // L\u1ECDc theo category (n\u1EBFu c\u00F3)\n    if (category) {\n      const before = items.length;\n      items = items.filter(product => matchCategoryStrict(product, category));\n      console.log(`\u2705 Category \"${category}\": ${before} \u2192 ${items.length}`);\n    }\n\n    // Ch\u1EC9 l\u1EA5y s\u1EA3n ph\u1EA9m active\n    items = items.filter(p => p.status !== 0);\n\n    // \uD83D\uDD25 N\u1EA1p FULL t\u1EEB KV cho c\u00E1c item hi\u1EC3n th\u1ECB (sau filter)\n    const limited = items.slice(0, limit);\n    const full = [];\n    for (const s of limited) {\n      const id = String(s.id || s.key || '');\n      const p  = id ? (await getJSON(env, 'product:' + id, null)) : null;\n      full.push(p || s);\n    }\n\n    // T\u00EDnh gi\u00E1 t\u1EEB variants\n    const tier = getCustomerTier(req);\n    const out  = full.map(p => ({ ...p, ...computeDisplayPrice(p, tier) }));\n\n    console.log('[PRICE] listPublicProductsFiltered', { tier, in: items.length, out: out.length, cat: category, sample: { id: out[0]?.id, price: out[0]?.price_display } });\n    return json({ ok: true, items: out }, {}, req);\n  } catch (e) {\n    console.error('\u274C Error:', e);\n    return errorResponse(e, 500, req);\n  }\n}\n\n// ===================================================================\n// ADMIN: List All Products\n// ===================================================================\n\nasync function listAdminProducts(req, env) {\n  // \u26A0\uFE0F T\u1EA1m b\u1ECF x\u00E1c th\u1EF1c khi n\u1EA1p d\u1EEF li\u1EC7u\n  // if (!(await adminOK(req, env))) {\n  //   return errorResponse('Unauthorized', 401, req);\n  // }\n\n  try {\n    const list = await listProducts(env);\n    return json({ ok: true, items: list }, {}, req);\n  } catch (e) {\n    return errorResponse(e, 500, req);\n  }\n}\n\n\n// ===================================================================\n// ADMIN: Get Single Product\n// ===================================================================\n\nasync function getAdminProduct(req, env) {\n  const url = new URL(req.url);\n  const id = url.searchParams.get('id');\n  const slug = url.searchParams.get('slug');\n\n  if (!id && !slug) {\n    return errorResponse('Missing id or slug parameter', 400, req);\n  }\n\n  try {\n    let product = null;\n\n    // Try to get by ID first\n    if (id) {\n      product = await getJSON(env, 'product:' + id, null);\n    }\n\n    // Fallback: search by slug\n    if (!product && slug) {\n      const list = await listProducts(env);\n      const item = list.find(p => p.slug === slug);\n      if (item) {\n        product = await getJSON(env, 'product:' + item.id, null);\n      }\n    }\n\n    if (!product) {\n      return json({ \n        ok: false, \n        error: 'Product not found' \n      }, { status: 404 }, req);\n    }\n\n    return json({ ok: true, data: product }, {}, req);\n  } catch (e) {\n    return errorResponse(e, 500, req);\n  }\n}\n\n// ===================================================================\n// ADMIN: Upsert Product\n// ===================================================================\n\nasync function upsertProduct(req, env) {\n  if (!(await adminOK(req, env))) {\n    return errorResponse('Unauthorized', 401, req);\n  }\n\n  try {\n    const product = await readBody(req) || {};\n    \n    // Generate ID if not exists\n    product.id = product.id || crypto.randomUUID().replace(/-/g, '');\n    \n    // Update timestamp\n    product.updatedAt = Date.now();\n    \n    // Auto-generate slug if not provided\n    if (!product.slug && (product.title || product.name)) {\n      product.slug = slugify(product.title || product.name);\n    }\n\n    // \u2705 FIX: \u0110\u1EA3m b\u1EA3o category_slug \u0111\u01B0\u1EE3c l\u01B0u\n    if (!product.category_slug && product.category) {\n      product.category_slug = toSlug(product.category);\n    }\n\n    console.log('\uD83D\uDCBE Saving product:', {\n      id: product.id,\n      name: product.title || product.name,\n      category: product.category,\n      category_slug: product.category_slug\n    });\n\n    // Get current products list\n    const list = await listProducts(env);\n    \n    // Create summary version\n    const summary = toSummary(product);\n    \n    // Update or add to list\n    const index = list.findIndex(p => p.id === product.id);\n    if (index >= 0) {\n      list[index] = summary;\n    } else {\n      list.unshift(summary);\n    }\n\n    // Save to KV\n    await putJSON(env, 'products:list', list);\n    await putJSON(env, 'product:' + product.id, product);\n    \n    // Legacy compatibility\n    await putJSON(env, 'products:' + product.id, summary);\n\n    console.log('\u2705 Product saved');\n\n    return json({ ok: true, data: product }, {}, req);\n  } catch (e) {\n    console.error('\u274C Save error:', e);\n    return errorResponse(e, 500, req);\n  }\n}\n\n// ===================================================================\n// ADMIN: Delete Product\n// ===================================================================\n\nasync function deleteProduct(req, env) {\n  if (!(await adminOK(req, env))) {\n    return errorResponse('Unauthorized', 401, req);\n  }\n\n  try {\n    const body = await readBody(req) || {};\n    const id = body.id;\n\n    if (!id) {\n      return errorResponse('Product ID is required', 400, req);\n    }\n\n    // Get current list\n    const list = await listProducts(env);\n    \n    // Filter out deleted product\n    const newList = list.filter(p => p.id !== id);\n\n    // Save updated list\n    await putJSON(env, 'products:list', newList);\n    \n    // Delete from KV\n    await env.SHV.delete('product:' + id);\n    await env.SHV.delete('products:' + id);\n\n    return json({ ok: true, deleted: id }, {}, req);\n  } catch (e) {\n    return errorResponse(e, 500, req);\n  }\n} // <<< TH\u00CAM D\u1EA4U } N\u00C0Y \u0110\u1EC2 \u0110\u00D3NG H\u00C0M deleteProduct\n\nconsole.log('\u2705 products.js loaded - CATEGORY FILTER FIXED');\n// <<< Cu\u1ED1i file >>>", "// ===================================================================\r\n// modules/webhook-handler.js - X\u1EED l\u00FD Webhook t\u1EEB SuperAI\r\n// ===================================================================\r\n\r\nimport { json, errorResponse } from '../lib/response.js';\r\nimport { getJSON, putJSON } from '../lib/kv.js';\r\nimport { readBody } from '../lib/utils.js';\r\n\r\n// H\u00E0m x\u1EED l\u00FD ch\u00EDnh khi SuperAI g\u1ECDi webhook\r\nexport async function handleSuperAIWebhook(req, env) {\r\n  // Ch\u1EC9 ch\u1EA5p nh\u1EADn ph\u01B0\u01A1ng th\u1EE9c POST\r\n  if (req.method !== 'POST') {\r\n    return errorResponse('Method Not Allowed', 405, req);\r\n  }\r\n\r\n  try {\r\n    const body = await readBody(req);\r\n    console.log('[Webhook] Received:', JSON.stringify(body, null, 2));\r\n\r\n    // Ki\u1EC3m tra c\u1EA5u tr\u00FAc c\u01A1 b\u1EA3n c\u1EE7a webhook\r\n    if (!body || body.type !== 'update_status' || !body.code || !body.status || !body.status_name) {\r\n      console.warn('[Webhook] Invalid payload structure:', body);\r\n      // V\u1EABn tr\u1EA3 v\u1EC1 200 OK \u0111\u1EC3 SuperAI kh\u00F4ng g\u1EEDi l\u1EA1i\r\n      return json({ ok: true, message: 'Received, but ignored (invalid structure)' }, {}, req);\r\n    }\r\n\r\n    const superaiCode = body.code; // M\u00E3 \u0111\u01A1n h\u00E0ng SuperAI (CTOS...)\r\n    const newStatus = String(body.status); // M\u00E3 tr\u1EA1ng th\u00E1i m\u1EDBi (s\u1ED1)\r\n    const newStatusName = body.status_name; // T\u00EAn tr\u1EA1ng th\u00E1i m\u1EDBi\r\n\r\n    // ----- T\u00ECm \u0111\u01A1n h\u00E0ng trong KV -----\r\n    const list = await getJSON(env, 'orders:list', []);\r\n    let orderId = null;\r\n    let orderIndex = -1;\r\n\r\n    // T\u00ECm trong danh s\u00E1ch d\u1EF1a tr\u00EAn superai_code\r\n    orderIndex = list.findIndex(o => o.superai_code === superaiCode);\r\n\r\n    if (orderIndex === -1) {\r\n      // N\u1EBFu kh\u00F4ng th\u1EA5y, th\u1EED t\u00ECm theo tracking_code (c\u00F3 th\u1EC3 tr\u01B0\u1EDBc \u0111\u00F3 l\u01B0u nh\u1EA7m)\r\n      orderIndex = list.findIndex(o => o.tracking_code === superaiCode || o.shipping_tracking === superaiCode);\r\n    }\r\n\r\n    if (orderIndex === -1) {\r\n      console.warn('[Webhook] Order not found in list for superai_code:', superaiCode);\r\n      // V\u1EABn tr\u1EA3 v\u1EC1 200 OK\r\n      return json({ ok: true, message: 'Received, but order not found in list' }, {}, req);\r\n    }\r\n\r\n    orderId = list[orderIndex].id;\r\n\r\n    // ----- C\u1EADp nh\u1EADt tr\u1EA1ng th\u00E1i -----\r\n    let updated = false;\r\n\r\n    // 1. C\u1EADp nh\u1EADt trong danh s\u00E1ch (orders:list)\r\n    if (list[orderIndex].status !== newStatusName.toLowerCase()) {\r\n      list[orderIndex].status = newStatusName.toLowerCase(); // L\u01B0u t\u00EAn tr\u1EA1ng th\u00E1i cho d\u1EC5 \u0111\u1ECDc\r\n      list[orderIndex].status_code_superai = newStatus; // L\u01B0u c\u1EA3 m\u00E3 tr\u1EA1ng th\u00E1i\r\n      list[orderIndex].last_webhook_update = new Date().toISOString();\r\n      updated = true;\r\n      console.log(`[Webhook] Updating list for order ${orderId}: status -> ${newStatusName}`);\r\n    }\r\n\r\n    // 2. C\u1EADp nh\u1EADt trong chi ti\u1EBFt \u0111\u01A1n h\u00E0ng (order:<id>)\r\n    if (orderId) {\r\n      const order = await getJSON(env, 'order:' + orderId, null);\r\n      if (order && order.status !== newStatusName.toLowerCase()) {\r\n        order.status = newStatusName.toLowerCase();\r\n        order.status_code_superai = newStatus;\r\n        order.last_webhook_update = new Date().toISOString();\r\n        // L\u01B0u th\u00EAm c\u00E1c th\u00F4ng tin kh\u00E1c t\u1EEB webhook n\u1EBFu c\u1EA7n\r\n        order.webhook_history = order.webhook_history || [];\r\n        order.webhook_history.push({\r\n          status: newStatus,\r\n          status_name: newStatusName,\r\n          reason_code: body.reason_code,\r\n          reason_text: body.reason_text,\r\n          partial: body.partial,\r\n          barter: body.barter,\r\n          pushed_at: body.pushed_at,\r\n          received_at: new Date().toISOString()\r\n        });\r\n        await putJSON(env, 'order:' + orderId, order);\r\n        updated = true;\r\n        console.log(`[Webhook] Updating detail for order ${orderId}: status -> ${newStatusName}`);\r\n      } else if (!order) {\r\n        console.warn('[Webhook] Order detail not found for ID:', orderId);\r\n      }\r\n    }\r\n\r\n    // L\u01B0u l\u1EA1i danh s\u00E1ch n\u1EBFu c\u00F3 thay \u0111\u1ED5i\r\n    if (updated) {\r\n      await putJSON(env, 'orders:list', list);\r\n    } else {\r\n      console.log('[Webhook] No status change needed for superai_code:', superaiCode);\r\n    }\r\n\r\n    // Lu\u00F4n tr\u1EA3 v\u1EC1 200 OK cho SuperAI\r\n    return json({ ok: true, message: 'Webhook processed successfully' }, {}, req);\r\n\r\n  } catch (e) {\r\n    console.error('[Webhook] Exception:', e);\r\n    // V\u1EABn tr\u1EA3 v\u1EC1 200 OK \u0111\u1EC3 SuperAI kh\u00F4ng b\u1ECB l\u1ED7i v\u00E0 g\u1EEDi l\u1EA1i li\u00EAn t\u1EE5c\r\n    return json({ ok: true, message: `Webhook processed with error: ${e.message}` }, {}, req);\r\n  }\r\n}", "// ===================================================================\n// modules/shipping/areas.js - Province/District/Ward\n// ===================================================================\n\nimport { json } from '../../lib/response.js';\nimport { superFetch } from './helpers.js';\n\nexport async function handle(req, env, ctx) {\n  const url = new URL(req.url);\n  const path = url.pathname;\n\n  // \u2705 Full areas tree (Province -> District -> Commune)\n  if (path === '/public/shipping/areas' || \n      path === '/shipping/areas') {\n    return getAllAreas(req, env, ctx);\n  }\n\n  // Provinces\n  if (path === '/shipping/provinces' || \n      path === '/shipping/areas/province' ||\n      path === '/api/addresses/province' ||\n      path === '/v1/platform/areas/province') {\n    return getProvinces(req, env);\n  }\n\n  // Districts\n  if (path === '/shipping/districts' || \n      path === '/shipping/areas/district' ||\n      path === '/api/addresses/district' ||\n      path === '/v1/platform/areas/district') {\n    return getDistricts(req, env);\n  }\n\n  // Wards/Communes\n  if (path === '/shipping/wards' || \n      path === '/shipping/areas/commune' ||\n      path === '/api/addresses/commune' ||\n      path === '/v1/platform/areas/commune') {\n    return getWards(req, env);\n  }\n\n  return json({ ok: false, error: 'Not found' }, { status: 404 }, req);\n}\n\nasync function getProvinces(req, env) {\n  try {\n    const data = await superFetch(env, '/v1/platform/areas/province', { \n      method: 'GET' \n    });\n\n    const items = normalizeAreaData(data);\n    return json({ ok: true, items, data: items }, {}, req);\n  } catch (e) {\n    return json({ \n      ok: false, \n      error: String(e?.message || e) \n    }, { status: 500 }, req);\n  }\n}\n\nasync function getDistricts(req, env) {\n  const url = new URL(req.url);\n  const province = url.searchParams.get('province_code') || \n                  url.searchParams.get('province') || '';\n\n  try {\n    const data = await superFetch(env, \n      '/v1/platform/areas/district?province=' + encodeURIComponent(province), \n      { method: 'GET' }\n    );\n\n    const items = normalizeAreaData(data);\n    return json({ ok: true, items, data: items, province }, {}, req);\n  } catch (e) {\n    return json({ \n      ok: false, \n      error: String(e?.message || e) \n    }, { status: 500 }, req);\n  }\n}\n\nasync function getWards(req, env) {\n  const url = new URL(req.url);\n  const district = url.searchParams.get('district_code') || \n                  url.searchParams.get('district') || '';\n\n  try {\n    const data = await superFetch(env, \n      '/v1/platform/areas/commune?district=' + encodeURIComponent(district), \n      { method: 'GET' }\n    );\n\n    const items = normalizeAreaData(data);\n    return json({ ok: true, items, data: items, district }, {}, req);\n  } catch (e) {\n    return json({ \n      ok: false, \n      error: String(e?.message || e) \n    }, { status: 500 }, req);\n  }\n}\n\nfunction normalizeAreaData(data) {\n  const source = data?.data || data || [];\n  return source.map(item => ({\n    code: String(item.code || item.id || item.value || ''),\n    name: item.name || item.text || ''\n  }));\n}\n\n// \u2705 NEW FUNCTION - Get all areas with full tree structure\n/**\n * Get all areas with full tree structure\n * Route: GET /public/shipping/areas\n * Returns: { ok: true, areas: [{ code, name, province_code, districts: [...] }] }\n */\nasync function getAllAreas(req, env, ctx) {\n  try {\n    console.log('[Areas] Loading all provinces with districts...');\n\n    // L\u1EA5y danh s\u00E1ch t\u1EA5t c\u1EA3 provinces\n    const data = await superFetch(env, '/v1/platform/areas/province', { \n      method: 'GET' \n    });\n\n    const provinces = data?.data || data || [];\n    \n    // N\u1EBFu kh\u00F4ng c\u00F3 d\u1EEF li\u1EC7u, tr\u1EA3 v\u1EC1 m\u1EA3ng r\u1ED7ng\n    if (!Array.isArray(provinces) || provinces.length === 0) {\n      console.warn('[Areas] No provinces data from SuperAI API');\n      return json({ \n        ok: true, \n        areas: [],\n        data: [] \n      }, {}, req);\n    }\n\n    console.log(`[Areas] Found ${provinces.length} provinces, loading districts...`);\n\n    // L\u1EA5y chi ti\u1EBFt districts cho m\u1ED7i province (gi\u1EDBi h\u1EA1n 63 t\u1EC9nh VN)\n    const areasWithDetails = await Promise.all(\n      provinces.slice(0, 63).map(async (province) => {\n        try {\n          const provinceCode = String(province.code || province.province_code || '');\n          \n          if (!provinceCode) {\n            console.warn('[Areas] Province missing code:', province);\n            return {\n              code: '',\n              name: province.name || '',\n              province_code: '',\n              districts: []\n            };\n          }\n\n          // L\u1EA5y districts cho province n\u00E0y\n          const districtData = await superFetch(env, \n            '/v1/platform/areas/district?province=' + encodeURIComponent(provinceCode), \n            { method: 'GET' }\n          );\n          \n          const districts = (districtData?.data || []).map(district => ({\n            code: String(district.code || district.district_code || ''),\n            name: district.name || '',\n            district_code: String(district.code || district.district_code || ''),\n            communes: [] // C\u00F3 th\u1EC3 load communes sau n\u1EBFu c\u1EA7n\n          }));\n\n          return {\n            code: provinceCode,\n            name: province.name || '',\n            province_code: provinceCode,\n            districts: districts\n          };\n\n        } catch (e) {\n          console.warn('[Areas] Error loading districts for province:', province.code, e.message);\n          return {\n            code: String(province.code || ''),\n            name: province.name || '',\n            province_code: String(province.code || ''),\n            districts: []\n          };\n        }\n      })\n    );\n\n    console.log('[Areas] \u2705 Loaded areas successfully');\n\n    return json({ \n      ok: true, \n      areas: areasWithDetails,\n      data: areasWithDetails \n    }, {}, req);\n\n  } catch (e) {\n    console.error('[Areas] \u274C Error fetching all areas:', e);\n    return json({ \n      ok: false, \n      error: String(e?.message || e),\n      message: 'Kh\u00F4ng th\u1EC3 t\u1EA3i danh s\u00E1ch khu v\u1EF1c',\n      areas: [],\n      data: []\n    }, { status: 500 }, req);\n  }\n}\n", "// ===================================================================\n// modules/shipping/warehouses.js - Warehouse Management\n// ===================================================================\n\nimport { json } from '../../lib/response.js';\nimport { superFetch } from './helpers.js';\n\nexport async function handle(req, env, ctx) {\n  if (req.method === 'GET' || req.method === 'POST') {\n    return getWarehouses(req, env);\n  }\n\n  return json({ ok: false, error: 'Method not allowed' }, { status: 405 }, req);\n}\n\nasync function getWarehouses(req, env) {\n  try {\n    console.log('[Warehouses] \uD83D\uDCE6 Fetching warehouses from SuperAI...');\n    \n    const data = await superFetch(env, '/v1/platform/warehouses', { \n      method: 'GET',\n      useBearer: false        // \u2705 G\u1EEDi header Token:, KH\u00D4NG d\u00F9ng Bearer\n    });\n\n    console.log('[Warehouses] \uD83D\uDCE5 Response received:', {\n      hasData: !!data,\n      isError: data?.error,\n      message: data?.message,\n      dataKeys: data ? Object.keys(data) : []\n    });\n\n    // Ki\u1EC3m tra l\u1ED7i t\u1EEB API\n    if (data?.error || data?.message?.includes('Token') || data?.message?.includes('ch\u01B0a \u0111\u00FAng')) {\n      console.error('[Warehouses] \u274C Token error:', data.message);\n      return json({ \n        ok: false, \n        items: [], \n        error: data.message || 'Token kh\u00F4ng h\u1EE3p l\u1EC7',\n        raw: data\n      }, { status: 400 }, req);\n    }\n\n    const items = normalizeWarehouses(data);\n    console.log('[Warehouses] \u2705 Normalized items count:', items.length);\n    \n    if (items.length === 0) {\n      console.warn('[Warehouses] \u26A0\uFE0F No warehouses found. Raw data:', JSON.stringify(data, null, 2));\n    }\n    \n    return json({ ok: true, items, raw: data }, {}, req);\n  } catch (e) {\n    console.error('[Warehouses] \u274C Exception:', e);\n    return json({ \n      ok: false, \n      items: [], \n      error: String(e?.message || e) \n    }, { status: 500 }, req);\n  }\n}\n\nfunction normalizeWarehouses(data) {\n  const source = [];\n  const pushArray = (arr) => { \n    if (Array.isArray(arr)) source.push(...arr); \n  };\n\n  pushArray(data);\n  pushArray(data?.data);\n  pushArray(data?.items);\n  pushArray(data?.data?.items);\n  pushArray(data?.warehouses);\n  pushArray(data?.data?.warehouses);\n\n  return source.map(warehouse => ({\n    id: warehouse.id || warehouse.code || '',\n    name: warehouse.name || warehouse.contact_name || warehouse.wh_name || '',\n    phone: warehouse.phone || warehouse.contact_phone || warehouse.wh_phone || '',\n    address: warehouse.address || warehouse.addr || warehouse.wh_address || '',\n    province_code: String(warehouse.province_code || warehouse.provinceId || warehouse.province_code_id || ''),\n    province_name: warehouse.province || warehouse.province_name || '',\n    district_code: String(warehouse.district_code || warehouse.districtId || ''),\n    district_name: warehouse.district || warehouse.district_name || '',\n    ward_code: String(warehouse.commune_code || warehouse.ward_code || ''),\n    ward_name: String(warehouse.commune || warehouse.ward || warehouse.ward_name || '')\n  }));\n}\n", "// ===================================================================\n// modules/shipping/pricing.js - Shipping Price/Quote\n// ===================================================================\n\nimport { json, errorResponse } from '../../lib/response.js';\nimport { getJSON } from '../../lib/kv.js';\nimport { readBody } from '../../lib/utils.js';\nimport { superFetch } from './helpers.js';\n\nexport async function handle(req, env, ctx) {\n  const url = new URL(req.url);\n  const path = url.pathname;\n\n  // POST /shipping/price\n  if (path === '/shipping/price' && req.method === 'POST') {\n    return getShippingPrice(req, env);\n  }\n\n  // GET /shipping/quote (legacy)\n  if (path === '/shipping/quote' && req.method === 'GET') {\n    return getShippingQuote(req, env);\n  }\n\n  // POST /api/shipping/quote\n  if (path === '/api/shipping/quote' && req.method === 'POST') {\n    return getShippingQuoteAPI(req, env);\n  }\n\n  // POST /v1/platform/orders/price (MINI proxy)\n  if (path === '/v1/platform/orders/price' && req.method === 'POST') {\n    return getMiniPrice(req, env);\n  }\n\n  return json({ ok: false, error: 'Not found' }, { status: 404 }, req);\n}\n\n// Main pricing endpoint\nasync function getShippingPrice(req, env) {\n  try {\n    const body = await readBody(req) || {};\n    const settings = await getJSON(env, 'settings', {});\n    const shipping = settings.shipping || {};\n\n    const payload = {\n      // T\u00EAn (theo t\u00E0i li\u1EC7u SuperAI)\n      sender_province: body.sender_province || shipping.sender_province || '',\n      sender_district: body.sender_district || shipping.sender_district || '',\n      receiver_province: body.receiver_province || body.to_province || '',\n      receiver_district: body.receiver_district || body.to_district || '',\n      receiver_commune: body.receiver_commune || body.to_ward || '',\n      \n      // G\u00F3i h\u00E0ng (theo t\u00E0i li\u1EC7u SuperAI)\n      weight: Number(body.weight_gram || body.weight || 0) || 0,\n      value:  Number(body.cod || 0) || 0\n    };\n\n    const data = await superFetch(env, '/v1/platform/orders/price', {\n      method: 'POST',\n      body: payload\n      // headers: {} (\u0110\u00C3 X\u00D3A)\n    });\n\n    const items = normalizeShippingRates(data);\n    return json({ ok: true, items, raw: data }, {}, req);\n  } catch (e) {\n    return errorResponse(e, 500, req);\n  }\n}\n\n// Legacy GET quote\nasync function getShippingQuote(req, env) {\n  const url = new URL(req.url);\n  const weight = Number(url.searchParams.get('weight') || 0);\n  const to_province = url.searchParams.get('to_province') || '';\n  const to_district = url.searchParams.get('to_district') || '';\n  const cod = Number(url.searchParams.get('cod') || 0) || 0;\n\n  // Legacy Bearer-based quote disabled \u2013 using /shipping/price only\n/*\n  ...(gi\u1EEF nguy\u00EAn kh\u1ED1i tr\u00EAn nh\u01B0ng b\u1ECDc trong comment)...\n*/\n\n  // Fallback\n  const unit = Math.max(1, Math.ceil((weight || 0) / 500));\n  const base = 12000 + unit * 3000;\n  const items = [\n    { provider: 'jt', service_code: 'JT-FAST', name: 'Giao nhanh', fee: Math.round(base * 1.1), eta: '1-2 ng\u00E0y' },\n    { provider: 'spx', service_code: 'SPX-REG', name: 'Ti\u00EAu chu\u1EA9n', fee: Math.round(base), eta: '2-3 ng\u00E0y' },\n    { provider: 'aha', service_code: 'AHA-SAVE', name: 'Ti\u1EBFt ki\u1EC7m', fee: Math.round(base * 0.9), eta: '3-5 ng\u00E0y' }\n  ];\n\n  return json({ ok: true, items, to_province, to_district }, {}, req);\n}\n\n// API shipping quote\nasync function getShippingQuoteAPI(req, env) {\n  try {\n    const body = await readBody(req) || {};\n    const settings = await getJSON(env, 'settings', {});\n    const shipping = settings.shipping || {};\n\n    // Derive weight\n    let weight = 0;\n    if (body.package?.weight_grams != null) {\n      weight = Number(body.package.weight_grams) || 0;\n    }\n    if (!weight && Array.isArray(body.items)) {\n      weight = body.items.reduce((sum, item) => \n        sum + Number(item.weight_grams || item.weight || 0) * Number(item.qty || item.quantity || 1), 0\n      );\n    }\n    if (!weight && body.weight_grams != null) {\n      weight = Number(body.weight_grams) || 0;\n    }\n\n    // Volumetric weight\n    let volGrams = 0;\n    const dim = body.package?.dim_cm || null;\n    const L = Number(dim?.l || body.length_cm || 0);\n    const W = Number(dim?.w || body.width_cm || 0);\n    const H = Number(dim?.h || body.height_cm || 0);\n\n    if (L > 0 && W > 0 && H > 0) {\n      volGrams = Math.round((L * W * H) / 5000 * 1000);\n    }\n    if (volGrams > weight) weight = volGrams;\n\n    const receiver = body.to || body.receiver || {};\n    const payload = {\n      sender_province: String(body.from?.province_code || shipping.sender_province || ''),\n      sender_district: String(body.from?.district_code || shipping.sender_district || ''),\n      receiver_province: String(receiver.province_code || body.to_province || ''),\n      receiver_district: String(receiver.district_code || body.to_district || ''),\n      receiver_commune: String(receiver.commune_code || receiver.ward_code || body.to_ward || ''),\n      weight_gram: Number(weight) || 0,\n      cod: Number(body.total_cod || body.cod || 0) || 0,\n      option_id: String(body.option_id || shipping.option_id || '1')\n    };\n\n    const data = await superFetch(env, '/v1/platform/orders/price', {\n      method: 'POST',\n      body: payload\n    });\n\n    const items = normalizeShippingRates(data);\n\n    if (items.length) {\n      return json({ ok: true, items, used: payload }, {}, req);\n    }\n\n    // Fallback\n    const unit = Math.max(1, Math.ceil((payload.weight_gram || 0) / 500));\n    const base = 12000 + unit * 3000;\n    const fallback = [\n      { provider: 'jt', service_code: 'JT-FAST', name: 'Giao nhanh', fee: Math.round(base * 1.1), eta: '1-2 ng\u00E0y' },\n      { provider: 'spx', service_code: 'SPX-REG', name: 'Ti\u00EAu chu\u1EA9n', fee: Math.round(base), eta: '2-3 ng\u00E0y' },\n      { provider: 'aha', service_code: 'AHA-SAVE', name: 'Ti\u1EBFt ki\u1EC7m', fee: Math.round(base * 0.9), eta: '3-5 ng\u00E0y' }\n    ];\n\n    return json({ ok: true, items: fallback, used: payload, fallback: true }, {}, req);\n  } catch (e) {\n    return errorResponse(e, 500, req);\n  }\n}\n\n// MINI proxy pricing\nasync function getMiniPrice(req, env) {\n  try {\n    const body = await readBody(req) || {};\n    \n    const payload = {\n  sender_province: String(body.sender_province || body.from?.province_code || ''),\n  sender_district: String(body.sender_district || body.from?.district_code || ''),\n  receiver_province: String(body.receiver_province || body.to_province || body.to?.province_code || ''),\n  receiver_district: String(body.receiver_district || body.to_district || body.to?.district_code || ''),\n  receiver_commune: String(body.receiver_commune || body.to_ward || body.to?.commune_code || body.to?.ward_code || ''),\n  // Tr\u1ECDng l\u01B0\u1EE3ng & COD t\u1EEB checkout\n  weight_gram: Number(body.weight_gram || body.weight || 0) || 0,\n  cod: Number(body.cod || body.value || 0) || 0,\n  option_id: String(body.option_id || '1'),\n  // \uD83D\uDC47 Alias \u0111\u1EC3 SuperAI nh\u1EADn \u0111\u00FAng tham s\u1ED1\n  weight: Number(body.weight_gram || body.weight || 0) || 0,\n  value:  Number(body.value || body.cod || 0) || 0\n};\n\n    const data = await superFetch(env, '/v1/platform/orders/price', {\n      method: 'POST',\n      body: payload\n    });\n\n    const items = normalizeShippingRates(data);\n    return json({ ok: true, data: items, used: payload }, {}, req);\n  } catch (e) {\n    return json({ \n      ok: false, \n      error: String(e?.message || e) \n    }, { status: 500 }, req);\n  }\n}\n\n// Normalize shipping rates from various API responses\nfunction normalizeShippingRates(data) {\n  const arr = (data?.data && (data.data.services || data.data.items || data.data.rates)) ||\n            data?.data || data || [];\n  \n  const items = [];\n  \n  const pushOne = (rate) => {\n    if (!rate) return;\n    \n    const fee = Number(\n  rate.shipment_fee ?? rate.fee ?? rate.price ?? rate.total_fee ?? rate.amount ?? 0\n);\nconst eta = rate.estimated_delivery ?? rate.eta ?? rate.leadtime_text ?? rate.leadtime ?? '';\nconst provider = rate.carrier_name ?? rate.provider ?? rate.carrier ?? rate.brand ?? rate.code ?? 'dvvc';\nconst service_code = String(\n  rate.service_code ?? rate.service ?? rate.serviceId ?? rate.carrier_id ?? ''\n);\nconst name = rate.name ?? rate.service_name ?? rate.display ?? (rate.carrier_name || 'D\u1ECBch v\u1EE5');\n    \n    if (fee > 0) {\n      items.push({ provider, service_code, name, fee, eta });\n    }\n  };\n\n  if (Array.isArray(arr)) {\n    arr.forEach(pushOne);\n  } else {\n    pushOne(arr);\n  }\n\n  return items;\n}\n", "import { json } from '../../lib/response.js';\nimport * as areas from './areas.js';\nimport * as warehouses from './warehouses.js';\nimport * as pricing from './pricing.js';\nimport { createWaybill, printWaybill } from './waybill.js';\nimport { superToken } from './helpers.js';\n\nexport async function handle(req, env, ctx) {\n  const url = new URL(req.url);\n  const path = url.pathname;\n\n  // Areas (provinces/districts/wards) - \u2705 TH\u00CAM /public/shipping/areas\n  if (path.startsWith('/shipping/provinces') || \n      path.startsWith('/shipping/districts') ||\n      path.startsWith('/shipping/wards') ||\n      path.startsWith('/shipping/areas') ||\n      path.startsWith('/public/shipping/areas') ||  // \u2190 \u2705 TH\u00CAM D\u00D2NG N\u00C0Y\n      path.startsWith('/api/addresses') ||\n      path.startsWith('/v1/platform/areas')) {\n    return areas.handle(req, env, ctx);\n  }\n\n  // Warehouses\n  if (path === '/shipping/warehouses') {\n    return warehouses.handle(req, env, ctx);\n  }\n\n   // Pricing/Quote\n  if (path === '/v1/platform/orders/price') {\n    // d\u00F9ng mini proxy g\u1ECDi th\u1EB3ng SuperAI (alias weight/value \u0111\u00E3 map trong pricing.getMiniPrice)\n    return pricing.getMiniPrice(req, env, ctx);\n  }\n  if (path === '/shipping/price' || \n      path === '/shipping/quote' ||\n      path === '/api/shipping/quote') {\n    return pricing.handle(req, env, ctx);\n  }\n\n   // Waybill creation\n  if ((path === '/admin/shipping/create' || path === '/shipping/create') && req.method === 'POST') {\n    return createWaybill(req, env);\n  }\n\n  // Waybill printing\n  if (path === '/shipping/print' && req.method === 'POST') {\n    return printWaybill(req, env);\n  }\n\n  return json({ ok: false, error: 'Not found' }, { status: 404 }, req);\n}\n", "// ===================================================================\n// modules/settings.js - Settings Module\n// ===================================================================\n\nimport { json, errorResponse } from '../lib/response.js';\nimport { adminOK } from '../lib/auth.js';\nimport { getJSON, putJSON } from '../lib/kv.js';\nimport { readBody } from '../lib/utils.js';\n\n/**\n * Main handler for settings routes\n */\nexport async function handle(req, env, ctx) {\n  const url = new URL(req.url);\n  const path = url.pathname;\n  const method = req.method;\n\n  // Public: Get settings\n  if (path === '/public/settings' && method === 'GET') {\n    return getPublicSettings(req, env);\n  }\n\n  // Admin: Upsert settings\n  if (path === '/admin/settings/upsert' && method === 'POST') {\n    return upsertSettings(req, env);\n  }\n\n  return errorResponse('Route not found', 404, req);\n}\n\n/**\n * Public: Get all settings\n */\nasync function getPublicSettings(req, env) {\n  try {\n    const settings = await getJSON(env, 'settings', {});\n    return json({ ok: true, settings }, {}, req);\n  } catch (e) {\n    return errorResponse(e, 500, req);\n  }\n}\n\n/**\n * Admin: Update settings (deep path support)\n */\nasync function upsertSettings(req, env) {\n  if (!(await adminOK(req, env))) {\n    return errorResponse('Unauthorized', 401, req);\n  }\n\n  try {\n    const body = await readBody(req) || {};\n    const current = await getJSON(env, 'settings', {});\n\n    // Support deep path setting: {path: 'ads.fb', value: '...'}\n    if (body.path) {\n      setDeepValue(current, body.path, body.value);\n    } \n    // Support direct data merge\n    else if (body.data && typeof body.data === 'object') {\n      Object.assign(current, body.data);\n    }\n\n    await putJSON(env, 'settings', current);\n    return json({ ok: true, settings: current }, {}, req);\n  } catch (e) {\n    return errorResponse(e, 500, req);\n  }\n}\n\n/**\n * Helper: Set deep object value by path string\n * Example: setDeepValue(obj, 'shipping.sender_name', 'Shop')\n */\nfunction setDeepValue(obj, path, value) {\n  const parts = String(path || '').split('.').filter(Boolean);\n  let current = obj;\n\n  while (parts.length > 1) {\n    const key = parts.shift();\n    current[key] = current[key] || {};\n    current = current[key];\n  }\n\n  if (parts.length) {\n    current[parts[0]] = value;\n  }\n\n  return obj;\n}", "// ===================================================================\n// modules/banners.js - Banners Module\n// ===================================================================\n\nimport { json, errorResponse } from '../lib/response.js';\nimport { adminOK } from '../lib/auth.js';\nimport { getJSON, putJSON } from '../lib/kv.js';\nimport { readBody } from '../lib/utils.js';\n\n/**\n * Main handler for banner routes\n */\nexport async function handle(req, env, ctx) {\n  const url = new URL(req.url);\n  const path = url.pathname;\n  const method = req.method;\n\n  // Public: Get active banners\n  if (path === '/banners' && method === 'GET') {\n    return getPublicBanners(req, env);\n  }\n\n  // Admin: List all banners\n  if (path === '/admin/banners' && method === 'GET') {\n    return listAdminBanners(req, env);\n  }\n\n  // Admin: Upsert banner\n  if ((path === '/admin/banners/upsert' || \n       path === '/admin/banner' || \n       path === '/admin/banners') && method === 'POST') {\n    return upsertBanner(req, env);\n  }\n\n  // Admin: Delete banner\n  if ((path === '/admin/banners/delete' || \n       path === '/admin/banner/delete') && method === 'POST') {\n    return deleteBanner(req, env);\n  }\n\n  return errorResponse('Route not found', 404, req);\n}\n\n/**\n * Public: Get active banners only\n */\nasync function getPublicBanners(req, env) {\n  try {\n    const url = new URL(req.url);\n    const qType = (url.searchParams.get('type') || '').trim();\n    const qSlug = (url.searchParams.get('slug') || url.searchParams.get('category_slug') || '').trim();\n\n    const list = await getJSON(env, 'banners:list', []);\n    let active = list.filter(b => b && b.on !== false);\n\n    if (qType) {\n      active = active.filter(b => (b.type || '').toLowerCase() === qType.toLowerCase());\n    }\n    if (qType === 'category_hero' && qSlug) {\n      active = active.filter(b => (b.category_slug || '').toLowerCase() === qSlug.toLowerCase());\n    }\n\n    return json({ ok: true, items: active }, {}, req);\n  } catch (e) {\n    return errorResponse(e, 500, req);\n  }\n}\n\n/**\n * Admin: List all banners\n */\nasync function listAdminBanners(req, env) {\n  if (!(await adminOK(req, env))) {\n    return errorResponse('Unauthorized', 401, req);\n  }\n\n  try {\n    const list = await getJSON(env, 'banners:list', []);\n    return json({ ok: true, items: list }, {}, req);\n  } catch (e) {\n    return errorResponse(e, 500, req);\n  }\n}\n\n/**\n * Admin: Create or update banner\n */\nasync function upsertBanner(req, env) {\n  if (!(await adminOK(req, env))) {\n    return errorResponse('Unauthorized', 401, req);\n  }\n\n  try {\n    const banner = await readBody(req) || {};\n    banner.id = banner.id || crypto.randomUUID().replace(/-/g, '');\n\n    const list = await getJSON(env, 'banners:list', []);\n    const index = list.findIndex(b => b.id === banner.id);\n\n    if (index >= 0) {\n      list[index] = banner;\n    } else {\n      list.unshift(banner);\n    }\n\n    await putJSON(env, 'banners:list', list);\n    return json({ ok: true, data: banner }, {}, req);\n  } catch (e) {\n    return errorResponse(e, 500, req);\n  }\n}\n\n/**\n * Admin: Delete banner\n */\nasync function deleteBanner(req, env) {\n  if (!(await adminOK(req, env))) {\n    return errorResponse('Unauthorized', 401, req);\n  }\n\n  try {\n    const body = await readBody(req) || {};\n    const id = body.id;\n\n    if (!id) {\n      return errorResponse('Banner ID is required', 400, req);\n    }\n\n    const list = await getJSON(env, 'banners:list', []);\n    const newList = list.filter(b => b.id !== id);\n\n    await putJSON(env, 'banners:list', newList);\n    return json({ ok: true, deleted: id }, {}, req);\n  } catch (e) {\n    return errorResponse(e, 500, req);\n  }\n}", "// ===================================================================\n// workers/shv-api/src/modules/auth.js - Authentication Module\n// ===================================================================\n\nimport { json, errorResponse } from '../lib/response.js';\nimport { adminOK, sha256Hex } from '../lib/auth.js';\nimport { readBody } from '../lib/utils.js';\n// TH\u00CAM: Import h\u00E0m KV (Gi\u1EA3 \u0111\u1ECBnh \u0111\u01B0\u1EDDng d\u1EABn t\u1EEB file orders.js)\nimport { getJSON, putJSON } from '../lib/kv.js';\n\n/**\n * Main handler for auth routes\n */\nexport async function handle(req, env, ctx) {\n  const url = new URL(req.url);\n  const path = url.pathname;\n  const method = req.method;\n\n  // Admin login\n  if (path === '/admin/login' || \n      path === '/login' || \n      path === '/admin_auth/login') {\n    return adminLogin(req, env);\n  }\n\n  // Check admin status\n  if (path === '/admin/me' && method === 'GET') {\n    return checkAdminStatus(req, env);\n  }\n  \n  // TH\u00CAM: Route \u0111\u0103ng nh\u1EADp Facebook\n  if (path === '/auth/facebook/login' && method === 'POST') {\n    return facebookLogin(req, env);\n  }\n\n  return errorResponse('Route not found', 404, req);\n}\n\n// ===========================================\n// FACEBOOK LOGIN (M\u1EDAI)\n// ===========================================\nasync function facebookLogin(req, env) {\n  try {\n    const body = await readBody(req) || {};\n    const accessToken = body.accessToken;\n\n    if (!accessToken) {\n      return errorResponse('Missing accessToken', 400, req);\n    }\n\n    // 1. G\u1ECDi Facebook Graph API \u0111\u1EC3 l\u1EA5y th\u00F4ng tin user\n    const fbUrl = `https://graph.facebook.com/me?fields=id,name,email&access_token=${accessToken}`;\n    const fbResponse = await fetch(fbUrl);\n    const fbData = await fbResponse.json();\n\n    if (fbData.error) {\n      console.error('[Facebook Auth Error]', fbData.error);\n      return errorResponse(fbData.error.message, 400, req);\n    }\n\n    const { id: fb_id, name, email } = fbData;\n\n    if (!fb_id) {\n      return errorResponse('Kh\u00F4ng th\u1EC3 l\u1EA5y ID Facebook', 400, req);\n    }\n\n    // 2. T\u00ECm ho\u1EB7c T\u1EA1o Customer\n    let customer = null;\n    let customerId = null;\n\n    // 2a. T\u00ECm b\u1EB1ng Facebook ID\n    const fbKey = `customer:fb:${fb_id}`;\n    customerId = await getJSON(env, fbKey, null);\n    if (customerId) {\n      customer = await getJSON(env, `customer:${customerId}`, null);\n    }\n\n    // 2b. N\u1EBFu kh\u00F4ng th\u1EA5y, t\u00ECm b\u1EB1ng Email\n    if (!customer && email) {\n      const emailKey = `customer:email:${email.toLowerCase()}`;\n      customer = await getJSON(env, emailKey, null);\n    }\n\n    // 2c. N\u1EBFu v\u1EABn kh\u00F4ng th\u1EA5y, t\u1EA1o m\u1EDBi\n    if (!customer) {\n      customerId = `cust_${crypto.randomUUID().replace(/-/g, '')}`;\n      customer = {\n        id: customerId,\n        fb_id: fb_id,\n        full_name: name,\n        email: email ? email.toLowerCase() : null,\n        phone: null, // Facebook kh\u00F4ng tr\u1EA3 v\u1EC1 S\u0110T\n        addresses: [],\n        tier: 'dong', // Tier m\u1EB7c \u0111\u1ECBnh\n        points: 0,\n        created_at: Date.now()\n      };\n\n      // L\u01B0u customer m\u1EDBi\n      await putJSON(env, `customer:${customerId}`, customer);\n      if (email) {\n        await putJSON(env, `customer:email:${email.toLowerCase()}`, customer);\n      }\n      await putJSON(env, `customer:fb:${fb_id}`, customerId); // L\u01B0u li\u00EAn k\u1EBFt FB ID -> Customer ID\n    \n    } else if (!customer.fb_id) {\n      // N\u1EBFu t\u00ECm th\u1EA5y b\u1EB1ng email nh\u01B0ng ch\u01B0a li\u00EAn k\u1EBFt FB -> c\u1EADp nh\u1EADt\n      customer.fb_id = fb_id;\n      await putJSON(env, `customer:${customer.id}`, customer);\n      await putJSON(env, `customer:fb:${fb_id}`, customer.id);\n    }\n    \n    // 3. T\u1EA1o session token cho kh\u00E1ch h\u00E0ng\n    const customerToken = `shv_tok_${crypto.randomUUID().replace(/-/g, '')}`;\n    \n    // L\u01B0u token v\u00E0o KV (tr\u1ECF \u0111\u1EBFn ID kh\u00E1ch h\u00E0ng), h\u1EBFt h\u1EA1n sau 30 ng\u00E0y\n    await putJSON(env, `customer_token:${customerToken}`, customer.id, {\n      expirationTtl: 60 * 60 * 24 * 30 // 30 ng\u00E0y\n    });\n\n    // 4. Tr\u1EA3 v\u1EC1 token v\u00E0 th\u00F4ng tin customer\n    return json({\n      ok: true,\n      token: customerToken,\n      customer: customer\n    }, {}, req);\n\n  } catch (e) {\n    console.error('[facebookLogin Error]', e);\n    return errorResponse(e.message || 'L\u1ED7i m\u00E1y ch\u1EE7 n\u1ED9i b\u1ED9', 500, req);\n  }\n}\n\n\n/**\n * Admin login - Generate session token\n */\nasync function adminLogin(req, env) {\n  try {\n    let username = '';\n    let password = '';\n\n    // Get credentials from POST body or query params\n    if (req.method === 'POST') {\n      const body = await readBody(req) || {};\n      username = body.user || body.username || body.u || '';\n      password = body.pass || body.password || body.p || '';\n    } else {\n      const url = new URL(req.url);\n      username = url.searchParams.get('u') || '';\n      password = url.searchParams.get('p') || '';\n    }\n\n    // Get expected password from env or KV\n    let expectedPassword = (env && env.ADMIN_TOKEN) ? env.ADMIN_TOKEN : '';\n    \n    if (!expectedPassword && env && env.SHV) {\n      expectedPassword = (await env.SHV.get('admin_pass')) || \n                        (await env.SHV.get('admin_token')) || '';\n    }\n\n    // Validate credentials\n    if (!(username === 'admin' && password === expectedPassword)) {\n      return json({\n        ok: false,\n        error: 'Invalid credentials'\n      }, { status: 401 }, req);\n    }\n\n    // Generate session token\n    let token = '';\n    \n    if (env && env.SHV) {\n      // Generate random session token\n      token = crypto.randomUUID().replace(/-/g, '');\n      \n      // Store in KV with 7 day expiration\n      await env.SHV.put('admin_token', token, { \n        expirationTtl: 60 * 60 * 24 * 7 \n      });\n    } else {\n      // Fallback: hash of ADMIN_TOKEN\n      token = await sha256Hex(env.ADMIN_TOKEN || '');\n    }\n\n    return json({ ok: true, token }, {}, req);\n  } catch (e) {\n    return errorResponse(e, 500, req);\n  }\n}\n\n/**\n * Check if current token is valid\n */\nasync function checkAdminStatus(req, env) {\n  const isValid = await adminOK(req, env);\n  return json({ ok: isValid }, {}, req);\n}", "// File: workers/shv-api/src/modules/costs.js\r\n// Module qu\u1EA3n l\u00FD chi ph\u00ED (l\u01B0\u01A1ng, nh\u00E0, ads...)\r\n\r\nimport { json } from '../lib/response.js';\r\nimport { getJSON, putJSON } from '../lib/kv.js';\r\n\r\nconst COST_KEY = 'config:costs_v1';\r\n\r\n/**\r\n * Main handler for /admin/costs\r\n */\r\nexport async function handle(req, env, ctx) {\r\n  const method = req.method;\r\n\r\n  try {\r\n    if (method === 'GET') {\r\n      return await getCosts(req, env);\r\n    }\r\n    \r\n    if (method === 'POST') {\r\n      return await saveCosts(req, env);\r\n    }\r\n\r\n    return json({ ok: false, error: 'Method not allowed' }, { status: 405 }, req);\r\n\r\n  } catch (e) {\r\n    console.error('[Costs] Error:', e);\r\n    return json({ \r\n      ok: false, \r\n      error: 'Internal error', \r\n      details: e.message \r\n    }, { status: 500 }, req);\r\n  }\r\n}\r\n\r\n/**\r\n * L\u1EA5y danh s\u00E1ch chi ph\u00ED\r\n */\r\nasync function getCosts(req, env) {\r\n  const costs = await getJSON(env, COST_KEY, []);\r\n  return json({ ok: true, costs }, {}, req);\r\n}\r\n\r\n/**\r\n * L\u01B0u danh s\u00E1ch chi ph\u00ED\r\n */\r\nasync function saveCosts(req, env) {\r\n  try {\r\n    const { costs } = await req.json();\r\n\r\n    if (!Array.isArray(costs)) {\r\n      return json({ ok: false, error: 'Invalid data format' }, { status: 400 }, req);\r\n    }\r\n\r\n    // Validate data\r\n    const validCosts = costs.map(c => ({\r\n      id: c.id || Date.now(),\r\n      name: String(c.name || 'Chi ph\u00ED'),\r\n      amount: Number(c.amount || 0),\r\n      type: (c.type === 'monthly' || c.type === 'per_order') ? c.type : 'monthly'\r\n    })).filter(c => c.name && c.amount > 0);\r\n\r\n    await putJSON(env, COST_KEY, validCosts);\r\n\r\n    return json({ ok: true, message: 'Costs saved', costs: validCosts }, {}, req);\r\n\r\n  } catch (e) {\r\n    console.error('[Costs] Save error:', e);\r\n    return json({ ok: false, error: 'Failed to save costs' }, { status: 500 }, req);\r\n  }\r\n}\r\n\r\n/**\r\n * Helper function \u0111\u1EC3 c\u00E1c module kh\u00E1c (nh\u01B0 stats) g\u1ECDi\r\n * Tr\u1EA3 v\u1EC1 danh s\u00E1ch chi ph\u00ED th\u00F4\r\n */\r\nexport async function getCostRules(env) {\r\n  return await getJSON(env, COST_KEY, []);\r\n}", "// File: workers/shv-api/src/cart-sync-handler.js\n// Handler cho Cart Sync API\n\n/**\n * Main handler cho /api/cart/sync routes\n */\nexport async function handleCartSync(request, env) {\n  const url = new URL(request.url);\n  const method = request.method;\n  \n  // CORS headers\n  const corsHeaders = {\n    'Access-Control-Allow-Origin': '*',\n    'Access-Control-Allow-Methods': 'GET, POST, DELETE, OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type',\n  };\n  \n  // Handle OPTIONS (preflight)\n  if (method === 'OPTIONS') {\n    return new Response(null, { headers: corsHeaders });\n  }\n    // ==== START FIX: validate KV binding ====\n  if (!env || !env.CART_KV) {\n    return Response.json(\n      { ok: false, error: 'CART_KV not bound in environment' },\n      { status: 500, headers: corsHeaders }\n    );\n  }\n  // ==== END FIX: validate KV binding ====\n\n  try {\n    let response;\n    \n    if (method === 'GET') {\n      response = await getCart(request, env);\n    } else if (method === 'POST') {\n      response = await syncCart(request, env);\n    } else if (method === 'DELETE') {\n      response = await clearCart(request, env);\n    } else {\n      response = Response.json(\n        { ok: false, error: 'Method not allowed' },\n        { status: 405 }\n      );\n    }\n    \n    // Add CORS headers to response\n    const headers = new Headers(response.headers);\n    Object.entries(corsHeaders).forEach(([key, value]) => {\n      headers.set(key, value);\n    });\n    \n    return new Response(response.body, {\n      status: response.status,\n      statusText: response.statusText,\n      headers\n    });\n  } catch (e) {\n    console.error('[CartSync] Handler error:', e);\n    return Response.json(\n      { ok: false, error: 'Internal server error' },\n      { status: 500, headers: corsHeaders }\n    );\n  }\n}\n\n/**\n * GET /api/cart/sync?session_id=xxx\n * L\u1EA5y gi\u1ECF h\u00E0ng t\u1EEB KV\n */\nasync function getCart(request, env) {\n  const url = new URL(request.url);\n  const sessionId = url.searchParams.get('session_id');\n  \n  if (!sessionId) {\n    return Response.json(\n      { ok: false, error: 'Missing session_id parameter' },\n      { status: 400 }\n    );\n  }\n  \n  try {\n    const key = `cart:${sessionId}`;\n    const data = await env.CART_KV.get(key);\n    \n    if (!data) {\n      console.log(`[CartSync] No cart found for session: ${sessionId}`);\n      return Response.json({\n        ok: true,\n        cart: [],\n        updated_at: null,\n        message: 'No cart found'\n      });\n    }\n    \n    const parsed = JSON.parse(data);\n    console.log(`[CartSync] Retrieved cart for ${sessionId}: ${parsed.items?.length || 0} items`);\n    \n    return Response.json({\n      ok: true,\n      cart: parsed.items || [],\n      updated_at: parsed.updated_at,\n      source: parsed.source\n    });\n  } catch (e) {\n    console.error('[CartSync] Get error:', e);\n    return Response.json(\n      { ok: false, error: e.message },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * POST /api/cart/sync\n * Body: { session_id, cart: [...], source: 'fe'|'mini' }\n * L\u01B0u gi\u1ECF h\u00E0ng v\u00E0o KV\n */\nasync function syncCart(request, env) {\n  try {\n    const body = await request.json();\n    const { session_id, cart, source } = body;\n    \n    // Validate\n    if (!session_id) {\n      return Response.json(\n        { ok: false, error: 'Missing session_id' },\n        { status: 400 }\n      );\n    }\n    \n    if (!Array.isArray(cart)) {\n      return Response.json(\n        { ok: false, error: 'Cart must be an array' },\n        { status: 400 }\n      );\n    }\n    \n    const key = `cart:${session_id}`;\n    const now = new Date().toISOString();\n    \n    const data = {\n      items: cart,\n      updated_at: now,\n      source: source || 'unknown',\n      session_id: session_id\n    };\n    \n    // L\u01B0u v\u00E0o KV v\u1EDBi TTL 30 ng\u00E0y\n    await env.CART_KV.put(key, JSON.stringify(data), {\n      expirationTtl: 30 * 24 * 60 * 60 // 30 days\n    });\n    \n    console.log(`[CartSync] Saved cart for ${session_id}: ${cart.length} items from ${source}`);\n    \n    return Response.json({\n      ok: true,\n      updated_at: now,\n      items_count: cart.length,\n      message: 'Cart synced successfully'\n    });\n  } catch (e) {\n    console.error('[CartSync] Sync error:', e);\n    return Response.json(\n      { ok: false, error: e.message },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * DELETE /api/cart/sync?session_id=xxx\n * X\u00F3a gi\u1ECF h\u00E0ng\n */\nasync function clearCart(request, env) {\n  const url = new URL(request.url);\n  const sessionId = url.searchParams.get('session_id');\n  \n  if (!sessionId) {\n    return Response.json(\n      { ok: false, error: 'Missing session_id parameter' },\n      { status: 400 }\n    );\n  }\n  \n  try {\n    const key = `cart:${sessionId}`;\n    await env.CART_KV.delete(key);\n    \n    console.log(`[CartSync] Cleared cart for session: ${sessionId}`);\n    \n    return Response.json({\n      ok: true,\n      message: 'Cart cleared successfully'\n    });\n  } catch (e) {\n    console.error('[CartSync] Clear error:', e);\n    return Response.json(\n      { ok: false, error: e.message },\n      { status: 500 }\n    );\n  }\n}", "// workers/shv-api/src/index.js\n// src/index.js - Main Router (v\u1EDBi Admin Module)\n// ===================================================================\n\nimport { json, corsHeaders } from './lib/response.js';\nimport * as categories from './modules/categories.js';\nimport * as Orders from './modules/orders.js';\nimport * as Products from './modules/products.js';\nimport * as WebhookHandler from './modules/webhook-handler.js'; // TH\u00CAM D\u00D2NG N\u00C0Y\nimport * as shipping from './modules/shipping/index.js';\nimport * as settings from './modules/settings.js';\nimport * as banners from './modules/banners.js';\nimport * as vouchers from './modules/vouchers.js';\nimport * as auth from './modules/auth.js';\nimport * as admin from './modules/admin.js'; // NEW\nimport * as costs from './modules/costs.js'; // TH\u00CAM MODULE CHI PH\u00CD\nimport { handleCartSync } from './modules/cart-sync-handler.js';\nimport { printWaybill, cancelWaybill, printWaybillsBulk, cancelWaybillsBulk } from './modules/shipping/waybill.js'; // S\u1EECA: TH\u00CAM H\u1EE6Y & IN H\u00C0NG LO\u1EA0T\n\nconsole.log('[Index] \u2705 Module Products \u0111\u00E3 import:', typeof Products, Products ? Object.keys(Products) : 'undefined'); // LOG KI\u1EC2M TRA IMPORT\n\n/**\n * Logger middleware\n */\nfunction logEntry(req) {\n  try {\n    const url = new URL(req.url);\n    console.log(JSON.stringify({\n      t: Date.now(),\n      method: req.method,\n      path: url.pathname\n    }));\n  } catch (e) {\n    console.error('Log error:', e);\n  }\n}\n\n/**\n * Main Worker handler\n */\nexport default {\n  async fetch(req, env, ctx) {\n    console.log('--- Worker Request v1.1 ---'); // TH\u00CAM LOG N\u00C0Y\n    logEntry(req);\n\n    // Handle CORS preflight\n    if (req.method === 'OPTIONS') {\n      return new Response(null, {\n        status: 204,\n        headers: corsHeaders(req)\n      });\n    }\n\n    const url = new URL(req.url);\n    const path = url.pathname;\n\n    try {\n      // ============================================\n      // ADMIN ROUTES (NEW) - \u01AFU TI\u00CAN TR\u01AF\u1EDAC\n      // ============================================\n      \n      // Admin login routes - PH\u1EA2I \u0110\u1EB6T TR\u01AF\u1EDAC auth module\n      if (path === '/admin/login' ||\n          path === '/login' ||\n          path === '/admin_auth/login') {\n        return admin.handle(req, env, ctx);\n      }\n      \n      // Admin management routes\n      if (path.startsWith('/admin/setup') ||\n          path.startsWith('/admin/auth') ||\n          path.startsWith('/admin/users') ||\n          path.startsWith('/admin/roles')) {\n        return admin.handle(req, env, ctx);\n      }\n\t  // \u2705 TH\u00CAM \u0110O\u1EA0N N\u00C0Y - B\u1EAET \u0110\u1EA6U\n      // ============================================\n      // CUSTOMER API ROUTES (PUBLIC)\n      // ============================================\n      if (path.startsWith('/admin/customers') ||\n          path === '/api/customers/register' ||\n          path === '/api/customers/login' ||\n          path === '/api/customers/me') {\n        return admin.handle(req, env, ctx);\n      }\n      // \u2705 TH\u00CAM \u0110O\u1EA0N N\u00C0Y - K\u1EBET TH\u00DAC\n\n      // ============================================\n      // EXISTING ROUTES\n      // ============================================\n\n      // Auth module (OLD - \u0111\u1EC3 t\u01B0\u01A1ng th\u00EDch backward)\n      if (path === '/admin/me') {\n        return auth.handle(req, env, ctx);\n      }\n\n      // Categories module\n      if (path.startsWith('/admin/categories') ||\n          path.startsWith('/public/categories')) {\n        return categories.handle(req, env, ctx);\n      }\n\n      // Products module\n      if (path.startsWith('/products') ||\n          path.startsWith('/public/products') ||\n          path === '/admin/products' || // EXACT match\n          path === '/admin/products/list' || // EXACT match for list\n          path.startsWith('/admin/products/') || // Specific actions like /get, /upsert\n          path === '/product') {\n        console.log('[Index] \u27A1\uFE0F \u0110ang g\u1ECDi Products.handle cho path:', path, 'Module Products c\u00F3 t\u1ED3n t\u1EA1i:', typeof Products); // LOG KI\u1EC2M TRA TR\u01AF\u1EDAC KHI G\u1ECCI\n        return Products.handle(req, env, ctx);\n      }\n\n      // [INV-TRACE] router marker for Orders\n      if (path.startsWith('/api/orders') ||\n          path.startsWith('/admin/orders') ||\n          path.startsWith('/public/orders') ||\n          path.startsWith('/public/order-create')) {\n        console.log('[INV-TRACE] router \u2192 orders', { path, method: req.method });\n      }\n      // Orders module\n     if (path.startsWith('/api/orders') ||\n         path.startsWith('/admin/orders') ||\n         path.startsWith('/public/orders') ||\n         path.startsWith('/public/order-create') ||\n         path === '/admin/stats' ||\n         path === '/orders/my') { // S\u1EECA: X\u00F3a '||' v\u00E0 th\u00EAm '){'\n\n       return Orders.handle(req, env, ctx); // TH\u00CAM: D\u00F2ng x\u1EED l\u00FD\n\n     } // TH\u00CAM: D\u1EA5u \u0111\u00F3ng cho kh\u1ED1i Orders\n\n     // TH\u00CAM: Route H\u1EE6Y V\u1EACN \u0110\u01A0N\n     if (path === '/shipping/cancel' && req.method === 'POST') {\n       return cancelWaybill(req, env);\n     }\n\n     // TH\u00CAM: Route IN H\u00C0NG LO\u1EA0T\n     if (path === '/shipping/print-bulk' && req.method === 'POST') {\n       return printWaybillsBulk(req, env);\n     }\n\n     // TH\u00CAM: Route H\u1EE6Y H\u00C0NG LO\u1EA0T\n     if (path === '/shipping/cancel-bulk' && req.method === 'POST') {\n       return cancelWaybillsBulk(req, env);\n     }\n\n      // Shipping module (ensure Token header for SuperAI v1 routes)\n     if (path.startsWith('/shipping') ||\n         path.startsWith('/admin/shipping') ||\n         path.startsWith('/api/addresses') ||\n         path.startsWith('/v1/platform/areas') ||\n         path.startsWith('/v1/platform/orders/price') ||\n         path.startsWith('/v1/platform/orders/optimize') ||\n         path.startsWith('/v1/platform/orders/label') ||\n         path.startsWith('/v1/platform/orders/token') ||\n         path.startsWith('/v1/platform/carriers') ||\n         path.startsWith('/v1/platform/warehouses')) {\n     \n       let r = req;\n     \n       // SuperAI v1 endpoints: auto inject headers if missing\n       if (path.startsWith('/v1/platform/')) {\n         const h = new Headers(req.headers);\n         if (!h.get('Token')) {\n           h.set('Token', env.SUPER_KEY || 'FxXOoDz2qlTN5joDCsBGQFqKmm1UNvOw7YPwkzm5');\n         }\n         if (!h.get('Accept')) h.set('Accept', 'application/json');\n         if (req.method !== 'GET' && !h.get('Content-Type')) {\n           h.set('Content-Type', 'application/json');\n         }\n         r = new Request(req, { headers: h });\n       }\n     \n       return shipping.handle(r, env, ctx);\n     }\n\n      // Cart Sync module\n      if (path.startsWith('/api/cart/sync')) {\n        return handleCartSync(req, env);\n      }\n\n      // Settings module\n      if (path.startsWith('/public/settings') ||\n          path.startsWith('/admin/settings')) {\n        return settings.handle(req, env, ctx);\n      }\n\n      // Banners module\n      if (path === '/banners' ||\n          path.startsWith('/admin/banners') ||\n          path.startsWith('/admin/banner')) {\n        return banners.handle(req, env, ctx);\n      }\n\n      // Vouchers module\n      if (path === '/vouchers' ||\n          path === '/vouchers/apply' ||\n          path.startsWith('/admin/vouchers')) {\n        return vouchers.handle(req, env, ctx);\n      }\n\n      // TH\u00CAM: Routes cho Qu\u1EA3n l\u00FD Chi Ph\u00ED\n      if (path.startsWith('/admin/costs')) {\n        return costs.handle(req, env, ctx);\n      }\n\n      // ============================================\n      // ROOT ENDPOINTS\n      // ============================================\n\n      if (path === '/' || path === '') {\n        return json({\n          ok: true,\n          msg: 'SHV API v4.2 (Admin System Integrated)',\n          hint: 'All routes modularized + Cart Sync + Admin Management',\n          modules: {\n            admin: '\u2705 Added',\n            auth: '\u2705 Complete',\n            categories: '\u2705 Complete',\n            products: '\u2705 Complete',\n            orders: '\u2705 Complete',\n            shipping: '\u2705 Complete',\n            settings: '\u2705 Complete',\n            banners: '\u2705 Complete',\n            vouchers: '\u2705 Complete',\n            cart_sync: '\u2705 Complete'\n          }\n        }, {}, req);\n      }\n\n      if (path === '/me' && req.method === 'GET') {\n        return json({\n          ok: true,\n          msg: 'Worker alive',\n          version: 'v4.2'\n        }, {}, req);\n      }\n\n      // TH\u00CAM ROUTE WEBHOOK \u1EDE \u0110\u00C2Y\n      else if (path === '/webhook/superai' && req.method === 'POST') {\n         return WebhookHandler.handleSuperAIWebhook(req, env);\n      }\n\n      // Not found\n      return json({\n        ok: false,\n        error: 'Route not found'\n      }, { status: 404 }, req);\n\n    } catch (e) {\n      console.error('Worker error:', e);\n      return json({\n        ok: false,\n        error: String(e?.message || e)\n      }, { status: 500 }, req);\n    }\n  }\n};", "import type { Middleware } from \"./common\";\n\nconst drainBody: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} finally {\n\t\ttry {\n\t\t\tif (request.body !== null && !request.bodyUsed) {\n\t\t\t\tconst reader = request.body.getReader();\n\t\t\t\twhile (!(await reader.read()).done) {}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Failed to drain the unused request body.\", e);\n\t\t}\n\t}\n};\n\nexport default drainBody;\n", "import type { Middleware } from \"./common\";\n\ninterface JsonError {\n\tmessage?: string;\n\tname?: string;\n\tstack?: string;\n\tcause?: JsonError;\n}\n\nfunction reduceError(e: any): JsonError {\n\treturn {\n\t\tname: e?.name,\n\t\tmessage: e?.message ?? String(e),\n\t\tstack: e?.stack,\n\t\tcause: e?.cause === undefined ? undefined : reduceError(e.cause),\n\t};\n}\n\n// See comment in `bundle.ts` for details on why this is needed\nconst jsonError: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} catch (e: any) {\n\t\tconst error = reduceError(e);\n\t\treturn Response.json(error, {\n\t\t\tstatus: 500,\n\t\t\theaders: { \"MF-Experimental-Error-Stack\": \"true\" },\n\t\t});\n\t}\n};\n\nexport default jsonError;\n", "\t\t\t\timport worker, * as OTHER_EXPORTS from \"E:\\\\WEB\\\\Zaliminiapp-web\\\\shophuyvan\\\\workers\\\\shv-api\\\\src\\\\index.js\";\n\t\t\t\timport * as __MIDDLEWARE_0__ from \"C:\\\\Users\\\\Administrator\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-ensure-req-body-drained.ts\";\nimport * as __MIDDLEWARE_1__ from \"C:\\\\Users\\\\Administrator\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-miniflare3-json-error.ts\";\n\n\t\t\t\texport * from \"E:\\\\WEB\\\\Zaliminiapp-web\\\\shophuyvan\\\\workers\\\\shv-api\\\\src\\\\index.js\";\n\t\t\t\tconst MIDDLEWARE_TEST_INJECT = \"__INJECT_FOR_TESTING_WRANGLER_MIDDLEWARE__\";\n\t\t\t\texport const __INTERNAL_WRANGLER_MIDDLEWARE__ = [\n\t\t\t\t\t\n\t\t\t\t\t__MIDDLEWARE_0__.default,__MIDDLEWARE_1__.default\n\t\t\t\t]\n\t\t\t\texport default worker;", "export type Awaitable<T> = T | Promise<T>;\n// TODO: allow dispatching more events?\nexport type Dispatcher = (\n\ttype: \"scheduled\",\n\tinit: { cron?: string }\n) => Awaitable<void>;\n\nexport type IncomingRequest = Request<\n\tunknown,\n\tIncomingRequestCfProperties<unknown>\n>;\n\nexport interface MiddlewareContext {\n\tdispatch: Dispatcher;\n\tnext(request: IncomingRequest, env: any): Awaitable<Response>;\n}\n\nexport type Middleware = (\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tmiddlewareCtx: MiddlewareContext\n) => Awaitable<Response>;\n\nconst __facade_middleware__: Middleware[] = [];\n\n// The register functions allow for the insertion of one or many middleware,\n// We register internal middleware first in the stack, but have no way of controlling\n// the order that addMiddleware is run in service workers so need an internal function.\nexport function __facade_register__(...args: (Middleware | Middleware[])[]) {\n\t__facade_middleware__.push(...args.flat());\n}\nexport function __facade_registerInternal__(\n\t...args: (Middleware | Middleware[])[]\n) {\n\t__facade_middleware__.unshift(...args.flat());\n}\n\nfunction __facade_invokeChain__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tmiddlewareChain: Middleware[]\n): Awaitable<Response> {\n\tconst [head, ...tail] = middlewareChain;\n\tconst middlewareCtx: MiddlewareContext = {\n\t\tdispatch,\n\t\tnext(newRequest, newEnv) {\n\t\t\treturn __facade_invokeChain__(newRequest, newEnv, ctx, dispatch, tail);\n\t\t},\n\t};\n\treturn head(request, env, ctx, middlewareCtx);\n}\n\nexport function __facade_invoke__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tfinalMiddleware: Middleware\n): Awaitable<Response> {\n\treturn __facade_invokeChain__(request, env, ctx, dispatch, [\n\t\t...__facade_middleware__,\n\t\tfinalMiddleware,\n\t]);\n}\n", "// This loads all middlewares exposed on the middleware object and then starts\n// the invocation chain. The big idea is that we can add these to the middleware\n// export dynamically through wrangler, or we can potentially let users directly\n// add them as a sort of \"plugin\" system.\n\nimport ENTRY, { __INTERNAL_WRANGLER_MIDDLEWARE__ } from \"E:\\\\WEB\\\\Zaliminiapp-web\\\\shophuyvan\\\\workers\\\\shv-api\\\\.wrangler\\\\tmp\\\\bundle-vGPjzk\\\\middleware-insertion-facade.js\";\nimport { __facade_invoke__, __facade_register__, Dispatcher } from \"C:\\\\Users\\\\Administrator\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\common.ts\";\nimport type { WorkerEntrypointConstructor } from \"E:\\\\WEB\\\\Zaliminiapp-web\\\\shophuyvan\\\\workers\\\\shv-api\\\\.wrangler\\\\tmp\\\\bundle-vGPjzk\\\\middleware-insertion-facade.js\";\n\n// Preserve all the exports from the worker\nexport * from \"E:\\\\WEB\\\\Zaliminiapp-web\\\\shophuyvan\\\\workers\\\\shv-api\\\\.wrangler\\\\tmp\\\\bundle-vGPjzk\\\\middleware-insertion-facade.js\";\n\nclass __Facade_ScheduledController__ implements ScheduledController {\n\treadonly #noRetry: ScheduledController[\"noRetry\"];\n\n\tconstructor(\n\t\treadonly scheduledTime: number,\n\t\treadonly cron: string,\n\t\tnoRetry: ScheduledController[\"noRetry\"]\n\t) {\n\t\tthis.#noRetry = noRetry;\n\t}\n\n\tnoRetry() {\n\t\tif (!(this instanceof __Facade_ScheduledController__)) {\n\t\t\tthrow new TypeError(\"Illegal invocation\");\n\t\t}\n\t\t// Need to call native method immediately in case uncaught error thrown\n\t\tthis.#noRetry();\n\t}\n}\n\nfunction wrapExportedHandler(worker: ExportedHandler): ExportedHandler {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn worker;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\tconst fetchDispatcher: ExportedHandlerFetchHandler = function (\n\t\trequest,\n\t\tenv,\n\t\tctx\n\t) {\n\t\tif (worker.fetch === undefined) {\n\t\t\tthrow new Error(\"Handler does not export a fetch() function.\");\n\t\t}\n\t\treturn worker.fetch(request, env, ctx);\n\t};\n\n\treturn {\n\t\t...worker,\n\t\tfetch(request, env, ctx) {\n\t\t\tconst dispatcher: Dispatcher = function (type, init) {\n\t\t\t\tif (type === \"scheduled\" && worker.scheduled !== undefined) {\n\t\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\t\tDate.now(),\n\t\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t\t() => {}\n\t\t\t\t\t);\n\t\t\t\t\treturn worker.scheduled(controller, env, ctx);\n\t\t\t\t}\n\t\t\t};\n\t\t\treturn __facade_invoke__(request, env, ctx, dispatcher, fetchDispatcher);\n\t\t},\n\t};\n}\n\nfunction wrapWorkerEntrypoint(\n\tklass: WorkerEntrypointConstructor\n): WorkerEntrypointConstructor {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn klass;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\t// `extend`ing `klass` here so other RPC methods remain callable\n\treturn class extends klass {\n\t\t#fetchDispatcher: ExportedHandlerFetchHandler<Record<string, unknown>> = (\n\t\t\trequest,\n\t\t\tenv,\n\t\t\tctx\n\t\t) => {\n\t\t\tthis.env = env;\n\t\t\tthis.ctx = ctx;\n\t\t\tif (super.fetch === undefined) {\n\t\t\t\tthrow new Error(\"Entrypoint class does not define a fetch() function.\");\n\t\t\t}\n\t\t\treturn super.fetch(request);\n\t\t};\n\n\t\t#dispatcher: Dispatcher = (type, init) => {\n\t\t\tif (type === \"scheduled\" && super.scheduled !== undefined) {\n\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\tDate.now(),\n\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t() => {}\n\t\t\t\t);\n\t\t\t\treturn super.scheduled(controller);\n\t\t\t}\n\t\t};\n\n\t\tfetch(request: Request<unknown, IncomingRequestCfProperties>) {\n\t\t\treturn __facade_invoke__(\n\t\t\t\trequest,\n\t\t\t\tthis.env,\n\t\t\t\tthis.ctx,\n\t\t\t\tthis.#dispatcher,\n\t\t\t\tthis.#fetchDispatcher\n\t\t\t);\n\t\t}\n\t};\n}\n\nlet WRAPPED_ENTRY: ExportedHandler | WorkerEntrypointConstructor | undefined;\nif (typeof ENTRY === \"object\") {\n\tWRAPPED_ENTRY = wrapExportedHandler(ENTRY);\n} else if (typeof ENTRY === \"function\") {\n\tWRAPPED_ENTRY = wrapWorkerEntrypoint(ENTRY);\n}\nexport default WRAPPED_ENTRY;\n"],
  "mappings": "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",
  "names": ["json", "slugify", "handle", "handle", "formatPrice", "parseCookie", "v", "handle", "finalCustomer", "handle", "handle", "handle", "handle", "handle", "handle", "handle", "handle", "handle", "handle", "corsHeaders", "handle"]
}
