<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thanh to√°n - Shop Huy V√¢n</title>
  <meta name="description" content="Thanh to√°n ƒë∆°n h√†ng t·∫°i Shop Huy V√¢n - Nhanh ch√≥ng, an to√†n, b·∫£o m·∫≠t">
  <meta name="robots" content="noindex, nofollow">
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    
    * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .gradient-emerald {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .product-card { 
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .product-card:hover { 
      transform: translateY(-4px); 
      box-shadow: 0 12px 24px rgba(0,0,0,0.12);
    }
    
    .variant-badge { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
    
    .shipping-option { 
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      border: 2px solid #e5e7eb;
    }
    
    .shipping-option:hover { 
      transform: translateX(4px);
      border-color: #10b981;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
    }
    
    .shipping-option.selected { 
      border-color: #10b981;
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      box-shadow: 0 4px 16px rgba(16, 185, 129, 0.25);
    }
    
    .skeleton { 
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); 
      background-size: 200% 100%; 
      animation: loading 1.5s ease-in-out infinite;
    }
    
    @keyframes loading { 
      0% { background-position: 200% 0; } 
      100% { background-position: -200% 0; } 
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .slide-in {
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    .voucher-input:focus {
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 0 4px 14px rgba(16, 185, 129, 0.4);
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
      transform: translateY(-2px);
    }
    
    .btn-primary:active {
      transform: translateY(0);
    }
    
    .btn-secondary {
      border: 2px solid #10b981;
      color: #10b981;
      transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    .success-message {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border: 2px solid #10b981;
      animation: slideIn 0.3s ease-out;
    }
    
    .error-message {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border: 2px solid #ef4444;
      animation: slideIn 0.3s ease-out;
    }
    
    .info-message {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border: 2px solid #3b82f6;
    }
    
    @media (max-width: 768px) {
      .container-main {
        padding-bottom: 200px;
      }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">

<header class="bg-white border-b sticky top-0 z-50 shadow-lg backdrop-blur-sm bg-white/95">
  <div class="max-w-5xl mx-auto px-4 py-4 flex items-center gap-4">
    <a href="/" class="flex items-center gap-3 hover:opacity-80 transition-opacity group">
      <div class="relative">
        <img src="/public/logo.png" class="w-10 h-10 rounded-xl shadow-md group-hover:shadow-lg transition-shadow" alt="Logo" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22%3E%3Crect fill=%22%2310b981%22 width=%2240%22 height=%2240%22 rx=%228%22/%3E%3C/svg%3E'" />
        <div class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
      </div>
      <div>
        <div class="font-bold text-lg leading-none">SHOP HUY V√ÇN</div>
        <div class="text-xs text-gray-500">Thanh to√°n an to√†n</div>
      </div>
    </a>
    <div class="ml-auto flex items-center gap-2 text-sm font-medium">
      <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
      </svg>
      <span class="hidden sm:inline text-green-700">B·∫£o m·∫≠t</span>
    </div>
  </div>
</header>

  <main class="max-w-5xl mx-auto px-4 py-8 space-y-6 container-main">

  <h1 class="text-sm font-bold bg-gradient-to-r from-gray-900 to-gray-600 bg-clip-text text-transparent">
    Thanh to√°n ƒë∆°n h√†ng
  </h1>
  
  <!-- Cart Items -->
  <section class="bg-white rounded-3xl shadow-xl overflow-hidden border border-gray-100">
    <div class="p-5 border-b bg-gradient-to-r from-emerald-50 via-teal-50 to-cyan-50">
      <h2 class="font-bold text-xs flex items-center gap-3">
        <span class="text-base">üõí</span>
        <span>ƒê∆°n h√†ng c·ªßa b·∫°n</span>
        <span class="ml-auto bg-white px-3 py-1 rounded-full text-sm font-semibold text-emerald-600 shadow-sm">
          <span id="cart-count">0</span> s·∫£n ph·∫©m
        </span>
      </h2>
    </div>
    <div id="cart-items" class="divide-y divide-gray-100 max-h-[500px] overflow-y-auto">
      <div class="p-12 text-center">
        <div class="skeleton w-full h-40 rounded-2xl mb-4"></div>
        <div class="skeleton w-3/4 h-6 rounded-lg mx-auto"></div>
      </div>
    </div>
    <div class="p-4 border-t bg-gradient-to-r from-gray-50 to-gray-100">
      <div class="flex justify-between items-center">
        <span class="text-base font-semibold text-gray-700">T·∫°m T√≠nh</span>
        <span id="subtotal" class="text-lg font-bold" style="color: #ee4d2d;">0ƒê</span>
      </div>
    </div>
  </section>

  <!-- Customer Info -->
  <section class="bg-white rounded-3xl p-6 shadow-xl border border-gray-100">
    <h2 class="font-bold text-lg mb-4 flex items-center gap-3">
      <span class="text-2xl">üìç</span>
      <span>Th√¥ng tin nh·∫≠n h√†ng</span>
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="relative">
        <input id="name" placeholder="H·ªç v√† t√™n *" 
          class="w-full border-2 border-gray-200 rounded-2xl px-5 py-4 transition-all font-medium" required />
        <span class="absolute right-4 top-4 text-gray-400">üë§</span>
      </div>
      
      <div class="relative">
        <input id="phone" placeholder="S·ªë ƒëi·ªán tho·∫°i *" type="tel" 
          class="w-full border-2 border-gray-200 rounded-2xl px-5 py-4 transition-all font-medium" required />
        <span class="absolute right-4 top-4 text-gray-400">üì±</span>
      </div>
      
      <select id="province" class="border-2 border-gray-200 rounded-2xl px-5 py-4 transition-all font-medium appearance-none bg-white cursor-pointer">
        <option value="">-- T·ªânh/Th√†nh ph·ªë *</option>
      </select>
      
      <select id="district" class="border-2 border-gray-200 rounded-2xl px-5 py-4 transition-all font-medium appearance-none bg-white cursor-pointer" disabled>
        <option value="">-- Qu·∫≠n/Huy·ªán *</option>
      </select>
      
      <select id="ward" class="md:col-span-2 border-2 border-gray-200 rounded-2xl px-5 py-4 transition-all font-medium appearance-none bg-white cursor-pointer" disabled>
        <option value="">-- Ph∆∞·ªùng/X√£ *</option>
      </select>
      
      <div class="md:col-span-2 relative">
        <input id="address" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng (t·ªëi thi·ªÉu 10 k√Ω t·ª±) *" 
          class="w-full border-2 border-gray-200 rounded-2xl px-5 py-4 transition-all font-medium" required />
        <span class="absolute right-4 top-4 text-gray-400">üè†</span>
      </div>
      
      <textarea id="note" placeholder="Ghi ch√∫ ƒë∆°n h√†ng (kh√¥ng b·∫Øt bu·ªôc)" rows="3" 
        class="md:col-span-2 border-2 border-gray-200 rounded-2xl px-5 py-4 transition-all resize-none font-medium"></textarea>
    </div>
    <input type="hidden" id="province_code" />
    <input type="hidden" id="district_code" />
    <input type="hidden" id="ward_code" />
  </section>

  <!-- Shipping -->
  <section class="bg-white rounded-3xl p-6 shadow-xl border border-gray-100">
    <h2 class="font-bold text-lg mb-4 flex items-center gap-3">
      <span class="text-2xl">üöö</span>
      <span>Ph∆∞∆°ng th·ª©c v·∫≠n chuy·ªÉn</span>
    </h2>
    <div class="flex items-center gap-3 mb-5 bg-blue-50 p-4 rounded-2xl border border-blue-200">
      <svg class="w-5 h-5 text-blue-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
      </svg>
      <div class="text-sm">
        <span class="font-semibold text-gray-700">Kh·ªëi l∆∞·ª£ng ƒë∆°n h√†ng:</span>
        <span id="total-weight" class="font-bold text-blue-700 ml-2">-</span>
      </div>
    </div>
    <div id="shipping-list" class="space-y-3">
      <div class="text-center py-8 text-gray-400">
        <div class="text-4xl mb-3">üì¶</div>
        <p class="font-medium">Vui l√≤ng ch·ªçn ƒë·ªãa ch·ªâ ƒë·ªÉ xem ph√≠ v·∫≠n chuy·ªÉn</p>
      </div>
    </div>
  </section>

  <!-- Voucher Section -->
  <section class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-2xl p-4 shadow-lg border-2 border-amber-200">
    <h2 class="font-bold text-base mb-3 flex items-center gap-2">
      <span class="text-2xl">üéüÔ∏è</span>
      <span>M√£ gi·∫£m gi√°</span>
      <span class="ml-auto text-xs bg-amber-200 text-amber-800 px-3 py-1 rounded-full font-semibold">Kh√¥ng b·∫Øt bu·ªôc</span>
    </h2>
    <div class="flex gap-2">
      <input 
        id="voucher-input" 
        type="text" 
        placeholder="Nh·∫≠p M√£ Gi·∫£m G√≠a" 
        class="voucher-input flex-1 border-2 border-amber-300 rounded-xl px-4 py-2 text-sm font-semibold uppercase transition-all bg-white focus:border-emerald-500"
        autocomplete="off"
      />
      <button 
        id="apply-voucher" 
        class="btn-secondary px-4 py-2 rounded-xl font-semibold text-sm whitespace-nowrap shadow-md hover:shadow-lg transition-all"
      >
        √Åp d·ª•ng
      </button>
    </div>
    <div id="voucher-result" class="hidden mt-4"></div>
  </section>

  <!-- Order Summary -->
<section class="bg-white rounded-3xl p-3 shadow-xl border border-gray-100 sticky bottom-4">
    <h2 class="font-bold text-base mb-2 flex items-center gap-2">
      <span class="text-xl">üí∞</span>
      <span>Chi ti·∫øt thanh to√°n</span>
    </h2>
    <div class="space-y-1 mb-2">
      <div class="flex justify-between items-center text-xs">
        <span class="text-gray-600">T·ªïng s·∫£n ph·∫©m:</span>
        <span id="summary-subtotal" class="font-semibold text-gray-900">0‚Ç´</span>
      </div>
      <div class="flex justify-between items-center text-xs">
        <span class="text-gray-600">Ph√≠ v·∫≠n chuy·ªÉn:</span>
        <span id="summary-shipping" class="font-semibold text-emerald-600">0‚Ç´</span>
      </div>
      </div>
    <div class="flex justify-between items-center py-2 border-t-2 border-gray-200 mb-2">
      <span class="text-sm font-bold text-gray-900">T·ªïng thanh to√°n:</span>
      <span id="grand-total" class="text-lg font-bold" style="color: #ee4d2d;">0‚Ç´</span>
    </div>
    
    <div id="error-message" class="hidden mb-3"></div>
    
    <button id="place-order" 
      class="w-full text-white px-4 py-2 rounded-xl font-bold text-sm disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none" style="background: linear-gradient(135deg, #ee4d2d 0%, #d73211 100%); box-shadow: 0 4px 12px rgba(238, 77, 45, 0.3); transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 6px 20px rgba(238, 77, 45, 0.4)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='0 4px 12px rgba(238, 77, 45, 0.3)'; this.style.transform='translateY(0)'">
      <span class="flex items-center justify-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        <span>ƒê·∫∑t h√†ng ngay</span>
      </span>
    </button>
    
    <div id="order-result" class="text-center mt-3"></div>
    
    <div class="mt-2 flex items-center justify-center gap-2 text-[10px] text-gray-500">
      <div class="flex items-center gap-1">
        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
        </svg>
        <span>Thanh to√°n b·∫£o m·∫≠t</span>
      </div>
      <div class="flex items-center gap-1">
        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
          <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
          <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
        </svg>
        <span>X√°c nh·∫≠n qua email</span>
      </div>
    </div>
  </section>
</main>

<script type="module">
const API_BASE = 'https://shv-api.shophuyvan.workers.dev';
const VN_PHONE_RE = /^(03|05|07|08|09)\d{8}$/;
const $ = id => document.getElementById(id);
const fmtVND = v => (Number(v)||0).toLocaleString('vi-VN') + '‚Ç´';

function cloudify(url, transforms = 'w_200,h_200,c_fill,q_auto,f_auto') {
  if (!url || !url.includes('res.cloudinary.com')) return url;
  return url.replace('/upload/', `/upload/${transforms}/`);
}

async function api(path, opts = {}) {
  const url = `${API_BASE}${path.startsWith('/') ? '' : '/'}${path}`;
  const headers = { ...opts.headers };
  let body = opts.body;
  if (body && typeof body === 'object' && !(body instanceof FormData)) {
    headers['Content-Type'] = 'application/json';
    body = JSON.stringify(body);
  }
  const res = await fetch(url, { method: opts.method || 'GET', headers, body });
  const ctype = res.headers.get('content-type') || '';
  if (ctype.includes('application/json')) return await res.json();
  return await res.text();
}

function getFixedQuotes(weightGrams) {
  const kg = Math.max(1, Math.ceil(Number(weightGrams||0)/1000));
  const cap = Math.min(kg, 6);
  const table = {
    vtp: { name: 'Viettel Post', rates: {1:18000,2:23000,3:28000,4:33000,5:38000,6:43000} },
    ghn: { name: 'GHN', rates: {1:19000,2:19000,3:24000,4:29000,5:34000,6:39000} },
  };
  function extend(code) {
    const r = table[code].rates;
    if(kg<=6) return r[cap];
    const last = r[6], prev = r[5];
    const step = (last - prev) || 5000;
    return last + step*(kg-6);
  }
  return Object.entries(table).map(([code,info])=> ({
    provider: code,
    service_code: 'fixed',
    name: info.name,
    fee: extend(code),
    eta: 'Giao h√†ng ti√™u chu·∫©n'
  }));
}

let selectedShipping = null;
let placing = false;
let appliedVoucher = null;

function getCart() {
  try {
    const lower = JSON.parse(localStorage.getItem('cart') || '[]');
    if (Array.isArray(lower) && lower.length) return lower;
    const upper = JSON.parse(localStorage.getItem('CART') || '[]');
    return Array.isArray(upper) ? upper : [];
  } catch { return []; }
}

function clearCart() {
  try {
    localStorage.removeItem('cart');
    localStorage.removeItem('CART');
    localStorage.removeItem('shv_cart');
    localStorage.removeItem('shv_cart_v1');
    window.dispatchEvent(new Event('storage'));
    window.dispatchEvent(new CustomEvent('shv:cart-changed'));
    console.log('‚úÖ Cart cleared');
  } catch(e) {
    console.error('‚ùå Clear cart error:', e);
  }
}

function calculateTotals() {
  const cart = getCart();
  const subtotal = cart.reduce((sum, item) => sum + Number(item.price || 0) * Number(item.qty || 1), 0);
  const shippingFeeOriginal = selectedShipping ? Number(selectedShipping.fee || 0) : 0;
  const discount = appliedVoucher ? Number(appliedVoucher.discount || 0) : 0;
  const shippingDiscount = appliedVoucher ? Number(appliedVoucher.ship_discount || 0) : 0;
  const shippingFee = Math.max(0, shippingFeeOriginal - shippingDiscount);
  const total = Math.max(0, subtotal + shippingFee - discount);
  return { subtotal, shippingFee, shippingFeeOriginal, discount, shippingDiscount, total };
}

function renderCartItems() {
  const cart = getCart();
  const container = $('cart-items');
  const countEl = $('cart-count');
  
  if (countEl) countEl.textContent = cart.length;
  
  if (!cart.length) {
    container.innerHTML = `
      <div class="p-12 text-center">
        <div class="text-7xl mb-4 animate-bounce">üõí</div>
        <p class="text-xl text-gray-500 font-semibold mb-6">Gi·ªè h√†ng tr·ªëng</p>
        <a href="/" class="inline-flex items-center gap-2 px-8 py-4 btn-primary text-white rounded-2xl font-bold shadow-lg hover:shadow-xl transition-all">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
          </svg>
          <span>Ti·∫øp t·ª•c mua s·∫Øm</span>
        </a>
      </div>
    `;
    return;
  }
  
  container.innerHTML = cart.map(item => {
    const image = cloudify(item.variantImage || item.image || '/icon.png');
    const itemTotal = Number(item.price || 0) * Number(item.qty || 1);
    return `
      <div class="product-card p-5 flex gap-5 items-start">
        <div class="relative flex-shrink-0">
          <img src="${image}" alt="${item.name}" 
            class="w-28 h-28 rounded-2xl object-cover border-2 border-gray-100 shadow-md" 
            loading="lazy" 
            onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22112%22 height=%22112%22%3E%3Crect fill=%22%23e5e7eb%22 width=%22112%22 height=%22112%22 rx=%2216%22/%3E%3C/svg%3E'" />
          <div class="absolute -top-2 -right-2 bg-emerald-500 text-white text-xs font-bold rounded-full w-7 h-7 flex items-center justify-center shadow-lg">
            ${item.qty}
          </div>
        </div>
        <div class="flex-1 min-w-0">
          <h3 class="font-bold text-sm line-clamp-2 mb-2 text-gray-900">${item.name || 'S·∫£n Ph·∫©m'}</h3>
          ${item.variantName || item.variant ? `
            <div class="mb-3">
              <span class="inline-block px-2 py-0.5 text-xs rounded-md bg-blue-500 text-white font-medium">
                ${item.variantName || item.variant}
              </span>
            </div>
          ` : ''}
          <div class="flex items-end justify-between mt-auto">
            <div>
              <div class="text-sm font-bold" style="color: #ee4d2d;">${fmtVND(item.price)}</div>
            </div>
            <div class="text-right">
              <div class="text-base font-medium text-gray-700">
                x ${item.qty || 1}
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  updateSummary();
}

function toHumanWeight(grams) {
  const g = Number(grams || 0);
  if (g <= 0) return '0 g';
  if (g < 1000) return `${g} g`;
  const kg = g / 1000;
  return (kg % 1 === 0) ? `${kg.toFixed(0)} kg` : `${kg.toFixed(1)} kg`;
}

function updateSummary() {
  const { subtotal, shippingFee, shippingFeeOriginal, discount, shippingDiscount, total } = calculateTotals();
  
  $('subtotal').textContent = fmtVND(subtotal);
  $('summary-subtotal').textContent = fmtVND(subtotal);
  
  // Show original shipping fee with strikethrough if discount applied
  if (shippingDiscount > 0) {
    $('summary-shipping').innerHTML = `
      <span class="line-through text-gray-400 mr-2">${fmtVND(shippingFeeOriginal)}</span>
      <span class="text-emerald-600 font-bold">${fmtVND(shippingFee)}</span>
    `;
  } else {
    $('summary-shipping').textContent = fmtVND(shippingFee);
  }
  
  // Add/update discount row
  let discountRow = document.querySelector('#discount-row');
  const summaryDiv = document.querySelector('.space-y-1.mb-2'); // S·ª¨A: ƒê√∫ng selector
  
  if ((discount > 0 || shippingDiscount > 0) && summaryDiv) {
    const totalDiscount = discount + shippingDiscount;
    if (!discountRow) {
      discountRow = document.createElement('div');
      discountRow.id = 'discount-row';
      discountRow.className = 'flex justify-between items-center text-xs slide-in'; // S·ª¨A: K√≠ch th∆∞·ªõc ch·ªØ
      summaryDiv.appendChild(discountRow);
    }
    discountRow.innerHTML = `
      <span class="text-emerald-700 font-semibold flex items-center gap-1.5">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"> <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
        </svg>
        <span>Gi·∫£m gi√°:</span>
      </span>
      <span class="font-bold text-emerald-600">-${fmtVND(totalDiscount)}</span>
    `;
  } else if (discountRow) {
    discountRow.remove();
  }
  
  $('grand-total').textContent = fmtVND(total);
  
  const cart = getCart();
  const totalWeight = cart.reduce(
    (sum, item) => sum + Number(item.weight_gram || item.weight || 0) * Number(item.qty || 1),
    0
  );
  $('total-weight').textContent = toHumanWeight(totalWeight);
}

async function loadProvinces() {
  try {
    const res = await api('/shipping/provinces');
    const provinces = res.items || res.data || [];
    const select = $('province');
    select.innerHTML = '<option value="">-- T·ªânh/Th√†nh ph·ªë *</option>';
    provinces.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item.code;
      opt.textContent = item.name;
      select.appendChild(opt);
    });
  } catch (e) {
    console.error('Load provinces error:', e);
  }
}

async function loadDistricts(provinceCode) {
  try {
    const res = await api(`/shipping/districts?province_code=${encodeURIComponent(provinceCode)}`);
    const districts = res.items || res.data || [];
    const select = $('district');
    select.innerHTML = '<option value="">-- Qu·∫≠n/Huy·ªán *</option>';
    select.disabled = false;
    districts.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item.code;
      opt.textContent = item.name;
      select.appendChild(opt);
    });
    $('ward').innerHTML = '<option value="">-- Ph∆∞·ªùng/X√£ *</option>';
    $('ward').disabled = true;
    $('district_code').value = '';
    $('ward_code').value = '';
  } catch (e) {
    console.error('Load districts error:', e);
  }
}

async function loadWards(districtCode) {
  try {
    const res = await api(`/shipping/wards?district_code=${encodeURIComponent(districtCode)}`);
    const wards = res.items || res.data || [];
    const select = $('ward');
    select.innerHTML = '<option value="">-- Ph∆∞·ªùng/X√£ *</option>';
    select.disabled = false;
    wards.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item.code;
      opt.textContent = item.name;
      select.appendChild(opt);
    });
    $('ward_code').value = '';
  } catch (e) {
    console.error('Load wards error:', e);
  }
}

async function getShippingQuote() {
  const provinceEl = $('province');
  const districtEl = $('district');
  const provinceName = provinceEl.options[provinceEl.selectedIndex]?.text || '';
  const districtName = districtEl.options[districtEl.selectedIndex]?.text || '';
  
  if (!provinceName || !districtName || provinceEl.value === '') {
    $('shipping-list').innerHTML = `
      <div class="text-center py-8 text-gray-400">
        <div class="text-4xl mb-3">üìç</div>
        <p class="font-medium">Vui l√≤ng ch·ªçn ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß</p>
      </div>
    `;
    return;
  }
  
  try {
    $('shipping-list').innerHTML = `
      <div class="text-center py-8">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-emerald-200 border-t-emerald-600 mb-3"></div>
        <p class="text-gray-600 font-medium">ƒêang t·∫£i ph√≠ v·∫≠n chuy·ªÉn...</p>
      </div>
    `;
    
    const cart = getCart();
    const weight = cart.reduce((sum, item) => sum + Number(item.weight_gram || item.weight || 0) * Number(item.qty || 1), 0) || 500;
    const subtotal = cart.reduce((sum, item) => sum + Number(item.price || 0) * Number(item.qty || 1), 0);
    
    let items = [];
    
    try {
      const payload = {
        receiver_province: provinceName,
        receiver_district: districtName,
        weight_gram: weight,
        value: subtotal,
        cod: subtotal
      };
      const res = await api('/shipping/price', {
        method: 'POST',
        body: payload
      });
      const apiItems = res.items || res.data || [];
      items = apiItems.map(o => ({
        provider: o.provider || o.carrier || '',
        service_code: o.service_code || o.service || '',
        name: o.name || o.service_name || o.provider,
        fee: Number(o.fee || o.total_fee || 0),
        eta: o.eta || o.leadtime || ''
      }));
    } catch (e) {
      console.log('API shipping failed, using fallback');
    }
    
    items = items.filter(o => o.fee > 0);
    if (!items.length) {
      $('shipping-list').innerHTML = `
        <div class="text-center py-8 text-gray-400">
          <div class="text-4xl mb-3">üì¶</div>
          <p class="font-medium">Kh√¥ng c√≥ d·ªãch v·ª• v·∫≠n chuy·ªÉn kh·∫£ d·ª•ng</p>
        </div>
      `;
      return;
    }
    
    const seen = new Set();
    items = items.filter(item => {
      const key = `${item.provider}-${item.service_code}`;
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    }).sort((a, b) => a.fee - b.fee);
    
    $('shipping-list').innerHTML = items.map((item, idx) => `
      <label class="shipping-option flex items-center justify-between rounded-2xl p-3 ${idx === 0 ? 'selected' : ''} cursor-pointer">
        <div class="flex items-center gap-3 flex-1">
          <input type="radio" name="ship_opt" value="${idx}" ${idx === 0 ? 'checked' : ''} 
            data-provider="${item.provider}" data-service="${item.service_code}" 
            data-fee="${item.fee}" data-eta="${item.eta || ''}" data-name="${item.name}"
            class="w-4 h-4 text-emerald-600 focus:ring-2 focus:ring-emerald-500" />
          <div class="flex-1">
            <div class="font-bold text-sm text-gray-900">${item.name}</div>
            <div class="text-xs text-gray-600 mt-1 flex items-center gap-1.5">
              <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
              </svg>
              <span>${item.eta || 'Giao h√†ng ti√™u chu·∫©n'}</span>
            </div>
          </div>
        </div>
        <div class="font-bold text-lg text-emerald-600">${fmtVND(item.fee)}</div>
      </label>
    `).join('');
    
    document.querySelectorAll('input[name="ship_opt"]').forEach(radio => {
      radio.addEventListener('change', function() {
        document.querySelectorAll('.shipping-option').forEach(opt => opt.classList.remove('selected'));
        this.closest('.shipping-option').classList.add('selected');
        selectedShipping = {
          provider: this.dataset.provider,
          service_code: this.dataset.service,
          fee: Number(this.dataset.fee || 0),
          eta: this.dataset.eta,
          name: this.dataset.name
        };
        updateSummary();
      });
    });
    
    const firstRadio = document.querySelector('input[name="ship_opt"]');
    if (firstRadio) {
      selectedShipping = {
        provider: firstRadio.dataset.provider,
        service_code: firstRadio.dataset.service,
        fee: Number(firstRadio.dataset.fee || 0),
        eta: firstRadio.dataset.eta,
        name: firstRadio.dataset.name
      };
      updateSummary();
    }
  } catch (e) {
    console.error('Get quote error:', e);
    $('shipping-list').innerHTML = `
      <div class="error-message p-5 rounded-2xl text-center">
        <div class="text-3xl mb-2">‚ö†Ô∏è</div>
        <p class="font-semibold text-red-700">L·ªói khi l·∫•y ph√≠ v·∫≠n chuy·ªÉn</p>
      </div>
    `;
  }
}

async function applyVoucher() {
  const input = $('voucher-input');
  const btn = $('apply-voucher');
  const result = $('voucher-result');
  const code = input.value.trim().toUpperCase();
  
  if (!code) {
    result.innerHTML = `
      <div class="error-message p-4 rounded-2xl flex items-center gap-3">
        <svg class="w-6 h-6 text-red-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
        </svg>
        <span class="font-semibold text-red-700">Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°</span>
      </div>
    `;
    result.classList.remove('hidden');
    return;
  }
  
  btn.disabled = true;
  btn.innerHTML = '<span class="pulse">ƒêang ki·ªÉm tra...</span>';
  result.innerHTML = `
    <div class="info-message p-4 rounded-2xl flex items-center gap-3">
      <div class="inline-block animate-spin rounded-full h-5 w-5 border-2 border-blue-200 border-t-blue-600"></div>
      <span class="font-medium text-blue-700">ƒêang ki·ªÉm tra m√£ gi·∫£m gi√°...</span>
    </div>
  `;
  result.classList.remove('hidden');
  
  try {
    const cart = getCart();
    const subtotal = cart.reduce((sum, item) => sum + Number(item.price || 0) * Number(item.qty || 1), 0);
    
    const res = await api('/vouchers/apply', {
      method: 'POST',
      body: {
        code: code,
        subtotal: subtotal,
        customer_id: null
      }
    });
    
    if (res.ok === true && res.valid === true) {
      appliedVoucher = {
        code: res.code,
        discount: res.discount || 0,
        ship_discount: res.ship_discount || 0
      };
      
      const totalSaved = (res.discount || 0) + (res.ship_discount || 0);
      result.innerHTML = `
        <div class="success-message p-3 rounded-2xl">
          <div class="flex items-center gap-2">
            <div class="flex-shrink-0">
              <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
            </div>
            <div class="flex-1">
              <div class="font-bold text-sm text-green-800">
                ${res.message || '√Åp d·ª•ng m√£ gi·∫£m gi√° th√†nh c√¥ng!'}
              </div>
              <div class="text-green-700 text-xs">
                B·∫°n ƒë√£ ti·∫øt ki·ªám ƒë∆∞·ª£c <span class="font-bold text-sm">${fmtVND(totalSaved)}</span>
              </div>
            </div>
            <button onclick="clearVoucher()" class="text-green-700 hover:text-green-900 font-bold text-lg">
              ‚úï
            </button>
          </div>
        </div>
      `;
      input.disabled = true;
      btn.textContent = '‚úì ƒê√£ √°p d·ª•ng';
      // X√≥a class k√≠ch th∆∞·ªõc c≈©
      btn.classList.remove('px-4', 'py-2', 'text-sm');
      // Th√™m class m√†u v√† class k√≠ch th∆∞·ªõc m·ªõi (nh·ªè h∆°n)
      btn.classList.add('bg-green-100', 'text-green-700', 'border-green-300', 'px-3', 'py-1.5', 'text-xs');
      updateSummary();
    } else {
      appliedVoucher = null;
      result.innerHTML = `
        <div class="error-message p-4 rounded-2xl flex items-center gap-3">
          <svg class="w-6 h-6 text-red-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
          </svg>
          <span class="font-semibold text-red-700">${res.message || 'M√£ gi·∫£m gi√° kh√¥ng h·ª£p l·ªá'}</span>
        </div>
      `;
      btn.disabled = false;
      btn.textContent = '√Åp d·ª•ng';
      updateSummary();
    }
  } catch (err) {
    appliedVoucher = null;
    result.innerHTML = `
      <div class="error-message p-4 rounded-2xl flex items-center gap-3">
        <svg class="w-6 h-6 text-red-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
        </svg>
        <span class="font-semibold text-red-700">${err.message || 'C√≥ l·ªói x·∫£y ra khi ki·ªÉm tra m√£'}</span>
      </div>
    `;
    btn.disabled = false;
    btn.textContent = '√Åp d·ª•ng';
    updateSummary();
  }
}

window.clearVoucher = function() {
  appliedVoucher = null;
  $('voucher-input').value = '';
  $('voucher-input').disabled = false;
  $('voucher-result').classList.add('hidden');
  const btn = $('apply-voucher');
  btn.textContent = '√Åp d·ª•ng';
  btn.disabled = false;
  btn.classList.remove('bg-green-100', 'text-green-700', 'border-green-300');
  updateSummary();
};

function showError(message) {
  const errorEl = $('error-message');
  errorEl.innerHTML = `
    <div class="error-message p-4 rounded-2xl flex items-center gap-3">
      <svg class="w-6 h-6 text-red-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
      </svg>
      <span class="font-semibold text-red-700">${message}</span>
    </div>
  `;
  errorEl.classList.remove('hidden');
  setTimeout(() => {
    errorEl.classList.add('hidden');
  }, 6000);
}

async function placeOrder() {
  const btn = $('place-order');
  const resultEl = $('order-result');
  
  if (placing) return;
  placing = true;
  
  const name = $('name').value.trim();
  const phone = $('phone').value.trim();
  const address = $('address').value.trim();
  const provinceCode = $('province_code').value;
  const districtCode = $('district_code').value;
  const wardCode = $('ward_code').value;
  const note = $('note').value.trim();
  
  if (!name || !phone || !address || !provinceCode || !districtCode || !wardCode) {
    showError('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªãa ch·ªâ nh·∫≠n h√†ng!');
    placing = false;
    return;
  }

  if (address.length < 10) {
    showError('ƒê·ªãa ch·ªâ chi ti·∫øt qu√° ng·∫Øn. Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß s·ªë nh√†, t√™n ƒë∆∞·ªùng (t·ªëi thi·ªÉu 10 k√Ω t·ª±).');
    placing = false;
    $('address').focus();
    return;
  }
  
  const cleanPhone = phone.replace(/\D/g, '');
  if (!VN_PHONE_RE.test(cleanPhone)) {
    showError('S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá! Vui l√≤ng nh·∫≠p ƒë√∫ng ƒë·ªãnh d·∫°ng (VD: 0912345678).');
    placing = false;
    return;
  }
  
  if (!selectedShipping) {
    showError('Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c v·∫≠n chuy·ªÉn!');
    placing = false;
    return;
  }
  
  const cart = getCart();
  if (!cart.length) {
    showError('Gi·ªè h√†ng tr·ªëng!');
    placing = false;
    return;
  }
  
  const { subtotal, shippingFee, shippingFeeOriginal, discount, shippingDiscount, total } = calculateTotals();
  
  btn.disabled = true;
  btn.innerHTML = `
    <span class="flex items-center justify-center gap-3">
      <div class="inline-block animate-spin rounded-full h-6 w-6 border-3 border-white border-t-transparent"></div>
      <span>ƒêang x·ª≠ l√Ω ƒë∆°n h√†ng...</span>
    </span>
  `;
  resultEl.textContent = '';
  
  try {
    const provinceName = $('province').options[$('province').selectedIndex]?.text || '';
    const districtName = $('district').options[$('district').selectedIndex]?.text || '';
    const communeName = $('ward').options[$('ward').selectedIndex]?.text || '';
    
    const payload = {
      customer: {
        name: name,
        phone: cleanPhone,
        address: address,
        province: provinceName,
        district: districtName,
        commune: communeName,
        province_code: provinceCode,
        district_code: districtCode,
        commune_code: wardCode,
        ward_code: wardCode
      },
      items: cart.map(item => ({
        id: item.id,
        sku: item.sku || item.id,
        name: item.name || item.title,
        price: Number(item.price || 0),
        cost: Number(item.cost || 0),
        qty: Number(item.qty || 1),
        weight_gram: Number(item.weight_gram || item.weight || 0),
        variant: item.variantName || item.variant || '',
        image: item.variantImage || item.image || ''
      })),
      totals: {
        subtotal: subtotal,
        shipping_fee: shippingFeeOriginal,
        discount: discount,
        shipping_discount: shippingDiscount,
        total: total
      },
      shipping_provider: selectedShipping.provider,
      shipping_service: selectedShipping.service_code,
      shipping_name: selectedShipping.name,
      shipping_eta: selectedShipping.eta,
      shipping_fee: shippingFeeOriginal,
      discount: discount,
      shipping_discount: shippingDiscount,
      voucher_code: appliedVoucher ? appliedVoucher.code : '',
      note: note,
      source: 'website',
      status: 'placed'
    };
    
    console.log('Order payload:', payload);
    
    const res = await api('/api/orders', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Idempotency-Key': 'order-' + Date.now() + '-' + Math.random().toString(36).slice(2)
      },
      body: payload
    });
    
    if (res.ok || res.id) {
      const orderId = res.id || res.order_id || '';
      
      clearCart();
      
      resultEl.innerHTML = `
        <div class="success-message p-6 rounded-2xl shadow-lg">
          <div class="flex flex-col items-center text-center gap-4">
            <div class="w-16 h-16 rounded-full bg-green-500 flex items-center justify-center">
              <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
            </div>
            <div>
              <div class="text-2xl font-bold text-green-800 mb-2">ƒê·∫∑t h√†ng th√†nh c√¥ng!</div>
              <div class="text-green-700 mb-1">M√£ ƒë∆°n h√†ng: <span class="font-bold">${orderId}</span></div>
              <div class="text-sm text-green-600">Ch√∫ng t√¥i s·∫Ω li√™n h·ªá v·ªõi b·∫°n trong th·ªùi gian s·ªõm nh·∫•t.</div>
            </div>
          </div>
        </div>
      `;
      
      setTimeout(() => {
        window.location.href = '/?order_success=1&order_id=' + orderId;
      }, 2500);
    } else {
      throw new Error(res.error || res.message || 'ƒê·∫∑t h√†ng th·∫•t b·∫°i');
    }
  } catch (e) {
    console.error('Place order error:', e);
    showError(e.message || 'C√≥ l·ªói x·∫£y ra khi ƒë·∫∑t h√†ng. Vui l√≤ng th·ª≠ l·∫°i.');
    btn.disabled = false;
    btn.innerHTML = `
      <span class="flex items-center justify-center gap-3">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        <span>ƒê·∫∑t h√†ng ngay</span>
      </span>
    `;
    placing = false;
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  const cart = getCart();
  if (!cart.length) {
    showError('Gi·ªè h√†ng tr·ªëng! Vui l√≤ng th√™m s·∫£n ph·∫©m tr∆∞·ªõc khi thanh to√°n.');
    setTimeout(() => {
      window.location.href = '/';
    }, 2000);
    return;
  }
  
  renderCartItems();
  await loadProvinces();
  
  $('province').addEventListener('change', function() {
    $('province_code').value = this.value;
    if (this.value) {
      loadDistricts(this.value);
    }
    getShippingQuote();
  });
  
  $('district').addEventListener('change', function() {
    $('district_code').value = this.value;
    if (this.value) {
      loadWards(this.value);
    }
    getShippingQuote();
  });
  
  $('ward').addEventListener('change', function() {
    $('ward_code').value = this.value;
  });
  
  $('place-order').addEventListener('click', placeOrder);
  
  const applyVoucherBtn = $('apply-voucher');
  const voucherInput = $('voucher-input');
  if (applyVoucherBtn) {
    applyVoucherBtn.addEventListener('click', applyVoucher);
  }
  if (voucherInput) {
    voucherInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        applyVoucher();
      }
    });
  }
  
  ['name', 'phone', 'address'].forEach(id => {
    const el = $(id);
    if (el) {
      el.addEventListener('input', updateSummary);
    }
  });
});

console.log('‚úÖ Checkout page loaded - Voucher integrated');
</script>

</body>
</html>