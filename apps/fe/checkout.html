<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thanh to√°n - Shop Huy V√¢n</title>
  <meta name="description" content="Thanh to√°n ƒë∆°n h√†ng t·∫°i Shop Huy V√¢n">
  <meta name="robots" content="noindex, nofollow">
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    * { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    
    .product-card { transition: all 0.2s ease; }
    .product-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    
    .variant-badge { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .shipping-option { 
      transition: all 0.2s ease;
      cursor: pointer;
      border: 2px solid #e5e7eb;
    }
    
    .shipping-option:hover { 
      border-color: #10b981;
    }
    
    .shipping-option.selected { 
      border-color: #10b981;
      background: #ecfdf5;
    }
    
    .skeleton { 
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); 
      background-size: 200% 100%; 
      animation: loading 1.5s ease-in-out infinite;
    }
    
    @keyframes loading { 
      0% { background-position: 200% 0; } 
      100% { background-position: -200% 0; } 
    }
    
    .voucher-input:focus {
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      transition: all 0.2s ease;
    }
    
    .btn-primary:hover {
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      border: 2px solid #10b981;
      color: #10b981;
      transition: all 0.2s ease;
    }
    
    .btn-secondary:hover {
      background: #10b981;
      color: white;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    .success-message {
      background: #d1fae5;
      border: 2px solid #10b981;
    }
    
    .error-message {
      background: #fee2e2;
      border: 2px solid #ef4444;
    }
    
    /* Fix mobile overflow */
    @media (max-width: 768px) {
      .summary-section {
        position: relative !important;
        bottom: auto !important;
      }
    }
  </style>
</head>

<body class="bg-gray-50">

<header class="bg-white border-b sticky top-0 z-50 shadow-sm">
  <div class="max-w-4xl mx-auto px-3 py-2.5 flex items-center gap-2">
    <a href="/" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
      <img src="/logo.png" class="w-8 h-8 rounded" alt="Logo" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2232%22 height=%2232%22%3E%3Crect fill=%22%2310b981%22 width=%2232%22 height=%2232%22 rx=%224%22/%3E%3C/svg%3E'" />
      <span class="font-bold text-sm sm:text-base">SHOP HUY V√ÇN</span>
    </a>
    <div class="ml-auto text-xs sm:text-sm text-gray-600 flex items-center gap-1">
      <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
      </svg>
      <span class="hidden sm:inline">B·∫£o m·∫≠t</span>
    </div>
  </div>
</header>

<main class="max-w-4xl mx-auto px-3 py-4 space-y-3">
  
  <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Thanh to√°n</h1>
  
  <!-- Cart Items -->
  <section class="bg-white rounded-xl shadow-sm overflow-hidden">
    <div class="p-3 border-b bg-emerald-50">
      <h2 class="font-semibold text-sm sm:text-base flex items-center gap-2">
        <span>üõí</span>
        <span>ƒê∆°n h√†ng (<span id="cart-count">0</span>)</span>
      </h2>
    </div>
    <div id="cart-items" class="divide-y max-h-80 overflow-y-auto">
      <div class="p-6 text-center">
        <div class="skeleton w-full h-24 rounded-lg"></div>
      </div>
    </div>
    <div class="p-3 border-t bg-gray-50">
      <div class="flex justify-between items-center text-sm sm:text-base font-semibold">
        <span>T·∫°m t√≠nh</span>
        <span id="subtotal" class="text-emerald-600">0‚Ç´</span>
      </div>
    </div>
  </section>

  <!-- Customer Info -->
  <section class="bg-white rounded-xl p-3 sm:p-4 shadow-sm">
    <h2 class="font-semibold text-sm sm:text-base mb-3 flex items-center gap-2">
      <span>üìç</span>
      <span>Th√¥ng tin nh·∫≠n h√†ng</span>
    </h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2.5">
      <input id="name" placeholder="H·ªç t√™n *" 
        class="w-full border border-gray-300 rounded-lg px-3 py-2.5 text-sm" required />
      
      <input id="phone" placeholder="S·ªë ƒëi·ªán tho·∫°i *" type="tel" 
        class="w-full border border-gray-300 rounded-lg px-3 py-2.5 text-sm" required />
      
      <select id="province" class="border border-gray-300 rounded-lg px-3 py-2.5 text-sm bg-white">
        <option value="">-- T·ªânh/Th√†nh *</option>
      </select>
      
      <select id="district" class="border border-gray-300 rounded-lg px-3 py-2.5 text-sm bg-white" disabled>
        <option value="">-- Qu·∫≠n/Huy·ªán *</option>
      </select>
      
      <select id="ward" class="sm:col-span-2 border border-gray-300 rounded-lg px-3 py-2.5 text-sm bg-white" disabled>
        <option value="">-- Ph∆∞·ªùng/X√£ *</option>
      </select>
      
      <input id="address" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng (t·ªëi thi·ªÉu 10 k√Ω t·ª±) *" 
        class="sm:col-span-2 w-full border border-gray-300 rounded-lg px-3 py-2.5 text-sm" required />
      
      <textarea id="note" placeholder="Ghi ch√∫ (kh√¥ng b·∫Øt bu·ªôc)" rows="2" 
        class="sm:col-span-2 border border-gray-300 rounded-lg px-3 py-2.5 text-sm resize-none"></textarea>
    </div>
    <input type="hidden" id="province_code" />
    <input type="hidden" id="district_code" />
    <input type="hidden" id="ward_code" />
  </section>

  <!-- Shipping -->
  <section class="bg-white rounded-xl p-3 sm:p-4 shadow-sm">
    <h2 class="font-semibold text-sm sm:text-base mb-2 flex items-center gap-2">
      <span>üöö</span>
      <span>V·∫≠n chuy·ªÉn</span>
    </h2>
    <div class="text-xs sm:text-sm text-gray-600 mb-3 bg-blue-50 p-2 rounded">
      Kh·ªëi l∆∞·ª£ng: <span id="total-weight" class="font-semibold">-</span>
    </div>
    <div id="shipping-list" class="space-y-2">
      <div class="text-center py-4 text-sm text-gray-500">
        Vui l√≤ng ch·ªçn ƒë·ªãa ch·ªâ
      </div>
    </div>
  </section>

  <!-- Voucher -->
  <section class="bg-amber-50 rounded-xl p-3 sm:p-4 shadow-sm border border-amber-200">
    <h2 class="font-semibold text-sm sm:text-base mb-3 flex items-center gap-2">
      <span>üéüÔ∏è</span>
      <span>M√£ gi·∫£m gi√°</span>
    </h2>
    <div class="flex gap-2">
      <input 
        id="voucher-input" 
        type="text" 
        placeholder="Nh·∫≠p m√£ (VD: OPEN111)" 
        class="voucher-input flex-1 border border-amber-300 rounded-lg px-3 py-2.5 text-sm font-medium uppercase bg-white"
        autocomplete="off"
      />
      <button 
        id="apply-voucher" 
        class="btn-secondary px-4 sm:px-6 py-2.5 rounded-lg font-semibold text-sm whitespace-nowrap"
      >
        √Åp d·ª•ng
      </button>
    </div>
    <div id="voucher-result" class="hidden mt-3"></div>
  </section>

  <!-- Summary -->
  <section class="summary-section bg-white rounded-xl p-3 sm:p-4 shadow-sm">
    <h2 class="font-semibold text-sm sm:text-base mb-3">Chi ti·∫øt thanh to√°n</h2>
    <div class="space-y-2 mb-3 text-sm">
      <div class="flex justify-between">
        <span>T·ªïng s·∫£n ph·∫©m:</span>
        <span id="summary-subtotal" class="font-semibold">0‚Ç´</span>
      </div>
      <div class="flex justify-between">
        <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
        <span id="summary-shipping" class="font-semibold text-emerald-600">0‚Ç´</span>
      </div>
    </div>
    <div class="flex justify-between py-3 border-t text-base sm:text-lg font-bold">
      <span>T·ªïng:</span>
      <span id="grand-total" class="text-emerald-600">0‚Ç´</span>
    </div>
    
    <div id="error-message" class="hidden mb-3"></div>
    
    <button id="place-order" 
      class="btn-primary w-full text-white px-4 py-3 sm:py-3.5 rounded-lg font-bold text-sm sm:text-base disabled:opacity-50">
      ƒê·∫∑t h√†ng
    </button>
    
    <div id="order-result" class="text-center mt-3 text-sm"></div>
  </section>
</main>

<script type="module">
const API_BASE = 'https://shv-api.shophuyvan.workers.dev';
const VN_PHONE_RE = /^(03|05|07|08|09)\d{8}$/;
const $ = id => document.getElementById(id);
const fmtVND = v => (Number(v)||0).toLocaleString('vi-VN') + '‚Ç´';

function cloudify(url, transforms = 'w_150,h_150,c_fill,q_auto,f_auto') {
  if (!url || !url.includes('res.cloudinary.com')) return url;
  return url.replace('/upload/', `/upload/${transforms}/`);
}

async function api(path, opts = {}) {
  const url = `${API_BASE}${path.startsWith('/') ? '' : '/'}${path}`;
  const headers = { ...opts.headers };
  let body = opts.body;
  if (body && typeof body === 'object' && !(body instanceof FormData)) {
    headers['Content-Type'] = 'application/json';
    body = JSON.stringify(body);
  }
  const res = await fetch(url, { method: opts.method || 'GET', headers, body });
  const ctype = res.headers.get('content-type') || '';
  if (ctype.includes('application/json')) return await res.json();
  return await res.text();
}

let selectedShipping = null;
let placing = false;
let appliedVoucher = null;

function getCart() {
  try {
    const lower = JSON.parse(localStorage.getItem('cart') || '[]');
    if (Array.isArray(lower) && lower.length) 