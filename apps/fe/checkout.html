<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thanh toán - Shop Huy Vân</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module" src="/src/pixels.js?v=99"></script>
\n  <script>window.API_BASE="https://shv-api.shophuyvan.workers.dev";</script>
</head>
<body class="bg-gray-50">
<header class="border-b bg-white">
  <div class="max-w-3xl mx-auto px-4 py-3 flex items-center gap-3">
    <a href="/" class="flex items-center gap-2"><img src="/public/logo.png" class="w-7 h-7"/><span class="font-bold">SHOP HUY VÂN</span></a>
  </div>
</header>

<main class="max-w-3xl mx-auto px-4 py-6 space-y-4">
  <h1 class="font-semibold text-lg">Thanh toán</h1>
  <section class="bg-white border rounded p-4">
    <h2 class="font-semibold">Địa chỉ nhận</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2">
      <input id="name" placeholder="Họ tên" class="border rounded px-3 py-2" />
      <input id="phone" placeholder="Số điện thoại" class="border rounded px-3 py-2" />
      <input id="province" placeholder="Tỉnh/Thành" class="border rounded px-3 py-2" />
      <input id="district" placeholder="Quận/Huyện" class="border rounded px-3 py-2" />
      <input id="ward" placeholder="Phường/Xã" class="border rounded px-3 py-2" />
      <input id="address" placeholder="Địa chỉ chi tiết" class="md:col-span-2 border rounded px-3 py-2" />
    </div>
  </section>

  <section class="bg-white border rounded p-4">
    <h2 class="font-semibold">Vận chuyển</h2>
    <button id="get-quote" class="border rounded px-3 py-1 mt-2">Lấy báo giá</button>
    <div id="quote-list" class="mt-3 grid gap-2"></div>
  </section>

  <section class="bg-white border rounded p-4">
    <h2 class="font-semibold">Mã giảm</h2>
    <div class="flex gap-2 mt-2">
      <input id="voucher" placeholder="Nhập mã" class="border rounded px-3 py-2">
      <button id="test-voucher" class="border rounded px-3 py-2">Áp dụng</button>
    </div>
    <div id="voucher-result" class="text-sm mt-2"></div>
  </section>

  <section class="bg-white border rounded p-4">
    <h2 class="font-semibold">Đặt hàng</h2>
    <button id="place-order" class="bg-emerald-600 text-white px-4 py-2 rounded">Đặt hàng</button>
    <div id="order-result" class="text-sm mt-2"></div>
  </section>

  <section class="bg-white border rounded p-4">
    <h2 class="font-semibold mb-2">Mã khuyến mãi</h2>
    <div class="flex gap-2">
      <input id="voucher" class="border rounded px-3 py-2 flex-1" placeholder="Nhập mã voucher (miễn phí ship / giảm giá)">
      <button id="apply-voucher" class="bg-rose-600 text-white px-4 py-2 rounded">Áp dụng</button>
    </div>
    <div id="voucher-result" class="text-sm mt-2"></div>
    <div class="font-semibold mt-4 mb-2">Chi tiết thanh toán</div>
    <div id="cart-summary" class="text-sm"></div>
  </section>

</main>

<script type="module" src="/src/checkout.js?v=99"></script>
<script type="module" src="/src/tracking.js?v=99"></script>
<script type="module" src="/src/frontend.js?v=99"></script>
<script type="module" src="/src/voucher-ui.js?v=99"></script>

<!-- SHV fallback: auto shipping quote via API if original /src scripts don't run or return mock -->
<script>
(function(){
  if (window.SHV_FALLBACK_SHIPPING) return; window.SHV_FALLBACK_SHIPPING = true;
  const api = (path, opt={}) => fetch((window.Admin?.getApiBase?.()||'https://shv-api.shophuyvan.workers.dev') + path, Object.assign({headers:{'content-type':'application/json'}}, opt)).then(r=>r.json()).catch(()=>null);
  const el = (id)=>document.getElementById(id);
  const money = (v)=> (Number(v||0)).toLocaleString('vi-VN') + 'đ';

  async function autoQuote(){
    const to_province = el('province')?.value?.trim() || '';
    const to_district = el('district')?.value?.trim() || '';
    if(!to_province || !to_district) return; // wait until address filled

    // naive weight fallback: 500g if không có dữ liệu
    let weight = window.__SHV_TOTAL_WEIGHT__ || 0; if(!weight){ try{ const wDom = document.querySelector('[data-cart-weight]')?.dataset?.cartWeight || ''; weight = Math.max(0, parseInt(wDom)) || 500; }catch(e){ weight = 500; } } }

    const params = new URLSearchParams({ weight: String(weight), to_province, to_district });
    const rs = await fetch((window.Admin?.getApiBase?.()||'https://shv-api.shophuyvan.workers.dev') + '/shipping/quote?' + params.toString()).then(r=>r.json()).catch(()=>null);
    if(!(rs && (rs.ok||Array.isArray(rs)))) return;

    const list = Array.isArray(rs) ? rs : (rs.items||[]);
    const ql = el('quote-list'); if(!ql) return;
    if(!list.length){ ql.innerHTML = '<div class="text-sm text-gray-500">Không có DVVC khả dụng.</div>'; return; }
    ql.innerHTML = list.map((x,i)=>{
      const id = 'ship_'+(i+1);
      return \`<label class="flex items-center justify-between border rounded p-2 cursor-pointer">
        <div class="flex items-center gap-2">
          <input type="radio" name="ship_opt" value="\${x.provider}|\\${x.service_code}|\\${x.fee}" \${i===0?'checked':''}/>
          <div class="font-semibold">\${x.provider} - \${x.name||x.service_code||''}</div>
        </div>
        <div class="font-semibold">\${money(x.fee||0)}</div>
      </label>\`;
    }).join('');

    // Update totals on change
    const radios = ql.querySelectorAll('input[name="ship_opt"]');
    const updateFee = ()=>{
      const val = ql.querySelector('input[name="ship_opt"]:checked')?.value||'';
      const fee = Number(val.split('|')[2]||0);
      let feeRow = document.getElementById('shv-fee-row');
      if(!feeRow){
        feeRow = document.createElement('div');
        feeRow.id = 'shv-fee-row';
        feeRow.className = 'mt-2 text-sm';
        const wrap = document.querySelector('section.bg-white.border.rounded.p-4:nth-of-type(3)') || document.body;
        wrap.appendChild(feeRow);
      }
      feeRow.innerHTML = '<div><span class="font-semibold">Phí vận chuyển (API):</span> '+money(fee)+'</div>';
      // Nếu có dòng "Tổng tiền phí vận chuyển" cũ, thay số 0đ
      const old = Array.from(document.querySelectorAll('section .font-semibold')).find(n=>/Tổng tiền phí vận chuyển/i.test(n.textContent||''));
      if(old && old.nextSibling){ old.nextSibling.textContent = ' '+money(fee); }
    };
    radios.forEach(r=>r.addEventListener('change', updateFee));
    updateFee();
  }

  // Auto run when user nhập địa chỉ, và chạy 1 lần khi load
  ['province','district','ward','address'].forEach(id=>{
    const E = el(id); if(E){ ['change','blur','keyup'].forEach(ev=>E.addEventListener(ev, ()=>autoQuote())); }
  });
  document.addEventListener('DOMContentLoaded', autoQuote);
  setTimeout(autoQuote, 800);
})();
</script>


<!-- SHV: compute cart total weight (gram) and attach to shipping quote -->
<script>
(function(){
  function readCart(){
    try{ return JSON.parse(localStorage.getItem('cart')||'[]'); }catch(e){ return []; }
  }
  function totalWeightGram(){
    const arr = readCart();
    let total = 0;
    for(const it of arr){
      const w = Number(it.weight_gram || it.weight || 0) || 0;
      const qty = Number(it.qty||1)||1;
      total += w*qty;
    }
    return total||0;
  }
  // patch fallback quote code if exists
  const oldAuto = window.autoQuote;
  window.autoQuote = async function(){
    if(typeof oldAuto === 'function') try{ await oldAuto(); }catch(e){};
    const w = totalWeightGram();
    // if our fallback exists, it uses wDom or 500; ensure we override
    window.__SHV_TOTAL_WEIGHT__ = w;
  };
  // if our own fallback script (from earlier patch) is present
  setInterval(function(){
    const el = document.getElementById('quote-list');
    if(!el) return;
    // store weight to dataset for any consumer
    el.dataset.totalWeightGram = String(totalWeightGram());
  }, 1000);
})();
</script>

</body>
</html>
