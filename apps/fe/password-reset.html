<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u - Shop Huy V√¢n</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="login-container">
    <div class="logo">
      <h1>üîë ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</h1>
      <p id="mode-text"></p>
    </div>

    <!-- Mode 1: C√≥ token (email link) -->
    <form id="form-token" style="display: none;">
      <div class="form-group">
        <label for="newPasswordToken">M·∫≠t kh·∫©u m·ªõi</label>
        <input
          type="password"
          id="newPasswordToken"
          name="newPasswordToken"
          placeholder="M·∫≠t kh·∫©u m·ªõi"
          required
          autocomplete="new-password"
        >
      </div>
      <div class="form-group">
        <label for="confirmPasswordToken">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi</label>
        <input
          type="password"
          id="confirmPasswordToken"
          name="confirmPasswordToken"
          placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi"
          required
          autocomplete="new-password"
        >
      </div>
      <button type="submit" class="btn-login" id="btn-token">
        ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u
      </button>
    </form>

    <!-- Mode 2: Phone + OTP ZNS -->
    <form id="form-otp" style="display: none; margin-top: 16px;">
      <div class="form-group">
        <label for="phone">S·ªë ƒëi·ªán tho·∫°i</label>
        <input
          type="text"
          id="phone"
          name="phone"
          placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i ƒë√£ ƒëƒÉng k√Ω"
          autocomplete="tel"
        >
      </div>
      <div class="form-group">
        <label for="otp">M√£ OTP</label>
        <input
          type="text"
          id="otp"
          name="otp"
          placeholder="Nh·∫≠p m√£ OTP ƒë∆∞·ª£c g·ª≠i qua Zalo/SMS"
        >
      </div>
      <div class="form-group">
        <label for="newPasswordOtp">M·∫≠t kh·∫©u m·ªõi</label>
        <input
          type="password"
          id="newPasswordOtp"
          name="newPasswordOtp"
          placeholder="M·∫≠t kh·∫©u m·ªõi"
          autocomplete="new-password"
        >
      </div>
      <div class="form-group">
        <label for="confirmPasswordOtp">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi</label>
        <input
          type="password"
          id="confirmPasswordOtp"
          name="confirmPasswordOtp"
          placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi"
          autocomplete="new-password"
        >
      </div>
      <button type="submit" class="btn-login" id="btn-otp">
        ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u
      </button>
    </form>

    <div class="register-link" style="margin-top: 16px;">
      <a href="/login.html">‚Üê Quay l·∫°i ƒëƒÉng nh·∫≠p</a>
    </div>
  </div>

  <script>
  (function() {
    const API_BASE = window.API_BASE || 'https://api.shophuyvan.vn';

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');

    const modeText = document.getElementById('mode-text');
    const formToken = document.getElementById('form-token');
    const formOtp = document.getElementById('form-otp');

    if (token) {
      // Flow email: c√≥ token trong URL
      modeText.textContent = 'B·∫°n ƒëang ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u qua li√™n k·∫øt email.';
      formToken.style.display = 'block';
    } else {
      // Flow ZNS: phone + OTP
      modeText.textContent = 'B·∫°n c√≥ th·ªÉ ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u b·∫±ng SƒêT + m√£ OTP.';
      formOtp.style.display = 'block';
    }

    // Submit: theo token (email)
    const btnToken = document.getElementById('btn-token');
    formToken.addEventListener('submit', async (e) => {
      e.preventDefault();

      const pass1 = document.getElementById('newPasswordToken').value;
      const pass2 = document.getElementById('confirmPasswordToken').value;

      if (!pass1 || !pass2) {
        showToast('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß m·∫≠t kh·∫©u', 'error');
        return;
      }
      if (pass1 !== pass2) {
        showToast('M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp', 'error');
        return;
      }

      btnToken.disabled = true;
      btnToken.textContent = 'ƒêang x·ª≠ l√Ω...';

      try {
        const res = await fetch(`${API_BASE}/auth/password/reset`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            token,
            password: pass1,
          }),
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.ok) {
          throw new Error(data.error || data.message || 'ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u th·∫•t b·∫°i');
        }

        // L∆∞u token m·ªõi (t·ª± login)
        if (data.token) {
          localStorage.setItem('customer_token', data.token);
          localStorage.setItem('x-customer-token', data.token);
          localStorage.setItem('x-token', data.token);
        }
        if (data.customer) {
          localStorage.setItem('customer_info', JSON.stringify(data.customer));
        }

        showToast('ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u th√†nh c√¥ng!', 'success');
        setTimeout(() => {
          window.location.href = '/account.html';
        }, 1500);
      } catch (err) {
        console.error('[PasswordReset - token] Error:', err);
        showToast(err.message || 'L·ªói ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u', 'error');
        btnToken.disabled = false;
        btnToken.textContent = 'ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u';
      }
    });

    // Submit: theo phone + OTP
    const btnOtp = document.getElementById('btn-otp');
    formOtp.addEventListener('submit', async (e) => {
      e.preventDefault();

      const phone = document.getElementById('phone').value.trim();
      const otp = document.getElementById('otp').value.trim();
      const pass1 = document.getElementById('newPasswordOtp').value;
      const pass2 = document.getElementById('confirmPasswordOtp').value;

      if (!phone || !otp || !pass1 || !pass2) {
        showToast('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin', 'error');
        return;
      }
      if (pass1 !== pass2) {
        showToast('M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp', 'error');
        return;
      }

      btnOtp.disabled = true;
      btnOtp.textContent = 'ƒêang x·ª≠ l√Ω...';

      try {
        const res = await fetch(`${API_BASE}/auth/password/reset`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            phone,
            code: otp,
            password: pass1,
          }),
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.ok) {
          throw new Error(data.error || data.message || 'ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u th·∫•t b·∫°i');
        }

        if (data.token) {
          localStorage.setItem('customer_token', data.token);
          localStorage.setItem('x-customer-token', data.token);
          localStorage.setItem('x-token', data.token);
        }
        if (data.customer) {
          localStorage.setItem('customer_info', JSON.stringify(data.customer));
        }

        showToast('ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u th√†nh c√¥ng!', 'success');
        setTimeout(() => {
          window.location.href = '/account.html';
        }, 1500);
      } catch (err) {
        console.error('[PasswordReset - otp] Error:', err);
        showToast(err.message || 'L·ªói ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u', 'error');
        btnOtp.disabled = false;
        btnOtp.textContent = 'ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u';
      }
    });
  })();
  </script>
</body>
</html>
