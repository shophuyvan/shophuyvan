<!doctype html><html lang="vi"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Uploader Test — SHOP HUY VÂN</title>
<style>
 body{font-family:system-ui,Arial,sans-serif;max-width:720px;margin:24px auto;padding:0 16px}
 h1{font-size:20px}label{display:block;margin:12px 0 4px;font-weight:600}
 input[type="text"],input[type="password"],input[type="url"]{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px}
 input[type="file"]{margin-top:8px}button{margin-top:14px;padding:10px 16px;border:0;background:#0ea5e9;color:#fff;border-radius:10px;cursor:pointer}
 .row{display:flex;gap:12px}.row>div{flex:1}.card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin-top:16px}
 .muted{color:#6b7280;font-size:12px}.ok{color:#16a34a}.err{color:#dc2626;white-space:pre-wrap}img{max-width:100%;display:block;margin-top:10px;border-radius:12px}
</style>
  <script type="module" src="src/pixels.js?v=23"></script>
</head><body>
<h1>Uploader Test — SHOP HUY VÂN</h1>
<div class="card">
  <div class="row">
    <div><label>API base</label><input id="apiBase" type="text" value="https://shv-api.shophuyvan.workers.dev"/></div>
    <div><label>Folder</label><input id="folder" type="text" value="shv"/></div>
  </div>
  <label>ADMIN_TOKEN</label><input id="token" type="text" value="Nghiem23091984"/>
  <div class="row">
    <div><label>Chọn file để upload</label><input id="file" type="file" accept="image/*,video/*"/></div>
    <div><label>Hoặc dán URL ảnh/video</label><input id="fileUrl" type="url" placeholder="https://..."/></div>
  </div>
  <div class="row">
    <button id="btnUpload">Upload</button>
    <button id="btnSample" type="button">Test bằng ảnh mẫu</button>
  </div>
  <div id="status" class="muted">Chưa chạy.</div>
  <div id="out" class="card" style="display:none">
    <div>Kết quả: <span id="ok" class="ok"></span><span id="err" class="err"></span></div>
    <div id="links" class="muted"></div>
    <img id="preview" alt="preview"/>
  </div>
</div>

<script>
async function sign(apiBase, token, folder){
  const url = apiBase.replace(/\/$/,'') + "/upload/signature";
  const resp = await fetch(url, {
    method:"POST",
    headers:{ "Authorization":"Bearer " + token, "Content-Type":"application/json" },
    body: JSON.stringify({ folder })
  });
  if(!resp.ok){ throw new Error("Signature error: " + (await resp.text())); }
  return resp.json();
}
async function uploadWithSig(sig, fileOrUrl){
  const fd = new FormData();
  fd.append("timestamp", sig.timestamp);
  fd.append("signature", sig.signature);
  fd.append("api_key", sig.api_key);
  fd.append("upload_preset", sig.upload_preset);
  fd.append("folder", sig.folder);
  fd.append("file", fileOrUrl);
  const url = `https://api.cloudinary.com/v1_1/${sig.cloud_name}/image/upload`;
  const r = await fetch(url, { method:"POST", body: fd });
  if(!r.ok){ throw new Error("Upload error: " + (await r.text())); }
  return r.json();
}
async function run(isSample=false){
  const apiBase = document.getElementById("apiBase").value.trim();
  const token = document.getElementById("token").value.trim();
  const folder = document.getElementById("folder").value.trim() || "shv";
  const f = document.getElementById("file");
  const url = document.getElementById("fileUrl").value.trim();
  const status = document.getElementById("status"), out = document.getElementById("out");
  const ok = document.getElementById("ok"), err = document.getElementById("err");
  const links = document.getElementById("links"), preview = document.getElementById("preview");
  out.style.display="none"; ok.textContent=""; err.textContent=""; links.textContent=""; preview.src="";
  try{
    status.textContent = "1/2 Ký yêu cầu…";
    const sig = await sign(apiBase, token, folder);
    let fileOrUrl = isSample ? "https://res.cloudinary.com/demo/image/upload/sample.jpg"
      : (f.files && f.files[0]) ? f.files[0] : (url ? url : null);
    if(!fileOrUrl){ alert("Chọn file hoặc dán URL trước đã."); return; }
    status.textContent = "2/2 Upload lên Cloudinary…";
    const up = await uploadWithSig(sig, fileOrUrl);
    out.style.display="block"; ok.textContent="Thành công!";
    links.innerHTML = 'secure_url: <a href="'+up.secure_url+'" target="_blank">'+up.secure_url+'</a>';
    if(/\.(jpg|jpeg|png|gif|webp|svg)$/i.test(up.secure_url)) preview.src = up.secure_url;
    status.textContent = "Xong.";
  }catch(e){
    out.style.display="block"; err.textContent = e.message;
    status.textContent = "Lỗi — xem chi tiết phía dưới.";
  }
}
document.getElementById("btnUpload").addEventListener("click", e=>{e.preventDefault();run(false)});
document.getElementById("btnSample").addEventListener("click", e=>{e.preventDefault();run(true)});
</script>
</body></html>
