<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Đăng nhập quản trị - Shop Huy Vân</title>
  <link rel="stylesheet" href="./styles.css"/>
  <script src="./admin_real.js?v=26"></script>
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .login-container {
      width: 100%;
      max-width: 420px;
      padding: 20px;
    }

    .login-card {
      background: #fff;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .login-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .login-logo {
      width: 64px;
      height: 64px;
      margin: 0 auto 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 28px;
      font-weight: 700;
    }

    .login-title {
      font-size: 24px;
      font-weight: 700;
      color: #0f172a;
      margin: 0 0 8px;
    }

    .login-subtitle {
      font-size: 14px;
      color: #64748b;
      margin: 0;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #334155;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
      box-sizing: border-box;
    }

    .form-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn-login {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-login:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-login:active {
      transform: translateY(0);
    }

    .btn-login:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .status-message {
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      text-align: center;
      display: none;
    }

    .status-message.info {
      background: #eff6ff;
      color: #1e40af;
      display: block;
    }

    .status-message.error {
      background: #fef2f2;
      color: #991b1b;
      display: block;
    }

    .status-message.success {
      background: #f0fdf4;
      color: #166534;
      display: block;
    }

    .api-settings {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #e2e8f0;
    }

    .api-settings-toggle {
      background: none;
      border: none;
      color: #64748b;
      font-size: 13px;
      cursor: pointer;
      padding: 0;
      text-decoration: underline;
    }

    .api-settings-content {
      margin-top: 16px;
      display: none;
    }

    .api-settings-content.show {
      display: block;
    }

    .api-input-group {
      display: flex;
      gap: 8px;
    }

    .api-input-group input {
      flex: 1;
    }

    .btn-secondary {
      padding: 12px 20px;
      background: #f1f5f9;
      color: #475569;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-secondary:hover {
      background: #e2e8f0;
    }

    .default-credentials {
      margin-top: 24px;
      padding: 16px;
      background: #f8fafc;
      border-radius: 8px;
      font-size: 12px;
      color: #64748b;
    }

    .default-credentials strong {
      color: #334155;
    }
  </style>
</head>

<body>
  <div class="login-container">
    <div class="login-card">
      <div class="login-header">
        <div class="login-logo">SHV</div>
        <h1 class="login-title">Đăng nhập quản trị</h1>
        <p class="login-subtitle">Shop Huy Vân Admin Panel</p>
      </div>

      <form id="loginForm" onsubmit="return false;">
        <div class="form-group">
          <label class="form-label" for="username">Tài khoản</label>
          <input 
            type="text" 
            id="username" 
            class="form-input" 
            placeholder="admin@shophuyvan.com"
            value="admin"
            required
            autocomplete="username"
          />
        </div>

        <div class="form-group">
          <label class="form-label" for="password">Mật khẩu</label>
          <input 
            type="password" 
            id="password" 
            class="form-input" 
            placeholder="••••••••"
            required
            autocomplete="current-password"
          />
        </div>

        <button type="submit" class="btn-login" id="loginBtn">
          Đăng nhập
        </button>

        <div class="status-message" id="statusMessage"></div>
      </form>

      <!-- Đã xóa hiển thị thông tin đăng nhập mặc định để bảo mật -->

      <div class="api-settings">
        <button class="api-settings-toggle" onclick="toggleApiSettings()">
          ⚙️ Cài đặt API
        </button>
        <div class="api-settings-content" id="apiSettings">
          <div class="form-group">
            <label class="form-label">API Base URL</label>
            <div class="api-input-group">
              <input 
                type="text" 
                id="apiBase" 
                class="form-input" 
                placeholder="https://shv-api.shophuyvan.workers.dev"
              />
              <button class="btn-secondary" onclick="saveApiBase()">Lưu</button>
            </div>
            <div style="margin-top: 8px; font-size: 12px; color: #64748b;">
              Hiện tại: <span data-api-base></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Toggle API settings
    function toggleApiSettings() {
      const content = document.getElementById('apiSettings');
      content.classList.toggle('show');
    }

    // Save API base
    function saveApiBase() {
      const value = document.getElementById('apiBase').value.trim();
      if (value) {
        Admin.setBase(value);
        showStatus('Đã lưu API base', 'success');
      }
    }

    // Show status message
    function showStatus(message, type = 'info') {
      const statusEl = document.getElementById('statusMessage');
      statusEl.textContent = message;
      statusEl.className = 'status-message ' + type;
      
      if (type === 'success') {
        setTimeout(() => {
          statusEl.style.display = 'none';
        }, 2000);
      }
    }

    // Handle login - FIXED VERSION
    async function handleLogin(e) {
      e?.preventDefault();
      
      const loginBtn = document.getElementById('loginBtn');
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();

      if (!username || !password) {
        showStatus('Vui lòng nhập đầy đủ thông tin', 'error');
        return false;
      }

      // Disable button
      loginBtn.disabled = true;
      loginBtn.textContent = 'Đang đăng nhập...';
      showStatus('Đang xác thực...', 'info');

      try {
        const success = await Admin.login(username, password);
        
        if (success) {
          showStatus('Đăng nhập thành công!', 'success');
          
          // CRITICAL FIX: Wait to ensure token is saved to localStorage
          await new Promise(resolve => setTimeout(resolve, 300));
          
          // Verify token is saved before redirect
          const savedToken = localStorage.getItem('x-token');
          console.log('[Login] Token saved:', savedToken ? 'YES ✓' : 'NO ✗');
          
          if (savedToken) {
            // Set flag to skip auth check on next page
            sessionStorage.setItem('just_logged_in', 'true');
            
            // Redirect to products page
            setTimeout(() => {
              location.href = '/products.html';
            }, 200);
          } else {
            showStatus('Lỗi lưu token. Vui lòng thử lại.', 'error');
            loginBtn.disabled = false;
            loginBtn.textContent = 'Đăng nhập';
          }
        } else {
          showStatus('Tài khoản hoặc mật khẩu không đúng', 'error');
          loginBtn.disabled = false;
          loginBtn.textContent = 'Đăng nhập';
        }
      } catch (error) {
        console.error('Login error:', error);
        showStatus('Lỗi kết nối. Vui lòng thử lại.', 'error');
        loginBtn.disabled = false;
        loginBtn.textContent = 'Đăng nhập';
      }

      return false;
    }

    // Setup form submit
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('loginBtn').addEventListener('click', handleLogin);

    // Enter key to submit
    document.getElementById('password').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        handleLogin(e);
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Load API base into input
      const apiInput = document.getElementById('apiBase');
      if (apiInput) {
        apiInput.value = Admin.getBase();
      }

      // Check if already logged in (but don't auto-redirect from login page)
      const token = localStorage.getItem('x-token');
      if (token) {
        console.log('[Login Page] User already has token');
        // Optional: Show a message or button to continue to dashboard
      }
    });
  </script>
  
</body>
</html>