<!doctype html><html lang='vi'><head><meta charset='utf-8'/><meta name='viewport' content='width=device-width,initial-scale=1'/><title>Vận chuyển</title><link rel="stylesheet" href="./styles.css"/><script src="./admin_real.js?v=25"></script><!-- build:21 -->

<style>
  :root{
    --primary:#1d4ed8; /* blue-700 */
    --primary-dark:#1e40af;
    --muted:#e5e7eb;
  }
  body{ background:#f8fafc; }
  .header{ background:linear-gradient(180deg,#eff6ff 0,#ffffff 100%); border-bottom:1px solid #e5e7eb; }
  .badge{ background:#eff6ff; color:var(--primary); border:1px solid #dbeafe; }
  .card{ background:#fff; border:1px solid #e5e7eb; border-radius:10px; }
  .title{ color:var(--primary); font-weight:600; }
  .btn{ background:var(--primary); color:#fff; border:0; border-radius:8px; }
  .btn:hover{ background:var(--primary-dark); }
  .input{ border:1px solid #dbeafe; border-radius:8px; background:#fff; }
  /* Hide duplicate text inputs – use dropdowns only */
  #sender_province, #sender_district { display:none !important; }

  /* Hide manual sender block; we will auto-sync from Warehouses */
  .sender-manual{ display:none !important; }
</style>


</head><body><div class='container'><div class='header'><div class='title'>Vận chuyển</div><div class='nav'><a href='./products.html' class='badge'>Sản phẩm</a><a href='./banners.html' class='badge'>Banner</a><a href='./vouchers.html' class='badge'>Voucher</a><a href='./orders.html' class='badge'>Đơn hàng</a><a href='./stats.html' class='badge'>Thống kê</a><a href='./shipping.html' class='badge'>Vận chuyển</a><a href='./ads.html' class='badge'>Quảng cáo</a><span class='badge'>API: <span data-api-base></span></span> <button id='sync-warehouses' class='btn' style='margin-left:8px'>Đồng bộ từ Warehouses</button></div></div>
<div class="grid">
  <div class="card"><div class="title">Thông tin người gửi</div>
    
    <!-- Summary (read-only) -->
    <div id="sender_summary" class="info-block" style="padding:8px 0; display:none">
      <div><b>Tên:</b> <span id="s_name"></span></div>
      <div><b>SĐT:</b> <span id="s_phone"></span></div>
      <div><b>Địa chỉ:</b> <span id="s_addr"></span></div>
      <div style="margin-top:8px">
        <button id="edit_sender" class="btn" style="background:#6b7280">Chỉnh sửa thủ công</button>
      </div>
    </div>
<div class='sender-manual'>
<div class="grid" style="grid-template-columns:1fr 1fr; gap:8px">
      <input id="sender_name" class="input" placeholder="Tên người gửi">
      <input id="sender_phone" class="input" placeholder="SĐT người gửi">
      <input id="sender_province" class="input" placeholder="Tỉnh/Thành (VD: Hồ Chí Minh)">
      <input id="sender_district" class="input" placeholder="Quận/Huyện (VD: Bình Chánh)">
      <input id="sender_address" class="input" placeholder="Địa chỉ chi tiết">
      <input id="option_id" class="input" placeholder="Option tối ưu (mặc định: 1)">
    
    <div class="grid" style="grid-template-columns:1fr 1fr 1fr; gap:8px; margin-top:8px">
      <select id="sender_province_sel" class="input">
        <option value="">— Chọn Tỉnh/Thành —</option>
      </select>
      <select id="sender_district_sel" class="input" disabled>
        <option value="">— Chọn Quận/Huyện —</option>
      </select>
      <select id="sender_commune_sel" class="input" disabled>
        <option value="">— Chọn Phường/Xã —</option>
      </select>
    </div>
    <input type="hidden" id="sender_province_code">
    <input type="hidden" id="sender_district_code">
    <input type="hidden" id="sender_commune_code">
    <small style="display:block;margin:6px 0 0;color:#6b7280">Mẹo: chọn từ danh sách để tránh sai chính tả; hệ thống sẽ tự điền lại vào ô văn bản.</small>
</div>
    <div style="margin-top:8px">
      <button id="save_sender" class="btn">Lưu người gửi</button>
    </div>
</div>
  </div>

  <div class="card"><div class="title">Super (Aggregator)</div>  <div style="display:grid;gap:8px">  <input id="super_key" class="input" placeholder="API Super Key (static)"/>  <div class="label">Hoặc dùng Password API Token</div>  <input id="super_user" class="input" placeholder="username (phone/email)"/>  <input id="super_pass" class="input" placeholder="password" type="password"/>  <input id="super_partner" class="input" placeholder="partner secret"/>  <div style="display:flex;gap:8px">    <button id="save_super" class="btn">Lưu token</button>    <button id="save_super_pwd" class="btn">Lưu tài khoản</button>    <button id="test_super" class="btn">Thử gọi báo giá</button>  </div>  </div></div>
  <div class="card"><div class="title">J&T</div><input id="jt_key" class="input" placeholder="API Key"/><button id="save_jt" class="btn">Lưu</button></div>
  <div class="card"><div class="title">SPX</div><input id="spx_key" class="input" placeholder="API Key"/><button id="save_spx" class="btn">Lưu</button></div>
  <div class="card"><div class="title">Ahamove</div><input id="aha_key" class="input" placeholder="API Key"/><button id="save_aha" class="btn">Lưu</button></div>
  <div class="card"><div class="title">Grab</div><input id="grab_key" class="input" placeholder="API Key"/><button id="save_grab" class="btn">Lưu</button></div>
</div>
<script>
['super','jt','spx','aha','grab'].forEach(k=>{
  let key=''; fetch(Admin.getApiBase()+'/public/settings').then(r=>r.json()).then(d=>{key=((d.settings||{}).shipping||{}).credentials?.[k]?.key||''; if(inp) inp.value=key;}).catch(()=>{if(inp) inp.value='';}); const inp = document.getElementById(k+'_key'); if(inp) inp.value = key;
  const btn = document.getElementById('save_'+k); if(btn) btn.onclick = ()=>{ localStorage.setItem('ship_'+k, document.getElementById(k+'_key').value.trim()); Admin.toast('Đã lưu '+k.toUpperCase()); };
});
</script>
</div><script>document.addEventListener('DOMContentLoaded',()=>Admin&&Admin.renderApiBase());</script>
<script>
document.addEventListener('DOMContentLoaded',()=>{
  try{
    fetch(Admin.getApiBase()+'/public/settings').then(r=>r.json()).then(s=>{
      const val = (s && s.shipping && s.shipping.super_key) || '';
      var el=document.getElementById('super_key'); if(el && !el.value) el.value=val;
    });
  }catch(e){}
  const btn = document.getElementById('save_super');
  if(btn && !btn.__wired){ btn.__wired=true; btn.addEventListener('click', async ()=>{
    const v = (document.getElementById('super_key')||{}).value||'';
    await Admin.req('/admin/settings/upsert',{method:'POST', body:{path:'shipping.super_key', value:v}});
    Admin.toast('Đã lưu Super Key');
  });}
});
</script>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  // Load settings
  (async ()=>{
    try{
      const s = await (await fetch(Admin.getApiBase()+'/public/settings')).json();
      const g = (p, d='') => p.split('.').reduce((o,k)=>(o||{})[k], s) || d;
      const set = (id, v)=>{ const el=document.getElementById(id); if(el && !el.value) el.value=v||''; };
      set('super_key', g('shipping.super_key',''));
      set('super_user', g('shipping.super_user',''));
      set('super_pass', g('shipping.super_pass',''));
      set('super_partner', g('shipping.super_partner',''));
    }catch(e){}
  })();

  // Wire sync warehouses
  const syncBtn = document.getElementById('sync-warehouses');
  if(syncBtn && !syncBtn.__wired){ syncBtn.__wired=true; syncBtn.addEventListener('click', syncSenderFromWarehouses); }

  // Save static token
  const btnTok=document.getElementById('save_super');
  if(btnTok && !btnTok.__wired){ btnTok.__wired=true; btnTok.addEventListener('click', async ()=>{
    const v=document.getElementById('super_key')?.value||'';
    await Admin.req('/admin/settings/upsert',{method:'POST', body:{path:'shipping.super_key', value:v}});
    await Admin.req('/admin/settings/upsert',{method:'POST', body:{path:'shipping.super_token', value:v}});
    Admin.toast('Đã lưu Super token');
  });}

  // Save username/password/partner
  const btnPwd=document.getElementById('save_super_pwd');
  if(btnPwd && !btnPwd.__wired){ btnPwd.__wired=true; btnPwd.addEventListener('click', async ()=>{
    const user=document.getElementById('super_user')?.value||'';
    const pass=document.getElementById('super_pass')?.value||'';
    const partner=document.getElementById('super_partner')?.value||'';
    await Admin.req('/admin/settings/upsert',{method:'POST', body:{path:'shipping.super_user', value:user}});
    await Admin.req('/admin/settings/upsert',{method:'POST', body:{path:'shipping.super_pass', value:pass}});
    await Admin.req('/admin/settings/upsert',{method:'POST', body:{path:'shipping.super_partner', value:partner}});
    Admin.toast('Đã lưu tài khoản SuperAI');
  });}

  // Quick test: call quote with HCM/HCM (dummy 500g) to verify token ok
  const btnTest=document.getElementById('test_super');
  if(btnTest && !btnTest.__wired){ btnTest.__wired=true; btnTest.addEventListener('click', async ()=>{
    const r = await Admin.req('/shipping/price',{method:'POST', body:{ receiver_province:'Hồ Chí Minh', receiver_district:'Quận 1', weight_gram:500, cod:0 } });
    alert('Kết quả: '+JSON.stringify(r).slice(0,400));
  });}
});
</script>
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const api = Admin.getApiBase();

  const $ = id => document.getElementById(id);
  const set = (id, v)=>{ const el=$(id); if(el) el.value = v||''; };

  async function getJSON(p){
    try{ const r = await fetch(api + p); return await r.json(); }catch(e){ return null; }
  }

  // Populate selects
  async function loadProvinces(selectedName){
    const data = await getJSON('/shipping/areas/province');
    const sel = $('sender_province_sel'); if(!sel) return;
    sel.innerHTML = '<option value="">— Chọn Tỉnh/Thành —</option>';
    if(data && data.items){
      data.items.forEach(it=>{
        const opt = document.createElement('option');
        opt.value = it.code; opt.textContent = it.name;
        if(selectedName && it.name.trim().toLowerCase() === selectedName.trim().toLowerCase()) opt.selected = true;
        sel.appendChild(opt);
      });
    }
    sel.disabled = false;
    if(sel.value){ await loadDistricts(sel.value, $('sender_district').value); }
    // Sync text input + code
    syncProvinceToInputs();
  }

  async function loadDistricts(provinceCode, selectedName){
    const data = await getJSON('/shipping/areas/district?province=' + encodeURIComponent(provinceCode||''));
    const sel = $('sender_district_sel'); if(!sel) return;
    sel.innerHTML = '<option value="">— Chọn Quận/Huyện —</option>';
    if(data && data.items){
      data.items.forEach(it=>{
        const opt = document.createElement('option');
        opt.value = it.code; opt.textContent = it.name;
        if(selectedName && it.name.trim().toLowerCase() === selectedName.trim().toLowerCase()) opt.selected = true;
        sel.appendChild(opt);
      });
    }
    sel.disabled = !provinceCode;
    if(sel.value){ await loadCommunes(sel.value, $('sender_commune')?.value || ''); }
    syncDistrictToInputs();
  }

  async function loadCommunes(districtCode, selectedName){
    const sel = $('sender_commune_sel'); if(!sel) return;
    sel.innerHTML = '<option value="">— Chọn Phường/Xã —</option>';
    const data = await getJSON('/shipping/areas/commune?district=' + encodeURIComponent(districtCode||''));
    if(data && data.items){
      data.items.forEach(it=>{
        const opt = document.createElement('option');
        opt.value = it.code; opt.textContent = it.name;
        if(selectedName && it.name.trim().toLowerCase() === selectedName.trim().toLowerCase()) opt.selected = true;
        sel.appendChild(opt);
      });
    }
    sel.disabled = !districtCode;
    syncCommuneToInputs();
  }

  function syncProvinceToInputs(){
    const sel = $('sender_province_sel');
    const name = sel.selectedOptions[0]?.textContent || '';
    const code = sel.value || '';
    if(name){ set('sender_province', name); }
    set('sender_province_code', code);
  }
  function syncDistrictToInputs(){
    const sel = $('sender_district_sel');
    const name = sel.selectedOptions[0]?.textContent || '';
    const code = sel.value || '';
    if(name){ set('sender_district', name); }
    set('sender_district_code', code);
  }
  function syncCommuneToInputs(){
    const sel = $('sender_commune_sel');
    const name = sel.selectedOptions[0]?.textContent || '';
    const code = sel.value || '';
    set('sender_commune_code', code);
    // Không bắt buộc điền phường vào text; nhưng nếu có input 'sender_commune' thì điền
    if($('sender_commune')) set('sender_commune', name);
  }

  // 
  // === Wire change listeners for selects ===
  const GET = (id)=>document.getElementById(id);
  const provinceSel = GET('sender_province_sel');
  const districtSel = GET('sender_district_sel');
  const communeSel  = GET('sender_commune_sel');
  if(provinceSel && !provinceSel.__wired){
    provinceSel.__wired = true;
    provinceSel.addEventListener('change', async ()=>{
      if (typeof syncProvinceToInputs==='function') syncProvinceToInputs();
      // clear dependents
      if(districtSel){ districtSel.innerHTML = '<option value="">— Chọn Quận/Huyện —</option>'; districtSel.disabled = !provinceSel.value; }
      if(communeSel){ communeSel.innerHTML  = '<option value="">— Chọn Phường/Xã —</option>'; communeSel.disabled  = true; }
      if(provinceSel.value && typeof loadDistricts==='function'){ await loadDistricts(provinceSel.value, ''); }
    });
  }
  if(districtSel && !districtSel.__wired){
    districtSel.__wired = true;
    districtSel.addEventListener('change', async ()=>{
      if (typeof syncDistrictToInputs==='function') syncDistrictToInputs();
      if(communeSel){ communeSel.innerHTML  = '<option value="">— Chọn Phường/Xã —</option>'; communeSel.disabled  = !districtSel.value; }
      if(districtSel.value && typeof loadCommunes==='function'){ await loadCommunes(districtSel.value, ''); }
    });
  }
  if(communeSel && !communeSel.__wired){
    communeSel.__wired = true;
    communeSel.addEventListener('change', ()=>{
      if (typeof syncCommuneToInputs==='function') syncCommuneToInputs();
    });
  }
// Prefill from settings, then load selects with matching selection
  (async ()=>{
    try{
      const s = await (await fetch(api + '/public/settings')).json();
      const g = (p, d='') => p.split('.').reduce((o,k)=>(o||{})[k], s) || d;
      set('sender_name',     g('shipping.sender_name',''));
      set('sender_phone',    g('shipping.sender_phone',''));
      set('sender_address',  g('shipping.sender_address',''));
      set('sender_province', g('shipping.sender_province',''));
      set('sender_district', g('shipping.sender_district',''));
      set('option_id',       g('shipping.option_id','1'));
      set('sender_province_code', g('shipping.sender_province_code',''));
      set('sender_district_code', g('shipping.sender_district_code',''));
      set('sender_commune_code',  g('shipping.sender_commune_code',''));
      // load select options and try select by saved name first; if code exists, use that value
      await loadProvinces(g('shipping.sender_province',''));
      // If we have code, set it and cascade loads
      if($('sender_province_code').value){
        $('sender_province_sel').value = $('sender_province_code').value;
        await loadDistricts($('sender_province_code').value, g('shipping.sender_district',''));
      }
      if($('sender_district_code').value){
        $('sender_district_sel').value = $('sender_district_code').value;
        await loadCommunes($('sender_district_code').value, g('shipping.sender_commune',''));
      }
    }catch(e){}
  })();

  // Save sender handler (upsert names + codes)
  const btnSave = $('save_sender');
  if(btnSave && !btnSave.__wired){
    btnSave.__wired = true;
    btnSave.addEventListener('click', async (ev)=>{
      ev.preventDefault();
      const upserts = (list)=>Promise.all(list.map(([path, value])=>{
        return Admin.req('/admin/settings/upsert', {method:'POST', body:{path, value}});
      }));
      await upserts([
        ['shipping.sender_name',     $('sender_name').value.trim()],
        ['shipping.sender_phone',    $('sender_phone').value.trim()],
        ['shipping.sender_address',  $('sender_address').value.trim()],
        ['shipping.sender_province', $('sender_province').value.trim()],
        ['shipping.sender_district', $('sender_district').value.trim()],
        ['shipping.option_id',       $('option_id').value.trim() || '1'],
        ['shipping.sender_province_code', $('sender_province_sel').value || $('sender_province_code').value || '' ],
        ['shipping.sender_district_code', $('sender_district_sel').value || $('sender_district_code').value || '' ],
        ['shipping.sender_commune_code',  $('sender_commune_sel').value  || $('sender_commune_code').value  || '' ],
      ]);
      Admin.toast('Đã lưu người gửi');
    });
  }
});
</script>


<script>
(function(){
  function showSummaryFromLocal(){
    try{
      const s = JSON.parse(localStorage.getItem('shipping.sender')||'null');
      if(!s) return;
      const sum = document.getElementById('sender_summary');
      if(!sum) return;
      document.getElementById('s_name').textContent = s.name||'';
      document.getElementById('s_phone').textContent = s.phone||'';
      const addr = [s.addr, s.ward_name, s.district_name, s.province_name].filter(Boolean).join(', ');
      document.getElementById('s_addr').textContent = addr;
      sum.style.display='block';
      var m = document.querySelector('.sender-manual'); if(m) m.style.display='none';
    }catch(e){}
  }
  window.__saveSenderSummary = function(v){
    try{ localStorage.setItem('shipping.sender', JSON.stringify(v||{})); }catch(e){}
    showSummaryFromLocal();
  };
  // attach edit button
  document.addEventListener('DOMContentLoaded', function(){
    const edit = document.getElementById('edit_sender');
    if(edit && !edit.__wired){ edit.__wired=true; edit.addEventListener('click', function(){
      var m = document.querySelector('.sender-manual'); if(m) m.style.display='block';
      var sum = document.getElementById('sender_summary'); if(sum) sum.style.display='none';
    }); }
    showSummaryFromLocal();
  });
})();
</script>

</body></html>
<script>
 document.addEventListener('DOMContentLoaded', function(){
   var $id=function(id){return document.getElementById(id)};
   var st=$id('super_token')||$id('super_key');
   if(st && !st.placeholder){st.placeholder='Nhập Super Token (Bearer) từ Aggregator';}
   var sp=document.getElementById('super_partner');
   if(sp && !sp.placeholder){sp.placeholder='Partner secret (nếu có)';}
 });
</script>/* ===== Shipping Admin Page JS (re-authored) ===== */
  (function(){
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const byId = id => document.getElementById(id);

    const SELS = {
      province: byId('co-province-sel'),
      district: byId('co-district-sel'),
      ward: byId('co-ward-sel'),
      name: byId('co-name'),
      phone: byId('co-phone'),
      addr: byId('co-addr'),
      opt: byId('co-opt')
    };

    function toast(msg){
      try{ if(window.Admin?.toast) return window.Admin.toast(msg); }catch(e){}
      console.log('[Admin]', msg);
    }

    async function api(path, body){
      const r = await fetch(path, {
        method: 'POST',
        headers: {'content-type':'application/json'},
        body: JSON.stringify(body||{})
      });
      let text = await r.text();
      try{ return JSON.parse(text); }catch(e){ return { ok:false, error:true, message:text }; }
    }

    function saveLocalSender(obj){
    function collectSenderValues(){
      return {
        name: $('#sender_name').value.trim(),
        phone: $('#sender_phone').value.trim(),
        address: $('#sender_address').value.trim(),
        optimize: Number($('#optimize').value || 1),
        province_code: SELS.province.value || '',
        province_name: SELS.province.selectedOptions[0]?.text || '',
        district_code: SELS.district.value || '',
        district_name: SELS.district.selectedOptions[0]?.text || '',
        commune_code: SELS.commune.value || '',
        commune_name: SELS.commune.selectedOptions[0]?.text || '',
      };
    }
    
      localStorage.setItem('shv_sender', JSON.stringify(obj));
    }
    function loadLocalSender(){
      try{ return JSON.parse(localStorage.getItem('shv_sender')||'{}'); }catch{return {};}
    }

    // --- load regions ---
    async function loadProvinces(){
      const pn = await api('/shipping/provinces', {});
      const list = (pn.data || pn.items || []).sort((a,b)=> a.name.localeCompare(b.name));
      SELS.province.innerHTML = '<option value=\"\">— Chọn Tỉnh/Thành —</option>' + list.map(p=>`<option value=\"${p.code}\" data-name=\"${p.name}\">${p.name}</option>`).join('');
    }
    async function loadDistricts(provinceCode){
      SELS.district.innerHTML = '<option value=\"\">— Chọn Quận/Huyện —</option>';
      SELS.ward.innerHTML = '<option value=\"\">— Chọn Phường/Xã —</option>';
      if(!provinceCode) return;
      const rs = await api('/shipping/districts', { province: provinceCode });
      const list = (rs.data || rs.items || []).sort((a,b)=> a.name.localeCompare(b.name));
      SELS.district.innerHTML += list.map(d=>`<option value=\"${d.code}\" data-name=\"${d.name}\">${d.name}</option>`).join('');
    }
    async function loadWards(districtCode){
      SELS.ward.innerHTML = '<option value=\"\">— Chọn Phường/Xã —</option>';
      if(!districtCode) return;
      const rs = await api('/shipping/wards', { district: districtCode });
      const list = (rs.data || rs.items || []).sort((a,b)=> a.name.localeCompare(b.name));
      SELS.ward.innerHTML += list.map(w=>`<option value=\"${w.code}\" data-name=\"${w.name}\">${w.name}</option>`).join('');
    }

    
window.syncSenderFromWarehouses = async function(){
  try{
    const rs = await api('/shipping/warehouses', {});
    const list = rs?.items || rs?.data || [];
    if(!Array.isArray(list) || list.length===0){ alert('Không lấy được warehouses'); return; }
    const w = list[0];
    const v = {
      name: w.name || w.contact_name || '',
      phone: w.phone || w.contact_phone || '',
      addr: w.address || w.addr || '',
      province_code: w.province_code || '', province_name: w.province || w.province_name || '',
      district_code: w.district_code || '', district_name: w.district || w.district_name || '',
      ward_code: w.ward_code || '', ward_name: w.ward || w.ward_name || '',
      option: '1'
    };
    await api('/admin/settings/upsert', { path: 'shipping.sender', value: v });
    if(window.__saveSenderSummary) window.__saveSenderSummary(v);
    toast('Đã đồng bộ địa chỉ người gửi từ Warehouses');
  }catch(e){ console.error(e); alert('Lỗi khi đồng bộ từ Warehouses'); }
}

async function upsertSender(){

      // save local first so F5 restores even if server fails
      const vBefore = collectSenderValues();
      saveLocalSender(vBefore);

      const v = {
        name: SELS.name.value.trim(),
        phone: SELS.phone.value.trim(),
        addr: SELS.addr.value.trim(),
        province_code: SELS.province.value,
        province_name: SELS.province.selectedOptions[0]?.dataset.name || '',
        district_code: SELS.district.value,
        district_name: SELS.district.selectedOptions[0]?.dataset.name || '',
        ward_code: SELS.ward.value,
        ward_name: SELS.ward.selectedOptions[0]?.dataset.name || '',
        option: SELS.opt?.value || '1'
      };
      if(!v.province_code || !v.district_code){
        alert('Vui lòng chọn đủ Tỉnh/Thành và Quận/Huyện.');
        return;
      }
      saveLocalSender(v);
      try{
        await api('/admin/settings/upsert', { path: 'shipping.sender', value: v });
    if(window.__saveSenderSummary) window.__saveSenderSummary(v);
        toast('Đã lưu người gửi');
      }catch(e){ /* ignore */ }
    }

    async function restore(){
      // 1) provinces
      await loadProvinces();
      const data = loadLocalSender();
      if(data.province_code){
        SELS.province.value = data.province_code;
        await loadDistricts(data.province_code);
      }
      if(data.district_code){
        SELS.district.value = data.district_code;
        await loadWards(data.district_code);
      }
      if(data.ward_code){
        SELS.ward.value = data.ward_code;
      }
      if(data.name) SELS.name.value = data.name;
      if(data.phone) SELS.phone.value = data.phone;
      if(data.addr) SELS.addr.value = data.addr;
      if(data.option) SELS.opt.value = data.option;
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      await restore();
      SELS.province.addEventListener('change', e=> loadDistricts(SELS.province.value));
      SELS.district.addEventListener('change', e=> loadWards(SELS.district.value));
      const btn = document.getElementById('save_sender');
      if(btn) btn.addEventListener('click', upsertSender);

      // Price test
      const probe = document.getElementById('btn-quote');
      if(probe) probe.addEventListener('click', async ()=>{
        const data = loadLocalSender();
        const body = {
          sender_province: data.province_name, sender_district: data.district_name, sender_ward: data.ward_name,
          receiver_province: 'Thành phố Hồ Chí Minh', receiver_district: 'Quận 1',
          weight_gram: 500, cod: 0
        };
        const r = await api('/shipping/price', body);
        alert('Kết quả: '+JSON.stringify(r));
      });
    });
  })();
</script>

<script>
(function(){
  function showSummaryFromLocal(){
    try{
      const s = JSON.parse(localStorage.getItem('shipping.sender')||'null');
      if(!s) return;
      const sum = document.getElementById('sender_summary');
      if(!sum) return;
      document.getElementById('s_name').textContent = s.name||'';
      document.getElementById('s_phone').textContent = s.phone||'';
      const addr = [s.addr, s.ward_name, s.district_name, s.province_name].filter(Boolean).join(', ');
      document.getElementById('s_addr').textContent = addr;
      sum.style.display='block';
      var m = document.querySelector('.sender-manual'); if(m) m.style.display='none';
    }catch(e){}
  }
  window.__saveSenderSummary = function(v){
    try{ localStorage.setItem('shipping.sender', JSON.stringify(v||{})); }catch(e){}
    showSummaryFromLocal();
  };
  // attach edit button
  document.addEventListener('DOMContentLoaded', function(){
    const edit = document.getElementById('edit_sender');
    if(edit && !edit.__wired){ edit.__wired=true; edit.addEventListener('click', function(){
      var m = document.querySelector('.sender-manual'); if(m) m.style.display='block';
      var sum = document.getElementById('sender_summary'); if(sum) sum.style.display='none';
    }); }
    showSummaryFromLocal();
  });
})();
</script>

</body>
</html>
