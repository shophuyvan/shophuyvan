<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Qu·∫£n l√Ω Admin & Ph√¢n quy·ªÅn</title>
  <link rel="stylesheet" href="./styles.css"/>
  <script src="./admin_real.js?v=27"></script>
  <style>
    .role-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .role-super { background: #fee2e2; color: #991b1b; }
    .role-manager { background: #dbeafe; color: #1e40af; }
    .role-staff { background: #d1fae5; color: #065f46; }
    .role-warehouse { background: #fef3c7; color: #92400e; }
    
    .status-active { color: #059669; }
    .status-inactive { color: #dc2626; }
    
    .permission-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      max-height: 400px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #f9fafb;
    }
    
    .permission-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px;
      background: white;
      border-radius: 4px;
    }
    
    .permission-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }
    
    .permission-category {
      font-weight: 600;
      color: #374151;
      margin: 10px 0 5px 0;
      padding-bottom: 5px;
      border-bottom: 2px solid #e5e7eb;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">Qu·∫£n l√Ω Admin & Ph√¢n quy·ªÅn</div>
    <div class="nav">
      <a href="./products.html" class="badge">S·∫£n ph·∫©m</a>
      <a href="./orders.html" class="badge">ƒê∆°n h√†ng</a>
      <a href="./admin-users.html" class="badge">Admin Users</a>
      <a href="./admin-roles.html" class="badge">Roles</a>
      <span class="badge">User: <span id="current-user">Loading...</span></span>
      <button id="logout-btn" class="badge" style="cursor: pointer; background: #fee2e2; color: #991b1b;">
        ƒêƒÉng xu·∫•t
      </button>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb;">
    <button class="tab-btn active" data-tab="users">
      üë§ Qu·∫£n l√Ω Admin Users
    </button>
    <button class="tab-btn" data-tab="roles">
      üîë Qu·∫£n l√Ω Roles & Permissions
    </button>
  </div>

  <!-- Users Tab -->
  <div id="tab-users" class="tab-content active">
    <div class="card">
      <div class="flex justify-between items-center mb-3">
        <h2>Danh s√°ch Admin</h2>
        <button id="btn-create-user" class="btn primary">‚ûï Th√™m Admin</button>
      </div>
      
      <table class="table">
        <thead>
          <tr>
            <th>H·ªç t√™n</th>
            <th>Email</th>
            <th>S·ªë ƒëi·ªán tho·∫°i</th>
            <th>Role</th>
            <th>Tr·∫°ng th√°i</th>
            <th>ƒêƒÉng nh·∫≠p l·∫ßn cu·ªëi</th>
            <th>H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody id="users-list"></tbody>
      </table>
    </div>
  </div>

  <!-- Roles Tab -->
  <div id="tab-roles" class="tab-content" style="display: none;">
    <div class="card">
      <div class="flex justify-between items-center mb-3">
        <h2>Danh s√°ch Roles</h2>
        <button id="btn-create-role" class="btn primary">‚ûï T·∫°o Role m·ªõi</button>
      </div>
      
      <div id="roles-list" class="grid gap-3"></div>
    </div>
  </div>
</div>

<!-- Modal: Create/Edit User -->
<div id="modal-user" class="modal">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <h3 id="modal-user-title">Th√™m Admin m·ªõi</h3>
      <button class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="user-id" />
      
      <div class="form-group">
        <label>H·ªç t√™n *</label>
        <input id="user-name" class="input" placeholder="Nguy·ªÖn VƒÉn A" required />
      </div>
      
      <div class="form-group">
        <label>Email *</label>
        <input id="user-email" class="input" type="email" placeholder="admin@example.com" required />
      </div>
      
      <div class="form-group">
        <label>M·∫≠t kh·∫©u * <span class="text-xs text-gray-500">(ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)</span></label>
        <input id="user-password" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
      
      <div class="form-group">
        <label>S·ªë ƒëi·ªán tho·∫°i</label>
        <input id="user-phone" class="input" type="tel" placeholder="0901234567" />
      </div>
      
      <div class="form-group">
        <label>Role *</label>
        <select id="user-role" class="input" required>
          <option value="">-- Ch·ªçn role --</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Tr·∫°ng th√°i</label>
        <select id="user-status" class="input">
          <option value="active">Active - Ho·∫°t ƒë·ªông</option>
          <option value="inactive">Inactive - T·∫°m kh√≥a</option>
          <option value="suspended">Suspended - ƒê√¨nh ch·ªâ</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('user')">H·ªßy</button>
      <button id="btn-save-user" class="btn primary">üíæ L∆∞u</button>
    </div>
  </div>
</div>

<!-- Modal: Create/Edit Role -->
<div id="modal-role" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
      <h3 id="modal-role-title">T·∫°o Role m·ªõi</h3>
      <button class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="role-id" />
      
      <div class="form-group">
        <label>T√™n Role *</label>
        <input id="role-name" class="input" placeholder="Qu·∫£n l√Ω kho" required />
      </div>
      
      <div class="form-group">
        <label>M√¥ t·∫£</label>
        <textarea id="role-desc" class="input" rows="2" placeholder="Qu·∫£n l√Ω s·∫£n ph·∫©m v√† v·∫≠n chuy·ªÉn"></textarea>
      </div>
      
      <div class="form-group">
        <label class="flex items-center gap-2">
          <input type="checkbox" id="role-system" />
          <span>Role h·ªá th·ªëng (kh√¥ng th·ªÉ x√≥a)</span>
        </label>
      </div>
      
      <div class="form-group">
        <label>Quy·ªÅn h·∫°n (Permissions)</label>
        <div style="margin-bottom: 10px;">
          <label style="display: inline-flex; align-items: center; gap: 5px;">
            <input type="checkbox" id="perm-select-all" />
            <strong>Ch·ªçn t·∫•t c·∫£</strong>
          </label>
        </div>
        <div id="permissions-grid" class="permission-grid"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('role')">H·ªßy</button>
      <button id="btn-save-role" class="btn primary">üíæ L∆∞u Role</button>
    </div>
  </div>
</div>

<script>
const API_BASE = 'https://shv-api.shophuyvan.workers.dev';
const $ = (id) => document.getElementById(id);

// Auth token
let authToken = localStorage.getItem('admin_token');
let currentAdmin = null;

// Permission definitions
const PERMISSIONS = {
  'Dashboard': ['dashboard.view'],
  'S·∫£n ph·∫©m': [
    'products.view', 'products.create', 'products.edit', 
    'products.delete', 'products.export', 'products.import'
  ],
  'ƒê∆°n h√†ng': [
    'orders.view', 'orders.create', 'orders.edit', 
    'orders.cancel', 'orders.export', 'orders.print'
  ],
  'Banner': ['banners.view', 'banners.create', 'banners.edit', 'banners.delete'],
  'Voucher': ['vouchers.view', 'vouchers.create', 'vouchers.edit', 'vouchers.delete'],
  'V·∫≠n chuy·ªÉn': ['shipping.view', 'shipping.edit'],
  'Th·ªëng k√™': ['stats.view', 'stats.export'],
  'Qu·∫£ng c√°o': ['ads.view', 'ads.create', 'ads.edit', 'ads.delete'],
  'Admin Users': ['admins.view', 'admins.create', 'admins.edit', 'admins.delete', 'admins.manage_roles'],
  'C√†i ƒë·∫∑t': ['settings.view', 'settings.edit']
};

// Check auth
async function checkAuth() {
  if (!authToken) {
    window.location.href = './login.html';
    return;
  }
  
  try {
    const res = await fetch(`${API_BASE}/admin/auth/me`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    
    if (!res.ok) {
      localStorage.removeItem('admin_token');
      window.location.href = './login.html';
      return;
    }
    
    const data = await res.json();
    currentAdmin = data.admin;
    $('current-user').textContent = currentAdmin.full_name;
    
    // Check permissions
    checkPagePermissions();
  } catch (e) {
    console.error('Auth error:', e);
    localStorage.removeItem('admin_token');
    window.location.href = './login.html';
  }
}

function checkPagePermissions() {
  if (!currentAdmin || !currentAdmin.permissions) return;
  
  const perms = currentAdmin.permissions;
  
  // Hide tabs if no permission
  if (!hasPermission(perms, 'admins.view')) {
    document.querySelector('[data-tab="users"]').style.display = 'none';
  }
  
  if (!hasPermission(perms, 'admins.manage_roles')) {
    document.querySelector('[data-tab="roles"]').style.display = 'none';
  }
  
  // Hide create buttons
  if (!hasPermission(perms, 'admins.create')) {
    $('btn-create-user').style.display = 'none';
  }
  
  if (!hasPermission(perms, 'admins.manage_roles')) {
    $('btn-create-role').style.display = 'none';
  }
}

function hasPermission(perms, required) {
  if (!perms || !Array.isArray(perms)) return false;
  if (perms.includes('*')) return true;
  if (perms.includes(required)) return true;
  
  const parts = required.split('.');
  if (parts.length === 2 && perms.includes(`${parts[0]}.*`)) return true;
  
  return false;
}

// Logout
$('logout-btn').onclick = () => {
  if (confirm('ƒêƒÉng xu·∫•t?')) {
    localStorage.removeItem('admin_token');
    window.location.href = './login.html';
  }
};

// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
    
    this.classList.add('active');
    $('tab-' + this.dataset.tab).style.display = 'block';
  });
});

// Modal functions
function openModal(type) {
  $(`modal-${type}`).style.display = 'flex';
}

function closeModal(type) {
  $(`modal-${type}`).style.display = 'none';
  
  if (type === 'user') {
    $('user-id').value = '';
    $('user-name').value = '';
    $('user-email').value = '';
    $('user-password').value = '';
    $('user-phone').value = '';
    $('user-role').value = '';
    $('user-status').value = 'active';
    $('modal-user-title').textContent = 'Th√™m Admin m·ªõi';
  } else if (type === 'role') {
    $('role-id').value = '';
    $('role-name').value = '';
    $('role-desc').value = '';
    $('role-system').checked = false;
    document.querySelectorAll('#permissions-grid input[type="checkbox"]').forEach(cb => cb.checked = false);
    $('modal-role-title').textContent = 'T·∫°o Role m·ªõi';
  }
}

document.querySelectorAll('.modal-close').forEach(btn => {
  btn.addEventListener('click', function() {
    this.closest('.modal').style.display = 'none';
  });
});

// ===== USERS MANAGEMENT =====

async function loadUsers() {
  try {
    const res = await fetch(`${API_BASE}/admin/users/list`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    
    if (!res.ok) throw new Error('Failed to load users');
    
    const data = await res.json();
    const tbody = $('users-list');
    tbody.innerHTML = '';
    
    if (!data.admins || data.admins.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Ch∆∞a c√≥ admin n√†o</td></tr>';
      return;
    }
    
    data.admins.forEach(admin => {
      const roleClass = admin.role_name.toLowerCase().replace(/\s/g, '-');
      const statusClass = admin.status === 'active' ? 'status-active' : 'status-inactive';
      const lastLogin = admin.last_login 
        ? new Date(admin.last_login).toLocaleString('vi-VN')
        : 'Ch∆∞a ƒëƒÉng nh·∫≠p';
      
      const canEdit = hasPermission(currentAdmin.permissions, 'admins.edit');
      const canDelete = hasPermission(currentAdmin.permissions, 'admins.delete') && admin.id !== currentAdmin.id;
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div style="font-weight: 600;">${admin.full_name}</div>
          <div style="font-size: 11px; color: #6b7280;">ID: ${admin.id}</div>
        </td>
        <td>${admin.email}</td>
        <td>${admin.phone || '-'}</td>
        <td><span class="role-badge role-${roleClass}">${admin.role_name}</span></td>
        <td class="${statusClass}">${admin.status}</td>
        <td style="font-size: 12px;">${lastLogin}</td>
        <td>
          ${canEdit ? `<button class="btn btn-sm" onclick="editUser('${admin.id}')">‚úèÔ∏è S·ª≠a</button>` : ''}
          ${canDelete ? `<button class="btn btn-sm danger" onclick="deleteUser('${admin.id}', '${admin.full_name}')">üóëÔ∏è X√≥a</button>` : ''}
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch (e) {
    console.error('Load users error:', e);
    alert('L·ªói t·∫£i danh s√°ch admin');
  }
}

$('btn-create-user').onclick = async () => {
  await loadRolesForSelect();
  openModal('user');
};

async function loadRolesForSelect() {
  try {
    const res = await fetch(`${API_BASE}/admin/roles/list`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    
    const data = await res.json();
    const select = $('user-role');
    select.innerHTML = '<option value="">-- Ch·ªçn role --</option>';
    
    if (data.roles) {
      data.roles.forEach(role => {
        const opt = document.createElement('option');
        opt.value = role.id;
        opt.textContent = role.name;
        select.appendChild(opt);
      });
    }
  } catch (e) {
    console.error('Load roles error:', e);
  }
}

$('btn-save-user').onclick = async () => {
  const id = $('user-id').value;
  const name = $('user-name').value.trim();
  const email = $('user-email').value.trim();
  const password = $('user-password').value;
  const phone = $('user-phone').value.trim();
  const role_id = $('user-role').value;
  const status = $('user-status').value;
  
  if (!name || !email || !role_id) {
    alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc');
    return;
  }
  
  if (!id && !password) {
    alert('Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u');
    return;
  }
  
  try {
    const body = { full_name: name, email, phone, role_id, status };
    if (password) body.password = password;
    
    const url = id 
      ? `${API_BASE}/admin/users/${id}`
      : `${API_BASE}/admin/users/create`;
    
    const method = id ? 'PUT' : 'POST';
    
    const res = await fetch(url, {
      method,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify(body)
    });
    
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || 'L·ªói l∆∞u admin');
    }
    
    alert(id ? 'ƒê√£ c·∫≠p nh·∫≠t admin' : 'ƒê√£ t·∫°o admin m·ªõi');
    closeModal('user');
    loadUsers();
  } catch (e) {
    console.error('Save user error:', e);
    alert(e.message);
  }
};

async function editUser(id) {
  try {
    const res = await fetch(`${API_BASE}/admin/users/${id}`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    
    if (!res.ok) throw new Error('Failed to load user');
    
    const data = await res.json();
    const admin = data.admin;
    
    await loadRolesForSelect();
    
    $('user-id').value = admin.id;
    $('user-name').value = admin.full_name;
    $('user-email').value = admin.email;
    $('user-phone').value = admin.phone || '';
    $('user-role').value = admin.role_id;
    $('user-status').value = admin.status;
    $('user-password').value = '';
    $('user-password').placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢  (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)';
    
    $('modal-user-title').textContent = 'S·ª≠a th√¥ng tin Admin';
    openModal('user');
  } catch (e) {
    console.error('Edit user error:', e);
    alert('L·ªói t·∫£i th√¥ng tin admin');
  }
}

async function deleteUser(id, name) {
  if (!confirm(`X√≥a admin "${name}"?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) return;
  
  try {
    const res = await fetch(`${API_BASE}/admin/users/${id}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || 'L·ªói x√≥a admin');
    }
    
    alert('ƒê√£ x√≥a admin');
    loadUsers();
  } catch (e) {
    console.error('Delete user error:', e);
    alert(e.message);
  }
}

// ===== ROLES MANAGEMENT =====

async function loadRoles() {
  try {
    const res = await fetch(`${API_BASE}/admin/roles/list`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    
    if (!res.ok) throw new Error('Failed to load roles');
    
    const data = await res.json();
    const container = $('roles-list');
    container.innerHTML = '';
    
    if (!data.roles || data.roles.length === 0) {
      container.innerHTML = '<div style="text-align:center;padding:40px;">Ch∆∞a c√≥ role n√†o</div>';
      return;
    }
    
    data.roles.forEach(role => {
      const card = document.createElement('div');
      card.className = 'card';
      card.style.padding = '20px';
      
      const permCount = Array.isArray(role.permissions) ? role.permissions.length : 0;
      const isSystem = role.is_system ? '<span class="role-badge role-super">System</span>' : '';
      
      const canEdit = hasPermission(currentAdmin.permissions, 'admins.manage_roles');
      const canDelete = canEdit && !role.is_system;
      
      card.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start;">
          <div>
            <h3 style="margin: 0 0 10px 0; display: flex; align-items: center; gap: 10px;">
              ${role.name}
              ${isSystem}
            </h3>
            <p style="color: #6b7280; margin: 0 0 10px 0;">${role.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</p>
            <div style="font-size: 13px; color: #059669;">
              ‚úì ${permCount} quy·ªÅn
            </div>
          </div>
          <div style="display: flex; gap: 5px;">
            ${canEdit ? `<button class="btn btn-sm" onclick="editRole('${role.id}')">‚úèÔ∏è S·ª≠a</button>` : ''}
            ${canDelete ? `<button class="btn btn-sm danger" onclick="deleteRole('${role.id}', '${role.name}')">üóëÔ∏è</button>` : ''}
          </div>
        </div>
        <details style="margin-top: 15px;">
          <summary style="cursor: pointer; font-size: 13px; color: #6b7280;">Xem chi ti·∫øt quy·ªÅn</summary>
          <div style="margin-top: 10px; padding: 10px; background: #f9fafb; border-radius: 6px; font-size: 12px;">
            ${role.permissions.includes('*') 
              ? '<strong style="color: #dc2626;">üî• To√†n quy·ªÅn h·ªá th·ªëng</strong>'
              : role.permissions.join(', ')
            }
          </div>
        </details>
      `;
      
      container.appendChild(card);
    });
  } catch (e) {
    console.error('Load roles error:', e);
    alert('L·ªói t·∫£i danh s√°ch roles');
  }
}

$('btn-create-role').onclick = () => {
  renderPermissionsGrid();
  openModal('role');
};

function renderPermissionsGrid() {
  const grid = $('permissions-grid');
  grid.innerHTML = '';
  
  Object.entries(PERMISSIONS).forEach(([category, perms]) => {
    const categoryDiv = document.createElement('div');
    categoryDiv.className = 'permission-category';
    categoryDiv.textContent = category;
    categoryDiv.style.gridColumn = '1 / -1';
    grid.appendChild(categoryDiv);
    
    perms.forEach(perm => {
      const item = document.createElement('div');
      item.className = 'permission-item';
      
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = perm;
      checkbox.id = `perm-${perm.replace(/\./g, '-')}`;
      
      const label = document.createElement('label');
      label.htmlFor = checkbox.id;
      label.textContent = perm;
      label.style.cursor = 'pointer';
      label.style.fontSize = '13px';
      
      item.appendChild(checkbox);
      item.appendChild(label);
      grid.appendChild(item);
    });
  });
}

// Select all permissions
$('perm-select-all').addEventListener('change', function() {
  document.querySelectorAll('#permissions-grid input[type="checkbox"]').forEach(cb => {
    cb.checked = this.checked;
  });
});

$('btn-save-role').onclick = async () => {
  const id = $('role-id').value;
  const name = $('role-name').value.trim();
  const description = $('role-desc').value.trim();
  const isSystem = $('role-system').checked;
  
  if (!name) {
    alert('Vui l√≤ng nh·∫≠p t√™n role');
    return;
  }
  
  const permissions = [];
  document.querySelectorAll('#permissions-grid input[type="checkbox"]:checked').forEach(cb => {
    permissions.push(cb.value);
  });
  
  if (permissions.length === 0) {
    alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 quy·ªÅn');
    return;
  }
  
  try {
    const body = { name, description, permissions, is_system: isSystem };
    
    const url = id
      ? `${API_BASE}/admin/roles/${id}`
      : `${API_BASE}/admin/roles/create`;
    
    const method = id ? 'PUT' : 'POST';
    
    const res = await fetch(url, {
      method,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify(body)
    });
    
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || 'L·ªói l∆∞u role');
    }
    
    alert(id ? 'ƒê√£ c·∫≠p nh·∫≠t role' : 'ƒê√£ t·∫°o role m·ªõi');
    closeModal('role');
    loadRoles();
  } catch (e) {
    console.error('Save role error:', e);
    alert(e.message);
  }
};

async function editRole(id) {
  try {
    const res = await fetch(`${API_BASE}/admin/roles/${id}`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    
    if (!res.ok) throw new Error('Failed to load role');
    
    const data = await res.json();
    const role = data.role;
    
    renderPermissionsGrid();
    
    $('role-id').value = role.id;
    $('role-name').value = role.name;
    $('role-desc').value = role.description || '';
    $('role-system').checked = role.is_system || false;
    
    // Check permissions
    if (role.permissions.includes('*')) {
      $('perm-select-all').checked = true;
      document.querySelectorAll('#permissions-grid input[type="checkbox"]').forEach(cb => cb.checked = true);
    } else {
      role.permissions.forEach(perm => {
        const cb = $(`perm-${perm.replace(/\./g, '-')}`);
        if (cb) cb.checked = true;
      });
    }
    
    $('modal-role-title').textContent = 'S·ª≠a Role';
    openModal('role');
  } catch (e) {
    console.error('Edit role error:', e);
    alert('L·ªói t·∫£i th√¥ng tin role');
  }
}

async function deleteRole(id, name) {
  if (!confirm(`X√≥a role "${name}"?\n\nC√°c admin ƒëang d√πng role n√†y s·∫Ω b·ªã ·∫£nh h∆∞·ªüng!`)) return;
  
  try {
    const res = await fetch(`${API_BASE}/admin/roles/${id}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || 'L·ªói x√≥a role');
    }
    
    alert('ƒê√£ x√≥a role');
    loadRoles();
  } catch (e) {
    console.error('Delete role error:', e);
    alert(e.message);
  }
}

// Init
checkAuth().then(() => {
  loadUsers();
  loadRoles();
});
</script>

<style>
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: white;
  border-radius: 12px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  padding: 20px;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  margin: 0;
  font-size: 18px;
}

.modal-close {
  background: none;
  border: none;
  font-size: 28px;
  cursor: pointer;
  color: #6b7280;
}

.modal-close:hover {
  color: #111827;
}

.modal-body {
  padding: 20px;
}

.modal-footer {
  padding: 20px;
  border-top: 1px solid #e5e7eb;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: 600;
  font-size: 14px;
}

.tab-btn {
  padding: 12px 24px;
  background: transparent;
  border: none;
  border-bottom: 3px solid transparent;
  cursor: pointer;
  font-weight: 600;
  color: #6b7280;
  transition: all 0.2s;
}

.tab-btn:hover {
  color: #111827;
}

.tab-btn.active {
  color: #059669;
  border-bottom-color: #059669;
}

.btn-sm {
  padding: 4px 12px;
  font-size: 13px;
}
</style>
</body>
</html>