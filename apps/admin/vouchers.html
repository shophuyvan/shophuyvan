<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Vouchers - Admin</title>
<link rel="stylesheet" href="./styles.css"/>
<script src="./admin_real.js"></script>
<script src="./sidebar-layout.js"></script>
<style>
/* Vouchers specific styles */
.toolbar {
  background: white;
  padding: 16px;
  border-radius: 8px;
  margin-bottom: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.card {
  background: white;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.row {
  display: flex;
  gap: 12px;
  align-items: flex-end;
  flex-wrap: wrap;
}

.col {
  flex: 1;
  min-width: 150px;
}

.col label {
  display: block;
  margin-bottom: 6px;
  font-size: 14px;
  font-weight: 500;
  color: #333;
}

.input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
}

.input:focus {
  outline: none;
  border-color: #1976d2;
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s;
  white-space: nowrap;
}

.btn.primary {
  background: #1976d2;
  color: white;
}

.btn.primary:hover {
  background: #1565c0;
}

.table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.table thead {
  background: #f9f9f9;
}

.table th {
  padding: 12px;
  text-align: left;
  font-weight: 600;
  font-size: 13px;
  color: #666;
  border-bottom: 2px solid #e0e0e0;
}

.table td {
  padding: 12px;
  font-size: 14px;
  border-bottom: 1px solid #f0f0f0;
}

.table tbody tr:hover {
  background: #f9f9f9;
}

h3 {
  font-size: 18px;
  font-weight: 600;
  margin: 24px 0 16px 0;
  color: #333;
}

@media (max-width: 768px) {
  .row {
    flex-direction: column;
  }

  .col {
    width: 100%;
  }
}
</style>
</head>
<body>

<!-- Toolbar with Tabs -->
<div class="toolbar" style="flex-direction: column; align-items: stretch;">
  <h2 style="margin: 0 0 12px 0; font-size: 18px;">üé´ Qu·∫£n l√Ω Vouchers</h2>
  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
    <button id="tab-discount" class="btn primary" style="flex: 1; min-width: 150px;">üí∞ Gi·∫£m Gi√° (%)</button>
    <button id="tab-freeship" class="btn" style="flex: 1; min-width: 150px; background: #e5e7eb; color: #374151;">üöö Mi·ªÖn Ship</button>
  </div>
</div>

<!-- Tab 1: Voucher Gi·∫£m Gi√° -->
<div id="form-discount" class="card">
  <h3 style="margin: 0 0 16px 0; color: #1976d2; font-size: 16px;">‚ûï T·∫°o Voucher Gi·∫£m Gi√° (%)</h3>
  
  <div class="row">
    <div class="col" style="flex: 1; min-width: 200px;">
      <label>M√£ voucher <span style="color: red;">*</span></label>
      <input id="code-discount" class="input" placeholder="VD: GIAM10"/>
    </div>
    <div class="col" style="flex: 0 0 120px; min-width: 120px;">
      <label>Gi·∫£m (%) <span style="color: red;">*</span></label>
      <input id="off-discount" class="input" type="number" min="1" max="100" value="10"/>
    </div>
    <div class="col" style="flex: 1; min-width: 150px;">
      <label>ƒê∆°n t·ªëi thi·ªÉu (ƒë)</label>
      <input id="min-purchase-discount" class="input" type="number" min="0" value="0" placeholder="0 = k gi·ªõi h·∫°n"/>
    </div>
    <div class="col" style="flex: 0 0 100px; min-width: 100px;">
      <label>Tr·∫°ng th√°i</label>
      <select id="on-discount" class="input">
        <option value="true">ON</option>
        <option value="false">OFF</option>
      </select>
    </div>
  </div>

  <div class="row" style="margin-top: 12px;">
    <div class="col" style="flex: 1; min-width: 180px;">
      <label>Ng√†y b·∫Øt ƒë·∫ßu</label>
      <input id="starts-discount" class="input" type="datetime-local"/>
    </div>
    <div class="col" style="flex: 1; min-width: 180px;">
      <label>Ng√†y h·∫øt h·∫°n</label>
      <input id="expires-discount" class="input" type="datetime-local"/>
    </div>
  </div>

  <div class="row" style="margin-top: 12px;">
    <div class="col" style="flex: 1; min-width: 150px;">
      <label>Gi·ªõi h·∫°n/ng∆∞·ªùi</label>
      <input id="usage-per-user-discount" class="input" type="number" min="0" value="1" placeholder="0 = kh√¥ng gi·ªõi h·∫°n"/>
    </div>
    <div class="col" style="flex: 1; min-width: 150px;">
      <label>T·ªïng gi·ªõi h·∫°n</label>
      <input id="usage-total-discount" class="input" type="number" min="0" value="0" placeholder="0 = kh√¥ng gi·ªõi h·∫°n"/>
    </div>
  </div>

  <div class="row" style="margin-top: 16px;">
    <button class="btn primary" id="save-discount" style="width: 100%;">üíæ L∆∞u Voucher Gi·∫£m Gi√°</button>
  </div>
</div>

<!-- Tab 2: Voucher Mi·ªÖn Ship -->
<div id="form-freeship" class="card" style="display: none;">
  <h3 style="margin: 0 0 16px 0; color: #059669; font-size: 16px;">üöö T·∫°o Voucher Mi·ªÖn Ship T·ª± ƒê·ªông</h3>
  
  <div style="background: #ecfdf5; border: 1px solid #a7f3d0; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
    <p style="margin: 0; font-size: 13px; color: #065f46;">
      ‚ÑπÔ∏è <strong>Ch∆∞∆°ng tr√¨nh mi·ªÖn ship t·ª± ƒë·ªông:</strong> Kh√¥ng c·∫ßn nh·∫≠p m√£ voucher. Khi kh√°ch h√†ng ƒë·∫∑t ƒë∆°n ƒë·ªß ƒëi·ªÅu ki·ªán (ƒë∆°n t·ªëi thi·ªÉu + trong th·ªùi gian) s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c mi·ªÖn ph√≠ ship.
    </p>
  </div>
  
  <div class="row">
    <div class="col" style="flex: 1; min-width: 150px;">
      <label>ƒê∆°n t·ªëi thi·ªÉu (ƒë) <span style="color: red;">*</span></label>
      <input id="min-purchase-freeship" class="input" type="number" min="0" placeholder="150000"/>
    </div>
    <div class="col" style="flex: 0 0 100px; min-width: 100px;">
      <label>Tr·∫°ng th√°i</label>
      <select id="on-freeship" class="input">
        <option value="true">ON</option>
        <option value="false">OFF</option>
      </select>
    </div>
  </div>

  <div class="row" style="margin-top: 12px;">
    <div class="col" style="flex: 1; min-width: 180px;">
      <label>Ng√†y b·∫Øt ƒë·∫ßu</label>
      <input id="starts-freeship" class="input" type="datetime-local"/>
    </div>
    <div class="col" style="flex: 1; min-width: 180px;">
      <label>Ng√†y h·∫øt h·∫°n</label>
      <input id="expires-freeship" class="input" type="datetime-local"/>
    </div>
  </div>

  <div class="row" style="margin-top: 12px;">
    <div class="col" style="flex: 1; min-width: 150px;">
      <label>Gi·ªõi h·∫°n/ng∆∞·ªùi</label>
      <input id="usage-per-user-freeship" class="input" type="number" min="0" value="1" placeholder="0 = kh√¥ng gi·ªõi h·∫°n"/>
    </div>
    <div class="col" style="flex: 1; min-width: 150px;">
      <label>T·ªïng gi·ªõi h·∫°n</label>
      <input id="usage-total-freeship" class="input" type="number" min="0" value="0" placeholder="0 = kh√¥ng gi·ªõi h·∫°n"/>
    </div>
  </div>

  <div class="row" style="margin-top: 16px;">
    <button class="btn primary" id="save-freeship" style="width: 100%; background: #059669;">üíæ L∆∞u Voucher Mi·ªÖn Ship</button>
  </div>
</div>

<!-- Vouchers List -->
<h3>Danh s√°ch vouchers</h3>
<table class="table">
  <thead>
    <tr>
      <th>M√£ / T√™n</th>
      <th>Lo·∫°i</th>
      <th>Chi ti·∫øt</th>
      <th>H·∫°n d√πng</th> <th>Gi·ªõi h·∫°n</th> <th>Tr·∫°ng th√°i</th>
      <th>H√†nh ƒë·ªông</th>
    </tr>
  </thead>
  <tbody id="list">
    <tr>
      <td colspan="3" style="text-align:center;padding:2rem">ƒêang t·∫£i...</td>
    </tr>
  </tbody>
</table>

<script>
// Initialize layout
document.addEventListener('DOMContentLoaded', function() {
  console.log('[Vouchers] DOM loaded, initializing...');

  // Initialize sidebar layout
  if (window.AdminLayout) {
    AdminLayout.init('Vouchers');
  }

  // Vouchers logic
  const $ = s => document.querySelector(s);

  // Tab Switching
  const tabDiscount = $('#tab-discount');
  const tabFreeship = $('#tab-freeship');
  const formDiscount = $('#form-discount');
  const formFreeship = $('#form-freeship');

  tabDiscount.onclick = () => {
    tabDiscount.className = 'btn primary';
    tabFreeship.className = 'btn';
    tabFreeship.style.background = '#e5e7eb';
    tabFreeship.style.color = '#374151';
    formDiscount.style.display = 'block';
    formFreeship.style.display = 'none';
  };

  tabFreeship.onclick = () => {
    tabFreeship.className = 'btn primary';
    tabDiscount.className = 'btn';
    tabDiscount.style.background = '#e5e7eb';
    tabDiscount.style.color = '#374151';
    formFreeship.style.display = 'block';
    formDiscount.style.display = 'none';
  };

  // Save Discount Voucher
  $('#save-discount').onclick = async () => {
    const code = $('#code-discount').value.trim();
    const off = Number($('#off-discount').value || 0);
    const min_purchase = Number($('#min-purchase-discount').value || 0);
    const on = $('#on-discount').value === 'true';
    const usage_limit_per_user = parseInt($('#usage-per-user-discount').value || '1');
    const usage_limit_total = parseInt($('#usage-total-discount').value || '0');
    const starts_at_input = $('#starts-discount').value;
    const expires_at_input = $('#expires-discount').value;

    if (!code) {
      alert('Vui l√≤ng nh·∫≠p m√£ voucher');
      return;
    }
    if (off <= 0 || off > 100) {
      alert('Gi·∫£m gi√° (%) ph·∫£i t·ª´ 1 ƒë·∫øn 100');
      return;
    }

    const starts_at = starts_at_input ? new Date(starts_at_input).getTime() : null;
    const expires_at = expires_at_input ? new Date(expires_at_input).getTime() : null;

    if (starts_at && expires_at && starts_at >= expires_at) {
      alert('Ng√†y b·∫Øt ƒë·∫ßu ph·∫£i tr∆∞·ªõc ng√†y h·∫øt h·∫°n');
      return;
    }

    const body = {
      code,
      on,
      voucher_type: 'code',
      off,
      min_purchase,
      usage_limit_per_user: usage_limit_per_user >= 0 ? usage_limit_per_user : 1,
      usage_limit_total: usage_limit_total >= 0 ? usage_limit_total : 0,
      starts_at,
      expires_at,
      usage_count: 0
    };

    try {
      let r = await Admin.req('/admin/vouchers/upsert', { method: 'POST', body });
      if (!(r && r.ok)) {
        r = await Admin.req('/admin/voucher', { method: 'POST', body });
      }

      if (r && r.ok) {
        Admin.toast('‚úÖ ƒê√£ l∆∞u voucher gi·∫£m gi√°');
        $('#code-discount').value = '';
        $('#off-discount').value = '10';
        $('#min-purchase-discount').value = '0';
        $('#starts-discount').value = '';
        $('#expires-discount').value = '';
        $('#usage-per-user-discount').value = '1';
        $('#usage-total-discount').value = '0';
        load();
      } else {
        alert('‚ùå L∆∞u th·∫•t b·∫°i: ' + (r?.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
      }
    } catch (error) {
      alert('‚ùå L∆∞u th·∫•t b·∫°i: ' + error.message);
    }
  };

  // Save Freeship Voucher
  $('#save-freeship').onclick = async () => {
    const min_purchase = Number($('#min-purchase-freeship').value || 0);
    const on = $('#on-freeship').value === 'true';
    const usage_limit_per_user = parseInt($('#usage-per-user-freeship').value || '1');
    const usage_limit_total = parseInt($('#usage-total-freeship').value || '0');
    const starts_at_input = $('#starts-freeship').value;
    const expires_at_input = $('#expires-freeship').value;

    if (min_purchase <= 0) {
      alert('Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn ƒëi·ªÅu ki·ªán mi·ªÖn ship h·ª£p l·ªá (l·ªõn h∆°n 0)');
      return;
    }

    const starts_at = starts_at_input ? new Date(starts_at_input).getTime() : null;
    const expires_at = expires_at_input ? new Date(expires_at_input).getTime() : null;

    if (starts_at && expires_at && starts_at >= expires_at) {
      alert('Ng√†y b·∫Øt ƒë·∫ßu ph·∫£i tr∆∞·ªõc ng√†y h·∫øt h·∫°n');
      return;
    }

    // T·ª± ƒë·ªông t·∫°o m√£ voucher d·ª±a tr√™n ƒëi·ªÅu ki·ªán
    const autoCode = `FREESHIP${Math.floor(min_purchase / 1000)}K_${Date.now()}`;

    const body = {
      code: autoCode,
      on,
      voucher_type: 'auto_freeship',
      off: 0,
      min_purchase,
      usage_limit_per_user: usage_limit_per_user >= 0 ? usage_limit_per_user : 1,
      usage_limit_total: usage_limit_total >= 0 ? usage_limit_total : 0,
      starts_at,
      expires_at,
      usage_count: 0
    };

    try {
      let r = await Admin.req('/admin/vouchers/upsert', { method: 'POST', body });
      if (!(r && r.ok)) {
        r = await Admin.req('/admin/voucher', { method: 'POST', body });
      }

      if (r && r.ok) {
        Admin.toast('‚úÖ ƒê√£ t·∫°o ch∆∞∆°ng tr√¨nh mi·ªÖn ship t·ª± ƒë·ªông');
        $('#min-purchase-freeship').value = '';
        $('#starts-freeship').value = '';
        $('#expires-freeship').value = '';
        $('#usage-per-user-freeship').value = '1';
        $('#usage-total-freeship').value = '0';
        load();
      } else {
        alert('‚ùå L∆∞u th·∫•t b·∫°i: ' + (r?.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
      }
    } catch (error) {
      alert('‚ùå L∆∞u th·∫•t b·∫°i: ' + error.message);
    }
  };

  async function load() {
    try {
      const r = await Admin.tryPaths([
        '/vouchers',
        '/admin/vouchers/list',
        '/admin/vouchers'
      ]);

      const items = r.items || r.vouchers || r.data || [];
      const tb = $('#list');
      
      if (items.length === 0) {
        tb.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:#999">Ch∆∞a c√≥ voucher n√†o</td></tr>';
        return;
      }

      tb.innerHTML = '';
      items.forEach(v => {
        const tr = document.createElement('tr');
        const status = (v.on === undefined ? true : v.on);
        const statusText = status ? 
          '<span style="color:#10b981;font-weight:600">ON</span>' : 
          '<span style="color:#ef4444;font-weight:600">OFF</span>';
        
        let typeText = 'Gi·∫£m gi√°';
        let detailText = `<span style="color:#f59e0b;font-weight:600">${v.off || 0}%</span>`;

        if (v.voucher_type === 'code' && v.min_purchase > 0) {
          detailText += `<br><span style="font-size:12px;color:#666">ƒê∆°n >= ${formatPrice(v.min_purchase)}</span>`;
        }

        if (v.voucher_type === 'auto_freeship') {
          typeText = 'Mi·ªÖn ship';
          detailText = `ƒê∆°n >= ${formatPrice(v.min_purchase || 0)}`;
        }

        let startsText = '-';
        if (v.starts_at) {
          try {
            startsText = new Date(v.starts_at).toLocaleString('vi-VN', { 
              day: '2-digit', month: '2-digit', year: 'numeric', 
              hour: '2-digit', minute: '2-digit' 
            });
          } catch { startsText = 'L·ªói ng√†y'; }
        }

        let expiryText = '-';
        if (v.expires_at) {
          try {
            expiryText = new Date(v.expires_at).toLocaleString('vi-VN', { 
              day: '2-digit', month: '2-digit', year: 'numeric', 
              hour: '2-digit', minute: '2-digit' 
            });
          } catch { expiryText = 'L·ªói ng√†y'; }
        }

        let limitText = '';
        if (v.usage_limit_per_user > 0) {
          limitText += `${v.usage_limit_per_user}/ng∆∞·ªùi`;
        }
        if (v.usage_limit_total > 0) {
          limitText += `${limitText ? ', ' : ''}${v.usage_count || 0}/${v.usage_limit_total} t·ªïng`;
        }
        if (!limitText) limitText = 'Kh√¥ng gi·ªõi h·∫°n';

        tr.innerHTML = `
          <td><strong>${v.code}</strong></td>
          <td>${typeText}</td>
          <td>${detailText}</td>
          <td style="font-size: 12px;">${startsText}<br>${expiryText}</td>
          <td>${limitText}</td>
          <td>${statusText}</td>
          <td><button class="btn" style="background: #fee2e2; color: #b91c1c; font-size: 13px; padding: 5px 10px;" onclick="deleteVoucher('${v.code}')">X√≥a</button></td>
        `;
        tb.appendChild(tr);
      });

      console.log('[Vouchers] Loaded', items.length, 'vouchers');
    } catch (error) {
      console.error('[Vouchers] Load error:', error);
      $('#list').innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:#ef4444">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>';
    }
  }

  function formatPrice(n) { return Number(n||0).toLocaleString('vi-VN') + 'ƒë'; }

  window.deleteVoucher = async (code) => {
    if (!code) return;
    if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a voucher "${code}" kh√¥ng? S·∫Ω kh√¥ng th·ªÉ ho√†n t√°c.`)) {
      return;
    }

    try {
      const r = await Admin.req('/admin/vouchers/delete', { 
        method: 'POST', 
        body: { code } 
      });

      if (r && r.ok) {
        Admin.toast('‚úÖ ƒê√£ x√≥a voucher');
        load();
      } else {
        alert('‚ùå X√≥a th·∫•t b·∫°i: ' + (r?.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
      }
    } catch (error) {
      alert('‚ùå X√≥a th·∫•t b·∫°i: ' + error.message);
    }
  };

  // Initial load
  load();
});
</script>

</body>
</html>