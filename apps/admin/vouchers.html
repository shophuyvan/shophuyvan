<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Vouchers - Admin</title>
<link rel="stylesheet" href="./styles.css"/>
<script src="./admin_real.js"></script>
<script src="./sidebar-layout.js"></script>
<style>
/* Vouchers specific styles */
.toolbar {
  background: white;
  padding: 16px;
  border-radius: 8px;
  margin-bottom: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.card {
  background: white;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.row {
  display: flex;
  gap: 12px;
  align-items: flex-end;
  flex-wrap: wrap;
}

.col {
  flex: 1;
  min-width: 150px;
}

.col label {
  display: block;
  margin-bottom: 6px;
  font-size: 14px;
  font-weight: 500;
  color: #333;
}

.input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
}

.input:focus {
  outline: none;
  border-color: #1976d2;
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s;
  white-space: nowrap;
}

.btn.primary {
  background: #1976d2;
  color: white;
}

.btn.primary:hover {
  background: #1565c0;
}

.table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.table thead {
  background: #f9f9f9;
}

.table th {
  padding: 12px;
  text-align: left;
  font-weight: 600;
  font-size: 13px;
  color: #666;
  border-bottom: 2px solid #e0e0e0;
}

.table td {
  padding: 12px;
  font-size: 14px;
  border-bottom: 1px solid #f0f0f0;
}

.table tbody tr:hover {
  background: #f9f9f9;
}

h3 {
  font-size: 18px;
  font-weight: 600;
  margin: 24px 0 16px 0;
  color: #333;
}

@media (max-width: 768px) {
  .row {
    flex-direction: column;
  }

  .col {
    width: 100%;
  }
}
</style>
</head>
<body>

<!-- Toolbar -->
<div class="toolbar">
  <h2 style="margin: 0; font-size: 18px;">üé´ Qu·∫£n l√Ω Vouchers</h2>
</div>

<!-- Add Voucher Form -->
<div class="card">
  <div class="row">
    <div class="col">
      <label>M√£</label>
      <input id="code" class="input" placeholder="HUYVAN10"/>
    </div>
    <div class="col">
      <label>Gi·∫£m (%)</label>
      <input id="off" class="input" type="number" min="0" max="100" value="10"/>
    </div>
    <div class="col">
      <label>Tr·∫°ng th√°i</label>
      <select id="on" class="input">
        <option value="true">ON</option>
        <option value="false">OFF</option>
      </select>
    </div>
    <div class="col">
      <label>Lo·∫°i Voucher</label>
      <select id="voucher_type" class="input">
        <option value="code">M√£ gi·∫£m gi√° (%)</option>
        <option value="auto_freeship">Mi·ªÖn ship t·ª± ƒë·ªông</option>
      </select>
    </div>
    <div class="col" id="min_purchase_col" style="display: none;">
      <label>ƒêi·ªÅu ki·ªán mi·ªÖn ship (>=)</label>
      <input id="min_purchase" class="input" type="number" min="0" placeholder="150000"/>
    </div>
   </div> <div class="row mt-4"> 
    <div class="col">
      <label>Gi·ªõi h·∫°n d√πng/ng∆∞·ªùi</label>
      <input id="usage_limit_per_user" class="input" type="number" min="0" value="1" placeholder="1 (0 = kh√¥ng gi·ªõi h·∫°n)"/>
    </div>
    <div class="col">
      <label>T·ªïng gi·ªõi h·∫°n l∆∞·ª£t d√πng</label>
      <input id="usage_limit_total" class="input" type="number" min="0" placeholder="100 (0 = kh√¥ng gi·ªõi h·∫°n)"/>
    </div>
    <div class="col">
      <label>Ng√†y h·∫øt h·∫°n (t√πy ch·ªçn)</label>
      <input id="expires_at" class="input" type="datetime-local"/>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col"> <button class="btn primary" id="save">L∆∞u Voucher</button>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() { // TH√äM D√íNG N√ÄY
      const voucherTypeSelect = document.getElementById('voucher_type');
      const minPurchaseCol = document.getElementById('min_purchase_col');
      const offCol = document.getElementById('off').closest('.col'); // L·∫•y c·∫£ c·ªôt ch·ª©a input %

      function toggleFields() {
        const showMinPurchase = voucherTypeSelect.value === 'auto_freeship';
        minPurchaseCol.style.display = showMinPurchase ? 'block' : 'none';
        // ·∫®n/hi·ªán c·ªôt Gi·∫£m (%)
        offCol.style.display = showMinPurchase ? 'none' : 'block'; 
      }

      voucherTypeSelect.addEventListener('change', toggleFields);
      
      // Trigger change l√∫c t·∫£i trang
      toggleFields(); // G·ªçi tr·ª±c ti·∫øp h√†m toggleFields
    }); // TH√äM D√íNG N√ÄY
  </script>
</div>

<!-- Vouchers List -->
<h3>Danh s√°ch vouchers</h3>
<table class="table">
  <thead>
    <tr>
      <th>M√£ / T√™n</th>
      <th>Lo·∫°i</th>
      <th>Chi ti·∫øt</th>
      <th>H·∫°n d√πng</th> <th>Gi·ªõi h·∫°n</th> <th>Tr·∫°ng th√°i</th>
      <th>H√†nh ƒë·ªông</th>
    </tr>
  </thead>
  <tbody id="list">
    <tr>
      <td colspan="3" style="text-align:center;padding:2rem">ƒêang t·∫£i...</td>
    </tr>
  </tbody>
</table>

<script>
// Initialize layout
document.addEventListener('DOMContentLoaded', function() {
  console.log('[Vouchers] DOM loaded, initializing...');

  // Initialize sidebar layout
  if (window.AdminLayout) {
    AdminLayout.init('Vouchers');
  }

  // Vouchers logic
  const $ = s => document.querySelector(s);

  $('#save').onclick = async () => {
    const code = $('#code').value.trim();
    const voucher_type = $('#voucher_type').value;
    const on = $('#on').value === 'true'; 
    
    // ƒê·ªçc c√°c tr∆∞·ªùng m·ªõi
    const usage_limit_per_user = parseInt($('#usage_limit_per_user').value || '1'); // M·∫∑c ƒë·ªãnh l√† 1
    const usage_limit_total = parseInt($('#usage_limit_total').value || '0'); // M·∫∑c ƒë·ªãnh l√† 0 (v√¥ h·∫°n)
    const expires_at_input = $('#expires_at').value;
    // Chuy·ªÉn ƒë·ªïi datetime-local sang timestamp (milliseconds) ho·∫∑c null
    const expires_at = expires_at_input ? new Date(expires_at_input).getTime() : null; 

    if (!code) {
      alert('Vui l√≤ng nh·∫≠p m√£ voucher (d√πng l√†m ID)');
      return;
    }

    let body = { 
      code, 
      on, 
      voucher_type,
      // Th√™m c√°c tr∆∞·ªùng m·ªõi v√†o body
      usage_limit_per_user: usage_limit_per_user >= 0 ? usage_limit_per_user : 1, // ƒê·∫£m b·∫£o kh√¥ng √¢m
      usage_limit_total: usage_limit_total >= 0 ? usage_limit_total : 0, // ƒê·∫£m b·∫£o kh√¥ng √¢m
      expires_at: expires_at,
      usage_count: 0 // S·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t ·ªü l·∫ßn sau n·∫øu l√† edit
    };

    if (voucher_type === 'code') {
      const off = Number($('#off').value || 0);
      if (off <= 0 || off > 100) {
        alert('Gi·∫£m gi√° (%) ph·∫£i t·ª´ 1 ƒë·∫øn 100');
        return;
      }
      body.off = off; 
      body.min_purchase = 0; 
    } else if (voucher_type === 'auto_freeship') {
      const min_purchase = Number($('#min_purchase').value || 0);
      if (min_purchase <= 0) {
        alert('Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn ƒêi·ªÅu ki·ªán mi·ªÖn ship h·ª£p l·ªá (l·ªõn h∆°n 0)');
        return;
      }
      body.min_purchase = min_purchase; 
      body.off = 0; 
    }

    try {
      let r = await Admin.req('/admin/vouchers/upsert', { method: 'POST', body });
      if (!(r && r.ok)) {
        r = await Admin.req('/admin/voucher', { method: 'POST', body });
      }

      if (r && r.ok) {
        Admin.toast('‚úÖ ƒê√£ l∆∞u voucher');
        $('#code').value = '';
        $('#off').value = '10';
        $('#on').value = 'true';
        load();
      } else {
        alert('‚ùå L∆∞u th·∫•t b·∫°i: ' + (r?.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
      }
    } catch (error) {
      alert('‚ùå L∆∞u th·∫•t b·∫°i: ' + error.message);
    }
  };

  async function load() {
    try {
      const r = await Admin.tryPaths([
        '/vouchers',
        '/admin/vouchers/list',
        '/admin/vouchers'
      ]);

      const items = r.items || r.vouchers || r.data || [];
      const tb = $('#list');
      
      if (items.length === 0) {
        tb.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:2rem;color:#999">Ch∆∞a c√≥ voucher n√†o</td></tr>';
        return;
      }

      tb.innerHTML = '';
      items.forEach(v => {
        const tr = document.createElement('tr');
        const status = (v.on === undefined ? true : v.on);
        const statusText = status ? 
          '<span style="color:#10b981;font-weight:600">ON</span>' : 
          '<span style="color:#ef4444;font-weight:600">OFF</span>';
        
        let typeText = 'M√£ gi·∫£m gi√°';
        let detailText = `<span style="color:#f59e0b;font-weight:600">${v.off || 0}%</span>`;

        if (v.voucher_type === 'auto_freeship') {
          typeText = 'Mi·ªÖn ship t·ª± ƒë·ªông';
          detailText = `ƒê∆°n >= ${formatPrice(v.min_purchase || 0)}`;
        }

        // Hi·ªÉn th·ªã ng√†y h·∫øt h·∫°n
        let expiryText = '-';
        if (v.expires_at) {
          try {
            expiryText = new Date(v.expires_at).toLocaleString('vi-VN', { 
              day: '2-digit', month: '2-digit', year: 'numeric', 
              hour: '2-digit', minute: '2-digit' 
            });
          } catch { expiryText = 'L·ªói ng√†y'; }
        }

        // Hi·ªÉn th·ªã gi·ªõi h·∫°n
        let limitText = '';
        if (v.usage_limit_per_user > 0) {
          limitText += `1/ng∆∞·ªùi`;
        }
        if (v.usage_limit_total > 0) {
          limitText += `${limitText ? ', ' : ''}${v.usage_count || 0}/${v.usage_limit_total} t·ªïng`;
        }
        if (!limitText) limitText = 'Kh√¥ng gi·ªõi h·∫°n';

        tr.innerHTML = `
          <td><strong>${v.code}</strong></td>
          <td>${typeText}</td>
          <td>${detailText}</td>
          <td>${expiryText}</td> <td>${limitText}</td> <td>${statusText}</td>
          <td><button class="btn" style="background: #fee2e2; color: #b91c1c; font-size: 13px; padding: 5px 10px;" onclick="deleteVoucher('${v.code}')">X√≥a</button></td>
        `;
        tb.appendChild(tr);

        // Helper format gi√° ti·ªÅn (th√™m v√†o trong h√†m load ho·∫∑c ngo√†i c√πng)
        function formatPrice(n) { return Number(n||0).toLocaleString('vi-VN') + 'ƒë'; }
      });

      console.log('[Vouchers] Loaded', items.length, 'vouchers');
    } catch (error) {
      console.error('[Vouchers] Load error:', error);
      $('#list').innerHTML = '<tr><td colspan="3" style="text-align:center;padding:2rem;color:#ef4444">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>';
    }
  }

  // H√†m x√≥a voucher
  window.deleteVoucher = async (code) => {
    if (!code) return;
    if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a voucher "${code}" kh√¥ng? S·∫Ω kh√¥ng th·ªÉ ho√†n t√°c.`)) {
      return;
    }

    try {
      const r = await Admin.req('/admin/vouchers/delete', { 
        method: 'POST', 
        body: { code } 
      });

      if (r && r.ok) {
        Admin.toast('‚úÖ ƒê√£ x√≥a voucher');
        load(); // T·∫£i l·∫°i danh s√°ch
      } else {
        alert('‚ùå X√≥a th·∫•t b·∫°i: ' + (r?.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
      }
    } catch (error) {
      alert('‚ùå X√≥a th·∫•t b·∫°i: ' + error.message);
    }
  };

  // Initial load
  load();
});
</script>

</body>
</html>