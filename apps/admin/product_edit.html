<!doctype html><html lang="vi"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Th√™m / S·ª≠a s·∫£n ph·∫©m</title>
<link rel="stylesheet" href="./styles.css"/>
<script src="./admin_real.js?v=25"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<link rel="preconnect" href="https://res.cloudinary.com" crossorigin>
<link rel="dns-prefetch" href="//res.cloudinary.com">
</head><body>
<div class="container">
  <div class="header">
    <div class="title">Th√™m / S·ª≠a s·∫£n ph·∫©m</div>
    <div class="nav">
      <a href="./products.html" class="badge">S·∫£n ph·∫©m</a>
      <a href="./banners.html" class="badge">Banner</a>
      <a href="./vouchers.html" class="badge">Voucher</a>
      <a href="./orders.html" class="badge">ƒê∆°n h√†ng</a>
      <a href="./stats.html" class="badge">Th·ªëng k√™</a>
      <a href="./shipping.html" class="badge">V·∫≠n chuy·ªÉn</a>
      <a href="./ads.html" class="badge">Qu·∫£ng c√°o</a>
      <span class="badge">API: <span data-api-base></span></span>
    </div>
  </div>

  <div class="grid cols-2">
    <div class="col">
      <div class="toolbar"><button id="btnGemini" class="btn">Ki·ªÉm tra Gemini</button></div>
      <label>Ti√™u ƒë·ªÅ</label>
      <div class="row">
        <div class="col"><input id="title" class="input" placeholder="T√™n s·∫£n ph·∫©m"/></div>
      </div>

      <label>M√¥ t·∫£</label>
      <div class="row">
        <div class="col"><textarea id="desc" class="input" rows="6" placeholder="M√¥ t·∫£ chi ti·∫øt..."></textarea></div>
      </div>

      <div class="grid">
        <div class="row">
          <div class="col">
            <label>SEO Title</label>
            <div class="row"><div class="col"><input id="seoTitle" class="input"/></div></div>
            <label>SEO Desc</label><input id="seoDesc" class="input"/>
            <label>Keywords (ph√¢n t√°ch d·∫•u ph·∫©y)</label>
            <div class="toolbar"><button id="pickCat" class="btn">+ Ch·ªçn danh m·ª•c</button></div>
            <input id="keywords" class="input"/>
            <label>Danh m·ª•c (slug)</label>
            <div class="row" style="gap:8px;align-items:center">
              <div class="col"><input id="category" class="input" placeholder="vd: dien-nuoc, nha-cua-doi-song"/></div>
              <div id="categoryPreview" class="badge" style="display:none"></div>
            </div>
          </div>
          <div class="col">
            <label>ƒê√°nh gi√° m·∫´u</label>
            <div class="row"><div class="col"><textarea id="reviews" class="input" rows="4" placeholder='JSON reviews[]'></textarea></div></div>
          </div>
        </div>
      </div>

      <label>Slug</label><input id="slug" class="input" placeholder="duong-dan-san-pham"/>

      <div class="row">
        <div class="col"><label>Gi√° b√°n</label><input id="price" class="input" type="number" min="0"/></div>
        <div class="col"><label>Gi√° sale</label><input id="price_sale" class="input" type="number" min="0"/></div>
        <div class="col"><label>Gi√° nh·∫≠p</label><input id="cost" class="input" type="number" min="0"/></div>
        <div class="col"><label>C√¢n n·∫∑ng (gram)</label><input id="weight" class="input" type="number" min="0"/></div>
        <div class="col"><label>T·ªìn kho</label><input id="stock" class="input" type="number" min="0"/></div>
      </div>

      <label>Video (URL)</label>
      <div class="row">
        <div class="col"><input id="video" class="input" placeholder="https://..."/></div>
        <div><input id="videoFile" type="file" accept="video/*"/></div>
        <div><button id="upVideo" class="btn">Upload video</button></div>
      </div>

      <label>H√¨nh ·∫£nh</label>
      <div class="row">
        <div class="col"><input id="imgFile" class="input" type="file" accept="image/*" multiple/></div>
        <div><button class="btn" id="upImg">Upload</button></div>
      </div>
      <div id="imgs" class="list-images"></div>

      <div class="toolbar">
        <button id="saveBtn" class="btn primary">L∆∞u s·∫£n ph·∫©m</button>
        <span class="hint">D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c g·ª≠i t·ªõi /admin/products/upsert (fallback /admin/product).</span>
      </div>
    </div>

    <div class="col">
      <hr/>
      
      <div class="toolbar">
        <div class="title">Nh·∫≠p g√≥i ZIP s·∫£n ph·∫©m</div>
        <input type="file" id="zipFile" accept=".zip" />
        <button class="btn" id="applyZip">√Åp d·ª•ng ZIP</button>
      </div>

      <div class="toolbar">
        <div class="title">Template m√¥ t·∫£</div>
        <select id="descTemplate" class="input" style="max-width:260px">
          <option value="">-- Ch·ªçn ng√†nh h√†ng --</option>
          <option value="gia-dung">Gia d·ª•ng</option>
          <option value="thoi-trang">Th·ªùi trang</option>
          <option value="dien-tu">ƒêi·ªán t·ª≠</option>
          <option value="my-pham">M·ªπ ph·∫©m</option>
        </select>
        <button class="btn" id="applyTemplate">√Åp d·ª•ng template</button>
      </div>

      <div class="toolbar">
        <div class="title">Nh·∫≠p file SEO</div>
        <input type="file" id="seoFile" accept=".txt,.md" />
        <button class="btn" id="applySeo">√Åp d·ª•ng file</button>
        <span class="hint">H·ªó tr·ª£ ƒë·ªãnh d·∫°ng: T√äN S·∫¢N PH·∫®M / --- TI√äU ƒê·ªÄ SEO --- / --- M√î T·∫¢ NG·∫ÆN --- / --- TH√îNG TIN CHI TI·∫æT --- / --- T·ª™ KH√ìA --- / --- C√ÇU H·ªéI TH∆Ø·ªúNG G·∫∂P (FAQ) ---</span>
      </div>

      <div class="toolbar">
        <div class="title">Schema JSON-LD</div>
        <textarea id="schemaJson" class="input" rows="10" placeholder='D√°n schema.json ho·∫∑c b·∫•m "T·∫°o schema t·ª± ƒë·ªông"'></textarea>
        <div class="row" style="gap:8px;margin-top:8px">
          <button class="btn" id="schemaAuto">T·∫°o schema t·ª± ƒë·ªông</button>
        </div>
      </div>

      <div class="toolbar"><div class="title">Bi·∫øn th·ªÉ</div><button id="addVar" class="btn">+ Th√™m bi·∫øn th·ªÉ</button></div>
      <div id="variants"></div>
    </div>
  </div>
</div>

<style>
#studioModal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:9999}
#studioWrap{position:absolute;inset:5%;background:#fff;border-radius:12px;overflow:hidden;display:flex;flex-direction:column}
#studioHead{padding:8px 12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
#studioFrame{flex:1;border:0;width:100%}
</style>

<script>
// ===== CLOUDINARY UPLOAD HELPER =====
// Th√™m v√†o ƒë·∫ßu file product_edit.html (trong th·∫ª <script>)

// Cloudinary config t·ª´ env
const CLOUDINARY_CONFIG = {
  cloudName: 'dtemskptf',
  uploadPreset: 'shophuyvan', // unsigned preset
  apiKey: '49963168148423'
};

/**
 * Upload file l√™n Cloudinary
 * @param {File} file - File c·∫ßn upload (image/video)
 * @param {Object} options - T√πy ch·ªçn upload
 * @returns {Promise<string>} - URL c·ªßa file tr√™n Cloudinary
 */
async function uploadToCloudinary(file, options = {}) {
  const {
    folder = 'products',
    transformation = null,
    resourceType = null // auto-detect
  } = options;

  try {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
    formData.append('folder', folder);
    
    // T·ª± ƒë·ªông ph√°t hi·ªán lo·∫°i file
    const type = resourceType || (file.type.startsWith('video/') ? 'video' : 'image');
    
    // Th√™m transformation n·∫øu c√≥ (resize, quality, format)
    if (transformation) {
      formData.append('transformation', transformation);
    }
    
    // Upload URL
    const uploadUrl = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/${type}/upload`;
    
    console.log(`üì§ Uploading ${type} to Cloudinary:`, file.name);
    
    const response = await fetch(uploadUrl, {
      method: 'POST',
      body: formData
    });
    
    if (!response.ok) {
      throw new Error(`Upload failed: ${response.status} ${response.statusText}`);
    }
    
    const data = await response.json();
    
    if (data.error) {
      throw new Error(data.error.message || 'Upload failed');
    }
    
    console.log('‚úÖ Cloudinary upload success:', data.secure_url);
    
    // Return optimized URL v·ªõi transformations
    return data.secure_url;
    
  } catch (error) {
    console.error('‚ùå Cloudinary upload error:', error);
    throw error;
  }
}

/**
 * Upload nhi·ªÅu files song song
 * @param {File[]} files - Array of files
 * @param {Function} onProgress - Progress callback
 * @returns {Promise<string[]>} - Array of URLs
 */
async function uploadMultipleToCloudinary(files, onProgress = null) {
  const total = files.length;
  let completed = 0;
  const results = [];
  
  // Upload song song (max 3 concurrent)
  const CHUNK_SIZE = 3;
  for (let i = 0; i < files.length; i += CHUNK_SIZE) {
    const chunk = files.slice(i, i + CHUNK_SIZE);
    const uploads = chunk.map(async (file) => {
      try {
        const url = await uploadToCloudinary(file);
        completed++;
        if (onProgress) {
          onProgress(completed, total);
        }
        return url;
      } catch (e) {
        console.error('Failed to upload:', file.name, e);
        return null;
      }
    });
    
    const chunkResults = await Promise.all(uploads);
    results.push(...chunkResults);
  }
  
  return results.filter(Boolean);
}

/**
 * Generate optimized Cloudinary URL
 * @param {string} url - Original Cloudinary URL
 * @param {Object} options - Transformation options
 * @returns {string} - Optimized URL
 */
function optimizeCloudinaryUrl(url, options = {}) {
  if (!url || !url.includes('cloudinary.com')) return url;
  
  const {
    width = 800,
    quality = 'auto',
    format = 'auto',
    crop = 'limit'
  } = options;
  
  // Insert transformation v√†o URL
  // From: https://res.cloudinary.com/dtemskptf/image/upload/v123/products/abc.jpg
  // To:   https://res.cloudinary.com/dtemskptf/image/upload/w_800,q_auto,f_auto,c_limit/v123/products/abc.jpg
  
  const transformation = `w_${width},q_${quality},f_${format},c_${crop}`;
  return url.replace('/upload/', `/upload/${transformation}/`);
}

// ===== OVERRIDE H√ÄM doUpload C≈® =====
// Thay th·∫ø h√†m doUpload c≈© trong product_edit.html

async function doUpload(fileOrFiles) {
  const arr = (Array.isArray(fileOrFiles) ? fileOrFiles : [fileOrFiles]).filter(Boolean);
  
  // Dedupe by name
  window.__UPLOAD_NAME_SET__ = window.__UPLOAD_NAME_SET__ || new Set();
  const filtered = [];
  for (const f of arr) {
    const nameKey = (f.name || '').toLowerCase();
    if (nameKey && window.__UPLOAD_NAME_SET__.has(nameKey)) {
      console.log('‚è≠Ô∏è Skipping duplicate:', nameKey);
      continue;
    }
    if (nameKey) window.__UPLOAD_NAME_SET__.add(nameKey);
    filtered.push(f);
  }
  
  if (!filtered.length) {
    console.log('‚ö†Ô∏è No files to upload');
    return [];
  }
  
  // Show progress
  const toast = (msg) => {
    if (window.Admin && Admin.toast) {
      Admin.toast(msg);
    } else {
      console.log(msg);
    }
  };
  
  toast(`ƒêang upload ${filtered.length} file...`);
  
  try {
    // Upload to Cloudinary
    const urls = await uploadMultipleToCloudinary(filtered, (completed, total) => {
      console.log(`üìä Progress: ${completed}/${total}`);
    });
    
    if (urls.length > 0) {
      toast(`‚úÖ ƒê√£ upload ${urls.length}/${filtered.length} file`);
    } else {
      toast('‚ùå Upload th·∫•t b·∫°i');
    }
    
    return urls;
    
  } catch (error) {
    console.error('Upload error:', error);
    toast('‚ùå L·ªói upload: ' + error.message);
    return [];
  }
}

// ===== HELPER: Hi·ªÉn th·ªã ·∫£nh t·ª´ Cloudinary =====
// Kh√¥ng c·∫ßn wrap URL n·ªØa, d√πng th·∫≥ng

function renderImgs() {
  const box = $('#imgs');
  if (!box) return;
  
  box.innerHTML = '';
  
  (state.images || []).forEach((url, idx) => {
    const wrap = document.createElement('div');
    wrap.className = 'image-card';
    
    // Optimize URL cho thumbnail
    const thumbUrl = optimizeCloudinaryUrl(url, { width: 400, quality: 'auto:eco' });
    
    wrap.innerHTML = `
      <img src="${thumbUrl}" 
           alt="image-${idx}" 
           loading="lazy"
           onerror="this.src='${url}'"/>
      <div class="row" style="margin-top:6px">
        <button class="btn" onclick="setCover(${idx})">ƒê·∫∑t cover</button>
        <button class="btn danger" onclick="delImg(${idx})">Xo√°</button>
      </div>`;
    
    box.appendChild(wrap);
  });
}

// ===== VIDEO UPLOAD =====
// S·ª≠a event listener cho video upload

$('#upVideo')?.addEventListener('click', async () => {
  const f = ($('#videoFile').files || [])[0];
  if (!f) return alert('Ch·ªçn video');
  
  try {
    // Video c·∫ßn upload ri√™ng v√¨ l√¢u h∆°n
    if (window.Admin && Admin.toast) {
      Admin.toast('ƒêang upload video, vui l√≤ng ƒë·ª£i...');
    }
    
    const url = await uploadToCloudinary(f, { folder: 'products/videos' });
    
    if (url) {
      $('#video').value = url;
      if (window.Admin && Admin.toast) {
        Admin.toast('‚úÖ Upload video th√†nh c√¥ng');
      }
    }
  } catch (e) {
    alert('Upload video th·∫•t b·∫°i: ' + e.message);
  }
});

// ===== VARIANTS IMAGE =====
// S·ª≠a h√†m addVar ƒë·ªÉ d√πng Cloudinary

function addVar(v = {}) {
  const id = Math.random().toString(36).slice(2, 8);
  const box = document.createElement('div');
  box.className = 'card';
  
  // Optimize variant image
  const variantImg = v.image ? optimizeCloudinaryUrl(v.image, { width: 200 }) : './no-image.svg';
  
  box.innerHTML = `
    <div class="row">
      <div class="col">
        <label>T√™n bi·∫øn th·ªÉ</label><input class="input" data-f="name" value="${v.name || ''}"/>
      </div>
      <div><button class="btn danger" data-del>Xo√°</button></div>
    </div>
    <div class="row">
      <div class="col"><label>Gi√° b√°n</label><input class="input" type="number" data-f="price" value="${v.price || 0}"/></div>
      <div class="col"><label>Gi√° sale</label><input class="input" type="number" data-f="price_sale" value="${v.price_sale || 0}"/></div>
      <div class="col"><label>Gi√° nh·∫≠p</label><input class="input" type="number" data-f="cost" value="${v.cost || 0}"/></div>
      <div class="col"><label>C√¢n n·∫∑ng (gram)</label><input class="input" type="number" step="1" data-f="weight" placeholder="vd: 300 (gram)" value="${v.weight || 0}"/></div>
      <div class="col"><label>T·ªìn kho</label><input class="input" type="number" data-f="stock" value="${v.stock || 0}"/></div>
    </div>
    <div class="row">
      <div class="col"><label>·∫¢nh</label><input type="file" data-f="file" accept="image/*"/></div>
      <div><img data-f="thumb" class="thumb" src="${variantImg}"/></div>
      <div><button class="btn" data-up>Upload</button></div>
    </div>`;
  
  const variants = $('#variants');
  if (variants) variants.appendChild(box);
  
  box.querySelector('[data-del]').onclick = () => box.remove();
  
  box.querySelector('[data-up]').onclick = async () => {
    const f = box.querySelector('[data-f="file"]').files[0];
    if (!f) return alert('Ch·ªçn ·∫£nh');
    
    try {
      const url = await uploadToCloudinary(f);
      if (url) {
        const optimized = optimizeCloudinaryUrl(url, { width: 200 });
        box.querySelector('[data-f="thumb"]').src = optimized;
        // L∆∞u URL g·ªëc v√†o data attribute
        box.querySelector('[data-f="thumb"]').dataset.original = url;
      }
    } catch (e) {
      alert('Upload th·∫•t b·∫°i: ' + e.message);
    }
  };
}

// ===== TEST CLOUDINARY =====
// Th√™m button test trong admin

function testCloudinaryConnection() {
  // Test upload v·ªõi 1x1 pixel image
  const canvas = document.createElement('canvas');
  canvas.width = 1;
  canvas.height = 1;
  
  canvas.toBlob(async (blob) => {
    const file = new File([blob], 'test.png', { type: 'image/png' });
    
    try {
      const url = await uploadToCloudinary(file, { folder: 'test' });
      console.log('‚úÖ Cloudinary connection OK:', url);
      alert('Cloudinary k·∫øt n·ªëi th√†nh c√¥ng!\n' + url);
    } catch (e) {
      console.error('‚ùå Cloudinary connection failed:', e);
      alert('Cloudinary k·∫øt n·ªëi th·∫•t b·∫°i:\n' + e.message);
    }
  });
}

// Expose to window for testing
window.testCloudinaryConnection = testCloudinaryConnection;
window.uploadToCloudinary = uploadToCloudinary;
window.optimizeCloudinaryUrl = optimizeCloudinaryUrl;

console.log('‚úÖ Cloudinary upload module loaded');
console.log('üìù Test: window.testCloudinaryConnection()');
</script>

</body></html>
