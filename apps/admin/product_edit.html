<!doctype html><html lang="vi"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Th√™m / S·ª≠a s·∫£n ph·∫©m</title>
<link rel="stylesheet" href="./styles.css"/>
<script src="./admin_real.js?v=25"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<link rel="preconnect" href="https://res.cloudinary.com" crossorigin>
</head><body>
<div class="container">
  <div class="header">
    <div class="title">Th√™m / S·ª≠a s·∫£n ph·∫©m</div>
    <div class="nav">
      <a href="./products.html" class="badge">S·∫£n ph·∫©m</a>
      <a href="./banners.html" class="badge">Banner</a>
      <a href="./vouchers.html" class="badge">Voucher</a>
      <a href="./orders.html" class="badge">ƒê∆°n h√†ng</a>
      <a href="./stats.html" class="badge">Th·ªëng k√™</a>
      <a href="./shipping.html" class="badge">V·∫≠n chuy·ªÉn</a>
      <a href="./ads.html" class="badge">Qu·∫£ng c√°o</a>
      <span class="badge">API: <span data-api-base></span></span>
    </div>
  </div>

  <div class="grid cols-2">
    <div class="col">
      <div class="toolbar">
        <button id="btnTestCloudinary" class="btn">Test Cloudinary</button>
        <label for="zipFile" class="btn primary" style="cursor:pointer">üì¶ Import t·ª´ ZIP</label>
        <input id="zipFile" type="file" accept=".zip" style="display:none"/>
      </div>
      
      <label>Ti√™u ƒë·ªÅ</label>
      <input id="title" class="input" placeholder="T√™n s·∫£n ph·∫©m"/>

      <label>M√¥ t·∫£ ng·∫Øn (Hi·ªÉn th·ªã trong danh s√°ch s·∫£n ph·∫©m)</label>
      <textarea id="shortDesc" class="input" rows="3" placeholder="M√¥ t·∫£ ng·∫Øn g·ªçn v·ªÅ s·∫£n ph·∫©m..."></textarea>

      <label>M√¥ t·∫£ chi ti·∫øt (N·ªôi dung ch√≠nh - H·ªó tr·ª£ HTML)</label>
      <textarea id="desc" class="input" rows="12" placeholder="N·ªôi dung chi ti·∫øt v·ªõi c·∫•u tr√∫c HTML...&#10;V√≠ d·ª•:&#10;<h1>Ti√™u ƒë·ªÅ ch√≠nh</h1>&#10;<h2>Ti√™u ƒë·ªÅ ph·ª•</h2>&#10;<p>ƒêo·∫°n vƒÉn...</p>"></textarea>
      <div class="hint">üí° S·ª≠ d·ª•ng &lt;h1&gt;, &lt;h2&gt;, &lt;h3&gt; ƒë·ªÉ t·∫°o c·∫•u tr√∫c ti√™u ƒë·ªÅ r√µ r√†ng</div>

      <div class="grid">
        <div class="row">
          <div class="col">
            <label>SEO Title</label>
            <input id="seoTitle" class="input"/>
            <label>SEO Desc</label>
            <input id="seoDesc" class="input"/>
            <label>Keywords (ph√¢n t√°ch d·∫•u ph·∫©y)</label>
            <div class="toolbar"><button id="pickCat" class="btn">+ Ch·ªçn danh m·ª•c</button></div>
            <input id="keywords" class="input"/>
            <label>Danh m·ª•c (slug)</label>
            <div class="row" style="gap:8px;align-items:center">
              <div class="col"><input id="category" class="input" placeholder="vd: dien-nuoc, nha-cua-doi-song"/></div>
              <div id="categoryPreview" class="badge" style="display:none"></div>
            </div>
          </div>
          <div class="col">
            <label>FAQ</label>
            <textarea id="faq" class="input" rows="6" placeholder="H·ªèi: ... | ƒê√°p: ..."></textarea>
            <label>ƒê√°nh gi√° m·∫´u (JSON)</label>
            <textarea id="reviews" class="input" rows="4" placeholder='[{"name":"Nguy·ªÖn A","rating":5,"comment":"T·ªët"}]'></textarea>
          </div>
        </div>
      </div>

      <label>Slug</label><input id="slug" class="input" placeholder="duong-dan-san-pham"/>

      <div class="row">
        <div class="col"><label>Gi√° b√°n</label><input id="price" class="input" type="number" min="0"/></div>
        <div class="col"><label>Gi√° sale</label><input id="price_sale" class="input" type="number" min="0"/></div>
        <div class="col"><label>Gi√° nh·∫≠p</label><input id="cost" class="input" type="number" min="0"/></div>
        <div class="col"><label>C√¢n n·∫∑ng (gram)</label><input id="weight" class="input" type="number" min="0"/></div>
        <div class="col"><label>T·ªìn kho</label><input id="stock" class="input" type="number" min="0"/></div>
      </div>

      <label>Video (URL)</label>
      <div class="row">
        <div class="col"><input id="video" class="input" placeholder="https://..."/></div>
        <div><input id="videoFile" type="file" accept="video/*"/></div>
        <div><button id="upVideo" class="btn">Upload video</button></div>
      </div>

      <label>H√¨nh ·∫£nh</label>
      <div class="row">
        <div class="col"><input id="imgFile" class="input" type="file" accept="image/*" multiple/></div>
        <div><button class="btn" id="upImg">Upload</button></div>
      </div>
      <div id="imgs" class="list-images"></div>

      <div class="toolbar">
        <button id="saveBtn" class="btn primary">L∆∞u s·∫£n ph·∫©m</button>
        <span class="hint">D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c g·ª≠i t·ªõi /admin/products/upsert.</span>
      </div>
    </div>

    <div class="col">
      <div class="toolbar">
        <div class="title">Bi·∫øn th·ªÉ</div>
        <button id="addVar" class="btn">+ Th√™m bi·∫øn th·ªÉ</button>
      </div>
      <div id="variants"></div>
    </div>
  </div>
</div>

<script>
// ===== CLOUDINARY CONFIG =====
const CLOUDINARY_CONFIG = {
  cloudName: 'dtemskptf',
  uploadPreset: 'shophuyvan',
  apiKey: '49963168148423'
};

// ===== CLOUDINARY FUNCTIONS =====
async function uploadToCloudinary(file, options = {}) {
  const { folder = 'products', resourceType = null } = options;
  
  try {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
    formData.append('folder', folder);
    
    const type = resourceType || (file.type.startsWith('video/') ? 'video' : 'image');
    const uploadUrl = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/${type}/upload`;
    
    console.log(`üì§ Uploading ${type}:`, file.name);
    
    const response = await fetch(uploadUrl, { method: 'POST', body: formData });
    
    if (!response.ok) throw new Error(`Upload failed: ${response.status}`);
    
    const data = await response.json();
    if (data.error) throw new Error(data.error.message || 'Upload failed');
    
    console.log('‚úÖ Upload success:', data.secure_url);
    return data.secure_url;
    
  } catch (error) {
    console.error('‚ùå Upload error:', error);
    throw error;
  }
}

async function uploadMultipleToCloudinary(files, onProgress = null) {
  const total = files.length;
  let completed = 0;
  const results = [];
  
  const CHUNK_SIZE = 3;
  for (let i = 0; i < files.length; i += CHUNK_SIZE) {
    const chunk = files.slice(i, i + CHUNK_SIZE);
    const uploads = chunk.map(async (file) => {
      try {
        const url = await uploadToCloudinary(file);
        completed++;
        if (onProgress) onProgress(completed, total);
        return url;
      } catch (e) {
        console.error('Failed:', file.name, e);
        return null;
      }
    });
    
    const chunkResults = await Promise.all(uploads);
    results.push(...chunkResults);
  }
  
  return results.filter(Boolean);
}

function optimizeCloudinaryUrl(url, options = {}) {
  if (!url || !url.includes('cloudinary.com')) return url;
  const { width = 800, quality = 'auto', format = 'auto', crop = 'limit' } = options;
  const transformation = `w_${width},q_${quality},f_${format},c_${crop}`;
  return url.replace('/upload/', `/upload/${transformation}/`);
}

async function doUpload(fileOrFiles) {
  const arr = (Array.isArray(fileOrFiles) ? fileOrFiles : [fileOrFiles]).filter(Boolean);
  
  window.__UPLOAD_NAME_SET__ = window.__UPLOAD_NAME_SET__ || new Set();
  const filtered = [];
  for (const f of arr) {
    const nameKey = (f.name || '').toLowerCase();
    if (nameKey && window.__UPLOAD_NAME_SET__.has(nameKey)) continue;
    if (nameKey) window.__UPLOAD_NAME_SET__.add(nameKey);
    filtered.push(f);
  }
  
  if (!filtered.length) return [];
  
  const toast = (msg) => (window.Admin?.toast || console.log)(msg);
  toast(`ƒêang upload ${filtered.length} file l√™n Cloudinary...`);
  
  try {
    const urls = await uploadMultipleToCloudinary(filtered, (completed, total) => {
      console.log(`üìä ${completed}/${total}`);
    });
    
    if (urls.length > 0) {
      toast(`‚úÖ Upload th√†nh c√¥ng ${urls.length}/${filtered.length} file`);
    }
    return urls;
  } catch (error) {
    toast('‚ùå Upload th·∫•t b·∫°i: ' + error.message);
    return [];
  }
}

// ===== ZIP IMPORT FUNCTIONS =====
function extractTextFromZip(txtContent) {
  const sections = {};
  const lines = txtContent.split('\n');
  let currentKey = null;
  let currentValue = [];
  
  for (const line of lines) {
    const trimmed = line.trim();
    if (trimmed.startsWith('---') && trimmed.endsWith('---')) {
      if (currentKey) {
        sections[currentKey] = currentValue.join('\n').trim();
      }
      currentKey = trimmed.replace(/^---\s*/, '').replace(/\s*---$/, '').trim();
      currentValue = [];
    } else if (currentKey) {
      currentValue.push(line);
    }
  }
  
  if (currentKey) {
    sections[currentKey] = currentValue.join('\n').trim();
  }
  
  return sections;
}

function parseDetailedContent(content) {
  if (!content) return '';
  
  // Chuy·ªÉn markdown th√†nh HTML v·ªõi c·∫•u tr√∫c r√µ r√†ng
  let html = content;
  
  // X·ª≠ l√Ω ti√™u ƒë·ªÅ v·ªõi th·ª© t·ª± ∆∞u ti√™n
  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
  
  // X·ª≠ l√Ω bullet points
  html = html.replace(/^[‚úÖ‚úì] (.+)$/gm, '<li>$1</li>');
  
  // X·ª≠ l√Ω in ƒë·∫≠m
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  
  // Wrap c√°c li v√†o ul
  html = html.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
  
  // X·ª≠ l√Ω ƒëo·∫°n vƒÉn (c√°c d√≤ng kh√¥ng ph·∫£i heading ho·∫∑c list)
  const parts = html.split(/(<h[123]>.*?<\/h[123]>|<ul>.*?<\/ul>)/gs);
  html = parts.map(part => {
    if (part.match(/^<(h[123]|ul)>/)) return part;
    return part.trim() ? `<p>${part.trim()}</p>` : '';
  }).join('\n');
  
  return html;
}

async function importFromZip(file) {
  try {
    const zip = await JSZip.loadAsync(file);
    const toast = (msg) => (window.Admin?.toast || console.log)(msg);
    
    toast('üì¶ ƒêang x·ª≠ l√Ω file ZIP...');
    
    // T√¨m file .txt
    let txtFile = null;
    let txtContent = '';
    
    for (const [filename, zipEntry] of Object.entries(zip.files)) {
      if (filename.endsWith('.txt') && !zipEntry.dir) {
        txtFile = zipEntry;
        txtContent = await txtFile.async('text');
        break;
      }
    }
    
    if (!txtContent) {
      alert('Kh√¥ng t√¨m th·∫•y file .txt trong ZIP');
      return;
    }
    
    // Parse n·ªôi dung
    const sections = extractTextFromZip(txtContent);
    console.log('Sections found:', Object.keys(sections));
    
    // ƒêi·ªÅn th√¥ng tin v√†o form
    if (sections['T√äN S·∫¢N PH·∫®M']) {
      $('#title').value = sections['T√äN S·∫¢N PH·∫®M'];
    }
    
    if (sections['URL SLUG']) {
      $('#slug').value = sections['URL SLUG'];
    }
    
    if (sections['M√î T·∫¢ NG·∫ÆN']) {
      $('#shortDesc').value = sections['M√î T·∫¢ NG·∫ÆN'];
    }
    
    if (sections['TH√îNG TIN CHI TI·∫æT']) {
      const htmlContent = parseDetailedContent(sections['TH√îNG TIN CHI TI·∫æT']);
      $('#desc').value = htmlContent;
    }
    
    if (sections['TI√äU ƒê·ªÄ SEO']) {
      $('#seoTitle').value = sections['TI√äU ƒê·ªÄ SEO'];
    }
    
    if (sections['M√î T·∫¢ NG·∫ÆN']) {
      $('#seoDesc').value = sections['M√î T·∫¢ NG·∫ÆN'];
    }
    
    // Parse keywords
    const kwSources = [
      sections['T·ª™ KH√ìA TI√äU ƒê·ªÄ'],
      sections['T·ª™ KH√ìA M√î T·∫¢'],
      sections['T·ª™ KH√ìA CH√çNH']
    ].filter(Boolean);
    
    if (kwSources.length > 0) {
      const allKeywords = new Set();
      kwSources.forEach(kw => {
        kw.split(',').forEach(k => allKeywords.add(k.trim()));
      });
      $('#keywords').value = Array.from(allKeywords).join(', ');
    }
    
    // Parse FAQ
    if (sections['C√ÇU H·ªéI TH∆Ø·ªúNG G·∫∂P (FAQ)']) {
      const faqLines = sections['C√ÇU H·ªéI TH∆Ø·ªúNG G·∫∂P (FAQ)']
        .split('\n')
        .filter(line => line.includes('H·ªèi:') || line.includes('ƒê√°p:'));
      
      const faqPairs = [];
      for (let i = 0; i < faqLines.length; i += 2) {
        if (faqLines[i] && faqLines[i + 1]) {
          faqPairs.push(`${faqLines[i].trim()}\n${faqLines[i + 1].trim()}`);
        }
      }
      $('#faq').value = faqPairs.join('\n');
    }
    
    // Parse Schema.org ƒë·ªÉ l·∫•y th√¥ng tin s·∫£n ph·∫©m
    if (sections['SCHEMA.ORG JSON-LD']) {
      try {
        const schema = JSON.parse(sections['SCHEMA.ORG JSON-LD']);
        // C√≥ th·ªÉ extract th√™m th√¥ng tin t·ª´ schema n·∫øu c·∫ßn
      } catch (e) {
        console.error('Schema parse error:', e);
      }
    }
    
    // Upload h√¨nh ·∫£nh t·ª´ ZIP
    const imageFiles = [];
    for (const [filename, zipEntry] of Object.entries(zip.files)) {
      if (filename.match(/\.(jpg|jpeg|png|gif|webp)$/i) && !zipEntry.dir) {
        const blob = await zipEntry.async('blob');
        const file = new File([blob], filename, { type: blob.type || 'image/jpeg' });
        imageFiles.push(file);
      }
    }
    
    if (imageFiles.length > 0) {
      toast(`üì§ ƒêang upload ${imageFiles.length} h√¨nh ·∫£nh...`);
      const urls = await doUpload(imageFiles);
      if (urls.length) {
        state.images.push(...urls);
        renderImgs();
        toast(`‚úÖ ƒê√£ upload ${urls.length} h√¨nh ·∫£nh`);
      }
    }
    
    toast('‚úÖ Import th√†nh c√¥ng!');
    
  } catch (error) {
    console.error('Import error:', error);
    alert('L·ªói khi import ZIP: ' + error.message);
  }
}

// ===== MAIN SCRIPT =====
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));
const qs = (k)=> new URL(location.href).searchParams.get(k);

Admin.ensureAuth();
let state = { id: qs('id')||'', images:[], variants:[] };

$('#upImg')?.addEventListener('click', async ()=>{
  const files = Array.from($('#imgFile').files||[]);
  if (!files.length) return alert('Ch·ªçn ·∫£nh');
  const urls = await doUpload(files);
  if (urls.length){ state.images.push(...urls); renderImgs(); }
});

$('#upVideo')?.addEventListener('click', async ()=>{
  const f = ($('#videoFile').files||[])[0];
  if (!f) return alert('Ch·ªçn video');
  
  Admin.toast('ƒêang upload video...');
  try {
    const url = await uploadToCloudinary(f, { folder: 'products/videos' });
    if (url) {
      $('#video').value = url;
      Admin.toast('‚úÖ Upload video th√†nh c√¥ng');
    }
  } catch (e) {
    alert('Upload video th·∫•t b·∫°i: ' + e.message);
  }
});

function renderImgs(){
  const box = $('#imgs'); box.innerHTML='';
  (state.images||[]).forEach((url, idx)=>{
    const wrap = document.createElement('div'); wrap.className='image-card';
    const thumbUrl = optimizeCloudinaryUrl(url, { width: 400, quality: 'auto:eco' });
    wrap.innerHTML = `
      <img src="${thumbUrl}" alt="image-${idx}" loading="lazy" onerror="this.src='${url}'"/>
      <div class="row" style="margin-top:6px">
        <button class="btn" onclick="setCover(${idx})">ƒê·∫∑t cover</button>
        <button class="btn danger" onclick="delImg(${idx})">Xo√°</button>
      </div>`;
    box.appendChild(wrap);
  });
}

window.setCover = (idx)=>{
  if (idx>0){
    const t = state.images[0]; state.images[0] = state.images[idx]; state.images[idx] = t;
    renderImgs();
  }
};
window.delImg = (idx)=>{ state.images.splice(idx,1); renderImgs(); };

$('#addVar')?.addEventListener('click', ()=> addVar({}));

function addVar(v={}){
  const box = document.createElement('div'); box.className='card';
  const variantImg = v.image ? optimizeCloudinaryUrl(v.image, { width: 200 }) : './no-image.svg';
  
  box.innerHTML = `
    <div class="row">
      <div class="col">
        <label>T√™n bi·∫øn th·ªÉ</label><input class="input" data-f="name" value="${v.name||''}"/>
      </div>
      <div class="col">
        <label>SKU</label><input class="input" data-f="sku" value="${v.sku||''}" placeholder="M√£ SKU"/>
      </div>
      <div><button class="btn danger" data-del>Xo√°</button></div>
    </div>
    <div class="row">
      <div class="col"><label>Gi√° b√°n</label><input class="input" type="number" data-f="price" value="${v.price||0}"/></div>
      <div class="col"><label>Gi√° sale</label><input class="input" type="number" data-f="price_sale" value="${v.price_sale||0}"/></div>
      <div class="col"><label>Gi√° nh·∫≠p</label><input class="input" type="number" data-f="cost" value="${v.cost||0}"/></div>
      <div class="col"><label>C√¢n n·∫∑ng (gram)</label><input class="input" type="number" step="1" data-f="weight" value="${v.weight||0}"/></div>
      <div class="col"><label>T·ªìn kho</label><input class="input" type="number" data-f="stock" value="${v.stock||0}"/></div>
    </div>
    <div class="row">
      <div class="col"><label>·∫¢nh</label><input type="file" data-f="file" accept="image/*"/></div>
      <div><img data-f="thumb" class="thumb" src="${variantImg}"/></div>
      <div><button class="btn" data-up>Upload</button></div>
    </div>`;
  
  const variants = $('#variants'); 
  if(variants) variants.appendChild(box);
  
  box.querySelector('[data-del]').onclick = ()=> box.remove();
  box.querySelector('[data-up]').onclick = async ()=>{
    const f = box.querySelector('[data-f="file"]').files[0];
    if (!f) return alert('Ch·ªçn ·∫£nh');
    try {
      const url = await uploadToCloudinary(f);
      if (url) {
        const optimized = optimizeCloudinaryUrl(url, { width: 200 });
        const thumb = box.querySelector('[data-f="thumb"]');
        thumb.src = optimized;
        thumb.dataset.original = url;
      }
    } catch (e) {
      alert('Upload th·∫•t b·∫°i: ' + e.message);
    }
  };
}

function parseFaq(text){
  const lines = (text||'').split(/\n+/).map(s=>s.trim()).filter(Boolean);
  return lines.map(s=>{
    const m = s.split('|');
    const q = (m[0]||'').replace(/^H·ªèi:\s*/i,'').trim();
    const a = (m[1]||'').replace(/^ƒê√°p:\s*/i,'').trim();
    return { q, a };
  });
}

function parseReviews(text){
  try{ const j = JSON.parse(text); if(Array.isArray(j)) return j; }catch(e){}
  return [];
}

function gramsOf(v){
  const raw = String(v||'').trim().replace(',','.');
  if(!raw) return 0;
  let num = Number(raw);
  if(isNaN(num)) return 0;
  if(/[.,]/.test(raw) && num > 0 && num <= 50) return Math.round(num * 1000);
  return Math.round(num);
}

$('#saveBtn')?.addEventListener('click', async ()=>{
  const vs = Array.from($('#variants').children||[]).map(div=>{
    const g = (sel)=> div.querySelector(sel);
    const thumb = g('[data-f="thumb"]');
    return {
      name: g('[data-f="name"]').value.trim(),
      sku: g('[data-f="sku"]').value.trim(),
      price: Number(g('[data-f="price"]').value||0),
      price_sale: Number(g('[data-f="price_sale"]').value||0),
      cost: Number(g('[data-f="cost"]').value||0),
      weight: gramsOf(g('[data-f="weight"]').value),
      stock: Number(g('[data-f="stock"]').value||0),
      image: thumb.dataset.original || thumb.src
    };
  });

  const payload = {
    id: state.id||undefined,
    title: $('#title').value.trim(),
    slug:  $('#slug').value.trim(),
    shortDesc: $('#shortDesc').value.trim(),
    desc:  $('#desc').value.trim(),
    seoTitle: $('#seoTitle').value.trim(),
    seoDesc: $('#seoDesc').value.trim(),
    keywords: ($('#keywords').value||'').split(',').map(s=>s.trim()).filter(Boolean),
    faq: parseFaq($('#faq').value),
    reviews: parseReviews($('#reviews').value),
    price: Number($('#price').value||0),
    price_sale: Number($('#price_sale').value||0),
    cost: Number($('#cost').value||0),
    weight: gramsOf($('#weight').value),
    stock: Number($('#stock').value||0),
    images: state.images||[],
    category: ($('#category')?.value||'').trim(),
    category_slug: ($('#category')?.value||'').trim(),
    video: $('#video').value.trim(),
    variants: vs
  };

  let r = await Admin.req('/admin/products/upsert', { method:'POST', body: payload });
  if (!(r && r.ok)) r = await Admin.req('/admin/product', { method:'POST', body: payload });
  
  if (r && r.ok){
    Admin.toast('‚úÖ ƒê√£ l∆∞u');
    if (!state.id && r.id) state.id = r.id;
    setTimeout(()=>{ location.href = './products.html?v='+Date.now(); }, 600);
  } else {
    alert('L∆∞u th·∫•t b·∫°i'); console.log(r);
  }
});

// ===== ZIP IMPORT =====
$('#zipFile')?.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (file) {
    await importFromZip(file);
    e.target.value = ''; // Reset input
  }
});

(async function init(){
  Admin.renderApiBase();
  
  document.getElementById('btnTestCloudinary').onclick = async ()=>{
    const canvas = document.createElement('canvas');
    canvas.width = 1; canvas.height = 1;
    canvas.toBlob(async (blob) => {
      const file = new File([blob], 'test.png', { type: 'image/png' });
      try {
        const url = await uploadToCloudinary(file, { folder: 'test' });
        alert('‚úÖ Cloudinary k·∫øt n·ªëi th√†nh c√¥ng!\n' + url);
      } catch (e) {
        alert('‚ùå Cloudinary th·∫•t b·∫°i:\n' + e.message);
      }
    });
  };
  
  const id = state.id;
  if (!id) return;
  
  const r = await Admin.tryPaths([
    '/admin/products/get?id='+encodeURIComponent(id),
    '/admin/product?id='+encodeURIComponent(id)
  ]);
  
  if (r && (r.item || r.data)){
    const d = r.item || r.data;
    $('#title').value = d.title||d.name||'';
    $('#shortDesc').value = d.shortDesc||'';
    $('#desc').value  = d.desc||d.description||'';
    $('#slug').value  = d.slug||'';
    $('#price').value = d.price||0;
    $('#price_sale').value = d.price_sale||0;
    $('#cost').value = d.cost||0;
    $('#weight').value = d.weight||0;
    $('#stock').value = d.stock||0;
    $('#seoTitle').value = (d.seo?.title) || d.seoTitle || '';
    $('#seoDesc').value  = (d.seo?.desc)  || d.seoDesc  || '';
    $('#keywords').value = ((d.seo?.keywords)||d.keywords||[]).join(', ');
    $('#video').value = d.video||'';
    state.images = d.images||[]; 
    renderImgs();
    
    if($('#category')){ 
      const slugPref = d.category_slug||d.category||d.categoryId||''; 
      $('#category').value = slugPref; 
      const pv = $('#categoryPreview'); 
      if(pv && slugPref){ 
        pv.textContent = slugPref; 
        pv.style.display='inline-block'; 
      } 
    }
    
    (d.variants||[]).forEach(v=> addVar(v));
  }
})();

async function loadCategor