<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Qu·∫£n l√Ω Flash Sale - Shop Huy V√¢n</title>
<link rel="stylesheet" href="./styles.css"/>
<script src="./admin_real.js"></script>
<script src="./sidebar-layout.js"></script>
<style>
.toolbar {
  background: white;
  padding: 16px;
  border-radius: 8px;
  margin-bottom: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.btn {
  padding: 10px 20px;
  border: 1px solid #ddd;
  border-radius: 6px;
  background: white;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s;
  text-decoration: none;
  color: #333;
  display: inline-block;
}

.btn:hover { background: #f5f5f5; }

.btn.primary {
  background: #1976d2;
  color: white;
  border-color: #1976d2;
}

.btn.primary:hover { background: #1565c0; }

.btn.danger { 
  background: #d32f2f; 
  color: white; 
  border-color: #d32f2f; 
}

.btn.danger:hover { background: #c62828; }

.flash-sale-card {
  background: white;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.flash-sale-info h3 {
  margin: 0 0 8px 0;
  font-size: 18px;
  font-weight: 600;
}

.flash-sale-meta {
  font-size: 13px;
  color: #666;
  margin-bottom: 4px;
}

.badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
  margin-left: 8px;
}

.badge.active {
  background: #4caf50;
  color: white;
}

.badge.inactive {
  background: #f44336;
  color: white;
}

.badge.scheduled {
  background: #ff9800;
  color: white;
}

.badge.ended {
  background: #9e9e9e;
  color: white;
}

.flash-sale-actions {
  display: flex;
  gap: 8px;
}

.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 9999;
  align-items: center;
  justify-content: center;
}

.modal.show { display: flex; }

.modal-content {
  background: white;
  border-radius: 12px;
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  padding: 24px;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 2px solid #e5e7eb;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #666;
}

.form-group {
  margin-bottom: 16px;
}

.form-group label {
  display: block;
  font-weight: 600;
  margin-bottom: 6px;
  font-size: 14px;
}

.form-group input,
.form-group textarea,
.form-group select {
  width: 100%;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
}

.form-group textarea {
  min-height: 80px;
  resize: vertical;
}

.product-search {
  position: relative;
  margin-bottom: 16px;
}

.product-search input {
  width: 100%;
  padding: 10px 40px 10px 10px;
  border: 1px solid #ddd;
  border-radius: 6px;
}

.search-results {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #ddd;
  border-radius: 6px;
  margin-top: 4px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 100;
  display: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.search-results.show { display: block; }

.search-result-item {
  padding: 10px;
  cursor: pointer;
  border-bottom: 1px solid #f0f0f0;
  display: flex;
  align-items: center;
  gap: 12px;
}

.search-result-item:hover {
  background: #f5f5f5;
}

.search-result-img {
  width: 40px;
  height: 40px;
  object-fit: cover;
  border-radius: 4px;
}

.selected-products {
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 12px;
  min-height: 100px;
}

/* [NEW] Style thanh thi·∫øt l·∫≠p h√†ng lo·∫°t */
.bulk-actions {
  background: #e3f2fd;
  padding: 10px;
  border-radius: 6px;
  margin-bottom: 10px;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  border: 1px solid #90caf9;
}
.bulk-actions label { margin: 0; font-size: 13px; color: #1565c0; }
.bulk-actions input, .bulk-actions select {
  padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;
}
.bulk-btn {
  padding: 5px 10px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;
}
.bulk-btn:hover { background: #1565c0; }

.price-preview { font-size: 12px; margin-top: 4px; }
.price-original { text-decoration: line-through; color: #999; }
.price-final { color: #d32f2f; font-weight: bold; margin-left: 5px; font-size: 13px; }

.selected-product {
  background: #f9fafb;
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.selected-product-img {
  width: 50px;
  height: 50px;
  object-fit: cover;
  border-radius: 4px;
}

.selected-product-info {
  flex: 1;
}

.selected-product-controls {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 8px;
  margin-top: 8px;
}

.selected-product-controls select,
.selected-product-controls input {
  padding: 6px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 13px;
}

.remove-product {
  background: #ef4444;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 13px;
}

.loading {
  text-align: center;
  padding: 40px;
  color: #666;
}
</style>
</head>
<body>
<div class="toolbar">
  <h2 style="margin:0;">Qu·∫£n l√Ω Flash Sale</h2>
  <button class="btn primary" id="btn-create">+ T·∫°o Flash Sale m·ªõi</button>
</div>

<div id="list" class="list">
  <div class="loading">ƒêang t·∫£i...</div>
</div>

<!-- Modal t·∫°o/s·ª≠a Flash Sale -->
<div id="modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modal-title">T·∫°o Flash Sale m·ªõi</h3>
      <button class="modal-close" id="modal-close">√ó</button>
    </div>

    <form id="form">
      <div class="form-group">
        <label>T√™n ch∆∞∆°ng tr√¨nh *</label>
        <input type="text" id="fs-name" required placeholder="VD: Flash Sale Cu·ªëi Tu·∫ßn">
      </div>

      <div class="form-group">
        <label>M√¥ t·∫£</label>
        <textarea id="fs-description" placeholder="M√¥ t·∫£ ng·∫Øn v·ªÅ ch∆∞∆°ng tr√¨nh"></textarea>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="form-group">
          <label>Th·ªùi gian b·∫Øt ƒë·∫ßu *</label>
          <input type="datetime-local" id="fs-start" required>
        </div>

        <div class="form-group">
          <label>Th·ªùi gian k·∫øt th√∫c *</label>
          <input type="datetime-local" id="fs-end" required>
        </div>
      </div>

      <div class="form-group">
        <label>Tr·∫°ng th√°i</label>
        <select id="fs-status">
          <option value="active">ƒêang ho·∫°t ƒë·ªông</option>
          <option value="inactive">T·∫°m d·ª´ng</option>
        </select>
      </div>

      <div class="form-group">
        <label>Ch·ªçn s·∫£n ph·∫©m Flash Sale *</label>
        <div class="product-search">
          <input type="text" id="product-search" placeholder="üîç T√¨m s·∫£n ph·∫©m theo t√™n...">
          <div id="search-results" class="search-results"></div>
        </div>
      </div>

      <div class="form-group">
        <label>S·∫£n ph·∫©m ƒë√£ ch·ªçn (<span id="selected-count">0</span>)</label>
        
        <div class="bulk-actions">
          <label>‚ö° Thi·∫øt l·∫≠p nhanh:</label>
          
          <select id="bulk-type" style="width:90px;">
            <option value="percent">Gi·∫£m %</option>
            <option value="fixed">Gi·∫£m ti·ªÅn</option>
          </select>
          <input type="number" id="bulk-value" placeholder="Gi√° tr·ªã" style="width:80px;">
          <button type="button" class="bulk-btn" id="btn-apply-price">√Åp d·ª•ng gi√°</button>
          
          <span style="color:#ccc">|</span>
          
          <input type="number" id="bulk-limit" placeholder="SL Ghim" style="width:70px;">
          <button type="button" class="bulk-btn" id="btn-apply-limit">√Åp d·ª•ng SL</button>
        </div>

        <div id="selected-products" class="selected-products">
          <div style="text-align:center;color:#999;padding:20px;">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px;">
        <button type="button" class="btn" id="btn-cancel">H·ªßy</button>
        <button type="submit" class="btn primary">üíæ L∆∞u Flash Sale</button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  if (window.AdminLayout) {
    AdminLayout.init('Flash Sale');
  }

  const $ = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));

  let allProducts = [];
  let selectedProducts = [];
  let editingId = null;

  // Load danh s√°ch Flash Sale
  async function loadList() {
    try {
      const res = await Admin.req('/admin/flash-sales');
      const items = res.items || [];
      
      if (items.length === 0) {
        $('#list').innerHTML = '<div class="loading">Ch∆∞a c√≥ Flash Sale n√†o</div>';
        return;
      }

      $('#list').innerHTML = items.map(fs => {
        const now = Date.now();
        const start = new Date(fs.start_time).getTime();
        const end = new Date(fs.end_time).getTime();
        
        let statusBadge = '';
        if (fs.status !== 'active') {
          statusBadge = '<span class="badge inactive">ƒê√£ t·∫Øt</span>';
        } else if (now < start) {
          statusBadge = '<span class="badge scheduled">Ch∆∞a b·∫Øt ƒë·∫ßu</span>';
        } else if (now > end) {
          statusBadge = '<span class="badge ended">ƒê√£ k·∫øt th√∫c</span>';
        } else {
          statusBadge = '<span class="badge active">ƒêang ch·∫°y</span>';
        }

        return `
          <div class="flash-sale-card">
            <div class="flash-sale-info">
              <h3>${fs.name} ${statusBadge}</h3>
              <div class="flash-sale-meta">
                üìÖ ${new Date(fs.start_time).toLocaleString('vi-VN')} ‚Üí ${new Date(fs.end_time).toLocaleString('vi-VN')}
              </div>
              <div class="flash-sale-meta">
                üõçÔ∏è ${fs.products.length} s·∫£n ph·∫©m
              </div>
              ${fs.description ? `<div class="flash-sale-meta">üí¨ ${fs.description}</div>` : ''}
            </div>
            <div class="flash-sale-actions">
              <button class="btn" onclick="window.editFlashSale('${fs.id}')">‚úèÔ∏è S·ª≠a</button>
              <button class="btn danger" onclick="window.deleteFlashSale('${fs.id}')">üóëÔ∏è X√≥a</button>
            </div>
          </div>
        `;
      }).join('');
    } catch (e) {
      console.error('Load error:', e);
      $('#list').innerHTML = '<div class="loading">L·ªói t·∫£i d·ªØ li·ªáu</div>';
    }
  }

  // Load danh s√°ch s·∫£n ph·∫©m (ƒë·ªÉ search)
  async function loadProducts() {
    try {
      const res = await Admin.req('/admin/products');
      allProducts = res.items || [];
      console.log('Loaded products:', allProducts.length);
    } catch (e) {
      console.error('Load products error:', e);
    }
  }

  // [FIX] T√¨m ki·∫øm s·∫£n ph·∫©m (G·ªçi Server Search thay v√¨ l·ªçc Local)
  let searchTimeout;
  
  $('#product-search')?.addEventListener('input', (e) => {
    const q = e.target.value.trim();
    const results = $('#search-results');
    
    if (!q) {
      results.classList.remove('show');
      return;
    }

    // Debounce: ƒê·ª£i user ng·ª´ng g√µ 300ms m·ªõi g·ªçi API
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
      
      results.innerHTML = '<div style="padding:10px;text-align:center;color:#666;">‚è≥ ƒêang t√¨m...</div>';
      results.classList.add('show');

      try {
        // G·ªçi API Search chu·∫©n c·ªßa Admin (t√¨m theo t√™n, sku, search_text)
        const res = await Admin.req(`/admin/products?search=${encodeURIComponent(q)}&limit=20`);
        const items = res.items || [];

        if (items.length === 0) {
          results.innerHTML = '<div style="padding:10px;text-align:center;color:#999;">Kh√¥ng t√¨m th·∫•y</div>';
          return;
        }

        // C·∫≠p nh·∫≠t l·∫°i allProducts c·ª•c b·ªô ƒë·ªÉ d√πng khi ch·ªçn
        // (Merge m·∫£ng c≈© v√† m·ªõi ƒë·ªÉ kh√¥ng m·∫•t d·ªØ li·ªáu)
        items.forEach(newItem => {
          if (!allProducts.find(p => p.id === newItem.id)) {
            allProducts.push(newItem);
          }
        });

        results.innerHTML = items.map(p => {
           // [FIX 1] Hi·ªÉn th·ªã gi√° chu·∫©n (n·∫øu c√≥ variants th√¨ hi·ªán kho·∫£ng gi√°)
           let priceDisplay = '0ƒë';
           if (p.variants && p.variants.length > 0) {
             const prices = p.variants.map(v => Number(v.price || 0));
             const min = Math.min(...prices);
             const max = Math.max(...prices);
             priceDisplay = min === max ? `${min.toLocaleString()}ƒë` : `${min.toLocaleString()}ƒë - ${max.toLocaleString()}ƒë`;
           } else {
             priceDisplay = `${Number(p.price || 0).toLocaleString()}ƒë`;
           }

           return `
            <div class="search-result-item" data-id="${p.id}">
              <img src="${(Array.isArray(p.images) ? p.images[0] : (JSON.parse(p.images || '[]')[0])) || '/assets/no-image.svg'}" class="search-result-img" alt="">
              <div style="flex:1;">
                <div style="font-weight:500;font-size:14px;">${p.title || p.name}</div>
                <div style="font-size:12px;color:#666;">SKU: ${p.sku || 'N/A'} | <b style="color:#d32f2f;">${priceDisplay}</b></div>
              </div>
            </div>
          `;
        }).join('');

        // X·ª≠ l√Ω click ch·ªçn s·∫£n ph·∫©m
        results.querySelectorAll('.search-result-item').forEach(item => {
          item.addEventListener('click', () => {
            const id = item.getAttribute('data-id');
            const product = allProducts.find(p => String(p.id) === String(id));
            
            if (product) {
              // [FIX 2] X·ª≠ l√Ω bi·∫øn th·ªÉ: N·∫øu c√≥ variants th√¨ bung ra t·ª´ng d√≤ng
              let img = '/assets/no-image.svg';
              try { 
                const rawImgs = typeof product.images === 'string' ? JSON.parse(product.images) : product.images;
                if (rawImgs && rawImgs.length) img = rawImgs[0];
              } catch {}

              const hasVariants = product.variants && product.variants.length > 0;
              
              if (hasVariants) {
                // Th√™m t·ª´ng bi·∫øn th·ªÉ
                product.variants.forEach(v => {
                  // Check tr√πng variant
                  const exists = selectedProducts.find(sp => sp.product_id === id && String(sp.variant_id) === String(v.id));
                  if (!exists) {
                    selectedProducts.push({
                      product_id: id,
                      variant_id: v.id, // L∆∞u th√™m variant_id
                      product_name: `${product.title || product.name} [${v.name}]`, // T√™n + Ph√¢n lo·∫°i
                      product_image: v.image || img,
                      original_price: v.price,
                      discount_type: 'percent',
                      discount_value: 10,
                      stock_limit: 0
                    });
                  }
                });
              } else {
                // S·∫£n ph·∫©m ƒë∆°n (kh√¥ng bi·∫øn th·ªÉ)
                if (!selectedProducts.find(p => p.product_id === id && !p.variant_id)) {
                  selectedProducts.push({
                    product_id: id,
                    variant_id: null,
                    product_name: product.title || product.name,
                    product_image: img,
                    original_price: product.price,
                    discount_type: 'percent',
                    discount_value: 10,
                    stock_limit: 0
                  });
                }
              }

              renderSelectedProducts();
              $('#product-search').value = '';
              results.classList.remove('show');
            }
          });
        });

      } catch (err) {
        console.error(err);
        results.innerHTML = '<div style="padding:10px;text-align:center;color:red;">L·ªói t√¨m ki·∫øm</div>';
      }
    }, 300); // 300ms delay
  });

  // Render danh s√°ch s·∫£n ph·∫©m ƒë√£ ch·ªçn
  function renderSelectedProducts() {
    const container = $('#selected-products');
    $('#selected-count').textContent = selectedProducts.length;

    if (selectedProducts.length === 0) {
      container.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn</div>';
      return;
    }

    container.innerHTML = selectedProducts.map((p, idx) => {
      // [NEW] T√≠nh to√°n gi√° hi·ªÉn th·ªã (Preview)
      const original = Number(p.original_price || 0);
      let final = original;
      
      if (p.discount_type === 'percent') {
        final = original - (original * (p.discount_value || 0) / 100);
      } else {
        final = original - (p.discount_value || 0);
      }
      if (final < 0) final = 0; // Kh√¥ng ƒë·ªÉ gi√° √¢m

      return `
      <div class="selected-product">
        <img src="${p.product_image || '/assets/no-image.svg'}" class="selected-product-img" alt="">
        <div class="selected-product-info">
          <div style="font-weight:500;">${p.product_name}</div>
          
          <div class="price-preview">
             <span class="price-original">${original.toLocaleString()}ƒë</span>
             <span>‚û°Ô∏è</span>
             <span class="price-final">${final.toLocaleString()}ƒë</span>
          </div>

          <div class="selected-product-controls">
            <select data-idx="${idx}" data-field="discount_type">
              <option value="percent" ${p.discount_type === 'percent' ? 'selected' : ''}>Gi·∫£m %</option>
              <option value="fixed" ${p.discount_type === 'fixed' ? 'selected' : ''}>Gi·∫£m ti·ªÅn (ƒë)</option>
            </select>
            <input type="number" placeholder="Gi√° tr·ªã gi·∫£m" value="${p.discount_value}" data-idx="${idx}" data-field="discount_value" min="0">
            <input type="number" placeholder="SL Ghim (0=‚àû)" value="${p.stock_limit}" data-idx="${idx}" data-field="stock_limit" min="0">
          </div>
        </div>
        <button class="remove-product" data-idx="${idx}">‚úï</button>
      </div>
    `;
    }).join('');

    // Event listeners cho controls
    container.querySelectorAll('select, input').forEach(el => {
      el.addEventListener('change', (e) => {
        const idx = parseInt(e.target.getAttribute('data-idx'));
        const field = e.target.getAttribute('data-field');
        selectedProducts[idx][field] = field === 'discount_type' ? e.target.value : Number(e.target.value);
      });
    });

    container.querySelectorAll('.remove-product').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = parseInt(btn.getAttribute('data-idx'));
        selectedProducts.splice(idx, 1);
        renderSelectedProducts();
      });
    });
  }

  // [NEW] Logic √Åp d·ª•ng h√†ng lo·∫°t
  $('#btn-apply-price')?.addEventListener('click', () => {
    if (selectedProducts.length === 0) return alert('Ch∆∞a ch·ªçn s·∫£n ph·∫©m n√†o');
    const type = $('#bulk-type').value;
    const val = Number($('#bulk-value').value);
    
    if (val < 0) return alert('Gi√° tr·ªã kh√¥ng h·ª£p l·ªá');

    // C·∫≠p nh·∫≠t to√†n b·ªô m·∫£ng
    selectedProducts.forEach(p => {
      p.discount_type = type;
      p.discount_value = val;
    });
    
    renderSelectedProducts(); // V·∫Ω l·∫°i ƒë·ªÉ th·∫•y gi√° m·ªõi
    Admin.toast('‚úÖ ƒê√£ √°p d·ª•ng gi√° cho t·∫•t c·∫£');
  });

  $('#btn-apply-limit')?.addEventListener('click', () => {
    if (selectedProducts.length === 0) return alert('Ch∆∞a ch·ªçn s·∫£n ph·∫©m n√†o');
    const limit = Number($('#bulk-limit').value);
    
    if (limit < 0) return alert('S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá');

    selectedProducts.forEach(p => {
      p.stock_limit = limit;
    });

    renderSelectedProducts();
    Admin.toast('‚úÖ ƒê√£ √°p d·ª•ng s·ªë l∆∞·ª£ng cho t·∫•t c·∫£');
  });

  // M·ªü modal t·∫°o m·ªõi
  $('#btn-create')?.addEventListener('click', () => {
    editingId = null;
    selectedProducts = [];
    $('#modal-title').textContent = 'T·∫°o Flash Sale m·ªõi';
    $('#form').reset();
    renderSelectedProducts();
    $('#modal').classList.add('show');
  });

  // ƒê√≥ng modal
  function closeModal() {
    $('#modal').classList.remove('show');
    $('#form').reset();
    selectedProducts = [];
    editingId = null;
  }

  $('#modal-close')?.addEventListener('click', closeModal);
  $('#btn-cancel')?.addEventListener('click', closeModal);

  // Submit form
  $('#form')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (selectedProducts.length === 0) {
      alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 s·∫£n ph·∫©m!');
      return;
    }

    // ‚úÖ Chuy·ªÉn datetime-local sang ISO-8601 ƒë·∫ßy ƒë·ªß (VN timezone)
    const startLocal = $('#fs-start').value; // "2025-11-08T14:26"
    const endLocal = $('#fs-end').value;
    
    const startISO = startLocal ? new Date(startLocal).toISOString() : '';
    const endISO = endLocal ? new Date(endLocal).toISOString() : '';
    
    const data = {
      id: editingId,
      name: $('#fs-name').value,
      description: $('#fs-description').value,
      start_time: startISO,  // ‚úÖ ISO-8601: "2025-11-08T07:26:00.000Z"
      end_time: endISO,      // ‚úÖ ISO-8601
      status: $('#fs-status').value,
     products: selectedProducts.map(p => ({
        product_id: p.product_id,
        variant_id: p.variant_id || null, // [FIX] G·ª≠i k√®m variant_id
        discount_type: p.discount_type,
        discount_value: p.discount_value,
        stock_limit: p.stock_limit
      }))
    };

    try {
      const res = await Admin.req('/admin/flash-sales', {
        method: 'POST',
        body: data
      });

      if (res.ok) {
        Admin.toast('‚úÖ ƒê√£ l∆∞u Flash Sale');
        closeModal();
        loadList();
      } else {
        alert('L·ªói: ' + (res.error || 'Unknown'));
      }
    } catch (e) {
      alert('L·ªói: ' + e.message);
    }
  });

  // [FIX 3] Edit Flash Sale (G·ªçi API Batch ƒë·ªÉ l·∫•y t√™n/·∫£nh s·∫£n ph·∫©m c≈©)
  window.editFlashSale = async (id) => {
    try {
      // 1. L·∫•y th√¥ng tin Flash Sale
      const res = await Admin.req(`/admin/flash-sales/get?id=${encodeURIComponent(id)}`);
      const fs = res.data;

      editingId = id;
      $('#modal-title').textContent = 'Ch·ªânh s·ª≠a Flash Sale';
      $('#fs-name').value = fs.name;
      $('#fs-description').value = fs.description || '';
      $('#fs-start').value = fs.start_time.slice(0, 16);
      $('#fs-end').value = fs.end_time.slice(0, 16);
      $('#fs-status').value = fs.status;

      // 2. L·∫•y danh s√°ch ID s·∫£n ph·∫©m c·∫ßn load th√¥ng tin
      const productIds = [...new Set(fs.products.map(p => p.product_id))];

      if (productIds.length > 0) {
        // G·ªçi API l·∫•y th√¥ng tin chi ti·∫øt (bao g·ªìm c·∫£ variants)
        const productsRes = await Admin.req('/admin/products/batch', {
          method: 'POST',
          body: { product_ids: productIds }
        });
        
        // Merge v√†o allProducts ƒë·ªÉ d√πng chung
        const fetchedProducts = productsRes.items || [];
        fetchedProducts.forEach(fp => {
           const exist = allProducts.findIndex(ap => String(ap.id) === String(fp.id));
           if (exist >= 0) allProducts[exist] = fp;
           else allProducts.push(fp);
        });

        // 3. Map d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã
        selectedProducts = fs.products.map(p => {
          const product = fetchedProducts.find(pr => String(pr.id) === String(p.product_id));
          
          let name = 'S·∫£n ph·∫©m ƒë√£ x√≥a';
          let img = '/assets/no-image.svg';
          let originalPrice = 0;

          if (product) {
            name = product.title || product.name;
            try { 
               const rawImgs = typeof product.images === 'string' ? JSON.parse(product.images) : product.images;
               if (rawImgs && rawImgs.length) img = rawImgs[0];
            } catch {}

            // N·∫øu c√≥ variant_id, t√¨m t√™n variant
            if (p.variant_id) {
               const variant = product.variants?.find(v => String(v.id) === String(p.variant_id));
               if (variant) {
                 name += ` [${variant.name}]`;
                 if (variant.image) img = variant.image;
                 originalPrice = variant.price;
               }
            } else {
               originalPrice = product.price;
            }
          }

          return {
            product_id: p.product_id,
            variant_id: p.variant_id,
            product_name: name,
            product_image: img,
            original_price: originalPrice,
            discount_type: p.discount_type,
            discount_value: p.discount_value,
            stock_limit: p.stock_limit
          };
        });
      } else {
        selectedProducts = [];
      }

      renderSelectedProducts();
      $('#modal').classList.add('show');
    } catch (e) {
      alert('L·ªói t·∫£i d·ªØ li·ªáu: ' + e.message);
      console.error(e);
    }
  };

  // Delete Flash Sale
  window.deleteFlashSale = async (id) => {
    if (!confirm('X√°c nh·∫≠n x√≥a Flash Sale n√†y?')) return;

    try {
      const res = await Admin.req('/admin/flash-sales/delete', {
        method: 'POST',
        body: { id }
      });

      if (res.ok) {
        Admin.toast('‚úÖ ƒê√£ x√≥a Flash Sale');
        loadList();
      } else {
        alert('L·ªói x√≥a');
      }
    } catch (e) {
      alert('L·ªói: ' + e.message);
    }
  };

  // Click outside to close search results
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.product-search')) {
      $('#search-results')?.classList.remove('show');
    }
  });

  // Initial load
  loadProducts();
  loadList();
});
</script>

</body>
</html>