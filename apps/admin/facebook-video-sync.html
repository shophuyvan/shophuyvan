<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook Video Auto Sync | Shop Huy Van</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">

    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <ul class="navbar-nav">
            <li class="nav-item"><a class="nav-link" data-widget="pushmenu" href="#"><i class="fas fa-bars"></i></a></li>
        </ul>
    </nav>

    <aside class="main-sidebar sidebar-dark-primary elevation-4" id="sidebar-container">
        </aside>

    <div class="content-wrapper">
        <div class="content-header">
            <div class="container-fluid">
                <h1 class="m-0">ü§ñ TikTok to Facebook Sync</h1>
            </div>
        </div>

        <section class="content">
            <div class="container-fluid">
                
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">üîó B∆∞·ªõc 1: Nh·∫≠p ngu·ªìn Video (Test API)</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>TikTok Video URL</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="tiktokUrl" 
                                       placeholder="https://www.tiktok.com/@user/video/..." 
                                       value="https://www.tiktok.com/@shophuyvan/video/735123456789">
                                <div class="input-group-append">
                                    <button class="btn btn-warning font-weight-bold" onclick="analyzeVideo()" id="btnAnalyze">
                                        <i class="fas fa-bolt"></i> G·ªåI API TEST
                                    </button>
                                </div>
                            </div>
                            <small class="text-muted">H·ªá th·ªëng s·∫Ω t·∫£i video v·ªÅ R2 (x√≥a logo) v√† d√πng Gemini AI vi·∫øt content.</small>
                        </div>
                        
                        <div id="loadingArea" class="mt-3" style="display: none;">
                            <div class="d-flex align-items-center text-primary">
                                <div class="spinner-border spinner-border-sm mr-2"></div>
                                <span>ƒêang x·ª≠ l√Ω... (Vui l√≤ng ƒë·ª£i 5-10s)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card card-success" id="resultArea" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">‚úÖ K·∫øt qu·∫£ t·ª´ Server</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <h5>Video Clean (R2)</h5>
                                <video id="videoPreview" controls style="width: 100%; border-radius: 8px; background: #000;"></video>
                                <div class="mt-2">
                                    <span class="badge badge-info" id="fileSize">Size: 0 MB</span>
                                    <a href="#" id="downloadLink" target="_blank" class="btn btn-sm btn-outline-secondary float-right">T·∫£i v·ªÅ</a>
                                </div>
                            </div>

                            <div class="col-md-8">
                                <h5>Gemini AI Generated</h5>
                                <ul class="nav nav-tabs" id="aiTabs" role="tablist">
                                    <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#verA">Version A</a></li>
                                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#verB">Version B</a></li>
                                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#verC">Version C</a></li>
                                </ul>
                                
                                <div class="tab-content mt-3">
                                    <div id="verA" class="tab-pane active">
                                        <textarea class="form-control" rows="6" id="contentA"></textarea>
                                    </div>
                                    <div id="verB" class="tab-pane">
                                        <textarea class="form-control" rows="6" id="contentB"></textarea>
                                    </div>
                                    <div id="verC" class="tab-pane">
                                        <textarea class="form-control" rows="6" id="contentC"></textarea>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-primary btn-block" onclick="alert('Ch·ª©c nƒÉng ƒëƒÉng b√†i s·∫Ω k√≠ch ho·∫°t ·ªü Phase sau!')">
                                        <i class="fab fa-facebook-f"></i> ƒêƒÉng l√™n Fanpage
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>
    </div>
</div>

<script src="sidebar-layout.js"></script>
<script>
// H√†m g·ªçi API Test (ƒê√£ s·ª≠a ƒë·ªÉ nh·∫≠n di·ªán x-token)
async function analyzeVideo() {
    const url = document.getElementById('tiktokUrl').value;
    if (!url) return alert('Vui l√≤ng nh·∫≠p link TikTok!');

    // UI Update
    const btn = document.getElementById('btnAnalyze');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-sync fa-spin"></i> ƒêang x·ª≠ l√Ω...';
    document.getElementById('loadingArea').style.display = 'block';
    document.getElementById('resultArea').style.display = 'none';

    try {
        // üîç ∆ØU TI√äN L·∫§Y x-token
        let token = localStorage.getItem('x-token');

        // Fallback: N·∫øu kh√¥ng c√≥ x-token m·ªõi t√¨m c√°c t√™n kh√°c
        if (!token && window.Admin && typeof window.Admin.token === 'function') {
            token = window.Admin.token();
        }
        if (!token) token = localStorage.getItem('admin_token');
        
        if (!token) {
            throw new Error('Kh√¥ng t√¨m th·∫•y Token (x-token)! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
        }

        console.log('Using Token:', token); // Debug

        const res = await fetch('https://api.shophuyvan.vn/api/social-sync/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // Server c·ªßa b·∫°n h·ªó tr·ª£ c·∫£ 2 c√°ch, g·ª≠i c√°ch n√†y cho chu·∫©n
                'Authorization': `Bearer ${token}`,
                'x-token': token // G·ª≠i k√®m c·∫£ header n√†y cho ch·∫Øc ch·∫Øn
            },
            body: JSON.stringify({ tiktokUrl: url })
        });

        if (res.status === 401) {
            throw new Error('Token h·∫øt h·∫°n ho·∫∑c kh√¥ng h·ª£p l·ªá (401).');
        }

        const data = await res.json();

        if (!data.ok && !data.success) {
            throw new Error(data.error || 'L·ªói x·ª≠ l√Ω t·ª´ server');
        }

        // Render k·∫øt qu·∫£ ra UI
        renderResult(data);

    } catch (e) {
        alert('L·ªói: ' + e.message);
        console.error(e);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-bolt"></i> G·ªåI API TEST';
        document.getElementById('loadingArea').style.display = 'none';
    }
}
</script>
</body>
</html>