<!doctype html><html lang="vi"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Qu·∫£n l√Ω S·∫£n ph·∫©m</title>
<link rel="stylesheet" href="./styles.css"/>
<script src="./admin_real.js?v=25"></script>
<!-- build:21 -->
</head><body>
<div class="container">
  <div class="header">
    <div class="title">S·∫£n ph·∫©m</div>
    <div class="nav">
      <a href="./products.html" class="badge">S·∫£n ph·∫©m</a>
      <a href="./banners.html" class="badge">Banner</a>
      <a href="./shipping.html" class="badge">V·∫≠n chuy·ªÉn</a><a href="./ads.html" class="badge">Qu·∫£ng c√°o</a>
      <span class="badge">API: <span data-api-base></span></span>
    </div>
  </div>

  <div class="toolbar">
    <div class="flex">
      <input id="q" class="input" placeholder="T√¨m theo ti√™u ƒë·ªÅ / slug / SKU"/>
      <button class="btn" id="reload">T·∫£i l·∫°i</button>
    </div>
    <div><a href="./product_edit.html" class="btn primary">+ Th√™m s·∫£n ph·∫©m</a></div>
  </div>

  <table class="table" id="tbl">
    <thead><tr><th>·∫¢nh</th><th>Ti√™u ƒë·ªÅ</th><th>Gi√°</th><th>Slug</th><th>H√†nh ƒë·ªông</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<script>
const $  = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));

// ===== üî• CDN URL Helper =====
function cdnUrl(url, transforms = 'w_400,dpr_auto,q_auto:eco,f_auto') {
  if (!url) return './no-image.svg';
  if (url.includes('res.cloudinary.com')) return url; // Already CDN
  
  // Hi·ªÉn th·ªã tr·ª±c ti·∫øp t·ª´ Workers.dev (kh√¥ng qua Cloudinary ƒë·ªÉ tr√°nh CORS)
  return url;
}

function row(p){
  const frag = document.createDocumentFragment();
  const tr = document.createElement('tr');
  const imgUrl = cdnUrl((p.images&&p.images[0]) || '');
  const price = p.price_sale || p.price || 0;
  tr.innerHTML = `
    <td><img class="thumb" src="${imgUrl}" loading="lazy" crossorigin="anonymous" onerror="this.src='./no-image.svg'"/></td>
    <td>${p.title||p.name||''}</td>
    <td>${price}</td>
    <td>${p.slug||''}</td>
    <td>
      <a class="btn" href="./product_edit.html?id=${encodeURIComponent(p.id||p._id||p.key||'')}">S·ª≠a</a>
      <button class="btn danger" data-del="${p.id||p._id||p.key||''}">Xo√°</button>
    </td>`;
  frag.appendChild(tr);

  const variants = Array.isArray(p.variants)? p.variants :
                   Array.isArray(p.options)? p.options :
                   Array.isArray(p.skus)? p.skus :
                   Array.isArray(p.children)? p.children :
                   Array.isArray(p.items)? p.items : [];
  if(variants && variants.length){
    const tr2 = document.createElement('tr');
    const cols = 5;
    const rows = variants.map(v=>{
      const name = v.name||v.title||v.variant||v.option||v.sku||v.id||'';
      const price = v.price_sale||v.price||v.sell_price||v.min_price||v.max_price||0;
      const stock = v.stock??v.inventory??v.qty??v.quantity??v.available??0;
      const stockStr = (typeof stock==='boolean') ? (stock?'C√≤n':'H·∫øt') : stock;
      return `<tr><td class="px-4 py-2">${name}</td><td class="px-4 py-2" style="text-align:right">${Number(price||0).toLocaleString('vi-VN')}</td><td class="px-4 py-2" style="text-align:right">${stockStr}</td></tr>`;
    }).join('');
    tr2.innerHTML = `<td colspan="${cols}" style="background:#f9fafb;padding:0">
      <table class="table variants" style="margin:0;border:0">
        <thead><tr><th>Ph√¢n lo·∫°i</th><th>Gi√°</th><th>T·ªìn kho</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </td>`;
    frag.appendChild(tr2);
  }
  return frag;
}

async function load(){
  const r = await Admin.tryPaths(['/admin/products','/admin/product/list','/admin/products/list']);
  const items = r.items || r.data || r.products || [];
  const q = ($('#q').value||'').toLowerCase();
  const tbody = $('#tbl tbody'); tbody.innerHTML='';
  items
    .filter(p => {
      const t = (p.title||p.name||'').toLowerCase();
      const slug = String(p.slug||'').toLowerCase();
      const sku = String(p.sku||'').toLowerCase();
      return !q || t.includes(q) || slug.includes(q) || sku.includes(q);
    })
    .forEach(p=> tbody.appendChild(row(p)));

  $$('[data-del]').forEach(btn=>{
    btn.onclick = ()=> del(btn.getAttribute('data-del'));
  });
}

async function del(id){
  if (!id) return;
  if (!confirm('X√°c nh·∫≠n xo√° s·∫£n ph·∫©m?')) return;
  let r = await Admin.req('/admin/products/delete', { method:'POST', body:{ id } });
  if(!(r && r.ok)) r = await Admin.req('/admin/product/delete?id='+encodeURIComponent(id), { method:'POST' });
  if(!(r && r.ok)) r = await Admin.req('/admin/product?id='+encodeURIComponent(id), { method:'DELETE' });
  if(r && r.ok){ alert('ƒê√£ xo√°'); load(); } else { alert('Xo√° th·∫•t b·∫°i'); }
}

$('#reload').onclick = load;
$('#q').addEventListener('input', load);
load();
</script>
</body></html>