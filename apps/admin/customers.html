<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Qu·∫£n l√Ω Kh√°ch h√†ng</title>
  <link rel="stylesheet" href="./styles.css"/>
  <script src="./admin_real.js?v=27"></script>
  <script src="./sidebar-layout.js"></script>
  <style>
    .customer-type-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .type-retail { background: #dbeafe; color: #1e40af; }
    .type-wholesale { background: #fef3c7; color: #92400e; }
    
    .status-active { color: #059669; font-weight: 600; }
    .status-inactive { color: #dc2626; font-weight: 600; }
    
    .points-badge {
      background: #dcfce7;
      color: #166534;
      padding: 2px 8px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      z-index: 10001;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 18px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #6b7280;
      line-height: 1;
    }

    .modal-close:hover {
      color: #111827;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      font-size: 14px;
    }

    .form-hint {
      font-size: 11px;
      color: #6b7280;
      font-weight: 400;
    }

    .btn-sm {
      padding: 4px 12px;
      font-size: 13px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #111827;
    }

    .stat-label {
      font-size: 13px;
      color: #6b7280;
      margin-top: 4px;
    }

    .customer-id {
      font-size: 11px;
      color: #6b7280;
    }

    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .filters .input {
      flex: 1;
      min-width: 200px;
    }

    @media (max-width: 768px) {
      .filters {
        flex-direction: column;
      }
      
      .filters .input {
        width: 100%;
      }

      .modal-content {
        width: 95%;
      }
    }
  </style>
</head>
<body>

<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px;">
    <h2 style="margin: 0;">üë• Qu·∫£n l√Ω Kh√°ch h√†ng</h2>
    <button id="btn-create-customer" class="btn primary">‚ûï Th√™m kh√°ch h√†ng</button>
  </div>

  <!-- Statistics -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value" id="stat-total">0</div>
      <div class="stat-label">T·ªïng kh√°ch h√†ng</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="stat-retail">0</div>
      <div class="stat-label">Kh√°ch l·∫ª</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="stat-wholesale">0</div>
      <div class="stat-label">Kh√°ch s·ªâ</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="stat-points">0</div>
      <div class="stat-label">T·ªïng ƒëi·ªÉm t√≠ch l≈©y</div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters">
    <input 
      id="search-input" 
      class="input" 
      placeholder="üîç T√¨m theo t√™n, email, SƒêT..." 
    />
    <select id="filter-type" class="input" style="width: 200px;">
      <option value="">T·∫•t c·∫£ lo·∫°i</option>
      <option value="retail">Kh√°ch l·∫ª</option>
      <option value="wholesale">Kh√°ch s·ªâ</option>
    </select>
    <select id="filter-status" class="input" style="width: 150px;">
      <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
      <option value="active">Active</option>
      <option value="inactive">Inactive</option>
    </select>
  </div>
  
  <div style="overflow-x: auto;">
    <table class="table">
      <thead>
        <tr>
          <th>H·ªç t√™n</th>
          <th>Email</th>
          <th>S·ªë ƒëi·ªán tho·∫°i</th>
          <th>Lo·∫°i</th>
          <th>ƒêi·ªÉm</th>
          <th>Tr·∫°ng th√°i</th>
          <th>ƒêƒÉng nh·∫≠p l·∫ßn cu·ªëi</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody id="customers-list">
        <tr><td colspan="8" style="text-align:center;">ƒêang t·∫£i...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal: Create/Edit Customer -->
<div id="modal-customer" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modal-customer-title">Th√™m kh√°ch h√†ng m·ªõi</h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="customer-id" />
      
      <div class="form-group">
        <label>H·ªç t√™n <span style="color: #dc2626;">*</span></label>
        <input id="customer-name" class="input" placeholder="Nguy·ªÖn VƒÉn A" required />
      </div>
      
      <div class="form-group">
        <label>Email <span style="color: #dc2626;">*</span></label>
        <input id="customer-email" class="input" type="email" placeholder="customer@example.com" required />
      </div>
      
      <div class="form-group">
        <label>M·∫≠t kh·∫©u <span style="color: #dc2626;">*</span> <span class="form-hint">(ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)</span></label>
        <input id="customer-password" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
      
      <div class="form-group">
        <label>S·ªë ƒëi·ªán tho·∫°i</label>
        <input id="customer-phone" class="input" type="tel" placeholder="0901234567" />
      </div>
      
      <div class="form-group">
        <label>Lo·∫°i kh√°ch h√†ng <span style="color: #dc2626;">*</span></label>
        <select id="customer-type" class="input" required>
          <option value="retail">Kh√°ch l·∫ª (Gi√° th∆∞·ªùng)</option>
          <option value="wholesale">Kh√°ch s·ªâ (Gi√° s·ªâ)</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>ƒêi·ªÉm t√≠ch l≈©y</label>
        <input id="customer-points" class="input" type="number" value="0" min="0" />
      </div>
      
      <div class="form-group">
        <label>Tr·∫°ng th√°i</label>
        <select id="customer-status" class="input">
          <option value="active">Active - Ho·∫°t ƒë·ªông</option>
          <option value="inactive">Inactive - T·∫°m kh√≥a</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">H·ªßy</button>
      <button id="btn-save-customer" class="btn primary">üíæ L∆∞u</button>
    </div>
  </div>
</div>

<script>
// ‚úÖ CRITICAL: Initialize Sidebar Layout FIRST
if (window.AdminLayout) {
  AdminLayout.init('üë• Qu·∫£n l√Ω Kh√°ch h√†ng');
}

document.addEventListener('DOMContentLoaded', function() {
  console.log('[Customers] Initializing...');

  const $ = (id) => document.getElementById(id);

  let allCustomers = [];
  let filteredCustomers = [];

  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Validate email
  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  // Modal functions
  window.openModal = function() {
    const modal = $('modal-customer');
    if (modal) {
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden'; // Prevent scroll
      console.log('[Modal] Opened');
    }
  };

  window.closeModal = function() {
    const modal = $('modal-customer');
    if (modal) {
      modal.style.display = 'none';
      document.body.style.overflow = ''; // Restore scroll
    }
    
    // Reset form
    $('customer-id').value = '';
    $('customer-name').value = '';
    $('customer-email').value = '';
    $('customer-password').value = '';
    $('customer-phone').value = '';
    $('customer-type').value = 'retail';
    $('customer-points').value = '0';
    $('customer-status').value = 'active';
    $('modal-customer-title').textContent = 'Th√™m kh√°ch h√†ng m·ªõi';
    
    console.log('[Modal] Closed');
  };

  // Load customers
  async function loadCustomers() {
    console.log('[Customers] Loading...');
    try {
      const r = await Admin.req('/admin/customers/list');
      
      const tbody = $('customers-list');
      if (!tbody) return;
      
      allCustomers = r.customers || [];
      
      if (allCustomers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Ch∆∞a c√≥ kh√°ch h√†ng n√†o</td></tr>';
        updateStats();
        return;
      }
      
      filteredCustomers = [...allCustomers];
      renderCustomers();
      updateStats();
      
      console.log('[Customers] Loaded:', allCustomers.length);
    } catch (e) {
      console.error('[Customers] Load error:', e);
      const tbody = $('customers-list');
      if (tbody) tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color: #dc2626;">‚ùå L·ªói t·∫£i danh s√°ch kh√°ch h√†ng</td></tr>';
    }
  }

  // Render customers (XSS-safe)
  function renderCustomers() {
    const tbody = $('customers-list');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (filteredCustomers.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng</td></tr>';
      return;
    }
    
    filteredCustomers.forEach(customer => {
      const typeClass = customer.customer_type === 'wholesale' ? 'type-wholesale' : 'type-retail';
      const typeName = customer.customer_type === 'wholesale' ? 'üè™ Kh√°ch s·ªâ' : 'üõí Kh√°ch l·∫ª';
      const statusClass = customer.status === 'active' ? 'status-active' : 'status-inactive';
      const lastLogin = customer.last_login 
        ? new Date(customer.last_login).toLocaleString('vi-VN')
        : 'Ch∆∞a ƒëƒÉng nh·∫≠p';
      
      const tr = document.createElement('tr');
      
      // Create cells safely
      const cells = [
        `<div style="font-weight: 600;">${escapeHtml(customer.full_name)}</div><div class="customer-id">ID: ${escapeHtml(customer.id)}</div>`,
        escapeHtml(customer.email),
        escapeHtml(customer.phone || '-'),
        `<span class="customer-type-badge ${typeClass}">${typeName}</span>`,
        `<span class="points-badge">${customer.points || 0} ƒëi·ªÉm</span>`,
        `<span class="${statusClass}">${escapeHtml(customer.status || 'active')}</span>`,
        `<span style="font-size: 12px;">${escapeHtml(lastLogin)}</span>`,
        '' // Actions column
      ];
      
      cells.forEach((content, i) => {
        const td = document.createElement('td');
        if (i === cells.length - 1) {
          // Actions column - use buttons with event listeners
          const editBtn = document.createElement('button');
          editBtn.className = 'btn btn-sm';
          editBtn.textContent = '‚úèÔ∏è S·ª≠a';
          editBtn.onclick = () => window.editCustomer(customer.id);
          
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'btn btn-sm danger';
          deleteBtn.textContent = 'üóëÔ∏è X√≥a';
          deleteBtn.onclick = () => window.deleteCustomer(customer.id, customer.full_name);
          
          td.appendChild(editBtn);
          td.appendChild(document.createTextNode(' '));
          td.appendChild(deleteBtn);
        } else {
          td.innerHTML = content;
        }
        tr.appendChild(td);
      });
      
      tbody.appendChild(tr);
    });
  }

  // Update statistics
  function updateStats() {
    const total = allCustomers.length;
    const retail = allCustomers.filter(c => c.customer_type === 'retail').length;
    const wholesale = allCustomers.filter(c => c.customer_type === 'wholesale').length;
    const points = allCustomers.reduce((sum, c) => sum + (c.points || 0), 0);
    
    $('stat-total').textContent = total;
    $('stat-retail').textContent = retail;
    $('stat-wholesale').textContent = wholesale;
    $('stat-points').textContent = points.toLocaleString('vi-VN');
  }

  // Filter customers
  function filterCustomers() {
    const searchTerm = $('search-input').value.toLowerCase();
    const typeFilter = $('filter-type').value;
    const statusFilter = $('filter-status').value;
    
    filteredCustomers = allCustomers.filter(customer => {
      const nameSafe  = (customer.full_name || '').toLowerCase();
      const emailSafe = (customer.email || '').toLowerCase();
      const phoneSafe = (customer.phone || '');
      const matchSearch = !searchTerm ||
        nameSafe.includes(searchTerm) ||
        emailSafe.includes(searchTerm) ||
        phoneSafe.includes(searchTerm);
      
      const matchType = !typeFilter || customer.customer_type === typeFilter;
      const matchStatus = !statusFilter || customer.status === statusFilter;
      
      return matchSearch && matchType && matchStatus;
    });
    
    renderCustomers();
  }

  // Event listeners
  $('search-input').addEventListener('input', filterCustomers);
  $('filter-type').addEventListener('change', filterCustomers);
  $('filter-status').addEventListener('change', filterCustomers);

  $('btn-create-customer').onclick = () => {
    openModal();
  };

  // Save customer
  $('btn-save-customer').onclick = async () => {
    const id = $('customer-id').value;
    const name = $('customer-name').value.trim();
    const email = $('customer-email').value.trim();
    const password = $('customer-password').value;
    const phone = $('customer-phone').value.trim();
    const customer_type = $('customer-type').value;
    const points = parseInt($('customer-points').value) || 0;
    const status = $('customer-status').value;
    
    // Validation
    if (!name || !email || !customer_type) {
      alert('‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc');
      return;
    }
    
    if (!isValidEmail(email)) {
      alert('‚ö†Ô∏è Email kh√¥ng h·ª£p l·ªá');
      return;
    }
    
    if (!id && !password) {
      alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u');
      return;
    }
    
    if (password && password.length < 6) {
      alert('‚ö†Ô∏è M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±');
      return;
    }
    
    try {
      const body = { full_name: name, email, phone, customer_type, points, status };
      if (password) body.password = password;
      
      const method = id ? 'PUT' : 'POST';
      const endpoint = id ? `/admin/customers/${id}` : '/admin/customers/create';
      
      const r = await Admin.req(endpoint, {
        method,
        body
      });
      
      if (r && r.ok) {
        Admin.toast(id ? '‚úÖ ƒê√£ c·∫≠p nh·∫≠t kh√°ch h√†ng' : '‚úÖ ƒê√£ t·∫°o kh√°ch h√†ng m·ªõi');
        closeModal();
        loadCustomers();
      } else {
        throw new Error(r.error || 'L·ªói l∆∞u kh√°ch h√†ng');
      }
    } catch (e) {
      console.error('[Customers] Save error:', e);
      alert('‚ùå ' + (e.message || 'L·ªói l∆∞u kh√°ch h√†ng'));
    }
  };

  // Edit customer
  window.editCustomer = async function(id) {
    try {
      const r = await Admin.req(`/admin/customers/${id}`);
      
      if (!r || !r.ok) throw new Error('Failed to load customer');
      
      const customer = r.customer;
      
      $('customer-id').value = customer.id;
      $('customer-name').value = customer.full_name;
      $('customer-email').value = customer.email;
      $('customer-phone').value = customer.phone || '';
      $('customer-type').value = customer.customer_type;
      $('customer-points').value = customer.points || 0;
      $('customer-status').value = customer.status || 'active';
      $('customer-password').value = '';
      $('customer-password').placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)';
      
      $('modal-customer-title').textContent = 'S·ª≠a th√¥ng tin kh√°ch h√†ng';
      
      openModal();
      
    } catch (e) {
      console.error('[Customers] Edit error:', e);
      alert('‚ùå L·ªói t·∫£i th√¥ng tin kh√°ch h√†ng');
    }
  };

  // Delete customer
  window.deleteCustomer = async function(id, name) {
    if (!confirm(`‚ö†Ô∏è X√≥a kh√°ch h√†ng "${name}"?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) return;
    
    try {
      const r = await Admin.req(`/admin/customers/${id}`, { method: 'DELETE' });
      
      if (r && r.ok) {
        Admin.toast('‚úÖ ƒê√£ x√≥a kh√°ch h√†ng');
        loadCustomers();
      } else {
        throw new Error(r.error || 'L·ªói x√≥a kh√°ch h√†ng');
      }
    } catch (e) {
      console.error('[Customers] Delete error:', e);
      alert('‚ùå ' + (e.message || 'L·ªói x√≥a kh√°ch h√†ng'));
    }
  };

  // Initialize
  loadCustomers();
});
</script>

</body>
</html>
