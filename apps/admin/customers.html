<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Qu·∫£n l√Ω Kh√°ch h√†ng</title>
  <link rel="stylesheet" href="./styles.css"/>
  <script src="./admin_real.js?v=27"></script>
  <script src="./sidebar-layout.js"></script>
  <style>
    /* Base styles */
    .customer-type-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .type-retail { background: #dbeafe; color: #1e40af; }
    .type-wholesale { background: #fef3c7; color: #92400e; }
    
    .status-active { color: #059669; }
    .status-inactive { color: #dc2626; }
    
    .points-badge {
      background: #dcfce7;
      color: #166534;
      padding: 2px 8px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 18px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #6b7280;
    }

    .modal-close:hover {
      color: #111827;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      font-size: 14px;
    }

    .btn-sm {
      padding: 4px 12px;
      font-size: 13px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #111827;
    }

    .stat-label {
      font-size: 13px;
      color: #6b7280;
      margin-top: 4px;
    }

    /* ========================================
       RESPONSIVE DESIGN - MOBILE & TABLET
       ======================================== */
    
    /* Header responsive */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .page-header h2 {
      margin: 0;
      font-size: 24px;
    }

    /* Filters responsive */
    .filters-container {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .filters-container input,
    .filters-container select {
      flex: 1;
      min-width: 200px;
    }

    /* Stats grid responsive */
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .stat-value {
        font-size: 22px;
      }

      .stat-label {
        font-size: 11px;
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Table responsive wrapper */
    .table-responsive {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Mobile: Hide less important columns */
    @media (max-width: 1024px) {
      .table th:nth-child(7),
      .table td:nth-child(7) {
        display: none; /* Hide "ƒêƒÉng nh·∫≠p l·∫ßn cu·ªëi" */
      }
    }

    @media (max-width: 768px) {
      .page-header h2 {
        font-size: 20px;
      }

      .page-header button {
        width: 100%;
      }

      .filters-container {
        flex-direction: column;
      }

      .filters-container input,
      .filters-container select {
        width: 100%;
        min-width: 100%;
      }

      /* Hide email column on mobile */
      .table th:nth-child(2),
      .table td:nth-child(2) {
        display: none;
      }

      /* Hide points column on mobile */
      .table th:nth-child(5),
      .table td:nth-child(5) {
        display: none;
      }

      /* Make action buttons vertical */
      .table td:last-child {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .table td:last-child button {
        width: 100%;
      }

      .table {
        font-size: 13px;
      }

      .table th,
      .table td {
        padding: 8px 6px;
      }
    }

    @media (max-width: 480px) {
      /* Card layout for mobile */
      .table thead {
        display: none;
      }

      .table tbody tr {
        display: block;
        margin-bottom: 16px;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 12px;
        background: white;
      }

      .table tbody td {
        display: block;
        border: none;
        padding: 8px 0;
        text-align: left !important;
      }

      .table tbody td:before {
        content: attr(data-label);
        font-weight: 600;
        display: inline-block;
        width: 120px;
        color: #6b7280;
      }

      .table tbody td:last-child {
        padding-top: 12px;
        border-top: 1px solid #e5e7eb;
      }
    }

    /* Modal responsive */
    @media (max-width: 640px) {
      .modal-content {
        width: 95%;
        margin: 10px;
      }

      .modal-header {
        padding: 16px;
      }

      .modal-header h3 {
        font-size: 16px;
      }

      .modal-body {
        padding: 16px;
      }

      .modal-footer {
        padding: 16px;
        flex-direction: column-reverse;
      }

      .modal-footer button {
        width: 100%;
      }
    }

    /* Touch-friendly buttons */
    @media (hover: none) and (pointer: coarse) {
      .btn,
      .btn-sm {
        min-height: 44px;
        padding: 12px 16px;
      }
    }
</style>
</head>
<body>

<div class="card">
  <div class="page-header">
  <h2>üë• Qu·∫£n l√Ω Kh√°ch h√†ng</h2>
  <button id="btn-create-customer" class="btn primary">‚ûï Th√™m kh√°ch h√†ng</button>
</div>

  <!-- Statistics -->
  <div class="stats-grid" id="stats-grid">
    <div class="stat-card">
      <div class="stat-value" id="stat-total">0</div>
      <div class="stat-label">T·ªïng kh√°ch h√†ng</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="stat-retail">0</div>
      <div class="stat-label">Kh√°ch l·∫ª</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="stat-wholesale">0</div>
      <div class="stat-label">Kh√°ch s·ªâ</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="stat-points">0</div>
      <div class="stat-label">T·ªïng ƒëi·ªÉm t√≠ch l≈©y</div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-container">
  <input 
    id="search-input" 
    class="input" 
    placeholder="üîç T√¨m theo t√™n, email, SƒêT..."
  />
  <select id="filter-type" class="input">
    <option value="">T·∫•t c·∫£ lo·∫°i</option>
    <option value="retail">Kh√°ch l·∫ª</option>
    <option value="wholesale">Kh√°ch s·ªâ</option>
  </select>
  <select id="filter-status" class="input">
    <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
    <option value="active">Active</option>
    <option value="inactive">Inactive</option>
  </select>
  <select id="filter-tier" class="input">
    <option value="">T·∫•t c·∫£ tier</option>
    <option value="retail">üÜì Th∆∞·ªùng</option>
    <option value="silver">ü•à B·∫°c</option>
    <option value="gold">ü•á V√†ng</option>
    <option value="diamond">üíé Kim c∆∞∆°ng</option>
  </select>
</div>
  
  <div class="table-responsive">
  <table class="table">
     <thead>
      <tr>
        <th>H·ªç t√™n</th>
        <th>Email</th>
        <th>S·ªë ƒëi·ªán tho·∫°i</th>
        <th>Lo·∫°i</th>
        <th>Tier</th>
        <th>ƒêi·ªÉm</th>
        <th>Tr·∫°ng th√°i</th>
        <th>ƒêƒÉng nh·∫≠p l·∫ßn cu·ªëi</th>
        <th>H√†nh ƒë·ªông</th>
      </tr>
    </thead>

    <tbody id="customers-list">
     <tr><td colspan="9" style="text-align:center;">ƒêang t·∫£i...</td></tr>
   </tbody>
    </table>
</div>

<!-- Modal: Create/Edit Customer -->
<div id="modal-customer" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modal-customer-title">Th√™m kh√°ch h√†ng m·ªõi</h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="customer-id" />
      
      <div class="form-group">
        <label>H·ªç t√™n *</label>
        <input id="customer-name" class="input" placeholder="Nguy·ªÖn VƒÉn A" required />
      </div>
      
      <div class="form-group">
        <label>Email *</label>
        <input id="customer-email" class="input" type="email" placeholder="customer@example.com" required />
      </div>
      
      <div class="form-group">
        <label>M·∫≠t kh·∫©u * <span style="font-size: 11px; color: #6b7280;">(ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)</span></label>
        <input id="customer-password" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
      
      <div class="form-group">
        <label>S·ªë ƒëi·ªán tho·∫°i</label>
        <input id="customer-phone" class="input" type="tel" placeholder="0901234567" />
      </div>
      
      <div class="form-group">
        <label>Lo·∫°i kh√°ch h√†ng *</label>
        <select id="customer-type" class="input" required>
          <option value="retail">Kh√°ch l·∫ª (Gi√° th∆∞·ªùng)</option>
          <option value="wholesale">Kh√°ch s·ªâ (Gi√° s·ªâ)</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>H·∫°ng th√†nh vi√™n (Tier)</label>
        <select id="customer-tier" class="input">
          <option value="retail">üÜì Th∆∞·ªùng (0ƒë)</option>
          <option value="silver">ü•à B·∫°c (1.000.000ƒë+)</option>
          <option value="gold">ü•á V√†ng (3.000.000ƒë+)</option>
          <option value="diamond">üíé Kim c∆∞∆°ng (5.000.000ƒë+)</option>
        </select>
        <small style="color: #6b7280; font-size: 11px;">Tier t·ª± ƒë·ªông t√≠nh theo ƒëi·ªÉm, b·∫°n c√≥ th·ªÉ ghi ƒë√® th·ªß c√¥ng</small>
      </div>
      
      <div class="form-group">
        <label>ƒêi·ªÉm t√≠ch l≈©y</label>
        <input id="customer-points" class="input" type="number" value="0" min="0" />
      </div>
      
      <div class="form-group">
        <label>Tr·∫°ng th√°i</label>
        <select id="customer-status" class="input">
          <option value="active">Active - Ho·∫°t ƒë·ªông</option>
          <option value="inactive">Inactive - T·∫°m kh√≥a</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">H·ªßy</button>
      <button id="btn-save-customer" class="btn primary">üíæ L∆∞u</button>
    </div>
  </div>
</div>

<script>
// B·∫Øt bu·ªôc: ch·∫∑n load n·∫øu ch∆∞a c√≥ token ƒë·ªÉ tr√°nh nh√°y/tr·∫Øng trang
if (window.Admin && typeof Admin.ensureAuth === 'function') {
  Admin.ensureAuth();
}
// Kh·ªüi t·∫°o layout chu·∫©n, ƒë·∫∑t ti√™u ƒë·ªÅ trang
if (window.AdminLayout && typeof AdminLayout.init === 'function') {
  AdminLayout.init('Qu·∫£n l√Ω Kh√°ch h√†ng');
}
document.addEventListener('DOMContentLoaded', function() {
  console.log('[Customers] DOM loaded, initializing...');

  const $ = (id) => document.getElementById(id);

 // RESET search box ƒë·ªÉ tr√°nh filter r·ªóng b·ªã k√≠ch khi click/focus (autofill tr√¨nh duy·ªát)
  const __search = $('search-input');
  if (__search) {
    __search.value = '';
    __search.setAttribute('autocomplete','off');
    __search.setAttribute('autocapitalize','off');
    __search.setAttribute('autocorrect','off');
    // Force clear l·∫°i sau 100ms ƒë·ªÉ ch·∫Øc ch·∫Øn x√≥a autofill
    setTimeout(() => {
      __search.value = '';
    }, 100);
  }


  let allCustomers = [];
  let filteredCustomers = [];

  // Modal functions
  window.openModal = function() {
    const modal = $('modal-customer');
    if (modal) modal.style.display = 'flex';
  };

  window.closeModal = function() {
    const modal = $('modal-customer');
    if (modal) modal.style.display = 'none';
    
    $('customer-id').value = '';
    $('customer-name').value = '';
    $('customer-email').value = '';
    $('customer-password').value = '';
    $('customer-phone').value = '';
    $('customer-type').value = 'retail';
    $('customer-points').value = '0';
    $('customer-status').value = 'active';
    $('modal-customer-title').textContent = 'Th√™m kh√°ch h√†ng m·ªõi';
  };

  // Load customers
  async function loadCustomers() {
    console.log('[Customers] Loading customers...');
    try {
      const r = await Admin.req('/admin/customers/list');
      
      console.log('[Customers] Response:', r);
      
      const tbody = $('customers-list');
      if (!tbody) return;
      
      allCustomers = r.customers || [];
      
      if (allCustomers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">Ch∆∞a c√≥ kh√°ch h√†ng n√†o</td></tr>';
        updateStats();
        return;
      }
      
      filteredCustomers = [...allCustomers];
      renderCustomers();
      updateStats();
      
      console.log('[Customers] Loaded', allCustomers.length, 'customers');
    } catch (e) {
      console.error('[Customers] Load error:', e);
      const tbody = $('customers-list');
      if (tbody) tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color: #dc2626;">L·ªói t·∫£i danh s√°ch kh√°ch h√†ng</td></tr>';
    }
  }

  // Render customers
  function renderCustomers() {
    const tbody = $('customers-list');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (filteredCustomers.length === 0) {
      tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng</td></tr>';
      return;
    }
    
    filteredCustomers.forEach(customer => {
      const typeClass = customer.customer_type === 'wholesale' ? 'type-wholesale' : 'type-retail';
      const typeName = customer.customer_type === 'wholesale' ? 'üè™ Kh√°ch s·ªâ' : 'üõí Kh√°ch l·∫ª';
      const statusClass = customer.status === 'active' ? 'status-active' : 'status-inactive';
      const lastLogin = customer.last_login 
        ? new Date(customer.last_login).toLocaleString('vi-VN')
        : 'Ch∆∞a ƒëƒÉng nh·∫≠p';
      
      const tierConfig = {
        retail: { name: 'Th∆∞·ªùng', icon: 'üÜì', color: '#6b7280' },
        silver: { name: 'B·∫°c', icon: 'ü•à', color: '#94a3b8' },
        gold: { name: 'V√†ng', icon: 'ü•á', color: '#fbbf24' },
        diamond: { name: 'Kim c∆∞∆°ng', icon: 'üíé', color: '#06b6d4' }
      };
      const tier = customer.tier || 'retail';
      const tierInfo = tierConfig[tier] || tierConfig.retail;
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div style="font-weight: 600;">${customer.full_name}</div>
          <div style="font-size: 11px; color: #6b7280;">ID: ${customer.id}</div>
        </td>
        <td>${customer.email}</td>
        <td>${customer.phone || '-'}</td>
        <td><span class="customer-type-badge ${typeClass}">${typeName}</span></td>
        <td><span class="points-badge" style="background: ${tierInfo.color}20; color: ${tierInfo.color};">${tierInfo.icon} ${tierInfo.name}</span></td>
        <td><span class="points-badge">${customer.points || 0} ƒëi·ªÉm</span></td>
        <td class="${statusClass}">${customer.status || 'active'}</td>
        <td style="font-size: 12px;">${lastLogin}</td>
        <td>
          <button class="btn btn-sm" onclick="window.editCustomer('${customer.id}')">‚úèÔ∏è S·ª≠a</button>
          <button class="btn btn-sm danger" onclick="window.deleteCustomer('${customer.id}', '${customer.full_name.replace(/'/g, "\\'")}')">üóëÔ∏è X√≥a</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Update statistics
  function updateStats() {
    const total = allCustomers.length;
    const retail = allCustomers.filter(c => c.customer_type === 'retail').length;
    const wholesale = allCustomers.filter(c => c.customer_type === 'wholesale').length;
    const points = allCustomers.reduce((sum, c) => sum + (c.points || 0), 0);
    
    $('stat-total').textContent = total;
    $('stat-retail').textContent = retail;
    $('stat-wholesale').textContent = wholesale;
    $('stat-points').textContent = points.toLocaleString('vi-VN');
  }

  // Filter customers
    function filterCustomers() {
  const __qRaw = $('search-input').value || '';
  const __q = __qRaw.trim().toLowerCase();
  const searchTerm = (__q.length >= 2) ? __q : ''; // < 2 k√Ω t·ª± coi nh∆∞ kh√¥ng l·ªçc

  const typeFilter = $('filter-type').value;
  const statusFilter = $('filter-status').value;
  const tierFilter = $('filter-tier').value; // ‚úÖ TH√äM

  // N·∫øu t·∫•t c·∫£ filter r·ªóng ‚Üí gi·ªØ nguy√™n to√†n b·ªô danh s√°ch (tr√°nh "bi·∫øn m·∫•t" khi ch·ªâ click)
  if (!searchTerm && !typeFilter && !statusFilter && !tierFilter) {
    filteredCustomers = [...allCustomers];
    renderCustomers();
    return;
  }
    
    filteredCustomers = allCustomers.filter(customer => {
      const matchSearch = !searchTerm || 
        customer.full_name.toLowerCase().includes(searchTerm) ||
        customer.email.toLowerCase().includes(searchTerm) ||
        (customer.phone && customer.phone.includes(searchTerm));
      
      const matchType = !typeFilter || customer.customer_type === typeFilter;
      const matchStatus = !statusFilter || customer.status === statusFilter;
      const matchTier = !tierFilter || customer.tier === tierFilter; // ‚úÖ TH√äM
      
      return matchSearch && matchType && matchStatus && matchTier; // ‚úÖ TH√äM matchTier
    });
    
    renderCustomers();
  }

    // Event listeners for filters (debounce input)
  let __findTimer = null;
  $('search-input').addEventListener('input', () => {
    clearTimeout(__findTimer);
    __findTimer = setTimeout(filterCustomers, 150);
  });
  $('filter-type').addEventListener('change', filterCustomers);
  $('filter-status').addEventListener('change', filterCustomers);
  $('filter-tier').addEventListener('change', filterCustomers); // gi·ªØ nguy√™n


  // Create customer
  $('btn-create-customer').onclick = () => {
    openModal();
  };

  // Save customer
  $('btn-save-customer').onclick = async () => {
    const id = $('customer-id').value;
    const name = $('customer-name').value.trim();
    const email = $('customer-email').value.trim();
    const password = $('customer-password').value;
    const phone = $('customer-phone').value.trim();
    const customer_type = $('customer-type').value;
    const tier = $('customer-tier').value; // ‚úÖ TH√äM
    const points = parseInt($('customer-points').value) || 0;
    const status = $('customer-status').value;
    
    if (!name || !email || !customer_type) {
      alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc');
      return;
    }
    
    if (!id && !password) {
      alert('Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u');
      return;
    }
    
    try {
      const body = { full_name: name, email, phone, customer_type, tier, points, status }; // ‚úÖ TH√äM tier
      if (password) body.password = password;
      
      const method = id ? 'PUT' : 'POST';
      const endpoint = id ? `/admin/customers/${id}` : '/admin/customers/create';
      
      const r = await Admin.req(endpoint, {
        method,
        body
      });
      
      if (r && r.ok) {
        Admin.toast(id ? 'ƒê√£ c·∫≠p nh·∫≠t kh√°ch h√†ng' : 'ƒê√£ t·∫°o kh√°ch h√†ng m·ªõi');
        closeModal();
        loadCustomers();
      } else {
        throw new Error(r.error || 'L·ªói l∆∞u kh√°ch h√†ng');
      }
    } catch (e) {
      console.error('[Customers] Save error:', e);
      alert(e.message || 'L·ªói l∆∞u kh√°ch h√†ng');
    }
  };

  // Edit customer
  window.editCustomer = async function(id) {
    try {
      const r = await Admin.req(`/admin/customers/${id}`);
      
      if (!r || !r.ok) throw new Error('Failed to load customer');
      
      const customer = r.customer;
      
      $('customer-id').value = customer.id;
      $('customer-name').value = customer.full_name;
      $('customer-email').value = customer.email;
      $('customer-phone').value = customer.phone || '';
      $('customer-type').value = customer.customer_type;
      $('customer-tier').value = customer.tier || 'retail'; // ‚úÖ TH√äM
      $('customer-points').value = customer.points || 0;
      $('customer-status').value = customer.status || 'active';
      $('customer-password').value = '';
      $('customer-password').placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)';
      
      $('modal-customer-title').textContent = 'S·ª≠a th√¥ng tin kh√°ch h√†ng';
      openModal();
    } catch (e) {
      console.error('[Customers] Edit error:', e);
      alert('L·ªói t·∫£i th√¥ng tin kh√°ch h√†ng');
    }
  };

  // Delete customer
  window.deleteCustomer = async function(id, name) {
    if (!confirm(`X√≥a kh√°ch h√†ng "${name}"?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) return;
    
    try {
      const r = await Admin.req(`/admin/customers/${id}`, { method: 'DELETE' });
      
      if (r && r.ok) {
        Admin.toast('ƒê√£ x√≥a kh√°ch h√†ng');
        loadCustomers();
      } else {
        throw new Error(r.error || 'L·ªói x√≥a kh√°ch h√†ng');
      }
    } catch (e) {
      console.error('[Customers] Delete error:', e);
      alert(e.message || 'L·ªói x√≥a kh√°ch h√†ng');
    }
  };

  // Init
  loadCustomers();
});
</script>
</body>
</html>