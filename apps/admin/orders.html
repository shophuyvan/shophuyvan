<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Đơn hàng</title>
  <link rel="stylesheet" href="../lib/admin.css"/>
  <script type="module">
    import Admin from '../lib/admin_real.js';
    window.addEventListener('DOMContentLoaded', ()=>{
      const modal = document.getElementById('order-modal');
      const btnC  = document.getElementById('btn-create-waybill');
      const btnP  = document.getElementById('btn-print-waybill');

      async function openPrint(order, tracking){
        if(!tracking) return Admin.toast('Chưa có tracking');
        const r = await Admin.req('/admin/shipping/label',{method:'POST', body:{tracking}});
        if(r && r.ok && r.url){ window.open(r.url,'_blank'); }
      }

      btnC.onclick = async ()=>{
        try{
          // lấy danh sách đơn mới nhất để đồng bộ
          const list = await Admin.req('/admin/orders',{method:'GET'});
          const itemsAll=(list&&list.items)||[];
          const idTxt = modal.querySelector('.card b')?.textContent||'';
          const ord = itemsAll.find(x=>(x.id||'').endsWith(idTxt.slice(-6))) || itemsAll[0];
          if(!ord){ Admin.toast('Không tìm thấy đơn để tạo vận đơn'); return; }

          const its = Array.isArray(ord.items)? ord.items: [];
          const weight = its.reduce((s,it)=> s + Number(it.weight_gram||it.weight_grams||it.weight||0)*Number(it.qty||1), 0);
          const subtotal = its.reduce((s,it)=> s + Number(it.price||0)*Number(it.qty||1), 0);
          const cleanItems = its.map(it=>({ sku: it.sku||it.id||'', name: it.name||it.title||'Hàng hóa',
                                            qty: Number(it.qty||1), price: Number(it.price||0),
                                            weight_grams: Number(it.weight_gram||it.weight_grams||it.weight||0) }));

          const payload = {
            order_id: ord.id || ord._id || '',
            provider: ord.shipping_provider || (ord.shipping && ord.shipping.provider) || '',
            service_code: ord.shipping_service || (ord.shipping && ord.shipping.service) || '',
            fee: Number(ord.shipping_fee||0),
            name: ord.name || (cleanItems[0]?.name) || 'Đơn hàng',
            to_name: (ord.customer&&ord.customer.name)||ord.customer_name||ord.name||'',
            to_phone: (ord.customer&&ord.customer.phone)||ord.phone||'',
            to_address: (ord.customer&&ord.customer.address)||ord.address||'',
            to_province_code: ord.customer?.province_code || ord.to_province_code || '',
            to_district_code: ord.customer?.district_code || ord.to_district_code || '',
            to_commune_code:  ord.customer?.commune_code  || ord.to_commune_code  || '',
            weight_gram: weight,
            cod: subtotal,
            items: cleanItems
          };

          const r = await Admin.req('/admin/shipping/create',{method:'POST', body: payload});
          if(r&&r.ok){ Admin.toast('Đã tạo vận đơn'); openPrint(ord, r.tracking||''); }
          else{ Admin.toast('Tạo vận đơn thất bại'); console.warn('create-failed', r); }
        }catch(e){ Admin.toast('Lỗi tạo vận đơn'); console.error(e); }
      };
      btnP.onclick = async ()=>{
        // giữ nguyên hành vi in theo tracking đã có
        const list = await Admin.req('/admin/orders',{method:'GET'});
        const itemsAll=(list&&list.items)||[];
        const idTxt = modal.querySelector('.card b')?.textContent||'';
        const ord = itemsAll.find(x=>(x.id||'').endsWith(idTxt.slice(-6))) || itemsAll[0];
        if(!ord){ return;}
        openPrint(ord, ord.tracking||'');
      };
    });
  </script>
</head>
<body>
  <div id="order-modal">
    <div class="card">
      <div class="actions">
        <button id="btn-create-waybill">Tạo vận đơn</button>
        <button id="btn-print-waybill">In vận đơn</button>
      </div>
      <b>ORDER-ID</b>
    </div>
  </div>
</body>
</html>
