<!doctype html><html lang="vi"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Đơn hàng</title>
<link rel="stylesheet" href="./styles.css"/>
<script src="./admin_real.js?v=25"></script>
<!-- build:21 -->
</head><body>
<div class="container">
  <div class="header">
    <div class="title">Đơn hàng</div>
    <div class="nav">
      <a href="./products.html" class="badge">Sản phẩm</a>
      <a href="./banners.html" class="badge">Banner</a>
      <a href="./vouchers.html" class="badge">Voucher</a><a href="./orders.html" class="badge">Đơn hàng</a><a href="./stats.html" class="badge">Thống kê</a><a href="./shipping.html" class="badge">Vận chuyển</a><a href="./ads.html" class="badge">Quảng cáo</a>
      <a href="./orders.html" class="badge">Đơn hàng</a>
      <a href="./stats.html" class="badge">Thống kê</a>
      <span class="badge">API: <span data-api-base></span></span>
    </div>
  </div>
  <div class="card">
    <div class="row"><div class="col">
      

  <div id="live-orders"></div>

<div id="live-orders"></div>

  <div class="card"><div class="title">Danh sách</div>
    <table class="table md-table"><thead><tr><th>Mã</th><th>Khách</th><th>Tổng hàng</th><th>Ship</th><th>Doanh thu</th><th>Lợi nhuận</th><th></th></tr></thead>
    <tbody id="list"></tbody></table>
  </div>
  <div id="new-order-banner" style="display:none;margin:10px 0;padding:10px;border:1px solid #16a34a;background:#ecfdf5;color:#065f46;border-radius:6px;">
    Có <strong>đơn hàng mới</strong>. <button id="reload-orders" class="btn">Tải lại</button>
  </div>
</div>

<div id="modal-detail" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:60">
  <div style="width:min(720px,92vw);background:#fff;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,.25);padding:16px;max-height:90vh;overflow:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:700;font-size:18px">Chi tiết đơn hàng</div>
      <button id="md-close" class="btn">Đóng</button>
    </div>
    <div id="md-body" style="font-size:14px;color:#111827"></div>
  </div>
</div>
<script>
(function(){
  function fmt(n){ try{ return Number(n||0).toLocaleString('vi-VN')+'đ'; }catch{return (n||0)+'đ';} }
  window.showOrderDetail = function(o){
    const b = document.getElementById('md-body');
    const c = document.getElementById('modal-detail');
    const its = Array.isArray(o.items)?o.items:[];
    const sub = its.reduce((s,it)=> s + Number(it.price||0)*Number(it.qty||1), 0);
    const ship = Number(o.shipping_fee||0);
    const disc = Number(o.discount||0) + Number(o.shipping_discount||0);
    const total = Math.max(0, sub + ship - disc);
    const addr = (o.address || o.customer?.address || '');
    const shipName = o.shipping_name || o.ship_name || '';
    const eta = o.shipping_eta || '';
    const when = o.createdAt ? new Date(Number(o.createdAt)).toLocaleString('vi-VN') : '';
    const cust = o.customer || {};
    const rows = its.map(it=>`
      <tr>
        <td>${it.sku||it.id||''}</td>
        <td>${(it.name||'') + (it.variant?(' - '+it.variant):'')}</td>
        <td style="text-align:right">${it.qty||1}</td>
        <td style="text-align:right">${fmt(it.price||0)}</td>
        <td style="text-align:right">${fmt(it.cost||0)}</td>
        <td style="text-align:right">${fmt((it.price||0)*(it.qty||1))}</td>
      </tr>`).join('');
    b.innerHTML = `
      <div style="margin-bottom:8px">
        <div><b>Khách:</b> ${cust.name||o.customer_name||o.name||'Khách'} ${cust.phone?('• '+cust.phone):''}</div>
        ${addr?('<div><b>Địa chỉ:</b> '+addr+'</div>'):''}
        ${shipName?('<div><b>Vận chuyển:</b> '+shipName+(eta?(' • '+eta):'')+'</div>'):''}
        ${when?('<div><b>Ngày tạo:</b> '+when+'</div>'):''}
        <div><b>Trạng thái:</b> ${o.status||'pending'}</div>
      </div>
      <div class="card">
        <table class="table md-table">
          <thead><tr><th>Mã SP</th><th>Tên/Phân loại</th><th>SL</th><th>Giá bán</th><th>Giá vốn</th><th>Thành tiền</th></tr></thead>
          <tbody>${rows || '<tr><td colspan="6" style="color:#6b7280">Không có dòng hàng</td></tr>'}</tbody>
        </table>
        <div style="border-top:1px dashed #e5e7eb;margin-top:8px;padding-top:8px">
          <div style="display:flex;justify-content:space-between"><span>Tổng hàng</span><b>${fmt(sub)}</b></div>
          <div style="display:flex;justify-content:space-between"><span>Phí vận chuyển</span><b>${fmt(ship)}</b></div>
          ${disc?('<div style="display:flex;justify-content:space-between;color:#059669"><span>Giảm</span><b>-'+fmt(disc)+'</b></div>'):''}
          <div style="display:flex;justify-content:space-between;font-size:16px"><span>Tổng thanh toán</span><b>${fmt(total)}</b></div>
        </div>
      </div>`;
    c.style.display='flex';
  };
  document.getElementById('md-close')?.addEventListener('click', ()=>{ document.getElementById('modal-detail').style.display='none'; });
  document.getElementById('modal-detail')?.addEventListener('click', (e)=>{ if(e.target.id==='modal-detail') e.currentTarget.style.display='none'; });
})();
</script>

<script>
// --- Inject shipping actions on order detail modal ---
(function(){
  function openPrint(order, tracking){
    const html = `<!doctype html><html><head><meta charset="utf-8"><title>Vận đơn</title>
    <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',sans-serif;padding:16px}
    .box{border:1px dashed #444;padding:12px;margin-bottom:12px}
    .row{display:flex;justify-content:space-between}</style></head><body>
    <h2>Vận đơn - ${order?.shipping_name||order?.shipping_provider||''}</h2>
    <div class="box"><div><b>Tracking:</b> ${tracking||order?.tracking||''}</div>
    <div><b>Đơn hàng:</b> ${order?.id||''}</div>
    <div><b>Khách:</b> ${(order?.customer?.name||order?.customer_name||order?.name||'')}</div>
    <div><b>ĐT:</b> ${(order?.customer?.phone||order?.phone||'')}</div>
    <div><b>Địa chỉ:</b> ${(order?.customer?.address||order?.address||'')}</div></div>
    <div class="box"><div class="row"><span>Phí VC:</span><b>${(order?.shipping_fee||0).toLocaleString('vi-VN')}đ</b></div>
    <div class="row"><span>Tổng:</span><b>${(order?.revenue||0).toLocaleString('vi-VN')}đ</b></div></div>
    <script>window.onload=()=>window.print()<\/script></body></html>`;
    const w = window.open('', '_blank'); w.document.write(html); w.document.close();
  }
  // Observe modal content changes to add buttons
  const modal = document.getElementById('modal-detail');
  const container = modal;
  const obs = new MutationObserver(()=>{
    const btnBarId='ship-actions';
    if(document.getElementById(btnBarId)) return;
    const panel = modal.querySelector('.card'); if(!panel) return;
    const bar = document.createElement('div'); bar.id=btnBarId; bar.className='toolbar';
    bar.innerHTML = '<button id="btn-create-waybill" class="btn">Tạo vận đơn</button><button id="btn-print-waybill" class="btn">In vận đơn</button>';
    panel.parentElement.insertBefore(bar, panel);
    const idEl = panel.closest('#modal-content') || document;
    const nameEl = panel.querySelector('b')||{};
    // Wire buttons
    const btnC = document.getElementById('btn-create-waybill');
    const btnP = document.getElementById('btn-print-waybill');
    
if(btnC){ btnC.addEventListener('click', async ()=>{
  try{
    const list = await Admin.req('/api/orders',{method:'GET'});
    const items=(list&&list.items)||[];
    // Try get current order id from modal header
    const idTxt = modal.querySelector('.card b')?.textContent||'';
    const o = items.find(x=>(x.id||'').endsWith(idTxt.slice(-6))) || items[0];
    if(!o){ Admin.toast('Không tìm thấy đơn để tạo vận đơn'); return; }
    const its = Array.isArray(o.items)? o.items: [];
    const weight = its.reduce((s,it)=> s + Number(it.weight_gram||it.weight_grams||it.weight||0)*Number(it.qty||1), 0);
    const subtotal = its.reduce((s,it)=> s + Number(it.price||0)*Number(it.qty||1), 0);
    const payload = { order_id: o.id || o._id || '' };
    const r = await Admin.req('/admin/shipping/create',{method:'POST', body: payload});
    if(r&&r.ok){ Admin.toast('Đã tạo vận đơn'); openPrint(o, r.tracking||''); }
    else{ Admin.toast(r && r.error === 'CREATE_FAILED' ? 'Không thể tạo vận đơn (thiếu cấu hình hoặc dữ liệu không hợp lệ)' : 'Tạo vận đơn thất bại');  }
  }catch(e){ Admin.toast('Không thể tạo vận đơn. Vui lòng kiểm tra cấu hình và dữ liệu đơn.');  }
});
if(btnP){ btnP.addEventListener('click', async ()=>{
      const list = await Admin.req('/api/orders',{method:'GET'});
      const o = (list&&list.items&&list.items[0])||null;
      openPrint(o, '');
    });
  obs.observe(container, { childList:true, subtree:true });
})();
</script>
</body>
</html>