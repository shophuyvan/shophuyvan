<!doctype html><html lang="vi"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Đơn hàng</title>
<link rel="stylesheet" href="./styles.css"/>
<script src="./admin_real.js?v=25"></script>
<!-- build:21 -->

<style>
/* Orders table layout like screenshot */
.table.order-table { width:100%; border-collapse:separate; border-spacing:0; }
.table.order-table thead th{ background:#f8fafc; border-bottom:1px solid #e5e7eb; font-weight:600; padding:10px 8px; text-align:left; color:#111827; }
.table.order-table tbody td{ border-bottom:1px solid #eef2f7; padding:10px 8px; vertical-align:top; color:#111827; }
.item-cell{ display:flex; gap:10px; align-items:flex-start; }
.item-cell img{ width:48px; height:48px; object-fit:cover; border:1px solid #e5e7eb; border-radius:6px; background:#fff; }
.item-meta .name{ font-weight:600; line-height:1.2; margin-bottom:2px; }
.badge-sm{ display:inline-block; padding:2px 6px; font-size:12px; border:1px solid #e5e7eb; color:#374151; border-radius:6px; background:#f9fafb; }
.text-right{ text-align:right; }
.nowrap{ white-space:nowrap; }
</style>

</head><body>
<div class="container">
  <div class="header">
    <div class="title">Đơn hàng</div>
    <div class="nav">
      <a href="./products.html" class="badge">Sản phẩm</a>
      <a href="./banners.html" class="badge">Banner</a>
      <a href="./vouchers.html" class="badge">Voucher</a><a href="./orders.html" class="badge">Đơn hàng</a><a href="./stats.html" class="badge">Thống kê</a><a href="./shipping.html" class="badge">Vận chuyển</a><a href="./ads.html" class="badge">Quảng cáo</a>
      <a href="./orders.html" class="badge">Đơn hàng</a>
      <a href="./stats.html" class="badge">Thống kê</a>
      <span class="badge">API: <span data-api-base></span></span>
    </div>
  </div>
  <div class="card">
    <div class="row"><div class="col">
      

  <div id="live-orders"></div>

<div id="live-orders"></div>

  <div class="card"><div class="title">Danh sách</div>
    <table class="table order-table"><thead><tr><th>Mặt hàng</th><th class="nowrap">Mã đơn</th><th class="nowrap">Hãng VC</th><th class="nowrap">Mã vận đơn</th><th class="nowrap">Doanh thu</th><th class="nowrap">Thời gian</th><th>Nguồn</th><th class="text-right">Thao tác</th></tr></thead>
    <tbody id="list"></tbody></table>
  </div>
  <div id="new-order-banner" style="display:none;margin:10px 0;padding:10px;border:1px solid #16a34a;background:#ecfdf5;color:#065f46;border-radius:6px;">
    Có <strong>đơn hàng mới</strong>. <button id="reload-orders" class="btn">Tải lại</button>
  </div>
</div>

<div id="modal-detail" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:60">
  <div style="width:min(720px,92vw);background:#fff;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,.25);padding:16px;max-height:90vh;overflow:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:700;font-size:18px">Chi tiết đơn hàng</div>
      <button id="md-close" class="btn">Đóng</button>
    </div>
    <div id="md-body" style="font-size:14px;color:#111827"></div>
  </div>
</div>
<script>

function g(o,arr){ try{ var v=o; for(var i=0;i<arr.length;i++){ if(!v||typeof v!=='object'){ return ''; } v=v[arr[i]]; } return (v==null?'':v);}catch(_e){return '';} }
(function(){
  async function loadOrders(){
    try{
      const res = await Admin.req('/api/orders',{method:'GET'});
      const items = (res && res.items) || [];
      const tbody = document.getElementById('list');
      if(!tbody) return;
      function sum(arr, f){ return (arr||[]).reduce((s,it)=> s + Number(f(it)||0)*Number(it.qty||1), 0); }
      
      tbody.innerHTML = items.map(function(o){
        function sum(arr, f){ var s=0; (arr||[]).forEach(function(it){ s += Number(f(it)||0)*Number(it.qty||1); }); return s; }
        var its = Array.isArray(o.items)?o.items:[];
        var first = its[0]||{};
        var img = first.image || first.img || first.thumbnail || '';
        if(!img){
          img = 'data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"><rect width="48" height="48" fill="%23f3f4f6"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" font-size="10" fill="%239ca3af">no img</text></svg>');
        }
        var itemTitle = String(first.name || first.title || first.sku || 'Sản phẩm');
        var itemQty = Number(first.qty || first.quantity || 1);
        var sub = sum(its, function(it){ return Number(it.price||0); });
        var cost = sum(its, function(it){ return Number(it.cost||0); });
        var ship = Number(o.shipping_fee||0);
        var disc = Number(o.discount||0) + Number(o.shipping_discount||0);
        var rev  = Math.max(0, sub + ship - disc);
        var provider = (o.shipping_provider || o.provider || o.shipping_name || o.ship_name || '').toString();
        var tracking = (o.tracking_code || o.shipping_tracking || o.ship_tracking || (o.shipping&&o.shipping.tracking_code) || '').toString();
        var created = (o.created_at || o.createdAt || o.createdAtMs || o.createdAtISO || '');
        var tStr = '';
        try{
          var d = (typeof created==='number'||/^[0-9]+$/.test(created))? new Date(Number(created)) : (created? new Date(created) : null);
          tStr = d? d.toLocaleString('vi-VN') : '';
        }catch(_e){ tStr=''; }
        var source = (o.source || o.channel || o.platform || 'Web').toString();
        var id = (o.id || '').toString();
        return '<tr>'
          + '<td><div class="item-cell"><img src="'+img+'"/><div class="item-meta"><div class="name">'+itemTitle+'</div><div>x'+itemQty+'</div></div></div></td>'
          + '<td class="nowrap">'+id+'</td>'
          + '<td class="nowrap">'+provider+'</td>'
          + '<td class="nowrap">'+(tracking||'-')+'</td>'
          + '<td class="nowrap">'+fmt(rev)+'</td>'
          + '<td class="nowrap">'+tStr+'</td>'
          + '<td>'+(source||'')+'</td>'
          + '<td class="text-right"><button class="btn btn-sm" data-view="'+id+'">Xem</button></td>'
          + '</tr>';
      }).join('');
    
      tbody.querySelectorAll('[data-view]').forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.getAttribute('data-view');
          const o = ((res && res.items)||[]).find(x=>(x.id||'')===id);
          if(o) window.showOrderDetail(o);
        };
      });
      var __rld=document.getElementById('reload-orders'); if(__rld){ __rld.addEventListener('click', loadOrders); }
    }catch(e){
      console.error(e);
    }
  }
  document.addEventListener('DOMContentLoaded', loadOrders);

  function fmt(n){ try{ return Number(n||0).toLocaleString('vi-VN')+'đ'; }catch(e){return (n||0)+'đ';} }
  window.showOrderDetail = function(o){ window.__currentOrder = o;
    const b = document.getElementById('md-body');
    const c = document.getElementById('modal-detail'); c && (c.dataset.orderId = (o && (o.id||o._id||''))||'');
    const its = Array.isArray(o.items)?o.items:[];
    const sub = its.reduce((s,it)=> s + Number(it.price||0)*Number(it.qty||1), 0);
    const ship = Number(o.shipping_fee||0);
    const disc = Number(o.discount||0) + Number(o.shipping_discount||0);
    const total = Math.max(0, sub + ship - disc);
    const addr = (o.address || (o.customer && o.customer.address) || '');
    const shipName = o.shipping_name || o.ship_name || '';
    const eta = o.shipping_eta || '';
    const when = o.createdAt ? new Date(Number(o.createdAt)).toLocaleString('vi-VN') : '';
    const cust = o.customer || {};
    const rows = its.map(it=>`
      <tr>
        <td>${it.sku||it.id||''}</td>
        <td>${(it.name||'') + (it.variant?(' - '+it.variant):'')}</td>
        <td style="text-align:right">${it.qty||1}</td>
        <td style="text-align:right">${fmt(it.price||0)}</td>
        <td style="text-align:right">${fmt(it.cost||0)}</td>
        <td style="text-align:right">${fmt((it.price||0)*(it.qty||1))}</td>
      </tr>`).join('');
    b.innerHTML = `
      <div style="margin-bottom:8px">
        <div><b>Khách:</b> ${cust.name||o.customer_name||o.name||'Khách'} ${cust.phone?('• '+cust.phone):''}</div>
        ${addr?('<div><b>Địa chỉ:</b> '+addr+'</div>'):''}
        ${shipName?('<div><b>Vận chuyển:</b> '+shipName+(eta?(' • '+eta):'')+'</div>'):''}
        ${when?('<div><b>Ngày tạo:</b> '+when+'</div>'):''}
        <div><b>Trạng thái:</b> ${o.status||'pending'}</div>
      </div>
      <div class="card">
        <table class="table md-table">
          <thead><tr><th>Mã SP</th><th>Tên/Phân loại</th><th>SL</th><th>Giá bán</th><th>Giá vốn</th><th>Thành tiền</th></tr></thead>
          <tbody>${rows || '<tr><td colspan="6" style="color:#6b7280">Không có dòng hàng</td></tr>'}</tbody>
        </table>
        <div style="border-top:1px dashed #e5e7eb;margin-top:8px;padding-top:8px">
          <div style="display:flex;justify-content:space-between"><span>Tổng hàng</span><b>${fmt(sub)}</b></div>
          <div style="display:flex;justify-content:space-between"><span>Phí vận chuyển</span><b>${fmt(ship)}</b></div>
          ${disc?('<div style="display:flex;justify-content:space-between;color:#059669"><span>Giảm</span><b>-'+fmt(disc)+'</b></div>'):''}
          <div style="display:flex;justify-content:space-between;font-size:16px"><span>Tổng thanh toán</span><b>${fmt(total)}</b></div>
        </div>
      </div>`;
    c.style.display='flex';
  };
  (function(){ var btn=document.getElementById('md-close'); if(btn){ btn.addEventListener('click', function(){ var m=document.getElementById('modal-detail'); if(m){ m.style.display='none'; } }); } })();
  var __mdl=document.getElementById('modal-detail'); if(__mdl){ __mdl.addEventListener('click', function(e){ if(e && e.target && e.target.id==='modal-detail'){ __mdl.style.display='none'; } }); }
})();
</script>

<script>
// --- Inject shipping actions on order detail modal ---
(function(){
  function openPrint(order, tracking){
    const html = `<!doctype html><html><head><meta charset="utf-8"><title>Vận đơn</title>
    <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',sans-serif;padding:16px}
    .box{border:1px dashed #444;padding:12px;margin-bottom:12px}
    .row{display:flex;justify-content:space-between}</style></head><body>
    <h2>Vận đơn - ${(g(order,['shipping_name'])||g(order,['shipping_provider'])||'')}</h2>
    <div class="box"><div><b>Tracking:</b> ${tracking||(g(order,['tracking'])||'')}</div>
    <div><b>Đơn hàng:</b> ${(g(order,['id'])||'')}</div>
    <div><b>Khách:</b> ${(g(order,['customer','name'])||g(order,['customer_name'])||g(order,['name'])||'')}</div>
    <div><b>ĐT:</b> ${(g(order,['customer','phone'])||g(order,['phone'])||'')}</div>
    <div><b>Địa chỉ:</b> ${(g(order,['customer','address'])||g(order,['address'])||'')}</div></div>
    <div class="box"><div class="row"><span>Phí VC:</span><b>${(Number(g(order,['shipping_fee'])||0).toLocaleString('vi-VN'))}đ</b></div>
    <div class="row"><span>Tổng:</span><b>${(Number(g(order,['revenue'])||0).toLocaleString('vi-VN'))}đ</b></div></div>
    <script>window.onload=()=>window.print()<\/script></body></html>`;
    const w = window.open('', '_blank'); w.document.write(html); w.document.close();
  }
  // Observe modal content changes to add buttons
  const modal = document.getElementById('modal-detail');
  const container = modal;
  const obs = new MutationObserver(()=>{
    const btnBarId='ship-actions';
    if(document.getElementById(btnBarId)) return;
    const panel = modal.querySelector('.card'); if(!panel) return;
    const bar = document.createElement('div'); bar.id=btnBarId; bar.className='toolbar';
    bar.innerHTML = '<button id="btn-create-waybill" class="btn">Tạo vận đơn</button><button id="btn-print-waybill" class="btn">In vận đơn</button>';
    panel.parentElement.insertBefore(bar, panel);
    const idEl = panel.closest('#modal-content') || document;
    const nameEl = panel.querySelector('b')||{};
    // Wire buttons
    const btnC = document.getElementById('btn-create-waybill');
    const btnP = document.getElementById('btn-print-waybill');
    


if(btnC){ btnC.addEventListener('click', async ()=>{
  try{
    var o = (window && window.__currentOrder) || null;
    try{
      var md = document.getElementById('modal-detail');
      var idHint = md ? (md.dataset && md.dataset.orderId) : '';
      if((!o || (idHint && (String(o.id||o._id||'')!==String(idHint)))) && idHint){
         const list2 = await Admin.req('/api/orders',{method:'GET'});
         const items2=(list2&&list2.items)||[];
         o = items2.find(function(x){ return String(x.id||'')===String(idHint); }) || o || null;
      }
    }catch(_e){}
    if(!o){ const list = await Admin.req('/api/orders',{method:'GET'});
      const items=(list&&list.items)||[]; var idTxt=(function(){ var el=modal.querySelector('.card b'); return el?el.textContent:''; })();
      o = items.find(function(x){ return (String(x.id||'')===String(idTxt)) || (String(x.id||'').endsWith(String(idTxt).slice(-6))); }) || items[0] || null; }
    if(!o){ Admin.toast('Không tìm thấy đơn để tạo vận đơn'); return; }

    function pick(obj, names){ for(var i=0;i<names.length;i++){ var k=names[i]; if(obj && obj[k]!=null && obj[k]!=='' ){ return obj[k]; } } return ''; }
    function norm(s){ try{ return (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').replace(/[^a-z0-9 ]/g,' ').replace(/\s+/g,' ').trim(); }catch(_){ return (s||'').toString().toLowerCase(); } }
    function containsName(addr, name){ return norm(addr).indexOf(norm(name))>=0; }

    async function fetchProvinces(){ var rs = await Admin.req('/shipping/provinces',{method:'GET'}); return (rs&&rs.items)||[]; }
    async function fetchDistricts(pcode){ if(!pcode) return []; var rs = await Admin.req('/shipping/districts',{method:'GET', query:{ province_code: pcode }}); return (rs&&rs.items)||[]; }
    async function fetchWards(dcode){ if(!dcode) return []; var rs = await Admin.req('/shipping/commune',{method:'GET', query:{ district_code: dcode }}); return (rs&&rs.items)||[]; }

    var w=null; try{
      var resW = await Admin.req('/shipping/warehouses',{method:'GET'});
      var listW = (resW && (resW.data||resW.items)) || resW || [];
      w = (Array.isArray(listW)? listW[0]: (listW && listW[0])) || null;
    }catch(_){}
    var sender = {
      name: (w && (w.name||w.contact_name||w.primary_name||w.wh_name)) || 'Kho #1',
      phone:(w && (w.phone||w.contact_phone||w.wh_phone||w.mobile)) || '0000000000',
      address:(w && (w.addr||w.address||w.formatted_address||w.wh_address)) || '',
      province_code: (w && (w.province_code || (w.province&&w.province.code) || w.provinceId || w.province_code_id)) || '',
      district_code: (w && (w.district_code || (w.district&&w.district.code) || w.districtId)) || '',
      ward_code: (w && (w.ward_code || w.commune_code || w.wardId || w.communeId)) || ''
    };
    if(!(sender.province_code&&sender.district_code&&sender.ward_code)){
      var pn = (w&& (w.province_name || (w.province&&w.province.name))) || '';
      var dn = (w&& (w.district_name || (w.district&&w.district.name))) || '';
      var wn = (w&& (w.commune_name || w.ward_name || (w.ward&&w.ward.name))) || '';
      var provs = await fetchProvinces();
      var hitP = null; for(var i=0;i<provs.length;i++){ if(containsName(pn||sender.address, provs[i].name)){ hitP = provs[i]; break; } }
      if(hitP){ sender.province_code = hitP.code; var dists = await fetchDistricts(hitP.code);
        var hitD=null; for(var j=0;j<dists.length;j++){ if(containsName(dn||sender.address, dists[j].name)){ hitD = dists[j]; break; } }
        if(hitD){ sender.district_code = hitD.code; var wards = await fetchWards(hitD.code);
          var hitW=null; for(var k=0;k<wards.length;k++){ if(containsName(wn||sender.address, wards[k].name)){ hitW = wards[k]; break; } }
          if(hitW){ sender.ward_code = hitW.code; }
        }
      }
    }

    var receiver = {
      name: pick(o, ['customer_name','customerName','name','receiver_name']),
      phone: pick(o, ['phone','customer_phone','receiver_phone']),
      address: pick(o, ['address','receiver_address','shipping_address']) || ''
    };
    receiver.province_code = pick(o, ['receiver_province_code','to_province_code','province_code','toProvinceCode']);
    // Extra: map from names if codes missing
    var rProvName = pick(o, ['receiver_province_name','province_name','province','to_province_name','to_province']);
    var rDistName = pick(o, ['receiver_district_name','district_name','district','to_district_name','to_district']);
    var rWardName = pick(o, ['receiver_commune_name','receiver_ward_name','ward_name','commune_name','ward','to_commune_name','to_ward_name']);
    if(!receiver.address){
      receiver.address = [pick(o,['address','receiver_address','shipping_address']), rWardName, rDistName, rProvName].filter(Boolean).join(', ');
    }

    receiver.district_code = pick(o, ['receiver_district_code','to_district_code','district_code','toDistrictCode']);
    receiver.ward_code     = pick(o, ['receiver_commune_code','receiver_ward_code','to_commune_code','ward_code','toWardCode']);

    
    if(!receiver.province_code && (receiver.address || rProvName)){
      var provs2 = await fetchProvinces(); var hitP2=null;
      if(rProvName){
        for(var a=0;a<provs2.length;a++){ if(containsName(rProvName, provs2[a].name)){ hitP2 = provs2[a]; break; } }
      }
      if(!hitP2 && receiver.address){
        for(var a2=0;a2<provs2.length;a2++){ if(containsName(receiver.address, provs2[a2].name)){ hitP2 = provs2[a2]; break; } }
      }
      if(hitP2){ receiver.province_code = hitP2.code; var dists2 = await fetchDistricts(hitP2.code);
        var hitD2=null;
        if(rDistName){
          for(var b=0;b<dists2.length;b++){ if(containsName(rDistName, dists2[b].name)){ hitD2 = dists2[b]; break; } }
        }
        if(!hitD2 && receiver.address){
          for(var b2=0;b2<dists2.length;b2++){ if(containsName(receiver.address, dists2[b2].name)){ hitD2 = dists2[b2]; break; } }
        }
        if(hitD2){ receiver.district_code = hitD2.code; var wards2 = await fetchWards(hitD2.code);
          var hitW2=null;
          if(rWardName){
            for(var c2=0;c2<wards2.length;c2++){ if(containsName(rWardName, wards2[c2].name)){ hitW2 = wards2[c2]; break; } }
          }
          if(!hitW2 && receiver.address){
            for(var c3=0;c3<wards2.length;c3++){ if(containsName(receiver.address, wards2[c3].name)){ hitW2 = wards2[c3]; break; } }
          }
          if(hitW2){ receiver.ward_code = hitW2.code; }
        }
      }
    }

      var provs2 = await fetchProvinces(); var hitP2=null;
      for(var a=0;a<provs2.length;a++){ if(containsName(receiver.address, provs2[a].name)){ hitP2 = provs2[a]; break; } }
      if(hitP2){ receiver.province_code = hitP2.code; var dists2 = await fetchDistricts(hitP2.code);
        var hitD2=null; for(var b=0;b<dists2.length;b++){ if(containsName(receiver.address, dists2[b].name)){ hitD2 = dists2[b]; break; } }
        if(hitD2){ receiver.district_code = hitD2.code; var wards2 = await fetchWards(hitD2.code);
          var hitW2=null; for(var c2=0;c2<wards2.length;c2++){ if(containsName(receiver.address, wards2[c2].name)){ hitW2 = wards2[c2]; break; } }
          if(hitW2){ receiver.ward_code = hitW2.code; }
        }
      }
    }

    var its = Array.isArray(o.items)? o.items: [];
    var mappedItems = its.map(function(it){
      return { name: (it.name||it.title||'Item'), qty: Number(it.qty||1), price: Number(it.price||0), weight_grams: Number(it.weight_gram||it.weight_grams||it.weight||0) };
    });

    var payload = {
      provider: (o.shipping_provider || o.provider || '').toString().toLowerCase(),
      order_id: o.id || o._id || '',
      sender_name: sender.name, sender_phone: sender.phone, sender_address: sender.address,
      sender_province_code: String(sender.province_code||''), sender_district_code: String(sender.district_code||''), sender_commune_code: String(sender.ward_code||''),
      receiver_name: receiver.name, receiver_phone: receiver.phone, receiver_address: receiver.address,
      receiver_province_code: String(receiver.province_code||''), receiver_district_code: String(receiver.district_code||''), receiver_commune_code: String(receiver.ward_code||''),
      items: mappedItems,
      cod: Number(o.cod||0),
      weight_gram: mappedItems.reduce(function(s,it){return s + Number(it.weight_grams||0)*Number(it.qty||1)}, 0)
    };

    if(!payload.receiver_province_code){ Admin.toast('Thiếu tỉnh/thành người nhận – hãy nhập địa chỉ đầy đủ hoặc cập nhật code.'); return; }
    const r = await Admin.req('/admin/shipping/create',{method:'POST', body: payload});
    if(r&&r.ok){ Admin.toast('Đã tạo vận đơn'); openPrint(o, r.tracking||r.tracking_code||''); }
    else { Admin.toast('Không thể tạo vận đơn (thiếu cấu hình hoặc dữ liệu).'); }
  }catch(e){ Admin.toast('Không thể tạo vận đơn. Vui lòng kiểm tra cấu hình và dữ liệu đơn.');  }
}); }
if(btnP){ btnP.addEventListener('click', async ()=>{
      var o = (window && window.__currentOrder) || null;
      try{
        var md = document.getElementById('modal-detail');
        var idHint = md ? (md.dataset && md.dataset.orderId) : '';
        if((!o || (idHint && (String(o.id||o._id||'')!==String(idHint)))) && idHint){
           const list2 = await Admin.req('/api/orders',{method:'GET'});
           const items2=(list2&&list2.items)||[];
           o = items2.find(function(x){ return String(x.id||'')===String(idHint); }) || o || null;
        }
      }catch(_e){}
      if(o){ openPrint(o, ''); } else {
        const list = await Admin.req('/api/orders',{method:'GET'});
        const items=(list&&list.items)||[];
        const idTxt = (function(){ var el=modal.querySelector('.card b'); return el?el.textContent:''; })();
        const oo = items.find(function(x){ return (String(x.id||'')===String(idTxt)) || (String(x.id||'').endsWith(String(idTxt).slice(-6))); }) || items[0] || null;
        openPrint(oo, '');
      }
    }); }});
  obs.observe(container, { childList:true, subtree:true });
})();
</script>
</body>
</html>