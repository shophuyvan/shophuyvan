<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ƒê∆°n h√†ng</title>
<link rel="stylesheet" href="./styles.css"/>
<script src="./admin_real.js?v=25"></script>
<style>
.table.order-table { width:100%; border-collapse:separate; border-spacing:0; }
.table.order-table thead th{ background:#f8fafc; border-bottom:1px solid #e5e7eb; font-weight:600; padding:10px 8px; text-align:left; color:#111827; }
.table.order-table tbody td{ border-bottom:1px solid #eef2f7; padding:10px 8px; vertical-align:top; color:#111827; }
.item-cell{ display:flex; gap:10px; align-items:flex-start; }
.item-cell img{ width:48px; height:48px; object-fit:cover; border:1px solid #e5e7eb; border-radius:6px; background:#fff; }
.item-meta .name{ font-weight:600; line-height:1.2; margin-bottom:2px; }
.badge-sm{ display:inline-block; padding:2px 6px; font-size:12px; border:1px solid #e5e7eb; color:#374151; border-radius:6px; background:#f9fafb; }
.text-right{ text-align:right; }
.nowrap{ white-space:nowrap; }
.btn-group{ display:flex; gap:4px; }
.btn-danger{ background:#dc2626; color:#fff; }
.btn-danger:hover{ background:#b91c1c; }
</style>
<link rel="preconnect" href="https://res.cloudinary.com" crossorigin>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">ƒê∆°n h√†ng</div>
    <div class="nav">
      <a href="./products.html" class="badge">S·∫£n ph·∫©m</a>
      <a href="./banners.html" class="badge">Banner</a>
      <a href="./vouchers.html" class="badge">Voucher</a>
      <a href="./orders.html" class="badge">ƒê∆°n h√†ng</a>
      <a href="./stats.html" class="badge">Th·ªëng k√™</a>
      <a href="./shipping.html" class="badge">V·∫≠n chuy·ªÉn</a>
      <a href="./ads.html" class="badge">Qu·∫£ng c√°o</a>
      <span class="badge">API: <span data-api-base></span></span>
    </div>
  </div>

  <div class="card">
    <div id="new-order-banner" style="display:none;margin:10px 0;padding:10px;border:1px solid #16a34a;background:#ecfdf5;color:#065f46;border-radius:6px;">
      C√≥ <strong>ƒë∆°n h√†ng m·ªõi</strong>. <button id="reload-orders" class="btn">T·∫£i l·∫°i</button>
    </div>

    <div class="card">
      <div class="title">Danh s√°ch</div>
      <table class="table order-table">
        <thead>
          <tr>
            <th>M·∫∑t h√†ng</th>
            <th class="nowrap">M√£ ƒë∆°n</th>
            <th class="nowrap">H√£ng VC</th>
            <th class="nowrap">M√£ v·∫≠n ƒë∆°n</th>
            <th class="nowrap">Doanh thu</th>
            <th class="nowrap">Th·ªùi gian</th>
            <th>Ngu·ªìn</th>
            <th class="text-right">Thao t√°c</th>
          </tr>
        </thead>
        <tbody id="list"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal Chi ti·∫øt -->
<div id="modal-detail" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:60">
  <div style="width:min(720px,92vw);background:#fff;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,.25);padding:16px;max-height:90vh;overflow:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:700;font-size:18px">Chi ti·∫øt ƒë∆°n h√†ng</div>
      <button id="md-close" class="btn">ƒê√≥ng</button>
    </div>
    <div id="md-body" style="font-size:14px;color:#111827"></div>
    <div id="ship-actions" class="toolbar" style="margin-top:12px;display:none">
      <button id="btn-create-waybill" class="btn">T·∫°o v·∫≠n ƒë∆°n</button>
      <button id="btn-print-waybill" class="btn">In v·∫≠n ƒë∆°n</button>
    </div>
  </div>
</div>

<script>
// Cloudinary helper
function cloudify(url, transform) {
  if (!url || !url.includes('cloudinary.com')) return url;
  return url.replace('/upload/', '/upload/' + transform + '/');
}

// Format number
function fmt(n) {
  try {
    return Number(n || 0).toLocaleString('vi-VN') + 'ƒë';
  } catch (e) {
    return (n || 0) + 'ƒë';
  }
}

// Get nested value
function g(o, arr) {
  try {
    var v = o;
    for (var i = 0; i < arr.length; i++) {
      if (!v || typeof v !== 'object') return '';
      v = v[arr[i]];
    }
    return (v == null ? '' : v);
  } catch (e) {
    return '';
  }
}

// State
let allOrders = [];

// Load orders
async function loadOrders() {
  try {
    const res = await Admin.req('/api/orders', { method: 'GET' });
    const items = (res && res.items) || [];
    allOrders = items;
    
    const tbody = document.getElementById('list');
    if (!tbody) return;

    function sum(arr, f) {
      return (arr || []).reduce((s, it) => s + Number(f(it) || 0) * Number(it.qty || 1), 0);
    }

    tbody.innerHTML = items.map(function(o) {
      var its = Array.isArray(o.items) ? o.items : [];
      var first = its[0] || {};
      var img = first.image || first.img || first.thumbnail || '';
      img = cloudify(img, 'w_96,q_auto,f_auto,c_fill');
      if (!img) {
        img = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"><rect width="48" height="48" fill="%23f3f4f6"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" font-size="10" fill="%239ca3af">no img</text></svg>');
      }
      var itemTitle = String(first.name || first.title || first.sku || 'S·∫£n ph·∫©m');
      var itemQty = Number(first.qty || first.quantity || 1);
      var sub = sum(its, function(it) { return Number(it.price || 0); });
      var ship = Number(o.shipping_fee || 0);
      var disc = Number(o.discount || 0) + Number(o.shipping_discount || 0);
      var rev = Math.max(0, sub + ship - disc);
      var provider = (o.shipping_provider || o.provider || o.shipping_name || o.ship_name || '').toString();
      var tracking = (o.tracking_code || o.shipping_tracking || o.ship_tracking || (o.shipping && o.shipping.tracking_code) || '').toString();
      var created = (o.created_at || o.createdAt || o.createdAtMs || o.createdAtISO || '');
      var tStr = '';
      try {
        var d = (typeof created === 'number' || /^[0-9]+$/.test(created)) ? new Date(Number(created)) : (created ? new Date(created) : null);
        tStr = d ? d.toLocaleString('vi-VN') : '';
      } catch (e) {
        tStr = '';
      }
      var source = (o.source || o.channel || o.platform || 'Web').toString();
      var id = (o.id || '').toString();
      
      return '<tr>' +
        '<td><div class="item-cell"><img src="' + img + '"/><div class="item-meta"><div class="name">' + itemTitle + '</div><div>x' + itemQty + '</div></div></div></td>' +
        '<td class="nowrap">' + id + '</td>' +
        '<td class="nowrap">' + provider + '</td>' +
        '<td class="nowrap">' + (tracking || '-') + '</td>' +
        '<td class="nowrap">' + fmt(rev) + '</td>' +
        '<td class="nowrap">' + tStr + '</td>' +
        '<td>' + (source || '') + '</td>' +
        '<td class="text-right"><div class="btn-group"><button class="btn btn-sm" data-view="' + id + '">Xem</button><button class="btn btn-sm btn-danger" data-delete="' + id + '">Xo√°</button></div></td>' +
        '</tr>';
    }).join('');

    // Wire view buttons
    tbody.querySelectorAll('[data-view]').forEach(btn => {
      btn.onclick = () => {
        const id = btn.getAttribute('data-view');
        const o = allOrders.find(x => (x.id || '') === id);
        if (o) showOrderDetail(o);
      };
    });

    // Wire delete buttons
    tbody.querySelectorAll('[data-delete]').forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute('data-delete');
        if (!confirm('X√°c nh·∫≠n xo√° ƒë∆°n h√†ng ' + id + '?')) return;
        try {
          const r = await Admin.req('/admin/orders/delete', { method: 'POST', body: { id: id } });
          if (r && r.ok) {
            Admin.toast('‚úÖ ƒê√£ xo√° ƒë∆°n h√†ng');
            loadOrders();
          } else {
            alert('Xo√° th·∫•t b·∫°i: ' + (r?.message || 'L·ªói'));
          }
        } catch (e) {
          alert('L·ªói xo√° ƒë∆°n: ' + e.message);
        }
      };
    });

    var reloadBtn = document.getElementById('reload-orders');
    if (reloadBtn) {
      reloadBtn.onclick = loadOrders;
    }
  } catch (e) {
    console.error('Load orders error:', e);
  }
}

// Show order detail
function showOrderDetail(o) {
  window.__currentOrder = o;
  const modal = document.getElementById('modal-detail');
  const body = document.getElementById('md-body');
  const actions = document.getElementById('ship-actions');
  
  if (modal) modal.dataset.orderId = (o && (o.id || o._id || '')) || '';

  const its = Array.isArray(o.items) ? o.items : [];
  const sub = its.reduce((s, it) => s + Number(it.price || 0) * Number(it.qty || 1), 0);
  const ship = Number(o.shipping_fee || 0);
  const disc = Number(o.discount || 0) + Number(o.shipping_discount || 0);
  const total = Math.max(0, sub + ship - disc);
  const addr = (o.address || (o.customer && o.customer.address) || '');
  const shipName = o.shipping_name || o.ship_name || o.shipping_provider || o.provider || '';
  const tracking = o.tracking_code || o.shipping_tracking || '';
  const eta = o.shipping_eta || '';
  const when = o.createdAt ? new Date(Number(o.createdAt)).toLocaleString('vi-VN') : '';
  const cust = o.customer || {};

  const rows = its.map(it => `
    <tr>
      <td>${it.sku || it.id || ''}</td>
      <td>${(it.name || '') + (it.variant ? (' - ' + it.variant) : '')}</td>
      <td style="text-align:right">${it.qty || 1}</td>
      <td style="text-align:right">${fmt(it.price || 0)}</td>
      <td style="text-align:right">${fmt(it.cost || 0)}</td>
      <td style="text-align:right">${fmt((it.price || 0) * (it.qty || 1))}</td>
    </tr>`).join('');

  body.innerHTML = `
    <div style="margin-bottom:8px">
      <div><b>Kh√°ch:</b> ${cust.name || o.customer_name || o.name || 'Kh√°ch'} ${cust.phone ? ('‚Ä¢ ' + cust.phone) : ''}</div>
      ${addr ? ('<div><b>ƒê·ªãa ch·ªâ:</b> ' + addr + '</div>') : ''}
      ${shipName ? ('<div><b>V·∫≠n chuy·ªÉn:</b> ' + shipName + (tracking ? (' ‚Ä¢ M√£: ' + tracking) : '') + (eta ? (' ‚Ä¢ ' + eta) : '') + '</div>') : ''}
      ${when ? ('<div><b>Ng√†y t·∫°o:</b> ' + when + '</div>') : ''}
      <div><b>Tr·∫°ng th√°i:</b> ${o.status || 'pending'}</div>
    </div>
    <div class="card">
      <table class="table md-table">
        <thead><tr><th>M√£ SP</th><th>T√™n/Ph√¢n lo·∫°i</th><th>SL</th><th>Gi√° b√°n</th><th>Gi√° v·ªën</th><th>Th√†nh ti·ªÅn</th></tr></thead>
        <tbody>${rows || '<tr><td colspan="6" style="color:#6b7280">Kh√¥ng c√≥ d√≤ng h√†ng</td></tr>'}</tbody>
      </table>
      <div style="border-top:1px dashed #e5e7eb;margin-top:8px;padding-top:8px">
        <div style="display:flex;justify-content:space-between"><span>T·ªïng h√†ng</span><b>${fmt(sub)}</b></div>
        <div style="display:flex;justify-content:space-between"><span>Ph√≠ v·∫≠n chuy·ªÉn</span><b>${fmt(ship)}</b></div>
        ${disc ? ('<div style="display:flex;justify-content:space-between;color:#059669"><span>Gi·∫£m</span><b>-' + fmt(disc) + '</b></div>') : ''}
        <div style="display:flex;justify-content:space-between;font-size:16px"><span>T·ªïng thanh to√°n</span><b>${fmt(total)}</b></div>
      </div>
    </div>`;

  // Show shipping actions if has tracking or can create
  if (actions) {
    actions.style.display = 'flex';
  }

  modal.style.display = 'flex';
}

// Print waybill
function openPrint(order, tracking) {
  const html = `<!doctype html><html><head><meta charset="utf-8"><title>V·∫≠n ƒë∆°n</title>
    <style>body{font-family:system-ui,-apple-system,sans-serif;padding:16px}
    .box{border:1px dashed #444;padding:12px;margin-bottom:12px}
    .row{display:flex;justify-content:space-between}</style></head><body>
    <h2>V·∫≠n ƒë∆°n - ${(g(order, ['shipping_name']) || g(order, ['shipping_provider']) || '')}</h2>
    <div class="box"><div><b>Tracking:</b> ${tracking || (g(order, ['tracking']) || '')}</div>
    <div><b>ƒê∆°n h√†ng:</b> ${(g(order, ['id']) || '')}</div>
    <div><b>Kh√°ch:</b> ${(g(order, ['customer', 'name']) || g(order, ['customer_name']) || g(order, ['name']) || '')}</div>
    <div><b>ƒêT:</b> ${(g(order, ['customer', 'phone']) || g(order, ['phone']) || '')}</div>
    <div><b>ƒê·ªãa ch·ªâ:</b> ${(g(order, ['customer', 'address']) || g(order, ['address']) || '')}</div></div>
    <div class="box"><div class="row"><span>Ph√≠ VC:</span><b>${(Number(g(order, ['shipping_fee']) || 0).toLocaleString('vi-VN'))}ƒë</b></div>
    <div class="row"><span>T·ªïng:</span><b>${(Number(g(order, ['revenue']) || 0).toLocaleString('vi-VN'))}ƒë</b></div></div>
    <script>window.onload=()=>window.print()<\/script></body></html>`;
  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
}

// Create waybill
// PATCH 2: Thay th·∫ø h√†m createWaybill trong orders.html
// T√¨m h√†m async function createWaybill() c≈© v√† thay b·∫±ng code n√†y:

async function createWaybill() {
  try {
    const order = window.__currentOrder;
    if (!order) {
      Admin.toast('‚ùå Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng');
      return;
    }
    
    console.log('üì¶ Creating waybill for order:', order);
    Admin.toast('üîÑ ƒêang t·∫°o v·∫≠n ƒë∆°n...');
    
    // Get settings
    const settings = await Admin.req('/public/settings', { method: 'GET' });
    
    // Helper to get nested setting value
    const getSetting = (path) => {
      const keys = path.split('.');
      let value = settings?.settings || settings;
      for (const key of keys) {
        value = value?.[key];
        if (value === undefined) return '';
      }
      return value || '';
    };
    
    // === SENDER INFO ===
    const sender = {
      name: getSetting('shipping.sender_name') || 'SHOP HUY V√ÇN',
      phone: getSetting('shipping.sender_phone') || '0909127967',
      address: getSetting('shipping.sender_address') || '91/6 Li√™n Khu 5-11-12',
      province_code: getSetting('shipping.sender_province_code') || '79',
      district_code: getSetting('shipping.sender_district_code') || '760',
      commune_code: getSetting('shipping.sender_commune_code') || '',
      province: getSetting('shipping.sender_province') || 'H·ªì Ch√≠ Minh',
      district: getSetting('shipping.sender_district') || 'B√¨nh T√¢n'
    };
    
    console.log('üì§ Sender info:', sender);
    
    // Validate sender - QUAN TR·ªåNG!
    if (!sender.province_code || !sender.district_code) {
      alert('‚ö†Ô∏è TH√îNG TIN NG∆Ø·ªúI G·ª¨I CH∆ØA ƒê·∫¶Y ƒê·ª¶!\n\n' +
            'Hi·ªán t·∫°i:\n' +
            `‚Ä¢ T·ªânh: ${sender.province_code || 'CH∆ØA C√ì'}\n` +
            `‚Ä¢ Qu·∫≠n: ${sender.district_code || 'CH∆ØA C√ì'}\n\n` +
            'Vui l√≤ng:\n' +
            '1. V√†o trang "V·∫≠n chuy·ªÉn"\n' +
            '2. B·∫•m "ƒê·ªìng b·ªô t·ª´ Warehouses"\n' +
            '3. Ki·ªÉm tra th√¥ng tin v√† b·∫•m "L∆∞u ng∆∞·ªùi g·ª≠i"');
      return;
    }
    
    // === RECEIVER INFO ===
    const customer = order.customer || {};
    const receiver = {
      name: customer.name || order.customer_name || order.name || 'Kh√°ch',
      phone: customer.phone || order.phone || '',
      address: customer.address || order.address || '',
      // Try multiple possible field names for codes
      province_code: customer.province_code || order.receiver_province_code || 
                    order.province_code || order.to_province_code || '',
      district_code: customer.district_code || order.receiver_district_code || 
                    order.district_code || order.to_district_code || '',
      commune_code: customer.commune_code || customer.ward_code || 
                   order.receiver_commune_code || order.commune_code || 
                   order.ward_code || order.to_commune_code || '',
      // Names for display
      province: customer.province || order.province || '',
      district: customer.district || order.district || ''
    };
    
    console.log('üì• Receiver info:', receiver);
    
    // Validate receiver - QUAN TR·ªåNG!
    const missingFields = [];
    if (!receiver.province_code) missingFields.push('T·ªânh/Th√†nh ph·ªë');
    if (!receiver.district_code) missingFields.push('Qu·∫≠n/Huy·ªán');
    
    if (missingFields.length > 0) {
      alert('‚ö†Ô∏è ƒê∆†N H√ÄNG THI·∫æU TH√îNG TIN NG∆Ø·ªúI NH·∫¨N!\n\n' +
            'Thi·∫øu: ' + missingFields.join(', ') + '\n\n' +
            'Th√¥ng tin hi·ªán t·∫°i:\n' +
            `‚Ä¢ T·ªânh code: ${receiver.province_code || 'CH∆ØA C√ì'}\n` +
            `‚Ä¢ Qu·∫≠n code: ${receiver.district_code || 'CH∆ØA C√ì'}\n` +
            `‚Ä¢ Ph∆∞·ªùng code: ${receiver.commune_code || 'CH∆ØA C√ì'}\n\n` +
            'Vui l√≤ng:\n' +
            '1. C·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß cho kh√°ch h√†ng\n' +
            '2. ƒê·∫£m b·∫£o ch·ªçn t·ª´ dropdown (ƒë·ªÉ c√≥ m√£ t·ªânh/qu·∫≠n)\n' +
            '3. Th·ª≠ t·∫°o v·∫≠n ƒë∆°n l·∫°i');
      return;
    }
    
    // === ITEMS ===
    const items = (order.items || []).map(item => ({
      name: item.name || item.title || 'S·∫£n ph·∫©m',
      qty: Number(item.qty || 1),
      price: Number(item.price || 0),
      weight_grams: Number(item.weight_gram || item.weight_grams || item.weight || 0)
    }));
    
    // Calculate total weight
    const totalWeight = items.reduce((sum, item) => 
      sum + (item.weight_grams || 0) * (item.qty || 1), 0);
    
    // === BUILD PAYLOAD ===
    const payload = {
      provider: (order.shipping_provider || order.provider || 'vtp').toLowerCase(),
      order_id: order.id || order._id || '',
      
      // Sender (ng∆∞·ªùi g·ª≠i)
      sender_name: sender.name,
      sender_phone: sender.phone,
      sender_address: sender.address,
      sender_province_code: String(sender.province_code),
      sender_district_code: String(sender.district_code),
      sender_commune_code: String(sender.commune_code),
      sender_province: sender.province,
      sender_district: sender.district,
      
      // Receiver (ng∆∞·ªùi nh·∫≠n)
      receiver_name: receiver.name,
      receiver_phone: receiver.phone,
      receiver_address: receiver.address,
      receiver_province_code: String(receiver.province_code),
      receiver_district_code: String(receiver.district_code),
      receiver_commune_code: String(receiver.commune_code),
      receiver_province: receiver.province || 'T·ªânh/TP',
      receiver_district: receiver.district || 'Qu·∫≠n/Huy·ªán',
      
      // Aliases (m·ªôt s·ªë carrier c·∫ßn c√°c field n√†y)
      province_code: String(receiver.province_code),
      district_code: String(receiver.district_code),
      commune_code: String(receiver.commune_code),
      to_province_code: String(receiver.province_code),
      to_district_code: String(receiver.district_code),
      to_commune_code: String(receiver.commune_code),
      
      // Package info
      items: items,
      cod: Number(order.cod || 0),
      weight_gram: totalWeight || 500,
      note: order.note || '',
      service_code: order.shipping_service || order.service_code || ''
    };
    
    console.log('üìã Waybill payload:', JSON.stringify(payload, null, 2));
    
    // === CALL API ===
    const result = await Admin.req('/admin/shipping/create', {
      method: 'POST',
      body: payload
    });
    
    console.log('üì¨ Waybill result:', result);
    
    // === HANDLE RESULT ===
    if (result && result.ok) {
      Admin.toast('‚úÖ ƒê√£ t·∫°o v·∫≠n ƒë∆°n th√†nh c√¥ng');
      const tracking = result.tracking || result.tracking_code || result.code || '';
      
      if (tracking) {
        // Update order with tracking code
        try {
          await Admin.req('/admin/orders/upsert', {
            method: 'POST',
            body: {
              id: order.id,
              tracking_code: tracking,
              shipping_provider: payload.provider,
              status: 'shipping'
            }
          });
          console.log('‚úÖ Updated order with tracking:', tracking);
        } catch (e) {
          console.error('‚ö†Ô∏è Update order error:', e);
        }
        
        // Print waybill
        openPrint(order, tracking);
      }
      
      // Reload orders list
      setTimeout(loadOrders, 1000);
      
    } else {
      // Error handling
      const errorMsg = result?.error || result?.message || 'Kh√¥ng r√µ l·ªói';
      console.error('‚ùå Waybill creation failed:', result);
      
      Admin.toast('‚ùå L·ªói: ' + errorMsg);
      
      alert('‚ùå T·∫†O V·∫¨N ƒê∆†N TH·∫§T B·∫†I\n\n' +
            'L·ªói: ' + errorMsg + '\n\n' +
            'Chi ti·∫øt:\n' + JSON.stringify(result, null, 2) + '\n\n' +
            'Ki·ªÉm tra:\n' +
            '1. Th√¥ng tin ng∆∞·ªùi g·ª≠i ƒë√£ ƒë·∫ßy ƒë·ªß?\n' +
            '2. Th√¥ng tin ng∆∞·ªùi nh·∫≠n c√≥ ƒë√∫ng?\n' +
            '3. API token c√≤n hi·ªáu l·ª±c?');
    }
    
  } catch (error) {
    console.error('‚ùå Create waybill exception:', error);
    Admin.toast('‚ùå L·ªói: ' + error.message);
    alert('‚ùå L·ªñI T·∫†O V·∫¨N ƒê∆†N\n\n' + 
          'Message: ' + error.message + '\n\n' +
          'Stack: ' + (error.stack || 'N/A'));
  }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
  Admin.renderApiBase();
  loadOrders();

  // Close modal
  const btnClose = document.getElementById('md-close');
  if (btnClose) {
    btnClose.onclick = () => {
      document.getElementById('modal-detail').style.display = 'none';
    };
  }

  // Click outside to close
  const modal = document.getElementById('modal-detail');
  if (modal) {
    modal.onclick = (e) => {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    };
  }

  // Create waybill button
  const btnCreate = document.getElementById('btn-create-waybill');
  if (btnCreate) {
    btnCreate.onclick = createWaybill;
  }

  // Print waybill button
  const btnPrint = document.getElementById('btn-print-waybill');
  if (btnPrint) {
    btnPrint.onclick = () => {
      const o = window.__currentOrder;
      if (o) {
        openPrint(o, o.tracking_code || o.shipping_tracking || '');
      }
    };
  }
});

console.log('‚úÖ Orders page ready');
</script>

</body>
</html>