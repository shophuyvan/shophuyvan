<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ƒê∆°n h√†ng</title>
  <link rel="stylesheet" href="./styles.css"/>
  <script src="./admin_real.js?v=25"></script>
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f7fa; }
    
    /* Header */
    .header { background: #fff; border-bottom: 1px solid #e5e7eb; padding: 1rem 2rem; }
    .header h1 { font-size: 1.5rem; font-weight: 600; color: #1f2937; margin-bottom: 0.75rem; }
    .tabs { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .tab { padding: 0.5rem 1rem; border-radius: 6px; background: #f3f4f6; color: #6b7280; text-decoration: none; font-size: 0.875rem; transition: all 0.2s; }
    .tab:hover { background: #e5e7eb; color: #374151; }
    .tab.active { background: #3b82f6; color: #fff; }
    .tab .count { margin-left: 0.25rem; font-weight: 600; }
    
    /* Container */
    .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem 2rem; }
    
    /* Toolbar */
    .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.75rem; }
    .btn-group { display: flex; gap: 0.5rem; }
    .btn { padding: 0.625rem 1.25rem; border-radius: 8px; border: none; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; }
    .btn-primary { background: #3b82f6; color: #fff; }
    .btn-primary:hover { background: #2563eb; }
    .btn-secondary { background: #fff; color: #374151; border: 1px solid #d1d5db; }
    .btn-secondary:hover { background: #f9fafb; }
    .search-box { position: relative; }
    .search-box input { padding: 0.625rem 2.5rem 0.625rem 1rem; border: 1px solid #d1d5db; border-radius: 8px; width: 300px; font-size: 0.875rem; }
    .search-box input:focus { outline: none; border-color: #3b82f6; }
    
    /* Table */
    .table-wrapper { background: #fff; border-radius: 12px; border: 1px solid #e5e7eb; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    thead { background: #f9fafb; border-bottom: 1px solid #e5e7eb; }
    th { padding: 0.875rem 1rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; }
    td { padding: 1rem; border-bottom: 1px solid #f3f4f6; font-size: 0.875rem; color: #374151; }
    tbody tr:hover { background: #f9fafb; }
    tbody tr:last-child td { border-bottom: none; }
    
    /* Product cell */
    .product-cell { display: flex; align-items: center; gap: 0.75rem; }
    .product-img { width: 48px; height: 48px; border-radius: 6px; object-fit: cover; border: 1px solid #e5e7eb; }
    .product-info { flex: 1; }
    .product-name { font-weight: 500; color: #1f2937; margin-bottom: 0.25rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .product-variant { font-size: 0.75rem; color: #6b7280; }
    
    /* Status badges */
    .status { padding: 0.25rem 0.625rem; border-radius: 6px; font-size: 0.75rem; font-weight: 500; display: inline-block; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-shipping { background: #dbeafe; color: #1e40af; }
    .status-delivered { background: #d1fae5; color: #065f46; }
    .status-cancelled { background: #fee2e2; color: #991b1b; }
    
    /* Source badges */
    .source { padding: 0.25rem 0.625rem; border-radius: 6px; font-size: 0.75rem; background: #f3f4f6; color: #4b5563; display: inline-flex; align-items: center; gap: 0.25rem; }
    .source-web::before { content: 'üåê'; }
    .source-zalo::before { content: 'üí¨'; }
    .source-tiktok::before { content: 'üéµ'; }
    
    /* Actions */
    .actions { display: flex; gap: 0.5rem; }
    .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.813rem; }
    .btn-danger { background: #ef4444; color: #fff; }
    .btn-danger:hover { background: #dc2626; }
    
    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal.active { display: flex; }
    .modal-content { background: #fff; border-radius: 12px; width: min(800px, 90vw); max-height: 90vh; overflow: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    .modal-header { padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h2 { font-size: 1.25rem; font-weight: 600; color: #1f2937; }
    .modal-body { padding: 1.5rem; }
    .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 0.75rem; }
    
    /* Info grid */
    .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    .info-item { display: flex; flex-direction: column; gap: 0.25rem; }
    .info-label { font-size: 0.75rem; color: #6b7280; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; }
    .info-value { font-size: 0.875rem; color: #1f2937; font-weight: 500; }
    
    /* Items table */
    .items-table { margin-top: 1.5rem; }
    .items-table table { font-size: 0.875rem; }
    .items-table th { background: #f9fafb; }
    
    /* Summary */
    .summary { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px dashed #e5e7eb; }
    .summary-row { display: flex; justify-content: space-between; padding: 0.5rem 0; font-size: 0.875rem; }
    .summary-row.total { font-size: 1rem; font-weight: 600; color: #1f2937; padding-top: 0.75rem; border-top: 1px solid #e5e7eb; margin-top: 0.5rem; }
  </style>
</head>

<body>
  <!-- Header -->
  <div class="header">
    <h1>ƒê∆°n h√†ng</h1>
    <div class="tabs">
      <a href="#" class="tab active">T·∫•t C·∫£ <span class="count">112</span></a>
      <a href="#" class="tab">Ch·ªù L·∫•y H√†ng <span class="count">108</span></a>
      <a href="#" class="tab">ƒêang Giao</a>
      <a href="#" class="tab">ƒê√£ Giao</a>
      <a href="#" class="tab">Giao Kh√¥ng Th√†nh C√¥ng <span class="count">7</span></a>
      <a href="#" class="tab">Tr·∫£ H√†ng/Ho√†n Ti·ªÅn <span class="count">9</span></a>
      <a href="#" class="tab">ƒê√£ H·ªßy <span class="count">1</span></a>
    </div>
  </div>

  <!-- Container -->
  <div class="container">
    <!-- Toolbar -->
    <div class="toolbar">
      <div class="btn-group">
        <button class="btn btn-primary" id="btn-create">
          <span>üì¶</span> Chu·∫©n b·ªã h√†ng
        </button>
        <button class="btn btn-secondary">
          <span>üñ®Ô∏è</span> In ƒë∆°n ho√° t·ªëc
        </button>
        <button class="btn btn-secondary">
          <span>üìã</span> Xem h√†ng
        </button>
      </div>
      <div class="search-box">
        <input type="text" placeholder="ID ƒë∆°n, m√£ v·∫≠n ƒë∆°n..." />
      </div>
    </div>

    <!-- Table -->
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th style="width:40px"></th>
            <th>M·∫∑t H√†ng</th>
            <th>M√£ ƒê∆°n H√†ng</th>
            <th>M√£ V·∫≠n ƒê∆°n</th>
            <th style="text-align:right">Doanh Thu</th>
            <th>Th·ªùi Gian</th>
            <th>Ngu·ªìn</th>
            <th style="text-align:right">Thao t√°c</th>
          </tr>
        </thead>
        <tbody id="orders-list"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal-detail" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Chi ti·∫øt ƒë∆°n h√†ng</h2>
        <button class="btn btn-secondary btn-sm" id="btn-close">ƒê√≥ng</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="btn-print">In v·∫≠n ƒë∆°n</button>
        <button class="btn btn-primary" id="btn-create-waybill">T·∫°o v·∫≠n ƒë∆°n</button>
      </div>
    </div>
  </div>

  <script src="./orders-manager.js"></script>
  <script src="./waybill-creator.js"></script>
  
  <script>
    // Mini implementation for demo
    class OrdersManagerUI {
      constructor() {
        this.orders = [];
        this.currentOrder = null;
      }

      formatPrice(n) {
        return Number(n || 0).toLocaleString('vi-VN') + 'ƒë';
      }

      formatDate(d) {
        try {
          const date = new Date(typeof d === 'number' ? d : Date.parse(d));
          return date.toLocaleString('vi-VN', { 
            hour: '2-digit', minute: '2-digit', 
            day: '2-digit', month: '2-digit', year: 'numeric' 
          });
        } catch { return ''; }
      }

      getStatusClass(status) {
        const map = {
          pending: 'status-pending',
          shipping: 'status-shipping',
          delivered: 'status-delivered',
          cancelled: 'status-cancelled'
        };
        return map[status] || 'status-pending';
      }

      getStatusText(status) {
        const map = {
          pending: 'Ch·ªù x·ª≠ l√Ω',
          shipping: 'ƒêang giao',
          delivered: 'ƒê√£ giao',
          cancelled: 'ƒê√£ h·ªßy'
        };
        return map[status] || status;
      }

      getSourceClass(source) {
        const s = (source || '').toLowerCase();
        if (s.includes('zalo')) return 'source-zalo';
        if (s.includes('tiktok')) return 'source-tiktok';
        return 'source-web';
      }

      async loadOrders() {
        try {
          const res = await Admin.req('/api/orders');
          this.orders = res?.items || [];
          this.renderOrders();
        } catch (e) {
          console.error('Load orders error:', e);
        }
      }

      renderOrders() {
        const tbody = document.getElementById('orders-list');
        if (!tbody) return;

        tbody.innerHTML = this.orders.map(order => {
          const items = order.items || [];
          const first = items[0] || {};
          const img = first.image || first.img || '';
          const productName = first.product_name || first.name || 'S·∫£n ph·∫©m';
          const variantName = first.variant_name || first.variant || '';
          const fullName = variantName ? `${productName} - ${variantName}` : productName;
          
          const { total } = this.calculateTotals(order);
          const source = order.source || order.channel || 'Website';
          
          return `<tr>
            <td><input type="checkbox" /></td>
            <td>
              <div class="product-cell">
                <img src="${img || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'48\' height=\'48\'%3E%3Crect fill=\'%23e5e7eb\' width=\'48\' height=\'48\'/%3E%3C/svg%3E'}" class="product-img" />
                <div class="product-info">
                  <div class="product-name">${fullName}</div>
                  <div class="product-variant">x${first.qty || 1}</div>
                </div>
              </div>
            </td>
            <td><span style="font-family:monospace;font-size:0.813rem">${String(order.id).substring(0,16)}...</span></td>
            <td>${order.tracking_code || '-'}</td>
            <td style="text-align:right">${this.formatPrice(total)}</td>
            <td>${this.formatDate(order.created_at || order.createdAt)}</td>
            <td><span class="source ${this.getSourceClass(source)}">${source}</span></td>
            <td style="text-align:right">
              <div class="actions">
                <button class="btn btn-secondary btn-sm" data-view="${order.id}">Xem</button>
                <button class="btn btn-danger btn-sm" data-delete="${order.id}">Xo√°</button>
              </div>
            </td>
          </tr>`;
        }).join('');

        this.wireEvents();
      }

      calculateTotals(order) {
        const items = order.items || [];
        const subtotal = items.reduce((sum, item) => 
          sum + Number(item.price || 0) * Number(item.qty || 1), 0);
        const shipping = Number(order.shipping_fee || 0);
        const discount = Number(order.discount || 0);
        const total = subtotal + shipping - discount;
        return { subtotal, shipping, discount, total };
      }

      wireEvents() {
        document.querySelectorAll('[data-view]').forEach(btn => {
          btn.onclick = () => {
            const id = btn.getAttribute('data-view');
            const order = this.orders.find(o => String(o.id) === id);
            if (order) this.showDetail(order);
          };
        });

        document.querySelectorAll('[data-delete]').forEach(btn => {
          btn.onclick = async () => {
            const id = btn.getAttribute('data-delete');
            if (!confirm('X√°c nh·∫≠n xo√° ƒë∆°n h√†ng?')) return;
            try {
              await Admin.req('/admin/orders/delete', { method: 'POST', body: { id } });
              Admin.toast('‚úÖ ƒê√£ xo√°');
              this.loadOrders();
            } catch (e) {
              alert('L·ªói: ' + e.message);
            }
          };
        });
      }

      showDetail(order) {
        this.currentOrder = order;
        window.__currentOrder = order;

        const modal = document.getElementById('modal-detail');
        const body = document.getElementById('modal-body');
        
        const { subtotal, shipping, discount, total } = this.calculateTotals(order);
        const customer = order.customer || {};

        body.innerHTML = `
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Kh√°ch h√†ng</div>
              <div class="info-value">${customer.name || order.customer_name || 'N/A'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">S·ªë ƒëi·ªán tho·∫°i</div>
              <div class="info-value">${customer.phone || order.phone || 'N/A'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">ƒê·ªãa ch·ªâ</div>
              <div class="info-value">${customer.address || order.address || 'N/A'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">V·∫≠n chuy·ªÉn</div>
              <div class="info-value">${order.shipping_provider || 'Ch∆∞a ch·ªçn'}</div>
            </div>
          </div>

          <div class="items-table">
            <table>
              <thead><tr><th>S·∫£n ph·∫©m</th><th>SL</th><th style="text-align:right">ƒê∆°n gi√°</th><th style="text-align:right">Th√†nh ti·ªÅn</th></tr></thead>
              <tbody>
                ${(order.items || []).map(item => {
                  const name = item.product_name || item.name || 'S·∫£n ph·∫©m';
                  const variant = item.variant_name || item.variant || '';
                  return `<tr>
                    <td>${variant ? `${name} - ${variant}` : name}</td>
                    <td>${item.qty || 1}</td>
                    <td style="text-align:right">${this.formatPrice(item.price)}</td>
                    <td style="text-align:right">${this.formatPrice((item.price || 0) * (item.qty || 1))}</td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>

          <div class="summary">
            <div class="summary-row"><span>T·ªïng h√†ng</span><span>${this.formatPrice(subtotal)}</span></div>
            <div class="summary-row"><span>Ph√≠ v·∫≠n chuy·ªÉn</span><span>${this.formatPrice(shipping)}</span></div>
            ${discount > 0 ? `<div class="summary-row"><span>Gi·∫£m gi√°</span><span>-${this.formatPrice(discount)}</span></div>` : ''}
            <div class="summary-row total"><span>T·ªïng thanh to√°n</span><span>${this.formatPrice(total)}</span></div>
          </div>
        `;

        modal.classList.add('active');
      }

      init() {
        this.loadOrders();

        document.getElementById('btn-close')?.addEventListener('click', () => {
          document.getElementById('modal-detail').classList.remove('active');
        });

        document.getElementById('btn-create-waybill')?.addEventListener('click', async () => {
          if (!this.currentOrder) return;
          if (window.waybillCreator) {
            await window.waybillCreator.createWaybill(this.currentOrder);
          } else if (window.ordersManager) {
            await window.ordersManager.createWaybill(this.currentOrder);
          }
        });

        document.getElementById('modal-detail')?.addEventListener('click', (e) => {
          if (e.target.id === 'modal-detail') {
            e.target.classList.remove('active');
          }
        });
      }
    }

    window.ordersManagerUI = new OrdersManagerUI();
    document.addEventListener('DOMContentLoaded', () => {
      if (window.Admin) {
        window.ordersManagerUI.init();
      }
    });
  </script>
</body>
</html>