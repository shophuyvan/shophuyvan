<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Qu·∫£n l√Ω Banner</title>
  <link rel="stylesheet" href="./styles.css"/>
  <script src="./admin_real.js?v=26"></script>
  <script src="./sidebar-layout.js"></script>
  
  <!-- Cropper.js -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  
  <style>
    .banner-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
    }
    .banner-tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 600;
      color: #6b7280;
      transition: all 0.2s;
    }
    .banner-tab:hover {
      color: #111827;
      background: #f9fafb;
    }
    .banner-tab.active {
      color: #059669;
      border-bottom-color: #059669;
    }
    .banner-section {
      display: none;
    }
    .banner-section.active {
      display: block;
    }
    
    /* ƒê√£ x√≥a Crop Modal CSS */
    
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      font-size: 14px;
      color: #374151;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .thumbnail-preview {
      width: 120px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
    }
    .banner-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .banner-info {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 15px;
      align-items: start;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-on {
      background: #d1fae5;
      color: #065f46;
    }
    .status-off {
      background: #fee2e2;
      color: #991b1b;
    }
  </style>
</head>
<body>

<!-- Platform Tabs -->
<div class="banner-tabs">
  <button class="banner-tab active" data-platform="fe">
    üåê Banner Trang Web (FE)
  </button>
  <button class="banner-tab" data-platform="mini">
    üì± Banner Mini App
  </button>
</div>

<!-- Banner FE Section -->
<div class="banner-section active" id="section-fe">
  <div class="card">
    <h3>Th√™m Banner Trang Web</h3>
    
    <div class="form-group">
      <label>üñ•Ô∏è Upload Banner Desktop (1920x600)</label>
      <input id="fe-desktop-file" type="file" accept="image/*" class="input"/>
      <small style="color:#6b7280;">Khuy·∫øn ngh·ªã: K√≠ch th∆∞·ªõc 1920x600px</small>
      <div id="fe-desktop-preview" style="margin-top:10px;display:none;">
        <img style="max-width:300px;border:1px solid #e5e7eb;border-radius:4px;" id="fe-desktop-preview-img"/>
        <input id="fe-desktop-url" class="input" readonly style="margin-top:5px;"/>
      </div>
    </div>

    <div class="form-group">
      <label>üì± Upload Banner Mobile (1080x720)</label>
      <input id="fe-mobile-file" type="file" accept="image/*" class="input"/>
      <small style="color:#6b7280;">Khuy·∫øn ngh·ªã: K√≠ch th∆∞·ªõc 1080x720px</small>
      <div id="fe-mobile-preview" style="margin-top:10px;display:none;">
        <img style="max-width:200px;border:1px solid #e5e7eb;border-radius:4px;" id="fe-mobile-preview-img"/>
        <input id="fe-mobile-url" class="input" readonly style="margin-top:5px;"/>
      </div>
    </div>

    <div class="form-group">
      <label>Th·ª© t·ª± hi·ªÉn th·ªã</label>
      <input id="fe-order" type="number" value="0" class="input"/>
    </div>
    
    <div class="form-group">
      <label>Lo·∫°i banner</label>
      <select id="fe-type" class="input">
        <option value="fe_banner" selected>Banner th∆∞·ªùng (FE)</option>
        <option value="category_hero">Category Hero</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>Category Slug (d√πng khi ch·ªçn Category Hero)</label>
      <input id="fe-cat" class="input" placeholder="v√≠ d·ª•: thiet-bi-dien-nuoc"/>
    </div>

    <div class="form-group">
      <label>M√¥ t·∫£ ·∫£nh (ALT)</label>
      <input id="fe-alt" class="input" placeholder="Banner khuy·∫øn m√£i..."/>
    </div>

    <div class="form-group">
      <label>Li√™n k·∫øt (URL ƒë√≠ch khi click)</label>
      <input id="fe-link" class="input" placeholder="https://..."/>
    </div>

    <div class="form-group">
      <label>Tr·∫°ng th√°i</label>
      <select id="fe-on" class="input">
        <option value="true">ON - Hi·ªÉn th·ªã</option>
        <option value="false">OFF - ·∫®n</option>
      </select>
    </div>

    <button class="btn primary" id="fe-save">üíæ L∆∞u Banner FE</button>
  </div>

  <h3>Danh s√°ch Banner Trang Web</h3>
  <div id="fe-banner-list">
    <p style="text-align:center;color:#6b7280;padding:30px">ƒêang t·∫£i...</p>
  </div>
</div>

<!-- Banner Mini Section -->
<div class="banner-section" id="section-mini">
  <div class="card">
    <h3>Th√™m Banner Mini App (Mobile Only)</h3>
    
    <div class="form-group">
      <label>üìÅ Upload ·∫£nh Mobile (1080x720)</label>
      <input id="mini-file" type="file" accept="image/*" class="input"/>
      <small style="color:#6b7280;">Khuy·∫øn ngh·ªã: ·∫¢nh t·ªâ l·ªá 3:2, k√≠ch th∆∞·ªõc t·ªëi thi·ªÉu 1080x720px</small>
    </div>

    <div id="mini-images" style="display:none;">
      <div class="form-group">
        <label>üì± Mobile URL</label>
        <input id="mini-mobile-url" class="input" readonly/>
      </div>
    </div>

    <div class="form-group">
      <label>Th·ª© t·ª± hi·ªÉn th·ªã</label>
      <input id="mini-order" type="number" value="0" class="input"/>
    </div>

    <div class="form-group">
      <label>M√¥ t·∫£ ·∫£nh (ALT)</label>
      <input id="mini-alt" class="input" placeholder="Banner khuy·∫øn m√£i..."/>
    </div>

    <div class="form-group">
      <label>Li√™n k·∫øt (URL ƒë√≠ch khi click)</label>
      <input id="mini-link" class="input" placeholder="/product/..."/>
    </div>

    <div class="form-group">
      <label>Tr·∫°ng th√°i</label>
      <select id="mini-on" class="input">
        <option value="true">ON - Hi·ªÉn th·ªã</option>
        <option value="false">OFF - ·∫®n</option>
      </select>
    </div>

    <button class="btn primary" id="mini-save">üíæ L∆∞u Banner Mini</button>
  </div>

  <h3>Danh s√°ch Banner Mini App</h3>
  <div id="mini-banner-list">
    <p style="text-align:center;color:#6b7280;padding:30px">ƒêang t·∫£i...</p>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  if (window.AdminLayout) {
    AdminLayout.init('Qu·∫£n l√Ω Banner');
  }

  const CLOUD_NAME = 'dtemskptf';
  const UPLOAD_PRESET = 'shophuyvan';
  const FOLDER = 'shv';

  let currentPlatform = 'fe';

  // Platform tabs
  document.querySelectorAll('.banner-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      document.querySelectorAll('.banner-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      const platform = this.getAttribute('data-platform');
      currentPlatform = platform;
      document.querySelectorAll('.banner-section').forEach(s => s.classList.remove('active'));
      document.getElementById('section-' + platform).classList.add('active');
      
      loadBanners(platform);
    });
  });

  // ============================================
  // Mini Platform: Direct Upload Logic
  // ============================================
  
  // Upload Mini Mobile
  document.getElementById('mini-file')?.addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    try {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', UPLOAD_PRESET);
      formData.append('folder', FOLDER + '/banners/mini');
      
      const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
        method: 'POST',
        body: formData
      });
      
      const result = await response.json();
      
      document.getElementById('mini-mobile-url').value = result.secure_url;
      document.getElementById('mini-images').style.display = 'block';
      
      Admin.toast('‚úÖ Upload th√†nh c√¥ng!');
    } catch (e) {
      alert('L·ªói upload: ' + e.message);
    }
  });

  // ============================================
  // FE Platform: Direct Upload Logic
  // ============================================

  // Upload Desktop
  document.getElementById('fe-desktop-file')?.addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    try {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', UPLOAD_PRESET);
      formData.append('folder', FOLDER + '/banners/desktop');
      
      const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
        method: 'POST',
        body: formData
      });
      
      const result = await response.json();
      
      document.getElementById('fe-desktop-url').value = result.secure_url;
      document.getElementById('fe-desktop-preview-img').src = result.secure_url;
      document.getElementById('fe-desktop-preview').style.display = 'block';
      
      Admin.toast('‚úÖ Upload Desktop th√†nh c√¥ng!');
    } catch (e) {
      alert('L·ªói upload Desktop: ' + e.message);
    }
  });

  // Upload Mobile
  document.getElementById('fe-mobile-file')?.addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    try {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', UPLOAD_PRESET);
      formData.append('folder', FOLDER + '/banners/mobile');
      
      const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
        method: 'POST',
        body: formData
      });
      
      const result = await response.json();
      
      document.getElementById('fe-mobile-url').value = result.secure_url;
      document.getElementById('fe-mobile-preview-img').src = result.secure_url;
      document.getElementById('fe-mobile-preview').style.display = 'block';
      
      Admin.toast('‚úÖ Upload Mobile th√†nh c√¥ng!');
    } catch (e) {
      alert('L·ªói upload Mobile: ' + e.message);
    }
  });

  // Save FE Banner
  document.getElementById('fe-save')?.addEventListener('click', async function() {
    const desktopUrl = document.getElementById('fe-desktop-url').value.trim();
    const mobileUrl = document.getElementById('fe-mobile-url').value.trim();
    
    if (!desktopUrl || !mobileUrl) {
      alert('Vui l√≤ng upload ·∫£nh tr∆∞·ªõc');
      return;
    }
    
    const body = {
      image_desktop: desktopUrl,
      image_mobile: mobileUrl,
      platform: 'fe',
      order: parseInt(document.getElementById('fe-order').value) || 0,
      type: document.getElementById('fe-type').value || 'fe_banner',
      category_slug: document.getElementById('fe-cat').value.trim(),
      alt: document.getElementById('fe-alt').value.trim(),
      link: document.getElementById('fe-link').value.trim(),
      on: document.getElementById('fe-on').value === 'true'
    };
    
    try {
      const r = await Admin.req('/admin/banners', { method: 'POST', body: body });
      
      if (r && r.ok) {
        Admin.toast('‚úÖ ƒê√£ l∆∞u banner');
        loadBanners('fe');
        
        // Reset form
        document.getElementById('fe-desktop-file').value = '';
        document.getElementById('fe-mobile-file').value = '';
        document.getElementById('fe-desktop-url').value = '';
        document.getElementById('fe-mobile-url').value = '';
        document.getElementById('fe-desktop-preview').style.display = 'none';
        document.getElementById('fe-mobile-preview').style.display = 'none';
        document.getElementById('fe-alt').value = '';
        document.getElementById('fe-link').value = '';
        document.getElementById('fe-order').value = '0';
      } else {
        alert('L∆∞u th·∫•t b·∫°i');
      }
    } catch (e) {
      console.error('Save error:', e);
      alert('L·ªói khi l∆∞u: ' + e.message);
    }
  });

  // Save Mini Banner
  document.getElementById('mini-save')?.addEventListener('click', async function() {
    const mobileUrl = document.getElementById('mini-mobile-url').value.trim();
    
    if (!mobileUrl) {
      alert('Vui l√≤ng upload ·∫£nh tr∆∞·ªõc');
      return;
    }
    
    const body = {
      image: mobileUrl,
      platform: 'mini',
      device: 'mobile',
      order: parseInt(document.getElementById('mini-order').value) || 0,
      alt: document.getElementById('mini-alt').value.trim(),
      link: document.getElementById('mini-link').value.trim(),
      on: document.getElementById('mini-on').value === 'true'
    };
    
    try {
      const r = await Admin.req('/admin/banners', { method: 'POST', body: body });
      
      if (r && r.ok) {
        Admin.toast('‚úÖ ƒê√£ l∆∞u banner');
        loadBanners('mini');
        
        // Reset form
        document.getElementById('mini-file').value = '';
        document.getElementById('mini-mobile-url').value = '';
        document.getElementById('mini-images').style.display = 'none';
        document.getElementById('mini-alt').value = '';
        document.getElementById('mini-link').value = '';
        document.getElementById('mini-order').value = '0';
      } else {
        alert('L∆∞u th·∫•t b·∫°i');
      }
    } catch (e) {
      console.error('Save error:', e);
      alert('L·ªói khi l∆∞u: ' + e.message);
    }
  });

  async function loadBanners(platform) {
    try {
      const r = await Admin.tryPaths(['/banners', '/admin/banners/list', '/admin/banners']);
      const items = r.items || r.banners || r.data || [];
      
      const filtered = items.filter(b => b.platform === platform);
      
      const listEl = document.getElementById(platform + '-banner-list');
      if (!listEl) return;
      
      listEl.innerHTML = '';
      
      if (filtered.length === 0) {
        listEl.innerHTML = '<p style="text-align:center;color:#6b7280;padding:30px">Ch∆∞a c√≥ banner n√†o</p>';
        return;
      }
      
      filtered.sort((a, b) => (a.order || 0) - (b.order || 0)).forEach(b => {
        listEl.appendChild(createBannerCard(b, platform));
      });
    } catch (e) {
      console.error('Load error:', e);
    }
  }

  function createBannerCard(banner, platform) {
    const card = document.createElement('div');
    card.className = 'banner-card';
    
    const isOn = banner.on === undefined ? true : banner.on;
    const statusClass = isOn ? 'status-on' : 'status-off';
    const statusText = isOn ? 'ON' : 'OFF';
    const bannerId = banner.id || banner._id || '';
    
    const imgSrc = banner.image_mobile || banner.image || banner.url || '';
    
    card.innerHTML = `
      <div class="banner-info">
        <img src="${imgSrc}" alt="${banner.alt || ''}" class="thumbnail-preview" onerror="this.src='./no-image.svg'">
        <div class="banner-details">
          <div>
            <span class="status-badge ${statusClass}">${statusText}</span>
            <span style="margin-left:10px;font-size:13px;color:#6b7280">Th·ª© t·ª±: ${banner.order || 0}</span>
          </div>
          <div class="banner-meta"><strong>Platform:</strong> ${banner.platform || 'fe'}</div>
          <div class="banner-meta"><strong>ALT:</strong> ${banner.alt || '(kh√¥ng c√≥)'}</div>
          <div class="banner-meta"><strong>Link:</strong> ${banner.link ? `<a href="${banner.link}" target="_blank" style="color:#2563eb">${banner.link}</a>` : '(kh√¥ng c√≥)'}</div>
          <div style="margin-top:10px">
            <button class="btn danger" onclick="deleteBanner('${bannerId}', '${platform}')">üóëÔ∏è X√≥a</button>
          </div>
        </div>
      </div>
    `;
    
    return card;
  }

  window.deleteBanner = async function(id, platform) {
    if (!confirm('X√°c nh·∫≠n x√≥a banner n√†y?')) return;
    
    try {
      const r = await Admin.req('/admin/banners/delete', { method: 'POST', body: { id: id } });
      
      if (r && r.ok) {
        Admin.toast('‚úÖ ƒê√£ x√≥a');
        loadBanners(platform);
      } else {
        alert('X√≥a th·∫•t b·∫°i');
      }
    } catch (e) {
      console.error('Delete error:', e);
      alert('L·ªói khi x√≥a: ' + e.message);
    }
  };

  loadBanners('fe');
});
</script>

</body>
</html>