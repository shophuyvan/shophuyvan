<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Qu·∫£n l√Ω Banner</title>
  <link rel="stylesheet" href="./styles.css"/>
  <script src="./admin_real.js?v=26"></script>
  <script src="./sidebar-layout.js"></script>
  <link rel="preconnect" href="https://res.cloudinary.com" crossorigin>
  <link rel="dns-prefetch" href="//res.cloudinary.com">
  <style>
    .banner-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
    }
    .banner-tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 600;
      color: #6b7280;
      transition: all 0.2s;
    }
    .banner-tab:hover {
      color: #111827;
      background: #f9fafb;
    }
    .banner-tab.active {
      color: #059669;
      border-bottom-color: #059669;
    }
    .banner-section {
      display: none;
    }
    .banner-section.active {
      display: block;
    }
    .size-guide {
      background: #f0f9ff;
      border: 1px solid #0ea5e9;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .size-guide h4 {
      margin: 0 0 8px 0;
      color: #0369a1;
      font-size: 14px;
      font-weight: 600;
    }
    .size-guide p {
      margin: 4px 0;
      font-size: 13px;
      color: #075985;
    }
    .size-guide strong {
      color: #0c4a6e;
    }
    .device-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
    }
    .device-tab {
      padding: 8px 16px;
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .device-tab:hover {
      background: #e5e7eb;
    }
    .device-tab.active {
      background: #059669;
      color: white;
      border-color: #059669;
    }
    .device-content {
      display: none;
    }
    .device-content.active {
      display: block;
    }
    .preview-container {
      margin-top: 15px;
      padding: 15px;
      background: #f9fafb;
      border-radius: 8px;
    }
    .preview-container img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      font-size: 14px;
      color: #374151;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .thumbnail-preview {
      width: 120px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
    }
    .banner-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .banner-info {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 15px;
      align-items: start;
    }
    .banner-details {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .banner-meta {
      font-size: 13px;
      color: #6b7280;
    }
    .banner-meta strong {
      color: #374151;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-on {
      background: #d1fae5;
      color: #065f46;
    }
    .status-off {
      background: #fee2e2;
      color: #991b1b;
    }
  </style>
</head>
<body>
<!-- Tab ch·ªçn platform -->
<div class="banner-tabs">
  <button class="banner-tab active" data-platform="fe">
    üåê Banner Trang Web (FE)
  </button>
  <button class="banner-tab" data-platform="mini">
    üì± Banner Mini App
  </button>
</div>

<!-- Banner FE Section -->
<div class="banner-section active" id="section-fe">
  <div class="card">
    <h3>Th√™m Banner Trang Web</h3>
    
    <div class="device-tabs">
      <button class="device-tab active" data-device="pc">üíª Desktop</button>
      <button class="device-tab" data-device="mobile">üì± Mobile</button>
    </div>

    <!-- PC Form -->
    <div class="device-content active" id="fe-pc">
      <div class="size-guide">
        <h4>üìè K√≠ch th∆∞·ªõc chu·∫©n cho Desktop</h4>
        <p><strong>Khuy·∫øn ngh·ªã:</strong> 1920x600 px (t·ª∑ l·ªá 16:5)</p>
        <p><strong>T·ªëi thi·ªÉu:</strong> 1200x400 px</p>
        <p><strong>ƒê·ªãnh d·∫°ng:</strong> JPG, PNG, WebP</p>
      </div>

      <div class="form-group">
        <label>·∫¢nh Banner (URL)</label>
        <input id="fe-pc-img" class="input" placeholder="https://..."/>
      </div>

      <div class="form-group">
        <label>Ho·∫∑c Upload ·∫£nh</label>
        <input id="fe-pc-file" type="file" accept="image/*"/>
        <button class="btn" data-upload="fe-pc">Upload</button>
      </div>

      <div class="form-group">
        <label>Th·ª© t·ª± hi·ªÉn th·ªã</label>
        <input id="fe-pc-order" type="number" value="0" class="input"/>
      </div>

      <div class="form-group">
        <label>M√¥ t·∫£ ·∫£nh (ALT)</label>
        <input id="fe-pc-alt" class="input" placeholder="Banner khuy·∫øn m√£i..."/>
      </div>

      <div class="form-group">
        <label>Li√™n k·∫øt (URL ƒë√≠ch khi click)</label>
        <input id="fe-pc-link" class="input" placeholder="https://..."/>
      </div>

      <div class="form-group">
        <label>Tr·∫°ng th√°i</label>
        <select id="fe-pc-on" class="input">
          <option value="true">ON - Hi·ªÉn th·ªã</option>
          <option value="false">OFF - ·∫®n</option>
        </select>
      </div>

      <div id="fe-pc-preview" class="preview-container" style="display:none">
        <h4>Preview:</h4>
        <img src="" alt="Preview">
      </div>

      <button class="btn primary" data-save="fe-pc">üíæ L∆∞u Banner PC</button>
    </div>

    <!-- Mobile Form -->
    <div class="device-content" id="fe-mobile">
      <div class="size-guide">
        <h4>üìè K√≠ch th∆∞·ªõc chu·∫©n cho Mobile</h4>
        <p><strong>Khuy·∫øn ngh·ªã:</strong> 750x400 px (t·ª∑ l·ªá 15:8)</p>
        <p><strong>T·ªëi thi·ªÉu:</strong> 600x320 px</p>
        <p><strong>ƒê·ªãnh d·∫°ng:</strong> JPG, PNG, WebP</p>
      </div>

      <div class="form-group">
        <label>·∫¢nh Banner (URL)</label>
        <input id="fe-mobile-img" class="input" placeholder="https://..."/>
      </div>

      <div class="form-group">
        <label>Ho·∫∑c Upload ·∫£nh</label>
        <input id="fe-mobile-file" type="file" accept="image/*"/>
        <button class="btn" data-upload="fe-mobile">Upload</button>
      </div>

      <div class="form-group">
        <label>Th·ª© t·ª± hi·ªÉn th·ªã</label>
        <input id="fe-mobile-order" type="number" value="0" class="input"/>
      </div>

      <div class="form-group">
        <label>M√¥ t·∫£ ·∫£nh (ALT)</label>
        <input id="fe-mobile-alt" class="input" placeholder="Banner khuy·∫øn m√£i..."/>
      </div>

      <div class="form-group">
        <label>Li√™n k·∫øt (URL ƒë√≠ch khi click)</label>
        <input id="fe-mobile-link" class="input" placeholder="https://..."/>
      </div>

      <div class="form-group">
        <label>Tr·∫°ng th√°i</label>
        <select id="fe-mobile-on" class="input">
          <option value="true">ON - Hi·ªÉn th·ªã</option>
          <option value="false">OFF - ·∫®n</option>
        </select>
      </div>

      <div id="fe-mobile-preview" class="preview-container" style="display:none">
        <h4>Preview:</h4>
        <img src="" alt="Preview">
      </div>

      <button class="btn primary" data-save="fe-mobile">üíæ L∆∞u Banner Mobile</button>
    </div>
  </div>

  <h3>Danh s√°ch Banner Trang Web</h3>
  <div id="fe-banner-list">
    <p style="text-align:center;color:#6b7280;padding:30px">ƒêang t·∫£i...</p>
  </div>
</div>

<!-- Banner Mini Section -->
<div class="banner-section" id="section-mini">
  <div class="card">
    <h3>Th√™m Banner Mini App</h3>
    
    <div class="device-tabs">
      <button class="device-tab active" data-device="mini-pc">üíª Desktop</button>
      <button class="device-tab" data-device="mini-mobile">üì± Mobile</button>
    </div>

    <!-- Mini PC Form -->
    <div class="device-content active" id="mini-pc">
      <div class="size-guide">
        <h4>üìè K√≠ch th∆∞·ªõc chu·∫©n cho Mini App Desktop</h4>
        <p><strong>Khuy·∫øn ngh·ªã:</strong> 1200x400 px (t·ª∑ l·ªá 3:1)</p>
        <p><strong>T·ªëi thi·ªÉu:</strong> 900x300 px</p>
        <p><strong>ƒê·ªãnh d·∫°ng:</strong> JPG, PNG, WebP</p>
      </div>

      <div class="form-group">
        <label>·∫¢nh Banner (URL)</label>
        <input id="mini-pc-img" class="input" placeholder="https://..."/>
      </div>

      <div class="form-group">
        <label>Ho·∫∑c Upload ·∫£nh</label>
        <input id="mini-pc-file" type="file" accept="image/*"/>
        <button class="btn" data-upload="mini-pc">Upload</button>
      </div>

      <div class="form-group">
        <label>Th·ª© t·ª± hi·ªÉn th·ªã</label>
        <input id="mini-pc-order" type="number" value="0" class="input"/>
      </div>

      <div class="form-group">
        <label>M√¥ t·∫£ ·∫£nh (ALT)</label>
        <input id="mini-pc-alt" class="input" placeholder="Banner khuy·∫øn m√£i..."/>
      </div>

      <div class="form-group">
        <label>Li√™n k·∫øt (URL ƒë√≠ch khi click)</label>
        <input id="mini-pc-link" class="input" placeholder="/product/..."/>
      </div>

      <div class="form-group">
        <label>Tr·∫°ng th√°i</label>
        <select id="mini-pc-on" class="input">
          <option value="true">ON - Hi·ªÉn th·ªã</option>
          <option value="false">OFF - ·∫®n</option>
        </select>
      </div>

      <div id="mini-pc-preview" class="preview-container" style="display:none">
        <h4>Preview:</h4>
        <img src="" alt="Preview">
      </div>

      <button class="btn primary" data-save="mini-pc">üíæ L∆∞u Banner PC</button>
    </div>

    <!-- Mini Mobile Form -->
    <div class="device-content" id="mini-mobile">
      <div class="size-guide">
        <h4>üìè K√≠ch th∆∞·ªõc chu·∫©n cho Mini App Mobile</h4>
        <p><strong>Khuy·∫øn ngh·ªã:</strong> 750x300 px (t·ª∑ l·ªá 5:2)</p>
        <p><strong>T·ªëi thi·ªÉu:</strong> 600x240 px</p>
        <p><strong>ƒê·ªãnh d·∫°ng:</strong> JPG, PNG, WebP</p>
      </div>

      <div class="form-group">
        <label>·∫¢nh Banner (URL)</label>
        <input id="mini-mobile-img" class="input" placeholder="https://..."/>
      </div>

      <div class="form-group">
        <label>Ho·∫∑c Upload ·∫£nh</label>
        <input id="mini-mobile-file" type="file" accept="image/*"/>
        <button class="btn" data-upload="mini-mobile">Upload</button>
      </div>

      <div class="form-group">
        <label>Th·ª© t·ª± hi·ªÉn th·ªã</label>
        <input id="mini-mobile-order" type="number" value="0" class="input"/>
      </div>

      <div class="form-group">
        <label>M√¥ t·∫£ ·∫£nh (ALT)</label>
        <input id="mini-mobile-alt" class="input" placeholder="Banner khuy·∫øn m√£i..."/>
      </div>

      <div class="form-group">
        <label>Li√™n k·∫øt (URL ƒë√≠ch khi click)</label>
        <input id="mini-mobile-link" class="input" placeholder="/product/..."/>
      </div>

      <div class="form-group">
        <label>Tr·∫°ng th√°i</label>
        <select id="mini-mobile-on" class="input">
          <option value="true">ON - Hi·ªÉn th·ªã</option>
          <option value="false">OFF - ·∫®n</option>
        </select>
      </div>

      <div id="mini-mobile-preview" class="preview-container" style="display:none">
        <h4>Preview:</h4>
        <img src="" alt="Preview">
      </div>

      <button class="btn primary" data-save="mini-mobile">üíæ L∆∞u Banner Mobile</button>
    </div>
  </div>

  <h3>Danh s√°ch Banner Mini App</h3>
  <div id="mini-banner-list">
    <p style="text-align:center;color:#6b7280;padding:30px">ƒêang t·∫£i...</p>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('[Banners] Initializing...');

  if (window.AdminLayout) {
    AdminLayout.init('Qu·∫£n l√Ω Banner');
  }

  // Cloudinary config
  const CLOUD_NAME = 'dtemskptf';
  const UPLOAD_PRESET = 'shophuyvan';
  const FOLDER = 'shv';

  // Platform tabs
  document.querySelectorAll('.banner-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      document.querySelectorAll('.banner-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      const platform = this.getAttribute('data-platform');
      document.querySelectorAll('.banner-section').forEach(s => s.classList.remove('active'));
      document.getElementById('section-' + platform).classList.add('active');
      
      loadBanners(platform);
    });
  });

  // Device tabs
  document.querySelectorAll('.device-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      const section = this.closest('.banner-section');
      section.querySelectorAll('.device-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      const device = this.getAttribute('data-device');
      section.querySelectorAll('.device-content').forEach(c => c.classList.remove('active'));
      const targetContent = section.querySelector('#' + device);
      if (targetContent) targetContent.classList.add('active');
    });
  });

  // Preview setup
  ['fe-pc', 'fe-mobile', 'mini-pc', 'mini-mobile'].forEach(prefix => {
    const imgInput = document.getElementById(prefix + '-img');
    const preview = document.getElementById(prefix + '-preview');
    
    if (imgInput && preview) {
      const previewImg = preview.querySelector('img');
      imgInput.addEventListener('input', function() {
        if (this.value.trim()) {
          previewImg.src = this.value.trim();
          preview.style.display = 'block';
        } else {
          preview.style.display = 'none';
        }
      });
    }
  });

  // Upload buttons
  setTimeout(function() {
    console.log('[Banners] Setting up upload listeners...');
    document.querySelectorAll('button[data-upload]').forEach(btn => {
      btn.addEventListener('click', async function(e) {
        e.preventDefault();
        const prefix = this.getAttribute('data-upload');
        console.log('[Banners] Upload clicked:', prefix);
        
        const fileInput = document.getElementById(prefix + '-file');
        const file = fileInput ? fileInput.files[0] : null;
        
        if (!file) {
          alert('Vui l√≤ng ch·ªçn ·∫£nh');
          return;
        }
        
        try {
          const formData = new FormData();
          formData.append('file', file);
          formData.append('upload_preset', UPLOAD_PRESET);
          formData.append('folder', FOLDER);
          
          const uploadUrl = 'https://api.cloudinary.com/v1_1/' + CLOUD_NAME + '/image/upload';
          
          console.log('[Banners] Uploading to Cloudinary...');
          const response = await fetch(uploadUrl, {
            method: 'POST',
            body: formData
          });
          
          if (!response.ok) {
            throw new Error('Upload failed: ' + response.status);
          }
          
          const result = await response.json();
          console.log('[Banners] Upload success:', result.secure_url);
          
          const imgInput = document.getElementById(prefix + '-img');
          if (imgInput) {
            imgInput.value = result.secure_url;
            imgInput.dispatchEvent(new Event('input'));
          }
          
          Admin.toast('Upload th√†nh c√¥ng!');
        } catch (e) {
          console.error('[Banners] Upload error:', e);
          alert('L·ªói khi upload: ' + e.message);
        }
      });
    });
  }, 200);

  // Save buttons
  setTimeout(function() {
    console.log('[Banners] Setting up save listeners...');
    document.querySelectorAll('button[data-save]').forEach(btn => {
      btn.addEventListener('click', async function(e) {
        e.preventDefault();
        const prefix = this.getAttribute('data-save');
        console.log('[Banners] Save clicked:', prefix);
        
        const parts = prefix.split('-');
        const platform = parts[0];
        const device = parts[1];
        
        const image = document.getElementById(prefix + '-img').value.trim();
        const order = parseInt(document.getElementById(prefix + '-order').value) || 0;
        const alt = document.getElementById(prefix + '-alt').value.trim();
        const link = document.getElementById(prefix + '-link').value.trim();
        const on = document.getElementById(prefix + '-on').value === 'true';
        
        if (!image) {
          alert('Vui l√≤ng nh·∫≠p URL ·∫£nh ho·∫∑c upload ·∫£nh');
          return;
        }
        
        const body = {
          image: image,
          pos: platform + '_' + device,
          platform: platform,
          device: device,
          order: order,
          alt: alt,
          link: link,
          on: on
        };
        
        try {
          let r = await Admin.req('/admin/banners/upsert', { method: 'POST', body: body });
          if (!(r && r.ok)) {
            r = await Admin.req('/admin/banner', { method: 'POST', body: body });
          }
          
          if (r && r.ok) {
            Admin.toast('ƒê√£ l∆∞u banner');
            loadBanners(platform);
            
            document.getElementById(prefix + '-img').value = '';
            document.getElementById(prefix + '-alt').value = '';
            document.getElementById(prefix + '-link').value = '';
            document.getElementById(prefix + '-order').value = '0';
            document.getElementById(prefix + '-preview').style.display = 'none';
          } else {
            alert('L∆∞u th·∫•t b·∫°i');
          }
        } catch (e) {
          console.error('[Banners] Save error:', e);
          alert('L·ªói khi l∆∞u: ' + e.message);
        }
      });
    });
  }, 200);

  // Load banners
  async function loadBanners(platform) {
    console.log('[Banners] Loading banners for:', platform);
    
    try {
      const r = await Admin.tryPaths(['/banners', '/admin/banners/list', '/admin/banners']);
      const items = r.items || r.banners || r.data || [];
      
      const filtered = items.filter(b => {
        const pos = b.pos || 'home';
        return pos.startsWith(platform + '_');
      });
      
      const pc = filtered.filter(b => (b.pos || '').includes('_pc'));
      const mobile = filtered.filter(b => (b.pos || '').includes('_mobile'));
      
      const listEl = document.getElementById(platform + '-banner-list');
      if (!listEl) return;
      
      listEl.innerHTML = '';
      
      if (pc.length === 0 && mobile.length === 0) {
        listEl.innerHTML = '<p style="text-align:center;color:#6b7280;padding:30px">Ch∆∞a c√≥ banner n√†o</p>';
        return;
      }
      
      if (pc.length > 0) {
        const pcSection = document.createElement('div');
        pcSection.innerHTML = '<h4 style="margin:20px 0 10px 0">üíª Banner Desktop</h4>';
        pc.sort((a, b) => (a.order || 0) - (b.order || 0)).forEach(b => {
          pcSection.appendChild(createBannerCard(b, platform));
        });
        listEl.appendChild(pcSection);
      }
      
      if (mobile.length > 0) {
        const mobileSection = document.createElement('div');
        mobileSection.innerHTML = '<h4 style="margin:20px 0 10px 0">üì± Banner Mobile</h4>';
        mobile.sort((a, b) => (a.order || 0) - (b.order || 0)).forEach(b => {
          mobileSection.appendChild(createBannerCard(b, platform));
        });
        listEl.appendChild(mobileSection);
      }
    } catch (e) {
      console.error('[Banners] Load error:', e);
    }
  }

  function createBannerCard(banner, platform) {
    const card = document.createElement('div');
    card.className = 'banner-card';
    
    const isOn = banner.on === undefined ? true : banner.on;
    const statusClass = isOn ? 'status-on' : 'status-off';
    const statusText = isOn ? 'ON' : 'OFF';
    const bannerId = banner.id || banner._id || '';
    
    card.innerHTML = '<div class="banner-info"><img src="' + (banner.image || banner.url || '') + '" alt="' + (banner.alt || '') + '" class="thumbnail-preview" onerror="this.src=\'./no-image.svg\'"><div class="banner-details"><div><span class="status-badge ' + statusClass + '">' + statusText + '</span><span style="margin-left:10px;font-size:13px;color:#6b7280">Th·ª© t·ª±: ' + (banner.order || 0) + '</span></div><div class="banner-meta"><strong>V·ªã tr√≠:</strong> ' + (banner.pos || 'home') + '</div><div class="banner-meta"><strong>ALT:</strong> ' + (banner.alt || '(kh√¥ng c√≥)') + '</div><div class="banner-meta"><strong>Link:</strong> ' + (banner.link ? '<a href="' + banner.link + '" target="_blank" style="color:#2563eb">' + banner.link + '</a>' : '(kh√¥ng c√≥)') + '</div><div style="margin-top:10px"><button class="btn danger" onclick="deleteBanner(\'' + bannerId + '\', \'' + platform + '\')">üóëÔ∏è X√≥a</button></div></div></div>';
    
    return card;
  }

  window.deleteBanner = async function(id, platform) {
    if (!confirm('X√°c nh·∫≠n x√≥a banner n√†y?')) return;
    
    try {
      let r = await Admin.req('/admin/banners/delete', { method: 'POST', body: { id: id } });
      if (!(r && r.ok)) {
        r = await Admin.req('/admin/banner/delete', { method: 'POST', body: { id: id } });
      }
      
      if (r && r.ok) {
        Admin.toast('ƒê√£ x√≥a');
        loadBanners(platform);
      } else {
        alert('X√≥a th·∫•t b·∫°i');
      }
    } catch (e) {
      console.error('[Banners] Delete error:', e);
      alert('L·ªói khi x√≥a: ' + e.message);
    }
  };

  loadBanners('fe');
});
</script>
</body>
</html>