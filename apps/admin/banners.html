<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Qu·∫£n l√Ω Banner</title>
  <link rel="stylesheet" href="./styles.css"/>
  <script src="./admin_real.js?v=26"></script>
  <script src="./sidebar-layout.js"></script>
  
  <!-- Cropper.js -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  
  <style>
    .banner-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
    }
    .banner-tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 600;
      color: #6b7280;
      transition: all 0.2s;
    }
    .banner-tab:hover {
      color: #111827;
      background: #f9fafb;
    }
    .banner-tab.active {
      color: #059669;
      border-bottom-color: #059669;
    }
    .banner-section {
      display: none;
    }
    .banner-section.active {
      display: block;
    }
    
    /* Crop Modal */
    .crop-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      z-index: 9999;
      padding: 20px;
    }
    .crop-modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .crop-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      max-width: 95vw;
      max-height: 95vh;
      overflow: auto;
    }
    .crop-area {
      max-width: 100%;
      max-height: 60vh;
    }
    .crop-preview-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 20px;
    }
    .preview-box {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 10px;
      text-align: center;
    }
    .preview-box h4 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #374151;
    }
    .preview-box img {
      max-width: 100%;
      border-radius: 4px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      font-size: 14px;
      color: #374151;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .thumbnail-preview {
      width: 120px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
    }
    .banner-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .banner-info {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 15px;
      align-items: start;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-on {
      background: #d1fae5;
      color: #065f46;
    }
    .status-off {
      background: #fee2e2;
      color: #991b1b;
    }
  </style>
</head>
<body>

<!-- Crop Modal -->
<div id="crop-modal" class="crop-modal">
  <div class="crop-container">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
      <h3 id="crop-title">Crop Banner</h3>
      <button id="crop-close" class="btn" style="background:#ef4444;color:white;">‚úï ƒê√≥ng</button>
    </div>
    
    <div>
      <img id="crop-image" class="crop-area" src="" alt="Crop">
    </div>
    
    <div class="crop-preview-grid">
      <div class="preview-box">
        <h4>üñ•Ô∏è Preview Desktop</h4>
        <div id="preview-desktop" style="width:100%;aspect-ratio:16/5;background:#f3f4f6;border-radius:4px;overflow:hidden;"></div>
      </div>
      <div class="preview-box">
        <h4>üì± Preview Mobile</h4>
        <div id="preview-mobile" style="width:100%;aspect-ratio:3/2;background:#f3f4f6;border-radius:4px;overflow:hidden;"></div>
      </div>
    </div>
    
    <div style="margin-top:20px;display:flex;gap:10px;">
      <button id="crop-save" class="btn primary" style="flex:1;">üíæ L∆∞u & Upload</button>
      <button id="crop-cancel" class="btn">H·ªßy</button>
    </div>
  </div>
</div>

<!-- Platform Tabs -->
<div class="banner-tabs">
  <button class="banner-tab active" data-platform="fe">
    üåê Banner Trang Web (FE)
  </button>
  <button class="banner-tab" data-platform="mini">
    üì± Banner Mini App
  </button>
</div>

<!-- Banner FE Section -->
<div class="banner-section active" id="section-fe">
  <div class="card">
    <h3>Th√™m Banner Trang Web</h3>
    
    <div class="form-group">
      <label>üìÅ Upload ·∫£nh g·ªëc (s·∫Ω crop th√†nh Desktop + Mobile)</label>
      <input id="fe-file" type="file" accept="image/*" class="input"/>
      <small style="color:#6b7280;">Khuy·∫øn ngh·ªã: ·∫¢nh t·ªâ l·ªá ngang, k√≠ch th∆∞·ªõc t·ªëi thi·ªÉu 1920x1080px</small>
    </div>

    <div id="fe-images" style="display:none;">
      <div class="form-group">
        <label>üñ•Ô∏è Desktop URL (1920x600)</label>
        <input id="fe-desktop-url" class="input" readonly/>
      </div>
      <div class="form-group">
        <label>üì± Mobile URL (1080x720)</label>
        <input id="fe-mobile-url" class="input" readonly/>
      </div>
    </div>

    <div class="form-group">
      <label>Th·ª© t·ª± hi·ªÉn th·ªã</label>
      <input id="fe-order" type="number" value="0" class="input"/>
    </div>
    
    <div class="form-group">
      <label>Lo·∫°i banner</label>
      <select id="fe-type" class="input">
        <option value="fe_banner" selected>Banner th∆∞·ªùng (FE)</option>
        <option value="category_hero">Category Hero</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>Category Slug (d√πng khi ch·ªçn Category Hero)</label>
      <input id="fe-cat" class="input" placeholder="v√≠ d·ª•: thiet-bi-dien-nuoc"/>
    </div>

    <div class="form-group">
      <label>M√¥ t·∫£ ·∫£nh (ALT)</label>
      <input id="fe-alt" class="input" placeholder="Banner khuy·∫øn m√£i..."/>
    </div>

    <div class="form-group">
      <label>Li√™n k·∫øt (URL ƒë√≠ch khi click)</label>
      <input id="fe-link" class="input" placeholder="https://..."/>
    </div>

    <div class="form-group">
      <label>Tr·∫°ng th√°i</label>
      <select id="fe-on" class="input">
        <option value="true">ON - Hi·ªÉn th·ªã</option>
        <option value="false">OFF - ·∫®n</option>
      </select>
    </div>

    <button class="btn primary" id="fe-save">üíæ L∆∞u Banner FE</button>
  </div>

  <h3>Danh s√°ch Banner Trang Web</h3>
  <div id="fe-banner-list">
    <p style="text-align:center;color:#6b7280;padding:30px">ƒêang t·∫£i...</p>
  </div>
</div>

<!-- Banner Mini Section -->
<div class="banner-section" id="section-mini">
  <div class="card">
    <h3>Th√™m Banner Mini App (Mobile Only)</h3>
    
    <div class="form-group">
      <label>üìÅ Upload ·∫£nh Mobile (1080x720)</label>
      <input id="mini-file" type="file" accept="image/*" class="input"/>
      <small style="color:#6b7280;">Khuy·∫øn ngh·ªã: ·∫¢nh t·ªâ l·ªá 3:2, k√≠ch th∆∞·ªõc t·ªëi thi·ªÉu 1080x720px</small>
    </div>

    <div id="mini-images" style="display:none;">
      <div class="form-group">
        <label>üì± Mobile URL</label>
        <input id="mini-mobile-url" class="input" readonly/>
      </div>
    </div>

    <div class="form-group">
      <label>Th·ª© t·ª± hi·ªÉn th·ªã</label>
      <input id="mini-order" type="number" value="0" class="input"/>
    </div>

    <div class="form-group">
      <label>M√¥ t·∫£ ·∫£nh (ALT)</label>
      <input id="mini-alt" class="input" placeholder="Banner khuy·∫øn m√£i..."/>
    </div>

    <div class="form-group">
      <label>Li√™n k·∫øt (URL ƒë√≠ch khi click)</label>
      <input id="mini-link" class="input" placeholder="/product/..."/>
    </div>

    <div class="form-group">
      <label>Tr·∫°ng th√°i</label>
      <select id="mini-on" class="input">
        <option value="true">ON - Hi·ªÉn th·ªã</option>
        <option value="false">OFF - ·∫®n</option>
      </select>
    </div>

    <button class="btn primary" id="mini-save">üíæ L∆∞u Banner Mini</button>
  </div>

  <h3>Danh s√°ch Banner Mini App</h3>
  <div id="mini-banner-list">
    <p style="text-align:center;color:#6b7280;padding:30px">ƒêang t·∫£i...</p>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  if (window.AdminLayout) {
    AdminLayout.init('Qu·∫£n l√Ω Banner');
  }

  const CLOUD_NAME = 'dtemskptf';
  const UPLOAD_PRESET = 'shophuyvan';
  const FOLDER = 'shv';

  let currentCropper = null;
  let currentPlatform = 'fe';
  let croppedDesktopBlob = null;
  let croppedMobileBlob = null;

  // Platform tabs
  document.querySelectorAll('.banner-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      document.querySelectorAll('.banner-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      const platform = this.getAttribute('data-platform');
      currentPlatform = platform;
      document.querySelectorAll('.banner-section').forEach(s => s.classList.remove('active'));
      document.getElementById('section-' + platform).classList.add('active');
      
      loadBanners(platform);
    });
  });

  // FE File Upload
  document.getElementById('fe-file')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(event) {
      openCropModal(event.target.result, 'fe');
    };
    reader.readAsDataURL(file);
  });

  // Mini File Upload
  document.getElementById('mini-file')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(event) {
      openCropModal(event.target.result, 'mini');
    };
    reader.readAsDataURL(file);
  });

  function openCropModal(imageSrc, platform) {
    const modal = document.getElementById('crop-modal');
    const img = document.getElementById('crop-image');
    const title = document.getElementById('crop-title');
    
    if (platform === 'fe') {
      title.textContent = 'Crop Banner Desktop & Mobile';
    } else {
      title.textContent = 'Crop Banner Mobile (Mini App)';
    }
    
    img.src = imageSrc;
    modal.classList.add('active');
    
    if (currentCropper) {
      currentCropper.destroy();
    }
    
    // Kh·ªüi t·∫°o cropper v·ªõi aspect ratio ph√π h·ª£p
    const aspectRatio = platform === 'fe' ? 16 / 5 : 3 / 2;
    
    currentCropper = new Cropper(img, {
      aspectRatio: aspectRatio,
      viewMode: 1,
      dragMode: 'move',
      autoCropArea: 1,
      restore: false,
      guides: true,
      center: true,
      highlight: true,
      cropBoxMovable: true,
      cropBoxResizable: true,
      toggleDragModeOnDblclick: false,
      crop: function() {
        updatePreviews(platform);
      }
    });
  }

  function updatePreviews(platform) {
    if (!currentCropper) return;
    
    const previewDesktop = document.getElementById('preview-desktop');
    const previewMobile = document.getElementById('preview-mobile');
    
    if (platform === 'fe') {
      // Desktop preview (16:5)
      const desktopCanvas = currentCropper.getCroppedCanvas({
        width: 1920,
        height: 600
      });
      previewDesktop.innerHTML = `<img src="${desktopCanvas.toDataURL()}" style="width:100%;height:100%;object-fit:cover;">`;
      
      // Mobile preview (3:2)
      const mobileCanvas = currentCropper.getCroppedCanvas({
        width: 1080,
        height: 720
      });
      previewMobile.innerHTML = `<img src="${mobileCanvas.toDataURL()}" style="width:100%;height:100%;object-fit:cover;">`;
      
      // L∆∞u blob
      desktopCanvas.toBlob(blob => { croppedDesktopBlob = blob; }, 'image/jpeg', 0.9);
      mobileCanvas.toBlob(blob => { croppedMobileBlob = blob; }, 'image/jpeg', 0.9);
      
    } else {
      // Mini: Ch·ªâ mobile
      previewDesktop.innerHTML = '<p style="color:#9ca3af;padding:20px;">Kh√¥ng c·∫ßn Desktop cho Mini App</p>';
      
      const mobileCanvas = currentCropper.getCroppedCanvas({
        width: 1080,
        height: 720
      });
      previewMobile.innerHTML = `<img src="${mobileCanvas.toDataURL()}" style="width:100%;height:100%;object-fit:cover;">`;
      
      mobileCanvas.toBlob(blob => { croppedMobileBlob = blob; }, 'image/jpeg', 0.9);
    }
  }

  document.getElementById('crop-close')?.addEventListener('click', closeCropModal);
  document.getElementById('crop-cancel')?.addEventListener('click', closeCropModal);

  function closeCropModal() {
    const modal = document.getElementById('crop-modal');
    modal.classList.remove('active');
    if (currentCropper) {
      currentCropper.destroy();
      currentCropper = null;
    }
    croppedDesktopBlob = null;
    croppedMobileBlob = null;
  }

  document.getElementById('crop-save')?.addEventListener('click', async function() {
    const platform = currentPlatform;
    
    try {
      if (platform === 'fe') {
        if (!croppedDesktopBlob || !croppedMobileBlob) {
          alert('Vui l√≤ng crop ·∫£nh tr∆∞·ªõc');
          return;
        }
        
        // Upload Desktop
        const desktopUrl = await uploadToCloudinary(croppedDesktopBlob, 'desktop');
        document.getElementById('fe-desktop-url').value = desktopUrl;
        
        // Upload Mobile
        const mobileUrl = await uploadToCloudinary(croppedMobileBlob, 'mobile');
        document.getElementById('fe-mobile-url').value = mobileUrl;
        
        document.getElementById('fe-images').style.display = 'block';
        
        Admin.toast('‚úÖ Upload th√†nh c√¥ng c·∫£ 2 ·∫£nh!');
        
      } else {
        if (!croppedMobileBlob) {
          alert('Vui l√≤ng crop ·∫£nh tr∆∞·ªõc');
          return;
        }
        
        const mobileUrl = await uploadToCloudinary(croppedMobileBlob, 'mobile');
        document.getElementById('mini-mobile-url').value = mobileUrl;
        
        document.getElementById('mini-images').style.display = 'block';
        
        Admin.toast('‚úÖ Upload th√†nh c√¥ng!');
      }
      
      closeCropModal();
      
    } catch (e) {
      console.error('Upload error:', e);
      alert('L·ªói khi upload: ' + e.message);
    }
  });

  async function uploadToCloudinary(blob, type) {
    const formData = new FormData();
    formData.append('file', blob, `banner_${type}_${Date.now()}.jpg`);
    formData.append('upload_preset', UPLOAD_PRESET);
    formData.append('folder', FOLDER + '/banners');
    
    const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
      method: 'POST',
      body: formData
    });
    
    if (!response.ok) {
      throw new Error('Upload failed: ' + response.status);
    }
    
    const result = await response.json();
    return result.secure_url;
  }

  // Save FE Banner
  document.getElementById('fe-save')?.addEventListener('click', async function() {
    const desktopUrl = document.getElementById('fe-desktop-url').value.trim();
    const mobileUrl = document.getElementById('fe-mobile-url').value.trim();
    
    if (!desktopUrl || !mobileUrl) {
      alert('Vui l√≤ng upload ·∫£nh tr∆∞·ªõc');
      return;
    }
    
    const body = {
      image_desktop: desktopUrl,
      image_mobile: mobileUrl,
      platform: 'fe',
      order: parseInt(document.getElementById('fe-order').value) || 0,
      type: document.getElementById('fe-type').value || 'fe_banner',
      category_slug: document.getElementById('fe-cat').value.trim(),
      alt: document.getElementById('fe-alt').value.trim(),
      link: document.getElementById('fe-link').value.trim(),
      on: document.getElementById('fe-on').value === 'true'
    };
    
    try {
      const r = await Admin.req('/admin/banners', { method: 'POST', body: body });
      
      if (r && r.ok) {
        Admin.toast('‚úÖ ƒê√£ l∆∞u banner');
        loadBanners('fe');
        
        // Reset form
        document.getElementById('fe-file').value = '';
        document.getElementById('fe-desktop-url').value = '';
        document.getElementById('fe-mobile-url').value = '';
        document.getElementById('fe-images').style.display = 'none';
        document.getElementById('fe-alt').value = '';
        document.getElementById('fe-link').value = '';
        document.getElementById('fe-order').value = '0';
      } else {
        alert('L∆∞u th·∫•t b·∫°i');
      }
    } catch (e) {
      console.error('Save error:', e);
      alert('L·ªói khi l∆∞u: ' + e.message);
    }
  });

  // Save Mini Banner
  document.getElementById('mini-save')?.addEventListener('click', async function() {
    const mobileUrl = document.getElementById('mini-mobile-url').value.trim();
    
    if (!mobileUrl) {
      alert('Vui l√≤ng upload ·∫£nh tr∆∞·ªõc');
      return;
    }
    
    const body = {
      image: mobileUrl,
      platform: 'mini',
      device: 'mobile',
      order: parseInt(document.getElementById('mini-order').value) || 0,
      alt: document.getElementById('mini-alt').value.trim(),
      link: document.getElementById('mini-link').value.trim(),
      on: document.getElementById('mini-on').value === 'true'
    };
    
    try {
      const r = await Admin.req('/admin/banners', { method: 'POST', body: body });
      
      if (r && r.ok) {
        Admin.toast('‚úÖ ƒê√£ l∆∞u banner');
        loadBanners('mini');
        
        // Reset form
        document.getElementById('mini-file').value = '';
        document.getElementById('mini-mobile-url').value = '';
        document.getElementById('mini-images').style.display = 'none';
        document.getElementById('mini-alt').value = '';
        document.getElementById('mini-link').value = '';
        document.getElementById('mini-order').value = '0';
      } else {
        alert('L∆∞u th·∫•t b·∫°i');
      }
    } catch (e) {
      console.error('Save error:', e);
      alert('L·ªói khi l∆∞u: ' + e.message);
    }
  });

  async function loadBanners(platform) {
    try {
      const r = await Admin.tryPaths(['/banners', '/admin/banners/list', '/admin/banners']);
      const items = r.items || r.banners || r.data || [];
      
      const filtered = items.filter(b => b.platform === platform);
      
      const listEl = document.getElementById(platform + '-banner-list');
      if (!listEl) return;
      
      listEl.innerHTML = '';
      
      if (filtered.length === 0) {
        listEl.innerHTML = '<p style="text-align:center;color:#6b7280;padding:30px">Ch∆∞a c√≥ banner n√†o</p>';
        return;
      }
      
      filtered.sort((a, b) => (a.order || 0) - (b.order || 0)).forEach(b => {
        listEl.appendChild(createBannerCard(b, platform));
      });
    } catch (e) {
      console.error('Load error:', e);
    }
  }

  function createBannerCard(banner, platform) {
    const card = document.createElement('div');
    card.className = 'banner-card';
    
    const isOn = banner.on === undefined ? true : banner.on;
    const statusClass = isOn ? 'status-on' : 'status-off';
    const statusText = isOn ? 'ON' : 'OFF';
    const bannerId = banner.id || banner._id || '';
    
    const imgSrc = banner.image_mobile || banner.image || banner.url || '';
    
    card.innerHTML = `
      <div class="banner-info">
        <img src="${imgSrc}" alt="${banner.alt || ''}" class="thumbnail-preview" onerror="this.src='./no-image.svg'">
        <div class="banner-details">
          <div>
            <span class="status-badge ${statusClass}">${statusText}</span>
            <span style="margin-left:10px;font-size:13px;color:#6b7280">Th·ª© t·ª±: ${banner.order || 0}</span>
          </div>
          <div class="banner-meta"><strong>Platform:</strong> ${banner.platform || 'fe'}</div>
          <div class="banner-meta"><strong>ALT:</strong> ${banner.alt || '(kh√¥ng c√≥)'}</div>
          <div class="banner-meta"><strong>Link:</strong> ${banner.link ? `<a href="${banner.link}" target="_blank" style="color:#2563eb">${banner.link}</a>` : '(kh√¥ng c√≥)'}</div>
          <div style="margin-top:10px">
            <button class="btn danger" onclick="deleteBanner('${bannerId}', '${platform}')">üóëÔ∏è X√≥a</button>
          </div>
        </div>
      </div>
    `;
    
    return card;
  }

  window.deleteBanner = async function(id, platform) {
    if (!confirm('X√°c nh·∫≠n x√≥a banner n√†y?')) return;
    
    try {
      const r = await Admin.req('/admin/banners/delete', { method: 'POST', body: { id: id } });
      
      if (r && r.ok) {
        Admin.toast('‚úÖ ƒê√£ x√≥a');
        loadBanners(platform);
      } else {
        alert('X√≥a th·∫•t b·∫°i');
      }
    } catch (e) {
      console.error('Delete error:', e);
      alert('L·ªói khi x√≥a: ' + e.message);
    }
  };

  loadBanners('fe');
});
</script>
</body>
</html>