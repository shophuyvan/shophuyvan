<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thanh to√°n - Shop Huy V√¢n</title>
  <meta name="description" content="Thanh to√°n ƒë∆°n h√†ng t·∫°i Shop Huy V√¢n - Nhanh ch√≥ng, an to√†n, b·∫£o m·∫≠t">
  <meta name="robots" content="noindex, nofollow">
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    .product-card { transition: all 0.2s ease; }
    .product-card:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
    .variant-badge { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .shipping-option { transition: all 0.2s ease; cursor: pointer; }
    .shipping-option:hover { transform: scale(1.02); }
    .shipping-option.selected { border-color: #10b981; background: #ecfdf5; }
    .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s ease-in-out infinite; }
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    img { image-rendering: -webkit-optimize-contrast; image-rendering: crisp-edges; }
  </style>
</head>

<body class="bg-gray-50">

<header class="bg-white border-b sticky top-0 z-40 shadow-sm">
  <div class="max-w-4xl mx-auto px-4 py-3 flex items-center gap-3">
    <a href="/" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
      <img src="/logo.png" class="w-8 h-8 rounded" alt="Logo" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2232%22 height=%2232%22%3E%3Crect fill=%22%23e5e7eb%22 width=%2232%22 height=%2232%22/%3E%3C/svg%3E'" />
      <span class="font-bold text-lg">SHOP HUY V√ÇN</span>
    </a>
    <div class="ml-auto text-sm text-gray-600">
      <span class="hidden sm:inline">Thanh to√°n an to√†n</span>
      <span class="inline sm:hidden">üîí</span>
    </div>
  </div>
</header>

<main class="max-w-4xl mx-auto px-4 py-6 space-y-4 pb-32">
  <h1 class="text-2xl font-bold">Thanh to√°n</h1>
  
  <section class="bg-white rounded-2xl shadow-sm overflow-hidden">
    <div class="p-4 border-b bg-gradient-to-r from-rose-50 to-pink-50">
      <h2 class="font-semibold text-lg flex items-center gap-2">
        <span>üõí</span>
        <span>ƒê∆°n h√†ng (<span id="cart-count">0</span> s·∫£n ph·∫©m)</span>
      </h2>
    </div>
    <div id="cart-items" class="divide-y max-h-96 overflow-y-auto">
      <div class="p-8 text-center text-gray-500">
        <div class="skeleton w-full h-32 rounded-xl mb-3"></div>
      </div>
    </div>
    <div class="p-4 border-t bg-gray-50">
      <div class="flex justify-between items-center text-lg font-semibold">
        <span>T·∫°m t√≠nh</span>
        <span id="subtotal" class="text-rose-600">0‚Ç´</span>
      </div>
    </div>
  </section>

  <section class="bg-white rounded-2xl p-4 shadow-sm">
    <h2 class="font-semibold text-lg mb-4 flex items-center gap-2">
      <span>üìç</span>
      <span>ƒê·ªãa ch·ªâ nh·∫≠n h√†ng</span>
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <input id="name" placeholder="H·ªç t√™n *" class="col-span-1 border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 outline-none" required />
      <input id="phone" placeholder="S·ªë ƒëi·ªán tho·∫°i *" type="tel" class="col-span-1 border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 outline-none" required />
      <select id="province" class="col-span-1 border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 outline-none">
        <option value="">-- Ch·ªçn T·ªânh/Th√†nh ph·ªë *</option>
      </select>
      <select id="district" class="col-span-1 border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 outline-none" disabled>
        <option value="">-- Ch·ªçn Qu·∫≠n/Huy·ªán *</option>
      </select>
      <select id="ward" class="col-span-1 md:col-span-2 border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 outline-none" disabled>
        <option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ *</option>
      </select>
      <input id="address" placeholder="ƒê·ªãa ch·ªâ chi ti·∫øt (s·ªë nh√†, t√™n ƒë∆∞·ªùng) *" class="col-span-1 md:col-span-2 border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 outline-none" required />
      <textarea id="note" placeholder="Ghi ch√∫ (kh√¥ng b·∫Øt bu·ªôc)" rows="2" class="col-span-1 md:col-span-2 border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 outline-none resize-none"></textarea>
    </div>
    <input type="hidden" id="province_code" />
    <input type="hidden" id="district_code" />
    <input type="hidden" id="ward_code" />
  </section>

  <section class="bg-white rounded-2xl p-4 shadow-sm">
    <h2 class="font-semibold text-lg mb-3 flex items-center gap-2">
      <span>üöö</span>
      <span>V·∫≠n chuy·ªÉn</span>
    </h2>
    <div class="text-sm text-gray-600 mb-3">
      Kh·ªëi l∆∞·ª£ng: <span id="total-weight" class="font-semibold">-</span>
    </div>
    <div id="shipping-list" class="space-y-2">
      <div class="text-sm text-gray-500 text-center py-4">
        Vui l√≤ng ch·ªçn ƒë·ªãa ch·ªâ ƒë·ªÉ xem ph√≠ v·∫≠n chuy·ªÉn
      </div>
    </div>
  </section>

  <section class="bg-white rounded-2xl p-4 shadow-sm">
    <h2 class="font-semibold text-lg mb-3">Chi ti·∫øt thanh to√°n</h2>
    <div class="space-y-2 text-sm">
      <div class="flex justify-between">
        <span>T·ªïng s·∫£n ph·∫©m:</span>
        <span id="summary-subtotal">0‚Ç´</span>
      </div>
      <div class="flex justify-between">
        <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
        <span id="summary-shipping" class="text-emerald-600 font-semibold">0‚Ç´</span>
      </div>
    </div>
    <div class="flex justify-between py-3 border-t mt-3 text-xl font-bold">
      <span>T·ªïng thanh to√°n:</span>
      <span id="grand-total" class="text-emerald-600">0‚Ç´</span>
    </div>
    <div id="error-message" class="hidden text-red-600 text-sm bg-red-50 p-3 rounded-lg border border-red-200 mt-3"></div>
    <button id="place-order" class="w-full bg-emerald-600 hover:bg-emerald-700 disabled:bg-gray-300 text-white px-6 py-4 rounded-xl font-bold text-lg transition-all shadow-lg hover:shadow-xl disabled:cursor-not-allowed mt-4">
      ƒê·∫∑t h√†ng
    </button>
    <div id="order-result" class="text-sm mt-3 text-center"></div>
  </section>
</main>

<script type="module">
const API_BASE = 'https://shv-api.shophuyvan.workers.dev';
const VN_PHONE_RE = /^(03|05|07|08|09)\d{8}$/;
const $ = id => document.getElementById(id);
const fmtVND = v => (Number(v)||0).toLocaleString('vi-VN') + '‚Ç´';

function cloudify(url, transforms = 'w_200,h_200,c_fill,q_auto,f_auto') {
  if (!url || !url.includes('res.cloudinary.com')) return url;
  return url.replace('/upload/', `/upload/${transforms}/`);
}

async function api(path, opts = {}) {
  const url = `${API_BASE}${path.startsWith('/') ? '' : '/'}${path}`;
  const headers = { ...opts.headers };
  let body = opts.body;
  if (body && typeof body === 'object' && !(body instanceof FormData)) {
    headers['Content-Type'] = 'application/json';
    body = JSON.stringify(body);
  }
  const res = await fetch(url, { method: opts.method || 'GET', headers, body });
  const ctype = res.headers.get('content-type') || '';
  if (ctype.includes('application/json')) return await res.json();
  return await res.text();
}

function getFixedQuotes(weightGrams) {
  const kg = Math.max(1, Math.ceil(Number(weightGrams||0)/1000));
  const cap = Math.min(kg, 6);
  const table = {
    vtp: { name: 'Viettel Post', rates: {1:18000,2:23000,3:28000,4:33000,5:38000,6:43000} },
    spx: { name: 'SPX Express',  rates: {1:15000,2:25000,3:35000,4:45000,5:55000,6:65000} },
    jt:  { name: 'J&T Express',  rates: {1:20000,2:25000,3:25000,4:30000,5:35000,6:40000} },
    ghn: { name: 'GHN',          rates: {1:19000,2:19000,3:24000,4:29000,5:34000,6:39000} },
  };
  function extend(code) {
    const r = table[code].rates;
    if(kg<=6) return r[cap];
    const last = r[6], prev = r[5];
    const step = (last - prev) || 5000;
    return last + step*(kg-6);
  }
  return Object.entries(table).map(([code,info])=> ({
    provider: code,
    service_code: 'fixed',
    name: info.name,
    fee: kg<=6 ? info.rates[cap] : extend(code),
    eta: 'Giao h√†ng ti√™u chu·∫©n'
  }));
}

let selectedShipping = null;
let placing = false;

function getCart() {
  try {
    const lower = JSON.parse(localStorage.getItem('cart') || '[]');
    if (Array.isArray(lower) && lower.length) return lower;
    const upper = JSON.parse(localStorage.getItem('CART') || '[]');
    return Array.isArray(upper) ? upper : [];
  } catch { return []; }
}

// ‚úÖ FIX: Clear cart function
function clearCart() {
  try {
    localStorage.removeItem('cart');
    localStorage.removeItem('CART');
    localStorage.removeItem('shv_cart');
    localStorage.removeItem('shv_cart_v1');
    window.dispatchEvent(new Event('storage'));
    window.dispatchEvent(new CustomEvent('shv:cart-changed'));
    window.dispatchEvent(new CustomEvent('cart-cleared'));
    console.log('‚úÖ Cart cleared successfully');
  } catch(e) {
    console.error('‚ùå Clear cart error:', e);
  }
}

function calculateTotals() {
  const cart = getCart();
  const subtotal = cart.reduce((sum, item) => sum + Number(item.price || 0) * Number(item.qty || 1), 0);
  const shippingFee = selectedShipping ? Number(selectedShipping.fee || 0) : 0;
  const discount = 0;
  const total = Math.max(0, subtotal + shippingFee - discount);
  return { subtotal, shippingFee, discount, total };
}

function renderCartItems() {
  const cart = getCart();
  const container = $('cart-items');
  const countEl = $('cart-count');
  
  if (countEl) countEl.textContent = cart.length;
  
  if (!cart.length) {
    container.innerHTML = `
      <div class="p-8 text-center text-gray-500">
        <div class="text-6xl mb-3">üõí</div>
        <p>Gi·ªè h√†ng tr·ªëng</p>
        <a href="/" class="inline-block mt-4 px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">
          Ti·∫øp t·ª•c mua s·∫Øm
        </a>
      </div>
    `;
    return;
  }
  
  container.innerHTML = cart.map(item => {
    const image = cloudify(item.variantImage || item.image || '/icon.png');
    const itemTotal = Number(item.price || 0) * Number(item.qty || 1);
    return `
      <div class="product-card p-4 flex gap-4 items-start hover:bg-gray-50">
        <img src="${image}" alt="${item.name}" class="w-24 h-24 rounded-xl object-cover flex-shrink-0 border-2 border-gray-100" loading="lazy" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23e5e7eb%22 width=%22100%22 height=%22100%22/%3E%3C/svg%3E'" />
        <div class="flex-1 min-w-0">
          <h3 class="font-semibold text-sm line-clamp-2 mb-1">${item.name || 'S·∫£n ph·∫©m'}</h3>
          ${item.variantName || item.variant ? `
            <div class="mb-2">
              <span class="inline-block px-3 py-1 text-xs rounded-full variant-badge text-white font-medium">
                ${item.variantName || item.variant}
              </span>
            </div>
          ` : ''}
          <div class="flex items-center justify-between">
            <div class="text-rose-600 font-bold">${fmtVND(item.price)}</div>
            <div class="text-sm text-gray-600">S·ªë l∆∞·ª£ng: <span class="font-semibold">${item.qty}</span></div>
          </div>
          <div class="mt-2 text-right">
            <span class="text-xs text-gray-500">Th√†nh ti·ªÅn: </span>
            <span class="font-bold text-emerald-600 text-lg">${fmtVND(itemTotal)}</span>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  updateSummary();
}

function updateSummary() {
  const { subtotal, shippingFee, discount, total } = calculateTotals();
  $('subtotal').textContent = fmtVND(subtotal);
  $('summary-subtotal').textContent = fmtVND(subtotal);
  $('summary-shipping').textContent = fmtVND(shippingFee);
  $('grand-total').textContent = fmtVND(total);
  
  const cart = getCart();
  const totalWeight = cart.reduce((sum, item) => sum + (Number(item.weight_gram || item.weight || 0) * Number(item.qty || 1)), 0);
  const weightKg = Math.max(1, Math.ceil(totalWeight / 1000));
  $('total-weight').textContent = `${weightKg} kg`;
}

async function loadProvinces() {
  try {
    const res = await api('/shipping/provinces');
    const provinces = res.items || res.data || [];
    const select = $('province');
    select.innerHTML = '<option value="">-- Ch·ªçn T·ªânh/Th√†nh ph·ªë *</option>';
    provinces.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item.code;
      opt.textContent = item.name;
      select.appendChild(opt);
    });
  } catch (e) {
    console.error('Load provinces error:', e);
  }
}

async function loadDistricts(provinceCode) {
  try {
    const res = await api(`/shipping/districts?province_code=${encodeURIComponent(provinceCode)}`);
    const districts = res.items || res.data || [];
    const select = $('district');
    select.innerHTML = '<option value="">-- Ch·ªçn Qu·∫≠n/Huy·ªán *</option>';
    select.disabled = false;
    districts.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item.code;
      opt.textContent = item.name;
      select.appendChild(opt);
    });
    $('ward').innerHTML = '<option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ *</option>';
    $('ward').disabled = true;
    $('district_code').value = '';
    $('ward_code').value = '';
  } catch (e) {
    console.error('Load districts error:', e);
  }
}

async function loadWards(districtCode) {
  try {
    const res = await api(`/shipping/wards?district_code=${encodeURIComponent(districtCode)}`);
    const wards = res.items || res.data || [];
    const select = $('ward');
    select.innerHTML = '<option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ *</option>';
    select.disabled = false;
    wards.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item.code;
      opt.textContent = item.name;
      select.appendChild(opt);
    });
    $('ward_code').value = '';
  } catch (e) {
    console.error('Load wards error:', e);
  }
}

async function getShippingQuote() {
  const provinceCode = $('province_code').value;
  const districtCode = $('district_code').value;
  
  if (!provinceCode || !districtCode) {
    $('shipping-list').innerHTML = '<div class="text-sm text-gray-500 text-center py-4">Vui l√≤ng ch·ªçn ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß</div>';
    return;
  }
  
  try {
    $('shipping-list').innerHTML = '<div class="text-sm text-gray-500 text-center py-4">ƒêang t·∫£i ph√≠ v·∫≠n chuy·ªÉn...</div>';
    
    const cart = getCart();
    const weight = cart.reduce((sum, item) => sum + Number(item.weight_gram || item.weight || 0) * Number(item.qty || 1), 0) || 500;
    const subtotal = cart.reduce((sum, item) => sum + Number(item.price || 0) * Number(item.qty || 1), 0);
    
    let items = [];
    
    try {
      const payload = {
        receiver_province: provinceCode,
        receiver_district: districtCode,
        weight_gram: weight,
        cod: subtotal
      };
      const res = await api('/shipping/price', {
        method: 'POST',
        body: payload
      });
      const apiItems = res.items || res.data || [];
      items = apiItems.map(o => ({
        provider: o.provider || o.carrier || '',
        service_code: o.service_code || o.service || '',
        name: o.name || o.service_name || o.provider,
        fee: Number(o.fee || o.total_fee || 0),
        eta: o.eta || o.leadtime || ''
      }));
    } catch (e) {
      console.log('API shipping failed, using fallback');
    }
    
    if (!items.length) {
      items = getFixedQuotes(weight);
    }
    
    items = items.filter(o => o.fee > 0);
    if (!items.length) {
      $('shipping-list').innerHTML = '<div class="text-sm text-gray-500 text-center py-4">Kh√¥ng c√≥ d·ªãch v·ª• v·∫≠n chuy·ªÉn kh·∫£ d·ª•ng</div>';
      return;
    }
    
    const seen = new Set();
    items = items.filter(item => {
      const key = `${item.provider}-${item.service_code}`;
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    }).sort((a, b) => a.fee - b.fee);
    
    $('shipping-list').innerHTML = items.map((item, idx) => `
      <label class="shipping-option flex items-center justify-between border-2 rounded-xl p-4 ${idx === 0 ? 'selected' : ''}">
        <div class="flex items-center gap-3 flex-1">
          <input type="radio" name="ship_opt" value="${idx}" ${idx === 0 ? 'checked' : ''} 
            data-provider="${item.provider}" data-service="${item.service_code}" 
            data-fee="${item.fee}" data-eta="${item.eta || ''}" data-name="${item.name}"
            class="w-5 h-5 text-emerald-600" />
          <div class="flex-1">
            <div class="font-semibold">${item.name}</div>
            <div class="text-sm text-gray-600">${item.eta || 'Giao h√†ng ti√™u chu·∫©n'}</div>
          </div>
        </div>
        <div class="font-bold text-emerald-600 text-lg">${fmtVND(item.fee)}</div>
      </label>
    `).join('');
    
    document.querySelectorAll('input[name="ship_opt"]').forEach(radio => {
      radio.addEventListener('change', function() {
        document.querySelectorAll('.shipping-option').forEach(opt => opt.classList.remove('selected'));
        this.closest('.shipping-option').classList.add('selected');
        selectedShipping = {
          provider: this.dataset.provider,
          service_code: this.dataset.service,
          fee: Number(this.dataset.fee || 0),
          eta: this.dataset.eta,
          name: this.dataset.name
        };
        updateSummary();
      });
    });
    
    const firstRadio = document.querySelector('input[name="ship_opt"]');
    if (firstRadio) {
      selectedShipping = {
        provider: firstRadio.dataset.provider,
        service_code: firstRadio.dataset.service,
        fee: Number(firstRadio.dataset.fee || 0),
        eta: firstRadio.dataset.eta,
        name: firstRadio.dataset.name
      };
      updateSummary();
    }
  } catch (e) {
    console.error('Get quote error:', e);
    $('shipping-list').innerHTML = '<div class="text-sm text-red-600 text-center py-4">L·ªói khi l·∫•y ph√≠ v·∫≠n chuy·ªÉn</div>';
  }
}

function showError(message) {
  const errorEl = $('error-message');
  errorEl.textContent = '‚ö†Ô∏è ' + message;
  errorEl.classList.remove('hidden');
  setTimeout(() => {
    errorEl.classList.add('hidden');
  }, 5000);
}

async function placeOrder() {
  const btn = $('place-order');
  const resultEl = $('order-result');
  
  if (placing) return;
  placing = true;
  
  const name = $('name').value.trim();
  const phone = $('phone').value.trim();
  const address = $('address').value.trim();
  const provinceCode = $('province_code').value;
  const districtCode = $('district_code').value;
  const wardCode = $('ward_code').value;
  const note = $('note').value.trim();
  
  if (!name || !phone || !address || !provinceCode || !districtCode || !wardCode) {
    showError('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªãa ch·ªâ nh·∫≠n h√†ng!');
    placing = false;
    return;
  }
  
  const cleanPhone = phone.replace(/\D/g, '');
  if (!VN_PHONE_RE.test(cleanPhone)) {
    showError('S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá (VD: 0912345678)!');
    placing = false;
    return;
  }
  
  if (!selectedShipping) {
    showError('Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c v·∫≠n chuy·ªÉn!');
    placing = false;
    return;
  }
  
  const cart = getCart();
  if (!cart.length) {
    showError('Gi·ªè h√†ng tr·ªëng!');
    placing = false;
    return;
  }
  
  const { subtotal, shippingFee, discount, total } = calculateTotals();
  
  btn.disabled = true;
  btn.textContent = 'ƒêang x·ª≠ l√Ω...';
  resultEl.textContent = '';
  
  try {
    const payload = {
      customer: {
        name: name,
        phone: cleanPhone,
        address: address,
        province_code: provinceCode,
        district_code: districtCode,
        commune_code: wardCode,
        ward_code: wardCode
      },
      items: cart.map(item => ({
        id: item.id,
        sku: item.sku || item.id,
        name: item.name || item.title,
        price: Number(item.price || 0),
        cost: Number(item.cost || 0),
        qty: Number(item.qty || 1),
        weight_gram: Number(item.weight_gram || item.weight || 0),
        variant: item.variantName || item.variant || '',
        image: item.variantImage || item.image || ''
      })),
      totals: {
        subtotal: subtotal,
        shipping_fee: shippingFee,
        discount: discount,
        shipping_discount: 0,
        total: total
      },
      shipping_provider: selectedShipping.provider,
      shipping_service: selectedShipping.service_code,
      shipping_name: selectedShipping.name,
      shipping_eta: selectedShipping.eta,
      shipping_fee: shippingFee,
      discount: discount,
      shipping_discount: 0,
      voucher_code: '',
      note: note,
      source: 'website',
      status: 'placed'
    };
    
    console.log('Order payload:', payload);
    
    const res = await api('/api/orders', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Idempotency-Key': 'order-' + Date.now() + '-' + Math.random().toString(36).slice(2)
      },
      body: payload
    });
    
    if (res.ok || res.id) {
      const orderId = res.id || res.order_id || '';
      
      // ‚úÖ FIX: Clear cart IMMEDIATELY after success
      clearCart();
      
      resultEl.innerHTML = `
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mt-3">
          <div class="flex items-center gap-2 text-green-700 font-semibold mb-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span>‚úì ƒê·∫∑t h√†ng th√†nh c√¥ng!</span>
          </div>
          <p class="text-sm text-gray-600">M√£ ƒë∆°n h√†ng: <strong>${orderId}</strong></p>
          <p class="text-sm text-gray-600 mt-1">Ch√∫ng t√¥i s·∫Ω li√™n h·ªá v·ªõi b·∫°n s·ªõm nh·∫•t.</p>
        </div>
      `;
      
      setTimeout(() => {
        window.location.href = '/?order_success=1&order_id=' + orderId;
      }, 2000);
    } else {
      throw new Error(res.error || res.message || 'ƒê·∫∑t h√†ng th·∫•t b·∫°i');
    }
  } catch (e) {
    console.error('Place order error:', e);
    showError(e.message || 'C√≥ l·ªói x·∫£y ra khi ƒë·∫∑t h√†ng');
    btn.disabled = false;
    btn.textContent = 'ƒê·∫∑t h√†ng';
    placing = false;
  } finally {
    // ‚úÖ FIX: Always reset button state
    if (btn.disabled) {
      setTimeout(() => {
        btn.disabled = false;
        btn.textContent = 'ƒê·∫∑t h√†ng';
      }, 3000);
    }
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  const cart = getCart();
  if (!cart.length) {
    showError('Gi·ªè h√†ng tr·ªëng! Vui l√≤ng th√™m s·∫£n ph·∫©m tr∆∞·ªõc khi thanh to√°n.');
    setTimeout(() => {
      window.location.href = '/';
    }, 2000);
    return;
  }
  
  renderCartItems();
  await loadProvinces();
  
  $('province').addEventListener('change', function() {
    $('province_code').value = this.value;
    if (this.value) {
      loadDistricts(this.value);
    }
    getShippingQuote();
  });
  
  $('district').addEventListener('change', function() {
    $('district_code').value = this.value;
    if (this.value) {
      loadWards(this.value);
    }
    getShippingQuote();
  });
  
  $('ward').addEventListener('change', function() {
    $('ward_code').value = this.value;
  });
  
  $('place-order').addEventListener('click', placeOrder);
  
  ['name', 'phone', 'address'].forEach(id => {
    const el = $(id);
    if (el) {
      el.addEventListener('input', updateSummary);
    }
  });
});

console.log('‚úÖ Checkout page loaded - Cart clear FIXED');
</script>

</body>
</html>
      