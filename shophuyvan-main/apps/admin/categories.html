<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Quản lý Danh mục - Shop Huy Vân</title>
<link rel="stylesheet" href="./styles.css"/>
<script src="./admin_real.js?v=25"></script>
<script src="./sidebar-layout.js"></script>
</head>
<body>
<!-- Content will be wrapped by sidebar-layout.js -->

<div class="grid cols-2" style="gap: 24px;">
  <!-- Form thêm/sửa -->
  <div class="card">
    <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px;">
      <span id="form-title">Thêm danh mục mới</span>
    </h3>
    
    <input type="hidden" id="cat-id" value=""/>
    
    <label>Tên danh mục *</label>
    <input id="name" class="input" placeholder="VD: Thiết Bị Điện & Nước"/>
    
    <label>Slug (URL)</label>
    <input id="slug" class="input" placeholder="Tự động tạo nếu để trống"/>
    <div class="hint">URL thân thiện, VD: dien-nuoc</div>
    
    <label>Danh mục cha</label>
    <select id="parent" class="input">
      <option value="">-- Không có (danh mục gốc) --</option>
    </select>
    
    <label>Thứ tự hiển thị</label>
    <input id="order" type="number" class="input" value="0"/>
    <div class="hint">Số càng nhỏ càng hiển thị trước</div>
    
    <div class="toolbar" style="margin-top: 20px;">
      <button id="save" class="btn primary">💾 Lưu danh mục</button>
      <button id="cancel" class="btn" style="display: none;">❌ Hủy</button>
    </div>
  </div>

  <!-- Preview cây danh mục -->
  <div class="card">
    <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px;">
      🌲 Cây danh mục
    </h3>
    <div id="tree-view" style="font-size: 14px; line-height: 1.8;"></div>
  </div>
</div>

<!-- Danh sách dạng bảng -->
<div class="card" style="margin-top: 24px;">
  <div class="toolbar">
    <h3 style="font-size: 18px; font-weight: 700; margin: 0;">
      📋 Danh sách danh mục
    </h3>
    <div class="flex" style="gap: 8px;">
      <input id="search" class="input" placeholder="Tìm kiếm..." style="max-width: 250px;"/>
      <button id="refresh" class="btn">🔄 Tải lại</button>
    </div>
  </div>
  
  <div style="overflow-x: auto; margin-top: 12px;">
    <table class="table">
      <thead>
        <tr>
          <th style="width: 50px;">#</th>
          <th>Tên</th>
          <th>Slug</th>
          <th style="width: 120px;">Danh mục cha</th>
          <th style="width: 100px; text-align: center;">Thứ tự</th>
          <th style="width: 180px; text-align: right;">Thao tác</th>
        </tr>
      </thead>
      <tbody id="list"></tbody>
    </table>
  </div>
  
  <div id="empty-state" style="display: none; text-align: center; padding: 40px; color: #64748b;">
    <div style="font-size: 48px; margin-bottom: 12px;">📦</div>
    <div>Chưa có danh mục nào</div>
    <div style="font-size: 14px; margin-top: 8px;">Thêm danh mục đầu tiên để bắt đầu</div>
  </div>
</div>

<script>
// ===================================================================
// State & Helpers
// ===================================================================
const $ = (s) => document.querySelector(s);
const $$ = (s) => Array.from(document.querySelectorAll(s));

Admin.ensureAuth();

let categories = [];
let editingId = null;

function slugify(text) {
  return String(text || '')
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/(^-|-$)/g, '');
}

function toast(msg) {
  if (window.Admin && window.Admin.toast) {
    window.Admin.toast(msg);
  } else {
    alert(msg);
  }
}

// ===================================================================
// Load Categories
// ===================================================================
async function loadCategories() {
  try {
    const r = await Admin.req('/admin/categories');
    
    if (r && r.ok !== false && r.items) {
      categories = r.items;
      renderTable();
      renderTreeView();
      renderParentSelect();
      
      if (categories.length === 0) {
        $('#empty-state').style.display = 'block';
        $('.table').style.display = 'none';
      } else {
        $('#empty-state').style.display = 'none';
        $('.table').style.display = 'table';
      }
    } else {
      toast('❌ Không tải được danh mục');
      categories = [];
    }
  } catch (e) {
    console.error('Load error:', e);
    toast('❌ Lỗi: ' + e.message);
    categories = [];
  }
}

// ===================================================================
// Render Table
// ===================================================================
function renderTable() {
  const searchTerm = $('#search')?.value.toLowerCase() || '';
  
  const filtered = categories.filter(c => {
    const name = (c.name || '').toLowerCase();
    const slug = (c.slug || '').toLowerCase();
    return !searchTerm || name.includes(searchTerm) || slug.includes(searchTerm);
  });
  
  // Sort by order
  const sorted = filtered.sort((a, b) => 
    (Number(a.order) || 0) - (Number(b.order) || 0)
  );
  
  const tbody = $('#list');
  tbody.innerHTML = '';
  
  sorted.forEach((c, idx) => {
    const tr = document.createElement('tr');
    
    // Find parent name
    const parent = categories.find(p => p.id === c.parent);
    const parentName = parent ? parent.name : '—';
    
    tr.innerHTML = `
      <td style="color: #64748b; font-size: 13px;">${idx + 1}</td>
      <td>
        <div style="font-weight: 600;">${c.name || '—'}</div>
      </td>
      <td>
        <code style="background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-size: 12px;">
          ${c.slug || '—'}
        </code>
      </td>
      <td style="color: #64748b; font-size: 13px;">${parentName}</td>
      <td style="text-align: center;">
        <span class="badge">${c.order || 0}</span>
      </td>
      <td style="text-align: right;">
        <div class="flex" style="justify-content: flex-end; gap: 6px;">
          <button class="btn" data-edit="${c.id}" title="Sửa">✏️</button>
          <button class="btn danger" data-del="${c.id}" title="Xóa">🗑️</button>
        </div>
      </td>
    `;
    
    tbody.appendChild(tr);
  });
  
  // Attach event listeners
  $$('[data-edit]').forEach(btn => {
    btn.addEventListener('click', () => editCategory(btn.dataset.edit));
  });
  
  $$('[data-del]').forEach(btn => {
    btn.addEventListener('click', () => deleteCategory(btn.dataset.del));
  });
}

// ===================================================================
// Render Tree View
// ===================================================================
function renderTreeView() {
  const tree = buildTree(categories);
  const html = renderTreeNode(tree, 0);
  $('#tree-view').innerHTML = html || '<div style="color: #94a3b8;">Chưa có danh mục</div>';
}

function buildTree(items) {
  const map = new Map();
  items.forEach(item => map.set(item.id, { ...item, children: [] }));
  
  const roots = [];
  items.forEach(item => {
    if (item.parent && map.has(item.parent)) {
      map.get(item.parent).children.push(map.get(item.id));
    } else {
      roots.push(map.get(item.id));
    }
  });
  
  // Sort by order
  const sortFn = (a, b) => (Number(a.order) || 0) - (Number(b.order) || 0);
  roots.sort(sortFn);
  roots.forEach(r => r.children.sort(sortFn));
  
  return roots;
}

function renderTreeNode(nodes, depth = 0) {
  if (!nodes || nodes.length === 0) return '';
  
  return nodes.map(node => {
    const indent = '    '.repeat(depth);
    const icon = node.children.length > 0 ? '📁' : '📄';
    const name = node.name || '—';
    
    let html = `<div style="padding: 4px 0; color: #334155;">`;
    html += `${indent}${icon} <strong>${name}</strong>`;
    html += ` <span style="color: #94a3b8; font-size: 12px;">(${node.slug || ''})</span>`;
    html += `</div>`;
    
    if (node.children && node.children.length > 0) {
      html += renderTreeNode(node.children, depth + 1);
    }
    
    return html;
  }).join('');
}

// ===================================================================
// Render Parent Select
// ===================================================================
function renderParentSelect() {
  const select = $('#parent');
  const currentId = editingId;
  
  select.innerHTML = '<option value="">-- Không có (danh mục gốc) --</option>';
  
  // Only show non-editing categories as potential parents
  const available = categories.filter(c => c.id !== currentId);
  
  available.forEach(c => {
    const option = document.createElement('option');
    option.value = c.id;
    option.textContent = c.name;
    select.appendChild(option);
  });
}

// ===================================================================
// Save Category
// ===================================================================
async function saveCategory() {
  const name = $('#name').value.trim();
  const slug = $('#slug').value.trim() || slugify(name);
  const parent = $('#parent').value;
  const order = Number($('#order').value || 0);
  
  if (!name) {
    toast('⚠️ Vui lòng nhập tên danh mục');
    $('#name').focus();
    return;
  }
  
  const body = {
    id: editingId || undefined,
    name,
    slug,
    parent: parent || '',
    order
  };
  
  try {
    const r = await Admin.req('/admin/categories/upsert', {
      method: 'POST',
      body
    });
    
    if (r && r.ok !== false) {
      toast('✅ Đã lưu danh mục');
      resetForm();
      await loadCategories();
    } else {
      toast('❌ Lưu thất bại');
      console.error(r);
    }
  } catch (e) {
    console.error('Save error:', e);
    toast('❌ Lỗi: ' + e.message);
  }
}

// ===================================================================
// Edit Category
// ===================================================================
function editCategory(id) {
  const cat = categories.find(c => c.id === id);
  if (!cat) return;
  
  editingId = id;
  
  $('#cat-id').value = cat.id;
  $('#name').value = cat.name || '';
  $('#slug').value = cat.slug || '';
  $('#order').value = cat.order || 0;
  
  renderParentSelect();
  $('#parent').value = cat.parent || '';
  
  $('#form-title').textContent = '✏️ Sửa danh mục';
  $('#cancel').style.display = 'inline-block';
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ===================================================================
// Delete Category
// ===================================================================
async function deleteCategory(id) {
  const cat = categories.find(c => c.id === id);
  if (!cat) return;
  
  // Check if has children
  const hasChildren = categories.some(c => c.parent === id);
  
  if (hasChildren) {
    toast('⚠️ Không thể xóa danh mục có danh mục con');
    return;
  }
  
  if (!confirm(`Xác nhận xóa danh mục "${cat.name}"?`)) return;
  
  try {
    const r = await Admin.req('/admin/categories/delete', {
      method: 'POST',
      body: { id }
    });
    
    if (r && r.ok) {
      toast('✅ Đã xóa danh mục');
      await loadCategories();
    } else {
      toast('❌ Xóa thất bại');
    }
  } catch (e) {
    console.error('Delete error:', e);
    toast('❌ Lỗi: ' + e.message);
  }
}

// ===================================================================
// Reset Form
// ===================================================================
function resetForm() {
  editingId = null;
  $('#cat-id').value = '';
  $('#name').value = '';
  $('#slug').value = '';
  $('#parent').value = '';
  $('#order').value = '0';
  $('#form-title').textContent = 'Thêm danh mục mới';
  $('#cancel').style.display = 'none';
  renderParentSelect();
}

// ===================================================================
// Event Listeners
// ===================================================================
window.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing categories...');
  
  // Initialize sidebar
  if (window.AdminLayout) {
    AdminLayout.init('Danh mục');
  }
  
  // Auto-generate slug
  $('#name').addEventListener('input', (e) => {
    if (!editingId && !$('#slug').value) {
      $('#slug').value = slugify(e.target.value);
    }
  });
  
  // Save button
  $('#save').addEventListener('click', saveCategory);
  
  // Cancel button
  $('#cancel').addEventListener('click', resetForm);
  
  // Refresh button
  $('#refresh').addEventListener('click', loadCategories);
  
  // Search
  $('#search').addEventListener('input', renderTable);
  
  // Initial load
  loadCategories();
  
  console.log('✅ Categories page initialized');
});

console.log('✅ Categories script loaded');
</script>

<style>
/* Additional styles for tree view */
#tree-view {
  background: #f8fafc;
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  padding: 16px;
  max-height: 400px;
  overflow-y: auto;
  font-family: 'Courier New', monospace;
}

/* Form improvements */
.card h3 {
  border-bottom: 2px solid #e5e7eb;
  padding-bottom: 12px;
}

/* Empty state */
#empty-state {
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Responsive */
@media (max-width: 768px) {
  .grid.cols-2 {
    grid-template-columns: 1fr;
  }
  
  #tree-view {
    max-height: 300px;
  }
}
</style>

</body>
</html>